
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Lipodem Takip Paneli - Ayrƒ± JSON Dosyalarƒ± v2.0</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzAwN2NmZiIvPgo8cGF0aCBkPSJNMTEgMTBoMTB2MkgxMXptMCA0aDd2MmgtN3ptMCA0aDEwdjJIMTF6IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K" />
  
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  
  <!-- JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- T√ºrk√ße karakter desteƒüi i√ßin font ekle -->
  <script>
    // jsPDF font encoding d√ºzeltmesi
    window.fixTurkishChars = function(text) {
      if (!text || typeof text !== 'string') return text;
      return text
        .replace(/≈û/g, 'S').replace(/≈ü/g, 's')
        .replace(/ƒû/g, 'G').replace(/ƒü/g, 'g')
        .replace(/ƒ∞/g, 'I').replace(/ƒ±/g, 'i')
        .replace(/√á/g, 'C').replace(/√ß/g, 'c')
        .replace(/√ñ/g, 'O').replace(/√∂/g, 'o')
        .replace(/√ú/g, 'U').replace(/√º/g, 'u');
    };
  </script>
  
  <!-- Google Drive API -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script>
    // Google Drive API Konfig√ºrasyonu
    window.GOOGLE_DRIVE_CONFIG = {
      // üîë BU ALANLAR localStorage'dan y√ºklenir:
      API_KEY: 'YOUR_API_KEY_HERE', // ‚Üê localStorage'dan y√ºklenecek
      CLIENT_ID: 'YOUR_CLIENT_ID_HERE', // ‚Üê localStorage'dan y√ºklenecek
      
      // Bu alanlarƒ± deƒüi≈ütirmeyin:
      DISCOVERY_DOC: 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
      SCOPES: 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/spreadsheets.readonly'
    };
    
    // localStorage'dan Google API ayarlarƒ±nƒ± y√ºkle
    function loadGoogleApiSettings() {
      const savedApiKey = localStorage.getItem('googleDriveApiKey');
      const savedClientId = localStorage.getItem('googleDriveClientId');
      
      if (savedApiKey && savedApiKey !== 'YOUR_API_KEY_HERE') {
        window.GOOGLE_DRIVE_CONFIG.API_KEY = savedApiKey;
        console.log('‚úÖ Google API Key localStorage\'dan y√ºklendi');
      }
      
      if (savedClientId && savedClientId !== 'YOUR_CLIENT_ID_HERE') {
        window.GOOGLE_DRIVE_CONFIG.CLIENT_ID = savedClientId;
        console.log('‚úÖ Google Client ID localStorage\'dan y√ºklendi');
      }
      
      if (savedApiKey && savedClientId) {
        console.log('üîß Google Drive API ayarlarƒ± localStorage\'dan hazƒ±r');
      } else {
        console.log('‚ö†Ô∏è Google Drive API ayarlarƒ± eksik - konfig√ºrasyon gerekli');
      }
    }
    
    // Sayfa y√ºklendiƒüinde API ayarlarƒ±nƒ± y√ºkle
    loadGoogleApiSettings();
    
    // Google API y√ºklenme durumu
    window.googleApiLoaded = false;
    window.googleSignedIn = false;
    window.googleApiAvailable = false;
    
    // File protokol√º kontrol
    window.isFileProtocol = window.location.protocol === 'file:';
    if (window.isFileProtocol) {
      console.log('‚ö†Ô∏è File protokol√ºnde √ßalƒ±≈üƒ±yor - Google API sƒ±nƒ±rlƒ± olabilir');
    }
  </script>
  
  <style>
    body { 
      font-family: sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #f7f7f7; 
      overflow-x: hidden;
    }
    
    /* Main Layout */
    .main-container {
      display: grid;
      grid-template-columns: 320px 4px 1fr 4px 200px;
      grid-template-rows: 60px 1fr;
      height: 100vh;
      gap: 0;
    }
    
    /* Resizable handles */
    .resize-handle {
      background: #e9ecef;
      cursor: ew-resize;
      border-left: 1px solid #dee2e6;
      border-right: 1px solid #dee2e6;
      position: relative;
      transition: background-color 0.2s;
    }
    
    .resize-handle:hover {
      background: #6c757d;
    }
    
    .resize-handle:before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 20px;
      background: #6c757d;
      border-radius: 1px;
    }
    
    .resize-handle:hover:before {
      background: white;
    }
    
    /* Header */
    .header {
      grid-column: 1 / -1;
      background: #343a40;
      color: white;
      display: flex;
      align-items: center;
      padding: 0 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      margin: 0;
      font-size: 18px;
    }
    
    /* Sol Sidebar */
    .left-sidebar {
      background: white;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    
    .sidebar-section {
      border-bottom: 1px solid #eee;
      padding: 15px;
    }
    
    .sidebar-section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #495057;
      text-transform: uppercase;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }
    
    /* Hasta Listesi */
    #hastaListesi {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    #hastaListesi li {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-bottom: 2px;
      font-size: 13px;
      transition: background 0.2s;
    }
    
    #hastaListesi li:hover {
      background: #f8f9fa;
    }
    
    /* Se√ßili hasta stili */
    #hastaListesi li.secili-hasta {
      position: relative;
      border: 2px solid #dc3545 !important;
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.3) !important;
      transform: scale(1.02) !important;
    }
    
    #hastaListesi li.secili-hasta::after {
      content: 'üëà SE√áƒ∞Lƒ∞';
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      background: #dc3545;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: bold;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; transform: translateY(-50%) scale(1); }
      50% { opacity: 0.7; transform: translateY(-50%) scale(1.1); }
      100% { opacity: 1; transform: translateY(-50%) scale(1); }
    }
    
    /* Orta Panel */
    .center-panel {
      display: flex;
      flex-direction: column;
      background: white;
      overflow-y: auto;
    }
    
    /* Saƒü Sidebar */
    .right-sidebar {
      background: white;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    
    /* Sistem Durumu Kompakt */
    .sistem-durumu-kompakt {
      background: #e9ecef;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      line-height: 1.3;
    }
    
    .sistem-durumu-kompakt .durum-item {
      display: block;
      margin-bottom: 3px;
    }
    
    /* Kompakt Grid */
    .kompakt-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .kompakt-box {
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid;
    }
    
    .pdf-box {
      background: #f8f9fa;
      border-left-color: #28a745;
    }
    
    .aciklama-box {
      background: #d1ecf1;
      border-left-color: #17a2b8;
    }
    
    textarea, input[type="file"] { width: 100%; margin-bottom: 10px; }
    button { padding: 10px 20px; }
    .matched img { width: 150px; margin: 5px; border: 1px solid #ccc; }
    
    /* Tab Sistemi CSS */
    .hafta-tabs {
      display: flex !important;
      flex-wrap: wrap !important;
      border-bottom: 2px solid #ddd;
      margin-bottom: 20px;
      background: #f8f9fa;
      padding: 5px;
      border-radius: 8px 8px 0 0;
      gap: 5px;
    }
    
    .hafta-tab {
      background: #e9ecef;
      border: 1px solid #ddd;
      border-bottom: none;
      padding: 10px 15px;
      margin-right: 3px;
      margin-bottom: 3px;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
      min-width: 120px;
      max-width: 160px;
      text-align: center;
      position: relative;
      flex: 0 0 auto;
    }
    
    .hafta-tab:hover {
      background: #dee2e6;
      transform: translateY(-2px);
    }
    
    .hafta-tab.active {
      background: #fff;
      border-color: #007bff;
      border-width: 2px;
      font-weight: bold;
      color: #007bff;
      transform: translateY(-3px);
      box-shadow: 0 3px 10px rgba(0,123,255,0.2);
    }
    
    .hafta-tab-content {
      display: none;
      border: 2px solid #ddd;
      padding: 20px;
      border-radius: 0 8px 8px 8px;
      background: #fff;
      min-height: 400px;
    }
    
    .hafta-tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .hafta-tab-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .hafta-no-input {
      width: 50px;
      font-weight: bold;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
    }
    
    .tab-status-indicators {
      display: flex;
      gap: 5px;
      margin-top: 5px;
      justify-content: center;
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .status-pdf { background: #28a745; }
    .status-kartlar { background: #ffc107; }
    .status-eslesen { background: #17a2b8; }
    .status-empty { background: #dc3545; }
    .status-locked { background: #fd7e14; }
    
    /* Kilit ikonu stili */
    .tab-lock-icon {
      position: absolute;
      top: 2px;
      right: 2px;
      font-size: 10px;
      color: #fd7e14;
      text-shadow: 0 0 2px rgba(0,0,0,0.5);
    }
    
    /* Kilitli hafta stili */
    .hafta-tab.locked {
      background: linear-gradient(135deg, #fff 0%, #fff5e6 100%);
      border-color: #fd7e14;
      position: relative;
    }
    
    .hafta-tab.locked.active {
      background: linear-gradient(135deg, #fff 0%, #fff5e6 100%);
      border-color: #fd7e14;
      color: #fd7e14;
    }
    
    /* Kayƒ±t butonu stili */
    .kayit-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .kayit-btn:hover {
      background: #218838;
      transform: translateY(-1px);
    }
    
    .kayit-btn.saved {
      background: #6c757d;
      cursor: default;
    }
    
    .kayit-btn.saved:hover {
      transform: none;
    }
    
    /* Kilit a√ßma butonu */
    .kilit-ac-btn {
      background: #fd7e14;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      margin-left: 8px;
    }
    
    .kilit-ac-btn:hover {
      background: #e8630a;
    }
    
    /* Kilitli alan stili */
    .locked-area {
      position: relative;
      opacity: 0.6;
    }
    
    /* Kilitli alandaki input ve textarea'larƒ± devre dƒ±≈üƒ± bƒ±rak */
    .locked-area input,
    .locked-area textarea {
      pointer-events: none;
    }
    
    /* ZIP butonlarƒ± her zaman aktif kalacak */
    .locked-area button[onclick*="zipEslesenGorseller"],
    .locked-area button[onclick*="haftaZipIndir"],
    .locked-area button[onclick*="kopyalaGptMesaj"] {
      pointer-events: auto !important;
      opacity: 1 !important;
    }
    
    .locked-area::before {
      content: 'üîí Bu alan kilitli - Kilidi a√ßmak i√ßin kilit a√ßma butonunu kullanƒ±n';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(253, 126, 20, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 11px;
      z-index: 10;
      white-space: nowrap;
      pointer-events: none;
    }
    
    .yeni-hafta-tab {
      background: #28a745;
      color: white;
      border-color: #28a745;
      font-weight: bold;
    }
    
    .yeni-hafta-tab:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    
    /* Hafta numarasƒ± d√ºzenleme */
    .hafta-no-display {
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .hafta-no-display:hover {
      background: #e3f2fd;
      border-color: #90caf9;
      transform: scale(1.05);
    }
    
    /* Grid responsive */
    @media (max-width: 768px) {
      .hafta-tab-content > div:first-of-type {
        grid-template-columns: 1fr !important;
      }
      
      /* Hasta bilgi paneli responsive */
      #hastaBilgiPanel {
        padding: 8px 10px !important;
      }
      
      #hastaBilgiPanel h3 {
        font-size: 14px !important;
      }
      
      #hastaBilgiPanel p {
        font-size: 11px !important;
      }
      
      #hastaBilgiButonlar button {
        padding: 5px 8px !important;
        font-size: 10px !important;
      }
      
      #hastaBilgiPanel > div {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 8px !important;
      }
      
      #hastaBilgiButonlar {
        margin-left: 0 !important;
        width: 100%;
      }
      
      #hastaBilgiButonlar > div {
        flex-wrap: wrap !important;
        gap: 4px !important;
      }
    }

    /* Manuel Kart Stilleri */
    .manuel-kart {
      display: inline-block;
      margin: 10px;
      position: relative;
      vertical-align: top;
    }
    
    .manuel-kart-ekleme-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin: 10px 0;
    }
    
    .manuel-kart-ekleme-btn:hover {
      background: #218838;
    }
  </style>
</head>
<body>

  <div class="main-container">
    <!-- Header -->
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Lipedem Hasta Takip Sistemi</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
          <div id="googleDriveStatus" style="font-size: 12px; color: #666;">Drive: Baƒülantƒ± Yok</div>
          <button onclick="showGptPanel()" style="
            padding: 6px 10px; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 11px;
          ">ü§ñ GPT Y√∂netimi</button>
          <button onclick="showGoogleApiConfig()" style="
            padding: 6px 10px; 
            background: #6c757d; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 11px;
          ">‚öôÔ∏è API Ayarlarƒ±</button>
          <button id="googleDriveBtn" onclick="signInToGoogle()" style="
            padding: 8px 15px; 
            background: #4285f4; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
          ">
            <span style="font-size: 14px;">üíæ</span>
            Google Drive'a Baƒülan
          </button>
        </div>
      </div>
    </div>

    <!-- Sol Sidebar -->
    <div class="left-sidebar">
      <!-- Hasta Listesi -->
      <div class="sidebar-section">
        <h3>üë• Hastalar</h3>
        <input type="text" id="hastaAra" placeholder="Hasta ara..." style="width:100%; padding:6px; margin-bottom:8px; border:1px solid #ddd; border-radius:4px; font-size:12px;" oninput="filtreleHastalar()">
        <select id="arsivFiltre" style="width:100%; padding:6px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px; font-size:12px;" onchange="filtreleHastalar()">
          <option value="aktif">Aktif Hastalar (0)</option>
          <option value="arsiv">Ar≈üiv (0)</option>
          <option value="tum">T√ºm√º (0)</option>
        </select>
        <ul id="hastaListesi"></ul>
        <button onclick="yeniHastaFormu()" style="width:100%; padding:8px; margin-top:10px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">+ Yeni Hasta</button>
      </div>
    </div>

    <!-- Sol Ayƒ±rƒ±cƒ± -->
    <div class="resize-handle" id="leftHandle"></div>

    <!-- Orta Panel -->
    <div class="center-panel">
      <!-- Hasta Bilgi Paneli (Sabit) -->
      <div id="hastaBilgiPanel" style="background: #fff; border-bottom: 2px solid #007bff; padding: 10px 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; min-height: 40px;">
          <div style="flex: 1; min-width: 0;">
            <h3 id="secilenHastaIsim" style="margin: 0; color: #007bff; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Hasta Se√ßilmedi</h3>
            <p id="secilenHastaNot" style="margin: 2px 0 0 0; color: #666; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">L√ºtfen sol men√ºden bir hasta se√ßin</p>
          </div>
          <div id="hastaBilgiButonlar" style="display: none; flex-shrink: 0; margin-left: 15px;">
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <button onclick="duzenleHasta()" style="padding: 6px 10px; background: #ffc107; color: #000; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">‚úèÔ∏è D√ºzenle</button>
              <button onclick="arsivleHasta()" style="padding: 6px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">üì¶ Ar≈üivle</button>
              <button onclick="silHasta()" style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" title="Dosyayƒ± ar≈üivle ve listeden kaldƒ±r">üóëÔ∏è Sil</button>
              <button onclick="sadeceLisedenKaldir()" style="padding: 6px 10px; background: #fd7e14; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" title="Sadece listeden kaldƒ±r, dosyayƒ± koru">üìã Listeden Kaldƒ±r</button>
              <button onclick="kapatDetay()" style="padding: 6px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">‚úñÔ∏è Kapat</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Hafta Tab'larƒ± -->
      <div id="haftaTabs" class="hafta-tabs"></div>
      
      <!-- Hafta ƒ∞√ßeriƒüi -->
      <div id="haftaTabContent"></div>
      
      <!-- E≈üle≈üen Kartlar (Alt Panel) -->
      <div style="border-top: 1px solid #ddd; background: #f8f9fa; padding: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h4 style="margin: 0; color: #6f42c1;">üîó E≈üle≈üen Kartlar</h4>
          <button id="manuelKartEkleBtn" onclick="manuelKartEklemeModalAc()" class="manuel-kart-ekleme-btn" style="font-size: 11px; padding: 5px 10px;">
            ‚ûï Manuel Kart Ekle
          </button>
        </div>
        <!-- üìÅ ACCORDION PANEL Sƒ∞STEMƒ∞ -->
        <div id="accordionContainer" style="margin-top: 10px;">
          
          <!-- 1Ô∏è‚É£ E≈ûLE≈ûEN KARTLAR ACCORDION -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('eslesen')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="eslesenBaslik">üìã E≈üle≈üen Kartlar</span>
              <span id="eslesenIcon">‚ñ∂</span>
            </button>
            <div id="eslesenContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
              min-height: 200px;
              max-height: 400px;
              overflow-y: auto;
            ">
              <div style="text-align: center; color: #666; padding: 40px;">
                √ñnce bir hasta se√ßin...
              </div>
            </div>
          </div>

          <!-- 3Ô∏è‚É£ YEMEK KULLANIM ANALƒ∞Zƒ∞ ACCORDION -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('analiz')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="analizBaslik">  Yemek Kullanƒ±m Analizi (0/239)</span>
              <span id="analizIcon">‚ñ∂</span>
            </button>
            <div id="analizContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
            ">
              <div style="margin-bottom: 10px; text-align: center;">
                <button onclick="siralaYemekAnalizi('cok')" id="btnCok" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #28a745; color: white; cursor: pointer; font-size: 11px;">üî∫ En √áok Kullanƒ±lan</button>
                <button onclick="siralaYemekAnalizi('az')" id="btnAz" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #dc3545; color: white; cursor: pointer; font-size: 11px;">üîª En Az Kullanƒ±lan</button>
                <button onclick="siralaYemekAnalizi('hic')" id="btnHic" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #6c757d; color: white; cursor: pointer; font-size: 11px;">‚ùå Hi√ß Kullanƒ±lmayan</button>
                <button onclick="siralaYemekAnalizi('alfabetik')" id="btnAlfabetik" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #17a2b8; color: white; cursor: pointer; font-size: 11px;">üìù Alfabetik</button>
              </div>
              
              <div id="yemekAnaliziListe" style="max-height: 400px; overflow-y: auto; font-size: 13px; line-height: 1.4; border: 1px solid #eee; border-radius: 4px; background: #fafafa;">
                <div style="text-align: center; color: #666; padding: 20px;">Hasta ve hafta se√ßin...</div>
              </div>
            </div>
          </div>

          <!-- 2Ô∏è‚É£ E≈ûLE≈ûMEYEN TARƒ∞FLER ACCORDION (EN ALTTA) -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('eslesmeyenler')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="eslesmeyenlerBaslik">  E≈üle≈ümeyen Tarifler</span>
              <span id="eslesmeyenlerIcon">‚ñ∂</span>
            </button>
            <div id="eslesmeyenlerContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
              min-height: 100px;
              max-height: 300px;
              overflow-y: auto;
            ">
              <div style="text-align: center; color: #666; padding: 20px;">
                E≈üle≈ümeyen tarif bulunamadƒ±
              </div>
            </div>
          </div>
          
          <!-- BUTONLAR ƒ∞√áƒ∞N SABƒ∞T ALAN (ƒ∞ndirme butonlarƒ± vs) -->
          <div id="sidebarButtons" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: white; min-height: 60px;">
          </div>
        </div>
      </div>
    </div>

    <!-- Saƒü Ayƒ±rƒ±cƒ± -->
    <div class="resize-handle" id="rightHandle"></div>

    <!-- Saƒü Sidebar -->
    <div class="right-sidebar">
      <!-- Sistem Durumu -->
      <div class="sidebar-section">
        <h3>üìä Sistem</h3>
        <div class="sistem-durumu-kompakt">
          <span class="durum-item" id="tariflerKlasoruDurumu">üîÑ Tarifler kontrol ediliyor...</span>
          <span class="durum-item" id="dataKlasoruDurumu">üîÑ Data kontrol ediliyor...</span>
          <span class="durum-item" id="githubDurumu">‚è≥ GitHub kontrol ediliyor...</span>
        </div>
      </div>

      <!-- Hƒ±zlƒ± ƒ∞≈ülemler -->
      <div class="sidebar-section">
        <h3>‚ö° ƒ∞≈ülemler</h3>
        <input type="password" id="githubToken" placeholder="GitHub Token" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; border:1px solid #ddd; border-radius:3px;" oninput="saveTokenToStorage()">
        <input type="text" id="githubRepo" placeholder="GitHub Repo (owner/repo)" value="mustafasacar35/nutrition-planner" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; border:1px solid #ddd; border-radius:3px;">
        <button onclick="testGitHubToken()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#17a2b8; color:white; border:none; border-radius:3px; cursor:pointer;">üîç Token Test Et</button>
      </div>

      <!-- Ara√ßlar -->
      <div class="sidebar-section">
        <h3>üõ†Ô∏è Ara√ßlar</h3>
        <input type="file" id="cokluPdfInput" multiple accept=".pdf" style="display:none" onchange="processCokluPdf(this.files)">
        <button onclick="document.getElementById('cokluPdfInput').click()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#6f42c1; color:white; border:none; border-radius:3px; cursor:pointer; font-weight:bold;">üìÅ √áoklu PDF Y√ºkle</button>
        <button onclick="yeniKartFormGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#17a2b8; color:white; border:none; border-radius:3px; cursor:pointer;">+ Yeni Kart</button>
        <button onclick="kartDuzenleFormGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#ffc107; color:black; border:none; border-radius:3px; cursor:pointer;">‚úèÔ∏è Kart D√ºzenle</button>
        <button onclick="kartSilFormGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer;">üóëÔ∏è Kart Sil</button>
        <button onclick="manuelEslestirmePaneliGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#6f42c1; color:white; border:none; border-radius:3px; cursor:pointer;">üîó Manuel E≈üle≈ütirme</button>
        <button onclick="eslesmemeRegeleriPaneliGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer;">üö´ E≈üle≈üme Yasaklarƒ±</button>
        <button onclick="generateCustomLenfMasajTakvimi()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#28a745; color:white; border:none; border-radius:3px; cursor:pointer;">üíÜ Lenf Masaj Takvimi</button>
        <button onclick="generateCustomEgzersizTakvimi()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#007bff; color:white; border:none; border-radius:3px; cursor:pointer;">üèÉ Egzersiz Takvimi</button>
      </div>
    </div>
  </div>

  <!-- E≈üle≈üme Yasaklarƒ± Paneli -->
  <div id="eslesmemePanel" style="display:none; background:#fff; border:2px solid #dc3545; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="eslesmemeRegeleriPaneliGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#dc3545; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">√ó</button>
    <h3>E≈üle≈üme Yasaklarƒ± Paneli</h3>
    <div style="display:flex; gap:20px; margin-bottom:20px;">
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">PDF'deki Yemek Adƒ±:</label>
        <textarea id="yasakTarifAdi" placeholder="√ñrn: tavuklu h√ºnkar beƒüendi" style="width:100%; height:80px; padding:8px; resize:vertical;"></textarea>
        <small style="display:block; color:#666; margin-top:5px;">
          PDF'de g√∂r√ºnen yemek adƒ±nƒ± yazƒ±n (bu hi√ß e≈üle≈ümesin)
        </small>
      </div>
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Yasaklƒ± Kartlar:</label>
        <input type="text" id="yasakKartArama" placeholder="Kart adƒ±nda ara..." style="width:100%; padding:8px; margin-bottom:8px;" />
        <div id="yasakKartListesi" style="height:120px; overflow-y:auto; border:1px solid #ddd; padding:8px; background:#f8f9fa;">
          <!-- Dinamik kartlar buraya gelecek -->
        </div>
        <small style="display:block; color:#666; margin-top:5px;">
          Bu kartlarla e≈üle≈ümesin diye i≈üaretleyin
        </small>
      </div>
    </div>
    <div style="margin-bottom:15px;">
      <button onclick="eslesmemeKuraliEkle()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        Yasak Ekle
      </button>
      <button onclick="eslesmemeKurallariniTemizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        T√ºm Yasaklarƒ± Temizle
      </button>
      <button onclick="eslesmemeKurallariniGitHubKaydet()" style="background:#007bff; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'a Kaydet
      </button>
      <button onclick="eslesmemeKurallariniGitHubYukle()" style="background:#6f42c1; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'dan Y√ºkle
      </button>
    </div>
    <div id="eslesmemeStatus" style="margin-bottom:15px; padding:10px; border-radius:5px; display:none;"></div>
    <div>
      <h4>Kayƒ±tlƒ± E≈üle≈üme Yasaklarƒ±:</h4>
      <div id="eslesmemeListesi" style="max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#f8f9fa;">
        <em>Hen√ºz yasak yok</em>
      </div>
    </div>
  </div>

  <!-- Manuel E≈üle≈ütirme Paneli -->
  <div id="manuelEslestirmePanel" style="display:none; background:#fff; border:2px solid #28a745; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="manuelEslestirmePaneliGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#28a745; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">√ó</button>
    <h3>Manuel E≈üle≈ütirme Paneli</h3>
    <div style="display:flex; gap:20px; margin-bottom:20px;">
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">PDF'deki Yemek Adƒ±:</label>
        <textarea id="manuelTarifAdi" placeholder="√ñrn: *Kƒ±ymalƒ± karnabahar /bamya yemeƒüi" style="width:100%; height:80px; padding:8px; resize:vertical;"></textarea>
        <small style="display:block; color:#666; margin-top:5px;">
          PDF'de g√∂r√ºnen tam metni yazƒ±n (*, / i≈üaretleri dahil)
        </small>
      </div>
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">E≈üle≈üecek Kartlar:</label>
        <input type="text" id="eskiKartArama" placeholder="Kart adƒ±nda ara..." style="width:100%; padding:8px; margin-bottom:8px;" oninput="manuelEslestirmeKartAra(this.value)" />
        <div id="manuelKartListesi" style="height:120px; overflow-y:auto; border:1px solid #ddd; padding:8px; background:#f8f9fa;">
          <!-- Dinamik kartlar buraya gelecek -->
        </div>
        <small style="display:block; color:#666; margin-top:5px;">
          E≈üle≈ümesini istediƒüiniz kartlarƒ± i≈üaretleyin
        </small>
      </div>
    </div>
    <div style="margin-bottom:15px;">
      <button onclick="manuelEslestirmeEkle()" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        E≈üle≈ütirme Ekle
      </button>
      <button onclick="manuelEslestirmeleriTemizle()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        T√ºm E≈üle≈ütirmeleri Temizle
      </button>
      <button onclick="manuelEslestirmeleriGitHubKaydet()" style="background:#007bff; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'a Kaydet
      </button>
      <button onclick="manuelEslestirmeleriGitHubYukle()" style="background:#6f42c1; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'dan Y√ºkle
      </button>
    </div>
    <div id="manuelEslestirmeStatus" style="margin-bottom:15px; padding:10px; border-radius:5px; display:none;"></div>
    <div>
      <h4>Kayƒ±tlƒ± Manuel E≈üle≈ütirmeler:</h4>
      <div id="manuelEslestirmeListesi" style="max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#f8f9fa;">
        <em>Hen√ºz manuel e≈üle≈ütirme yok</em>
      </div>
    </div>
  </div>

  <!-- Kart Silme Formu -->
  <div id="kartSilFormu" style="display:none; background:#fff; border:2px solid #dc3545; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="kartSilFormGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#dc3545; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">√ó</button>
    <h3>Tarif Kartƒ± Sil</h3>
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">Silinecek Kartƒ± Se√ßin:</label>
      <input type="text" id="kartAramaInput" placeholder="Kart adƒ±nda ara... (√∂rn: avok salat)" style="width:300px; padding:8px; margin-bottom:8px;" />
      <select id="silinecekKart" style="width:300px; padding:8px;">
        <option value="">Kart se√ßin...</option>
      </select>
      <small style="display:block; color:#666; margin-top:5px;">
        Yukarƒ±daki arama kutusuna yazarak filtreleyin veya listeden se√ßin
      </small>
      <small style="display:block; color:#666; margin-top:2px;">
        Bu i≈ülem hem dosyayƒ± hem de list.json'dan kaydƒ± siler
      </small>
    </div>
    <div id="onizlemeAlani" style="margin-bottom:15px; text-align:center;"></div>
    <div style="margin-bottom:15px;">
      <button onclick="kartSil()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        Kartƒ± Sil
      </button>
      <button onclick="kartSilFormGizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        ƒ∞ptal
      </button>
    </div>
    <div id="silmeStatus" style="margin-top:15px; padding:10px; border-radius:5px; display:none;"></div>
  </div>

  <!-- Yeni Kart Ekleme Formu -->
  <div id="yeniKartFormu" style="display:none; background:#fff; border:2px solid #007bff; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="yeniKartFormGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#007bff; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">√ó</button>
    <h3>Yeni Tarif Kartƒ± Ekle</h3>
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">Kart Adƒ±:</label>
      <input id="yeniKartAdi" placeholder="√ñrn: mantarli_tavuk_sote" style="width:300px; padding:8px;" />
      <small style="display:block; color:#666; margin-top:5px;">
        Not: T√ºrk√ße karakterler kullanmayƒ±n, bo≈üluk yerine _ kullanƒ±n, .jpg eklemeyin
      </small>
    </div>
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">G√∂rsel Dosyasƒ±:</label>
      <input type="file" id="yeniKartDosya" accept="image/jpeg,image/jpg,image/png" style="padding:8px;" />
      <small style="display:block; color:#666; margin-top:5px;">
        Sadece JPG/PNG dosyalarƒ± kabul edilir
      </small>
    </div>
    <div style="margin-bottom:15px;">
      <button onclick="yeniKartKaydet()" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        Kartƒ± Kaydet ve GitHub'a Y√ºkle
      </button>
      <button onclick="yeniKartFormGizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        ƒ∞ptal
      </button>
    </div>
    <div id="yuklemeStatus" style="margin-top:15px; padding:10px; border-radius:5px; display:none;"></div>
  </div>

  <!-- Kart D√ºzenleme Formu -->
  <div id="kartDuzenleFormu" style="display:none; background:#fff; border:2px solid #ffc107; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="kartDuzenleFormGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#ffc107; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">√ó</button>
    <h3>Tarif Kartƒ± D√ºzenle</h3>
    
    <!-- Kart Se√ßimi -->
    <div style="margin-bottom:20px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">D√ºzenlenecek Kartƒ± Se√ßin:</label>
      <div style="display:flex; gap:8px; margin-bottom:10px;">
        <input type="text" id="duzenleKartArama" placeholder="Kart adƒ±nda ara..." style="flex:1; padding:8px;" oninput="kartListesiniFiltreleForDuzenleme(this.value)" />
        <button onclick="listjsonTemizle()" style="padding:8px 12px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;"
                title="Mevcut olmayan dosyalarƒ± list.json'dan temizle">
          üßπ Temizle
        </button>
      </div>
      <div id="duzenleKartListesi" style="height:150px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#f8f9fa;">
        <!-- Dinamik kartlar buraya gelecek -->
      </div>
    </div>
    
    <!-- Se√ßili Kart Bilgileri -->
    <div id="seciliKartBilgileri" style="display:none;">
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Mevcut Kart:</label>
        <div id="mevcutKartOnizleme" style="border:1px solid #ddd; padding:10px; background:#f8f9fa; border-radius:5px;">
          <!-- Mevcut kart √∂nizlemesi -->
        </div>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Yeni Kart Adƒ±:</label>
        <input id="duzenleKartYeniAdi" placeholder="Yeni kart adƒ±" style="width:300px; padding:8px;" />
        <small style="display:block; color:#666; margin-top:5px;">
          Not: T√ºrk√ße karakterler kullanmayƒ±n, bo≈üluk yerine _ kullanƒ±n, .jpg eklemeyin
        </small>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Yeni G√∂rsel Dosyasƒ± (isteƒüe baƒülƒ±):</label>
        <input type="file" id="duzenleKartYeniDosya" accept="image/jpeg,image/jpg,image/png" style="padding:8px;" />
        <small style="display:block; color:#666; margin-top:5px;">
          Bo≈ü bƒ±rakƒ±rsanƒ±z sadece isim deƒüi≈üir. Dosya se√ßerseniz hem isim hem g√∂rsel deƒüi≈üir.
        </small>
      </div>
      
      <div style="margin-bottom:15px;">
        <button onclick="kartDuzenlemeKaydet()" style="background:#ffc107; color:#212529; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">
          Deƒüi≈üiklikleri Kaydet
        </button>
        <button onclick="kartDuzenleFormGizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
          ƒ∞ptal
        </button>
      </div>
    </div>
    
    <div id="duzenlemeStatus" style="margin-top:15px; padding:10px; border-radius:5px; display:none;"></div>
  </div>

  <!-- Manuel Kart Ekleme Modal -->
  <div id="manuelKartModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;" onclick="manuelKartModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80%; overflow: hidden;" onclick="event.stopPropagation()">
      <div style="padding: 20px; border-bottom: 1px solid #ddd;">
        <h3 style="margin: 0; color: #333;">Manuel Kart Ekleme</h3>
        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Se√ßili haftaya eklemek istediƒüiniz tarif kartlarƒ±nƒ± se√ßin</p>
      </div>
      
      <div style="padding: 20px;">
        <input type="text" id="manuelKartArama" placeholder="Tarif ara (bo≈ü bƒ±rakƒ±n t√ºm√ºn√º g√∂rmek i√ßin)..." style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;" oninput="manuelKartAramaYap(this.value)">
        
        <div id="manuelKartListe" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
          <div style="text-align: center; color: #666; padding: 20px;">Y√ºkleniyor...</div>
        </div>
      </div>
      
      <div style="padding: 20px; border-top: 1px solid #ddd; text-align: right;">
        <button onclick="manuelKartModalKapat()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">ƒ∞ptal</button>
        <button onclick="secilenManuelKartlariEkle()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Se√ßilen Kartlarƒ± Ekle</button>
      </div>
    </div>
  </div>

  <!-- GPT Y√∂netim Paneli -->
  <div id="gptPanel" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10001;" onclick="hideGptPanel(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 0; width: 90%; max-width: 1200px; max-height: 90%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
      
      <!-- Header -->
      <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
        <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 24px;">ü§ñ</span>
          GPT Prompt Y√∂netimi
        </h2>
        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">Beslenme listesi yorumlama i√ßin prompt ≈üablonlarƒ±nƒ± y√∂netin</p>
      </div>

      <!-- ƒ∞√ßerik -->
      <div style="overflow-y: auto; max-height: calc(90vh - 140px); padding: 20px;">
        
        <!-- GPT API Ayarlarƒ± -->
        <div style="margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
          <h3 style="margin: 0 0 15px 0; color: #007bff; display: flex; align-items: center; gap: 8px;">
            <span>üîë</span> GPT API Ayarlarƒ±
          </h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">API Key:</label>
              <input type="password" id="gptApiKey" placeholder="sk-..." style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">Model:</label>
              <select id="gptModel" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px;">
                <option value="gpt-4">GPT-4</option>
                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Genel Prompt ≈ûablonlarƒ± -->
        <div style="margin-bottom: 25px;">
          <h3 style="margin: 0 0 15px 0; color: #28a745; display: flex; align-items: center; gap: 8px;">
            <span>üé®</span> Genel Prompt ≈ûablonlarƒ±
          </h3>
          <div id="genelPromptlar"></div>
          <button onclick="yeniGenelPrompt()" style="margin-top: 10px; padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">+ Yeni ≈ûablon Ekle</button>
        </div>

        <!-- Haftalƒ±k Promptlar -->
        <div style="margin-bottom: 25px;">
          <h3 style="margin: 0 0 15px 0; color: #ffc107; display: flex; align-items: center; gap: 8px;">
            <span>üìÖ</span> Haftalƒ±k Prompt Temalarƒ±
          </h3>
          <div style="margin-bottom: 10px;">
            <input type="number" id="yeniHaftaNo" placeholder="Hafta No" min="1" max="52" style="width: 100px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; margin-right: 10px;">
            <input type="text" id="yeniHaftaBaslik" placeholder="Tema Ba≈ülƒ±ƒüƒ± (√∂rn: Antiinflamatuar Beslenme)" style="width: 300px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; margin-right: 10px;">
            <button onclick="yeniHaftalikPrompt()" style="padding: 8px 15px; background: #ffc107; color: #212529; border: none; border-radius: 4px; cursor: pointer;">+ Haftalƒ±k Tema Ekle</button>
          </div>
          <div id="haftalikPromptlar" style="max-height: 300px; overflow-y: auto;"></div>
        </div>

      </div>

      <!-- Footer -->
      <div style="background: #f8f9fa; padding: 15px 20px; border-radius: 0 0 12px 12px; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
        <div style="color: #6c757d; font-size: 12px;">Prompt ≈üablonlarƒ± otomatik kaydedilir</div>
        <div>
          <button onclick="hideGptPanel()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Kapat</button>
          <button onclick="saveGptSettings()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">üíæ Kaydet</button>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    // ‚ö° √áOKLU PDF ƒ∞≈ûLEME FONKSƒ∞YONU (Global)
    
    // Profesyonel PDF adƒ±nƒ± parse etme
    function parseProfessionalPdfName(fileName) {
      console.log('üîç PDF dosya adƒ± parse ediliyor:', fileName);
      
      // .pdf uzantƒ±sƒ±nƒ± kaldƒ±r
      const cleanName = fileName.replace(/\.pdf$/i, '');
      
      // Regex pattern'ler (esnek format desteƒüi)
      const patterns = [
        // "ESƒ∞N KARAKU≈û 28 TEMMUZ -3 AƒûUSTOS 17. HAFTA"
        /^(.+?)\s+(\d{1,2})\s+([A-Za-z√ß√áƒüƒûƒ±ƒ∞√∂√ñ≈ü≈û√º√ú]+)\s*-\s*(\d{1,2})\s+([A-Za-z√ß√áƒüƒûƒ±ƒ∞√∂√ñ≈ü≈û√º√ú]+)\s+(\d+)\.\s*HAFTA/i,
        
        // "Fƒ∞GEN TEZMAN 4-10 AƒûUSTOS 1.HAFTA"
        /^(.+?)\s+(\d{1,2})-(\d{1,2})\s+([A-Za-z√ß√áƒüƒûƒ±ƒ∞√∂√ñ≈ü≈û√º√ú]+)\s+(\d+)\.?\s*HAFTA/i,
        
        // "HASTA ADI TARIH ARALIGI X. HAFTA" (genel format)
        /^(.+?)\s+(.+?)\s+(\d+)\.?\s*HAFTA/i
      ];
      
      for (const pattern of patterns) {
        const match = cleanName.match(pattern);
        if (match) {
          console.log('‚úÖ Pattern match bulundu:', match);
          
          let sonuc = {};
          
          if (pattern === patterns[0]) {
            // "ESƒ∞N KARAKU≈û 28 TEMMUZ -3 AƒûUSTOS 17. HAFTA"
            sonuc = {
              hastaAdi: match[1].trim().toUpperCase(),
              haftaNo: parseInt(match[6]),
              tarihAraligi: `${match[2]} ${match[3]} - ${match[4]} ${match[5]}`.toUpperCase(),
              baslangicGun: parseInt(match[2]),
              baslangicAy: match[3].toUpperCase(),
              bitisGun: parseInt(match[4]),
              bitisAy: match[5].toUpperCase()
            };
          } else if (pattern === patterns[1]) {
            // "Fƒ∞GEN TEZMAN 4-10 AƒûUSTOS 1.HAFTA"
            sonuc = {
              hastaAdi: match[1].trim().toUpperCase(),
              haftaNo: parseInt(match[5]),
              tarihAraligi: `${match[2]}-${match[3]} ${match[4]}`.toUpperCase(),
              baslangicGun: parseInt(match[2]),
              bitisGun: parseInt(match[3]),
              baslangicAy: match[4].toUpperCase(),
              bitisAy: match[4].toUpperCase() // Aynƒ± ay
            };
          } else {
            // Genel format
            sonuc = {
              hastaAdi: match[1].trim().toUpperCase(),
              haftaNo: parseInt(match[3]),
              tarihAraligi: match[2].trim().toUpperCase()
            };
          }
          
          console.log('üìã Parse sonucu:', sonuc);
          return sonuc;
        }
      }
      
      console.warn('‚ö†Ô∏è Hi√ßbir pattern uyu≈ümadƒ±:', cleanName);
      return null;
    }

    // T√ºrk√ße ay adƒ±nƒ± sayƒ±ya √ßevir
    function turkceAyToNumber(ayAdi) {
      const aylar = {
        'OCAK': 1, '≈ûUBAT': 2, 'MART': 3, 'Nƒ∞SAN': 4, 'MAYIS': 5, 'HAZƒ∞RAN': 6,
        'TEMMUZ': 7, 'AƒûUSTOS': 8, 'EYL√úL': 9, 'EKƒ∞M': 10, 'KASIM': 11, 'ARALIK': 12
      };
      return aylar[ayAdi.toUpperCase()] || null;
    }

    // Parse edilen tarih bilgisini Date formatƒ±na √ßevir
    function parseEdilmistarihleriDateOlarak(parsedData) {
      if (!parsedData || !parsedData.baslangicGun || !parsedData.baslangicAy) {
        return null;
      }
      
      const currentYear = new Date().getFullYear();
      const baslangicAyNo = turkceAyToNumber(parsedData.baslangicAy);
      const bitisAyNo = parsedData.bitisAy ? turkceAyToNumber(parsedData.bitisAy) : baslangicAyNo;
      
      if (!baslangicAyNo || !bitisAyNo) {
        console.warn('‚ö†Ô∏è Ay adƒ± √ßevrilemedi:', parsedData.baslangicAy, parsedData.bitisAy);
        return null;
      }
      
      // Ba≈ülangƒ±√ß ve biti≈ü tarihlerini olu≈ütur
      const baslangicTarih = new Date(currentYear, baslangicAyNo - 1, parsedData.baslangicGun);
      const bitisTarih = new Date(currentYear, bitisAyNo - 1, parsedData.bitisGun || parsedData.baslangicGun);
      
      // Biti≈ü tarihi ba≈ülangƒ±√ßtan k√º√ß√ºkse, sonraki yƒ±la ge√ß
      if (bitisTarih < baslangicTarih) {
        bitisTarih.setFullYear(currentYear + 1);
      }
      
      return {
        baslangic: baslangicTarih.toISOString().slice(0, 10),
        bitis: bitisTarih.toISOString().slice(0, 10)
      };
    }

    // Dosyayƒ± Base64'e √ßevirme
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1]; // Data URL prefix'ini kaldƒ±r
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Tarih aralƒ±ƒüƒ±nƒ± parse etme
    function parseTarihAraligi(tarihAraligi) {
      console.log('üìÖ Tarih aralƒ±ƒüƒ± parse ediliyor:', tarihAraligi);
      
      const bugun = new Date();
      const yil = bugun.getFullYear();
      
      // "28 TEMMUZ - 3 AƒûUSTOS" formatƒ±nƒ± parse et
      const aylar = {
        'OCAK': '01', '≈ûUBAT': '02', 'MART': '03', 'Nƒ∞SAN': '04',
        'MAYIS': '05', 'HAZƒ∞RAN': '06', 'TEMMUZ': '07', 'AƒûUSTOS': '08',
        'EYL√úL': '09', 'EKƒ∞M': '10', 'KASIM': '11', 'ARALIK': '12'
      };
      
      try {
        // Format 1: "28 TEMMUZ - 3 AƒûUSTOS"
        if (tarihAraligi.includes(' - ')) {
          const parts = tarihAraligi.split(' - ');
          if (parts.length >= 2) {
            const baslangicParts = parts[0].trim().split(' ');
            const bitisParts = parts[1].trim().split(' ');
            
            const baslangicGun = baslangicParts[0].padStart(2, '0');
            const baslangicAy = aylar[baslangicParts[1]] || '01';
            
            const bitisGun = bitisParts[0].padStart(2, '0');
            const bitisAy = aylar[bitisParts[1]] || '01';
            
            const sonuc = {
              baslangic: `${yil}-${baslangicAy}-${baslangicGun}`,
              bitis: `${yil}-${bitisAy}-${bitisGun}`
            };
            
            console.log('‚úÖ Tarih parse ba≈üarƒ±lƒ± (Format 1):', sonuc);
            return sonuc;
          }
        }
        
        // Format 2: "4-10 AƒûUSTOS" (aynƒ± ay i√ßinde)
        const ayiciMatch = tarihAraligi.match(/^(\d{1,2})-(\d{1,2})\s+([A-Za-z√áƒûIƒ∞√ñ≈û√ú√ßƒüƒ±√∂≈ü√º]+)$/i);
        if (ayiciMatch) {
          const baslangicGun = ayiciMatch[1].padStart(2, '0');
          const bitisGun = ayiciMatch[2].padStart(2, '0');
          const ayAdi = ayiciMatch[3].toUpperCase();
          const ay = aylar[ayAdi] || '01';
          
          const sonuc = {
            baslangic: `${yil}-${ay}-${baslangicGun}`,
            bitis: `${yil}-${ay}-${bitisGun}`
          };
          
          console.log('‚úÖ Tarih parse ba≈üarƒ±lƒ± (Format 2):', sonuc);
          return sonuc;
        }
        
        console.log('‚ö†Ô∏è Tarih formatƒ± tanƒ±nmadƒ±, pattern denemesi yapƒ±lƒ±yor...');
        
      } catch (error) {
        console.warn('‚ùå Tarih parse hatasƒ±:', error);
      }
      
      // Fallback
      const fallback = {
        baslangic: bugun.toISOString().split('T')[0],
        bitis: bugun.toISOString().split('T')[0]
      };
      
      console.log('‚ö†Ô∏è Fallback tarih kullanƒ±lƒ±yor:', fallback);
      return fallback;
    }

    // Hasta bulma/olu≈üturma (GitHub entegrasyonlu)
    // √áoklu PDF i≈ülemi i√ßin hasta cache'i
    const cokluPdfHastaCache = new Map();

    async function findOrCreateHastaWithGitHub(hastaAdi) {
      console.log('üë§ Hasta aranƒ±yor/olu≈üturuluyor:', hastaAdi);
      
      // Cache'de var mƒ± kontrol et (√ßoklu PDF i≈ülemi i√ßin)
      const cacheKey = hastaAdi.toUpperCase();
      if (cokluPdfHastaCache.has(cacheKey)) {
        const cachedHasta = cokluPdfHastaCache.get(cacheKey);
        console.log('üö® CACHE\'DEN HASTA ALINDI:', hastaAdi);
        console.log('üîç Cache hafta sayƒ±sƒ±:', cachedHasta.haftalar ? cachedHasta.haftalar.length : 0);
        console.log('üîç Cache hafta detaylarƒ±:', cachedHasta.haftalar ? cachedHasta.haftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis })) : []);
        return cachedHasta;
      }
      
      // D√úZELTME: Global hastalar dizisini kullan (localStorage'dan her defasƒ±nda y√ºkleme!)
      // let hastalar = JSON.parse(localStorage.getItem('lipedem_hasta_kayitlari') || '[]');
      
      // Mevcut hastayƒ± ara (global hastalar dizisinde)
      let hasta = hastalar.find(h => 
        (h.ad && h.ad.toUpperCase() === hastaAdi.toUpperCase()) || 
        (h.isim && h.isim.toUpperCase() === hastaAdi.toUpperCase())
      );
      
      if (!hasta) {
        // Yeni hasta olu≈ütur (manuel kayƒ±t formatƒ±na uygun)
        const hastaId = generatePatientId(hastaAdi);
        hasta = {
          id: hastaId,
          isim: hastaAdi,
          ad: hastaAdi, // backward compatibility
          not: "",
          arsiv: false,
          kayitTarihi: new Date().toISOString(),
          haftalar: [],
          durumu: 'aktif',
          olusturmaTarihi: new Date().toISOString(),
          yeniSistem: true
        };
        hastalar.push(hasta);
        console.log('‚úÖ Yeni hasta olu≈üturuldu:', hastaAdi);
        
        // GitHub'a hasta listesi kaydet
        const token = document.getElementById('githubToken').value.trim();
        if (token) {
          try {
            // Hasta listesini GitHub'a kaydet
            const hastaListesi = await hastaListesiYukle() || [];
            const yeniHastaListesi = {
              id: hastaId,
              isim: hastaAdi,
              kayitTarihi: new Date().toISOString(),
              durumu: 'aktif'
            };
            
            // Aynƒ± hasta yoksa ekle
            if (!hastaListesi.find(h => h.id === hastaId)) {
              hastaListesi.push(yeniHastaListesi);
              await hastaListesiKaydet(hastaListesi);
              console.log('‚úÖ Hasta listesi GitHub\'a g√ºncellendi');
            }
            
            // Hasta verisini GitHub'a kaydet
            await hastayiAyriKaydet(hasta);
            console.log('‚úÖ Hasta verisi GitHub\'a kaydedildi');
            
          } catch (error) {
            console.error('‚ö†Ô∏è GitHub kaydetme hatasƒ±:', error);
          }
        }
      } else {
        console.log('‚úÖ Mevcut hasta bulundu:', hastaAdi, 'Hafta sayƒ±sƒ±:', hasta.haftalar ? hasta.haftalar.length : 0);
      }
      
      // Cache'e ekle (√ßoklu PDF i≈ülemi i√ßin)
      cokluPdfHastaCache.set(cacheKey, hasta);
      
      // D√úZELTME: Manuel sistemle aynƒ± ≈üekilde saveToStorage() kullan
      saveToStorage();
      
      return hasta;
    }

    // Hafta bulma/olu≈üturma (GitHub g√ºncellemeli)
    async function findOrCreateHaftaWithGitHub(hasta, haftaNo, tarihAraligi) {
      console.log('üìÖ Hafta aranƒ±yor/olu≈üturuluyor:', haftaNo, tarihAraligi);
      
      if (!hasta.haftalar) hasta.haftalar = [];
      
      // Mevcut haftayƒ± ara (hafta numarasƒ±na g√∂re)
      let hafta = hasta.haftalar.find(h => h.haftaNo === haftaNo);
      
      if (!hafta) {
        // Tarihleri parse et
        const tarihBilgisi = parseTarihAraligi(tarihAraligi);
        
        console.log(`‚ú® ${haftaNo}. hafta olu≈üturuluyor, mevcut hafta sayƒ±sƒ±: ${hasta.haftalar.length}`);
        console.log('üìÖ Hafta i√ßin hesaplanan tarihler:', tarihBilgisi);
        
        // Yeni hafta olu≈ütur (manuel kayƒ±t formatƒ±na uygun)
        hafta = {
          haftaNo: haftaNo,
          baslangic: tarihBilgisi.baslangic,
          bitis: tarihBilgisi.bitis,
          aciklama: "",
          pdf: null,
          pdfName: null,
          pdfOrijinalIsim: null,
          pdfYolu: null,
          githubUrl: null,
          indirmeUrl: null,
          kayitTarihi: new Date().toISOString(),
          tarifKartlar: [],
          tarifler: [],
          gptMesaj: "",
          pdfFile: {}
        };
        hasta.haftalar.push(hafta);
        console.log(`‚úÖ ${hasta.isim || hasta.ad} i√ßin ${haftaNo}. hafta olu≈üturuldu (${tarihAraligi})`);
        console.log('üìã Olu≈üturulan hafta detayƒ±:', { haftaNo: hafta.haftaNo, baslangic: hafta.baslangic, bitis: hafta.bitis });
        
        // GitHub'a g√ºncellenmi≈ü hasta verisini kaydet
        const token = document.getElementById('githubToken').value.trim();
        if (token) {
          try {
            await hastayiAyriKaydet(hasta);
            console.log(`‚úÖ ${hasta.isim || hasta.ad} hafta verisi GitHub'a g√ºncellendi`);
          } catch (error) {
            console.error('‚ö†Ô∏è Hafta GitHub kaydetme hatasƒ±:', error);
          }
        }
        
        // Cache'i de g√ºncelle (√ßoklu PDF i≈ülemi i√ßin)
        if (typeof cokluPdfHastaCache !== 'undefined') {
          const cacheKey = (hasta.isim || hasta.ad).toUpperCase();
          cokluPdfHastaCache.set(cacheKey, hasta);
          console.log(`üîÑ Cache g√ºncellendi: ${hasta.isim || hasta.ad} - Hafta sayƒ±sƒ±: ${hasta.haftalar.length}`);
        }
        
        // D√úZELTME: Manuel sistemle aynƒ± ≈üekilde saveToStorage() kullan
        saveToStorage();
      } else {
        console.log(`‚úÖ ${hasta.isim || hasta.ad} i√ßin ${haftaNo}. hafta zaten mevcut`);
      }
      
      return hafta;
    }

    async function processCokluPdf(files) {
      if (!files || files.length === 0) {
        alert('L√ºtfen en az bir PDF dosyasƒ± se√ßin.');
        return;
      }

      console.log('üìÅ √áoklu PDF i≈ülemi ba≈ülatƒ±ldƒ±:', files.length, 'dosya');
      
      const sonuclar = [];
      let basarili = 0;
      let hatali = 0;

      // Progress g√∂sterimi
      const progressDiv = document.createElement('div');
      progressDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000; min-width: 300px; text-align: center;
      `;
      progressDiv.innerHTML = `
        <h3>üìÅ PDF'ler ƒ∞≈üleniyor...</h3>
        <div id="progressBar" style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
          <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s;"></div>
        </div>
        <div id="progressText">0 / ${files.length}</div>
      `;
      document.body.appendChild(progressDiv);

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = ((i + 1) / files.length) * 100;
        
        // Progress g√ºncelle
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressText').textContent = `${i + 1} / ${files.length}`;
        
        try {
          console.log(`üîç ${i + 1}/${files.length} - "${file.name}" analiz ediliyor...`);
          
          // Dosya adƒ±nƒ± parse et
          const parsed = parseProfessionalPdfName(file.name);
          
          if (!parsed) {
            console.warn('‚ö†Ô∏è Dosya adƒ± format hatasƒ±:', file.name);
            sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: 'Dosya adƒ± formatƒ± tanƒ±nmadƒ±' });
            hatali++;
            continue;
          }

          // Hasta olu≈ütur/bul (GitHub entegrasyonlu)
          const hasta = await findOrCreateHastaWithGitHub(parsed.hastaAdi);
          
          // Hafta olu≈ütur/bul (GitHub g√ºncellemeli)
          const hafta = await findOrCreateHaftaWithGitHub(hasta, parsed.haftaNo, parsed.tarihAraligi);
          
          // PDF dosyasƒ±nƒ± i≈üle
          try {
            // PDF'i GitHub'a y√ºkle (manuel sistemle aynƒ±)
            console.log(`üì§ ${file.name} GitHub'a y√ºkleniyor...`);
            const pdfSonuc = await pdfYukleGithub(file, hasta.id, hafta.haftaNo);
            
            if (!pdfSonuc) {
              console.error(`‚ùå ${file.name} y√ºkleme ba≈üarƒ±sƒ±z`);
              sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: 'PDF y√ºkleme ba≈üarƒ±sƒ±z' });
              hatali++;
              continue;
            }
            
            // Manuel sistemle aynƒ± ≈üekilde yol referansƒ± kaydet (Base64 deƒüil!)
            hafta.pdfOrijinalIsim = pdfSonuc.orijinalAd;
            hafta.pdfName = pdfSonuc.guvenliAd;
            hafta.pdfYolu = pdfSonuc.dosyaYolu;
            hafta.githubUrl = pdfSonuc.githubUrl;
            hafta.indirmeUrl = pdfSonuc.indirmeUrl;
            hafta.kayitTarihi = new Date().toISOString();
            
            // PDF analizi i√ßin ge√ßici Base64 olu≈ütur (JSON'a kaydetmiyoruz!)
            const pdfBase64 = await fileToBase64(file);
            hafta.pdfFile = file; // Ge√ßici analiz i√ßin File objesi
            
            // PDF'den metin √ßƒ±kar ve tarif analizi yap
            try {
              console.log(`üîç ${file.name} PDF i√ßerik analizi ba≈ülƒ±yor...`);
              
              // Base64'den PDF metnini √ßƒ±kar
              let base64Data = pdfBase64;
              if (base64Data.includes(',')) {
                base64Data = base64Data.split(',')[1];
              }
              
              // Base64 verisini temizle ve doƒürula
              base64Data = base64Data.replace(/[^A-Za-z0-9+/=]/g, '');
              
              if (!base64Data || base64Data.length === 0) {
                console.warn(`‚ö†Ô∏è ${file.name} i√ßin ge√ßersiz Base64 verisi`);
                hafta.tarifler = [];
                hafta.tarifKartlar = [];
                throw new Error('Ge√ßersiz PDF Base64 verisi');
              }
              
              console.log(`üìÑ Base64 veri uzunluƒüu: ${base64Data.length} karakter`);
              
              const binaryString = atob(base64Data);
              const bytes = new Uint8Array(binaryString.length);
              for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
              }
              
              const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
              let fullText = '';
              
              console.log(`üìñ PDF toplam sayfa sayƒ±sƒ±: ${pdf.numPages}`);
              
              // Manuel sistemle AYNI ≈üekilde metin √ßƒ±karma
              for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                console.log(`üìÑ Sayfa ${pageNum}/${pdf.numPages} i≈üleniyor...`);
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                const strings = textContent.items.map(item => item.str);
                const pageText = strings.join('\n') + '\n';
                
                console.log(`üìÑ Sayfa ${pageNum} metin uzunluƒüu: ${pageText.length} karakter`);
                console.log(`üìÑ Sayfa ${pageNum} ilk 200 karakter:`, pageText.substring(0, 200));
                
                // Tavuk i√ßeren satƒ±rlarƒ± √∂zel kontrol et
                if (pageText.toLowerCase().includes('tavuk')) {
                  console.log(`üêî Sayfa ${pageNum}'da TAVUK bulundu!`);
                  const tavukSatirlari = pageText.split('\n').filter(line => line.toLowerCase().includes('tavuk'));
                  console.log(`üêî Sayfa ${pageNum} tavuk satƒ±rlarƒ±:`, tavukSatirlari);
                }
                
                // Pirzola i√ßeren satƒ±rlarƒ± √∂zel kontrol et
                if (pageText.toLowerCase().includes('pirzola')) {
                  console.log(`ü•© Sayfa ${pageNum}'da PIRZOLA bulundu!`);
                  const pirzolaSatirlari = pageText.split('\n').filter(line => line.toLowerCase().includes('pirzola'));
                  console.log(`ü•© Sayfa ${pageNum} pirzola satƒ±rlarƒ±:`, pirzolaSatirlari);
                }
                
                // 150 gr i√ßeren satƒ±rlarƒ± √∂zel kontrol et
                if (pageText.includes('150') && pageText.toLowerCase().includes('gr')) {
                  console.log(`‚öñÔ∏è Sayfa ${pageNum}'da 150 gr bulundu!`);
                  const miktarSatirlari = pageText.split('\n').filter(line => line.includes('150') && line.toLowerCase().includes('gr'));
                  console.log(`‚öñÔ∏è Sayfa ${pageNum} 150 gr satƒ±rlarƒ±:`, miktarSatirlari);
                }
                
                fullText += pageText; // Manuel sistemle aynƒ±: '\n' kullan!
              }
              
              console.log(`üìÑ PDF metni √ßƒ±karƒ±ldƒ±: ${fullText.length} karakter`);
              console.log(`üìÑ PDF tam metni (ilk 500 karakter):`, fullText.substring(0, 500));
              
              // Ham metinde aradƒ±ƒüƒ±mƒ±z satƒ±rlarƒ± kontrol et
              console.log(`üîç Ham metinde 'tavuk' var mƒ±?`, fullText.toLowerCase().includes('tavuk'));
              console.log(`üîç Ham metinde 'pirzola' var mƒ±?`, fullText.toLowerCase().includes('pirzola'));
              console.log(`üîç Ham metinde '150' var mƒ±?`, fullText.includes('150'));
              
              // Tarif detaylarƒ±nƒ± √ßƒ±kar
              const tarifDetaylar = extractTariflerDetay(fullText);
              hafta.tarifler = tarifDetaylar;
              console.log(`üçΩÔ∏è ${tarifDetaylar.length} tarif detayƒ± bulundu`);
              
              // Manuel sistemle AYNI ≈üekilde e≈üle≈ütirme yap
              if (window.tarifKartlari && window.tarifKartlari.length > 0 && tarifDetaylar.length > 0) {
                console.log(`üîó ${file.name} i√ßin tarif e≈üle≈ütirmesi ba≈ülƒ±yor (manuel sistem gibi)...`);
                
                // Global deƒüi≈ükenleri ge√ßici g√ºncelle (manuel sistem i√ßin gerekli)
                const tempSeciliHasta = seciliHasta;
                const tempHastalar = window.hastalar ? [...window.hastalar] : [];
                
                // Hasta listesini g√ºncelle
                if (!window.hastalar) window.hastalar = [];
                let hastaIndex = window.hastalar.findIndex(h => h.id === hasta.id);
                if (hastaIndex === -1) {
                  window.hastalar.push(hasta);
                  hastaIndex = window.hastalar.length - 1;
                } else {
                  window.hastalar[hastaIndex] = hasta;
                }
                
                // seciliHasta'yƒ± ge√ßici olarak g√ºncelle
                seciliHasta = hasta;
                
                // Manuel sistemle AYNI ≈üekilde hafta localStorage g√ºncellemesi
                const haftaIndex = hasta.haftalar.findIndex(h => h.haftaNo === hafta.haftaNo);
                if (haftaIndex >= 0) {
                  // Manuel sistemle AYNI: √∂nce tarifler g√ºncelle
                  hasta.haftalar[haftaIndex].tarifler = tarifDetaylar;
                  
                  try {
                    // Manuel sistemle AYNI otomatik e≈üle≈ütirme fonksiyonunu kullan
                    const eslestirmeSonucu = await otomatikEsleHafta(haftaIndex);
                    
                    if (eslestirmeSonucu) {
                      console.log('‚úÖ E≈üle≈ütirme sonu√ßlarƒ± hafta verilerine kaydediliyor...');
                      hafta.tarifKartlar = eslestirmeSonucu.eslesenKartlar || [];
                      console.log('üìù JSON\'a kaydedilecek e≈üle≈üen kart sayƒ±sƒ±:', eslestirmeSonucu.eslesenKartlar?.length || 0);
                      
                      // Manuel sistemle AYNI ≈üekilde hasta verilerini g√ºncelle
                      seciliHasta.haftalar[haftaIndex].tarifKartlar = hafta.tarifKartlar || [];
                      
                      // Mevcut JSON'da eslesmeyenTarifler varsa sil (manuel sistemle aynƒ±)
                      if (seciliHasta.haftalar[haftaIndex].eslesmeyenTarifler) {
                        delete seciliHasta.haftalar[haftaIndex].eslesmeyenTarifler;
                        console.log('üßπ Eski eslesmeyenTarifler verisi JSON\'dan temizlendi');
                      }
                      
                      // Manuel sistemle AYNI ≈üekilde GitHub'a kaydet
                      await hastayiAyriKaydet(seciliHasta);
                      console.log('üìù E≈üle≈ütirme sonrasƒ± GitHub\'a kaydedildi (manuel sistem gibi)');
                    }
                    
                    console.log(`‚úÖ Manuel sistem uyumlu e≈üle≈ütirme tamamlandƒ±: ${hafta.tarifKartlar.length} e≈üle≈üme bulundu`);
                  } catch (eslesmeError) {
                    console.warn('‚ö†Ô∏è E≈üle≈ütirme hatasƒ±:', eslesmeError);
                    hafta.tarifKartlar = [];
                  }
                }
                
                // Global deƒüi≈ükenleri geri y√ºkle
                seciliHasta = tempSeciliHasta;
                window.hastalar = tempHastalar;
                
              } else {
                console.warn('‚ö†Ô∏è Tarif kartlarƒ± y√ºklenmemi≈ü veya tarif bulunamadƒ±, e≈üle≈ütirme atlanƒ±yor');
                hafta.tarifKartlar = [];
              }
              
            } catch (pdfAnalysisError) {
              console.error('‚ùå PDF analiz hatasƒ±:', pdfAnalysisError);
              hafta.tarifler = [];
              hafta.tarifKartlar = [];
            }
            
            // Ge√ßici pdfFile'ƒ± temizle (manuel sistemle aynƒ±)
            if (hafta.pdfFile) {
              delete hafta.pdfFile;
            }
            
            // G√ºncellenmi≈ü hasta verisini kaydet
            console.log(`üîç DEBUG: ${file.name} - Hasta kaydedilmeden √∂nce hafta.tarifKartlar:`, hafta.tarifKartlar);
            console.log(`üîç DEBUG: ${file.name} - Hasta kaydedilmeden √∂nce hafta.tarifler:`, hafta.tarifler);
            console.log(`üîç DEBUG: ${file.name} - Final hafta verisi (Base64 olmadan):`, JSON.stringify(hafta, null, 2));
            await hastayiAyriKaydet(hasta);
            
            // Manuel sistemle AYNI ≈üekilde localStorage da g√ºncelle
            saveToStorage();
            
          } catch (pdfError) {
            console.warn('‚ö†Ô∏è PDF i≈üleme hatasƒ±:', pdfError);
            // PDF hatasƒ± olsa bile hasta/hafta kaydƒ±nƒ± tamamla
          }
          
          sonuclar.push({ 
            dosya: file.name, 
            durum: 'BA≈ûARILI', 
            hasta: parsed.hastaAdi,
            hafta: parsed.haftaNo,
            tarihAraligi: parsed.tarihAraligi,
            tarifSayisi: hafta.tarifler ? hafta.tarifler.length : 0,
            eslesmeSayisi: hafta.tarifKartlar ? hafta.tarifKartlar.length : 0,
            mesaj: `${hafta.tarifler ? hafta.tarifler.length : 0} tarif, ${hafta.tarifKartlar ? hafta.tarifKartlar.length : 0} e≈üle≈üme`
          });
          basarili++;
          
          console.log(`‚úÖ ${file.name} ba≈üarƒ±yla i≈ülendi`);
          
        } catch (error) {
          console.error('‚ùå PDF i≈üleme hatasƒ±:', file.name, error);
          sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: error.message });
          hatali++;
        }
        
        // K√º√ß√ºk bir delay (UI donmamasƒ± i√ßin)
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // Progress dialog'u kapat
      document.body.removeChild(progressDiv);
      
      // GitHub'dan hasta listesini yeniden y√ºkle ve UI'ƒ± g√ºncelle
      if (basarili > 0) {
        try {
          console.log('üîÑ √áoklu PDF i≈ülemi sonrasƒ± sistem g√ºncelleniyor...');
          
          // Cache'i temizle (yeni veriler i√ßin)
          try {
            const cacheKeys = Object.keys(localStorage).filter(key => key.startsWith('hasta_'));
            cacheKeys.forEach(key => localStorage.removeItem(key));
            console.log('‚úÖ Cache temizlendi');
          } catch (cacheError) {
            console.warn('‚ö†Ô∏è Cache temizleme hatasƒ±:', cacheError);
          }
          
          // Hasta listesini yeniden y√ºkle
          if (typeof loadHastaDataFromGitHub === 'function') {
            await loadHastaDataFromGitHub(true); // sessiz mod
            console.log('‚úÖ Hasta listesi GitHub\'dan yeniden y√ºklendi');
          }
          
          // UI'ƒ± g√ºncelle
          if (typeof updateHastaListesi === 'function') {
            updateHastaListesi();
            console.log('‚úÖ Hasta listesi UI g√ºncellendi');
          } else {
            console.warn('‚ö†Ô∏è updateHastaListesi fonksiyonu bulunamadƒ±');
          }
          
          // Ana sistem UI'ƒ±nƒ± g√ºncelle
          if (typeof renderYeniSistem === 'function') {
            renderYeniSistem();
            console.log('‚úÖ Ana sistem UI g√ºncellendi');
          }
          
        } catch (error) {
          console.warn('‚ö†Ô∏è Sistem g√ºncelleme hatasƒ±:', error);
        }
      }
      
      // Sonu√ß raporu g√∂ster
      let raporHtml = `
        <div style="max-height: 400px; overflow-y: auto;">
          <h3>üìä ƒ∞≈ülem Raporu</h3>
          <p><strong>Toplam:</strong> ${files.length} dosya</p>
          <p><strong>Ba≈üarƒ±lƒ±:</strong> ${basarili}</p>
          <p><strong>Hatalƒ±:</strong> ${hatali}</p>
          <hr>
          <h4>Detaylar:</h4>
      `;
      
      sonuclar.forEach(sonuc => {
        const ikon = sonuc.durum === 'BA≈ûARILI' ? '‚úÖ' : '‚ùå';
        raporHtml += `<p>${ikon} <strong>${sonuc.dosya}</strong>`;
        if (sonuc.hasta) {
          raporHtml += ` ‚Üí ${sonuc.hasta} (${sonuc.hafta}. hafta)`;
          if (sonuc.tarifSayisi !== undefined) raporHtml += ` - ${sonuc.tarifSayisi} tarif`;
          if (sonuc.eslesmeSayisi !== undefined) raporHtml += `, ${sonuc.eslesmeSayisi} e≈üle≈üme`;
        }
        if (sonuc.mesaj && sonuc.durum === 'HATA') raporHtml += ` - ${sonuc.mesaj}`;
        raporHtml += `</p>`;
      });
      
      raporHtml += '</div>';
      
      // Modal dialog olu≈ütur
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
      `;
      modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%;">
          ${raporHtml}
          <button onclick="this.closest('div').parentElement.remove()" 
                  style="margin-top: 15px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Tamam
          </button>
        </div>
      `;
      document.body.appendChild(modal);
      
      console.log('üéâ √áoklu PDF i≈ülemi tamamlandƒ±! Ba≈üarƒ±lƒ±:', basarili, 'Hatalƒ±:', hatali);
      
      // Otomatik kaydetme - √ßoklu PDF i≈ülemi tamamlandƒ± (Cache temizlenmeden √∂nce!)
      if (basarili > 0 && typeof cokluPdfHastaCache !== 'undefined') {
        console.log('üíæ √áoklu PDF i≈ülemi ba≈üarƒ±lƒ±, t√ºm hasta verileri otomatik kaydediliyor...');
        
        // Cache'deki t√ºm hastalarƒ± global hastalar dizisine ekle/g√ºncelle
        for (const [key, hasta] of cokluPdfHastaCache.entries()) {
          autoSaveHastaData(hasta);
        }
      }
      
      // Cache'i temizle
      if (typeof cokluPdfHastaCache !== 'undefined') {
        console.log('üßπ Cache temizleniyor... √ñnceki boyut:', cokluPdfHastaCache.size);
        cokluPdfHastaCache.clear();
      }
      
      // Final kaydetme: T√ºm deƒüi≈üiklikleri kesin olarak kaydet
      saveToStorage();
      console.log('üíæ √áoklu PDF i≈ülemi sonrasƒ± final kaydetme tamamlandƒ±');
      
      // Yemek analizini g√ºncelle (√ßoklu PDF i≈ülemi sonrasƒ±)
      if (basarili > 0) {
        console.log('üìä √áoklu PDF i≈ülemi sonrasƒ± yemek analizi g√ºncelleniyor...');
        setTimeout(() => {
          updateYemekAnalizi();
        }, 1000); // Veriler tamamen y√ºklenmesi i√ßin 1 saniye bekle
      }
    }

    // UTF-8 Base64 decode yardƒ±mcƒ± fonksiyonu (T√ºrk√ße karakterler i√ßin)
    function decodeBase64UTF8(base64Content) {
      try {
        // Modern tarayƒ±cƒ±larda TextDecoder kullan
        const bytes = Uint8Array.from(atob(base64Content), c => c.charCodeAt(0));
        return new TextDecoder('utf-8').decode(bytes);
      } catch (decodeError) {
        // Fallback: Normal atob kullan
        console.warn('UTF-8 decode ba≈üarƒ±sƒ±z, normal decode deneniyor:', decodeError);
        return atob(base64Content);
      }
    }
    
    // UTF-8 encoding i√ßin yardƒ±mcƒ± fonksiyon
    function encodeUTF8ToBase64(jsonData) {
      try {
        const jsonString = JSON.stringify(jsonData, null, 2);
        const encoder = new TextEncoder();
        const utf8Bytes = encoder.encode(jsonString);
        return btoa(String.fromCharCode(...utf8Bytes));
      } catch (error) {
        console.warn('UTF-8 encode ba≈üarƒ±sƒ±z, fallback kullanƒ±lƒ±yor:', error);
        // Fallback: Eski y√∂ntem
        return btoa(unescape(encodeURIComponent(JSON.stringify(jsonData, null, 2))));
      }
    }
    
    // Base64'√º blob'a √ßevir
    function base64ToBlob(base64Content, mimeType = 'application/octet-stream') {
      try {
        // Base64 string'den yeni satƒ±rlarƒ± temizle
        const cleanedBase64 = base64Content.replace(/\s/g, '');
        const byteCharacters = atob(cleanedBase64);
        const byteNumbers = new Array(byteCharacters.length);
        
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: mimeType });
      } catch (error) {
        console.error('Base64 to blob conversion error:', error);
        throw new Error('Base64 dosya d√∂n√º≈üt√ºrme hatasƒ±');
      }
    }
    
    // Hasta verisini GitHub'dan al (Yeni Sistem Uyumlu)
    async function getHastaData(hastaId, githubRepo = null, githubToken = null, hastaIsim = null) {
      try {
        // Parametrelerden veya global deƒüi≈ükenlerden al
        const repo = githubRepo || (typeof GITHUB_REPO !== 'undefined' ? GITHUB_REPO : null);
        const token = githubToken || (typeof GITHUB_TOKEN !== 'undefined' ? GITHUB_TOKEN : null);
        
        if (!repo || !token) {
          throw new Error('GitHub repo veya token eksik');
        }
        
        // Yeni sistem: hasta_ID_ISIM.json formatƒ±nda dosya ara
        const dosyaAdlari = [];
        
        if (hastaIsim) {
          dosyaAdlari.push(generateFileName({ id: hastaId, isim: hastaIsim }));
          dosyaAdlari.push(generateFileName({ id: hastaId, isim: turkceKarakterDuzelt(hastaIsim) }));
          dosyaAdlari.push(generateFileName({ isim: hastaIsim }));
          dosyaAdlari.push(generateFileName({ isim: turkceKarakterDuzelt(hastaIsim) }));
        }
        
        // √áift entryleri kaldƒ±r
        const benzersizDosyaAdlari = [...new Set(dosyaAdlari)];
        
        console.log('üîç Hasta verisi aranan dosyalar:', benzersizDosyaAdlari);
        
        // Her dosya adƒ±nƒ± dene
        for (const dosyaAdi of benzersizDosyaAdlari) {
          try {
            const response = await fetch(`https://api.github.com/repos/${repo}/contents/patients/${dosyaAdi}`, {
              headers: {
                'Authorization': `token ${token}`
              }
            });
            
            if (response.ok) {
              const data = await response.json();
              const content = decodeBase64UTF8(data.content);
              console.log(`‚úÖ Hasta verisi bulundu: ${dosyaAdi}`);
              return JSON.parse(content);
            }
          } catch (e) {
            console.log(`‚ùå Dosya bulunamadƒ±: ${dosyaAdi}`);
          }
        }
        
        // Eski sistem de deneyelim (backward compatibility)
        try {
          const response = await fetch(`https://api.github.com/repos/${repo}/contents/patients/${hastaId}/hasta_data.json`, {
            headers: {
              'Authorization': `token ${token}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const content = decodeBase64UTF8(data.content);
            console.log(`‚úÖ Hasta verisi eski sistemde bulundu: ${hastaId}/hasta_data.json`);
            return JSON.parse(content);
          }
        } catch (e) {
          console.log(`‚ùå Eski sistem de bulunamadƒ±: ${hastaId}/hasta_data.json`);
        }
        
        throw new Error('Hasta verisi bulunamadƒ±');
      } catch (error) {
        console.error('Hasta verisi alma hatasƒ±:', error);
        throw error;
      }
    }
    
    // --- GitHub'a JSON dosyasƒ± kaydetme fonksiyonu ---
    // Global deƒüi≈ükenler
    let seciliHasta = null;
    
    // E≈üle≈ümeyenler listesini g√ºncelle - manuel e≈üle≈ütirme sonrasƒ±
    function eslesmeyenlerListesiniGuncelle() {
      const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
      const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
      
      if (!eslesmeyenlerContent || !eslesmeyenlerBaslik) {
        console.log('üîç E≈üle≈ümeyenler DOM elementleri bulunamadƒ±');
        return;
      }
      
      // Mevcut e≈üle≈ümeyen tarifleri tekrar kontrol et
      const aktifHasta = seciliHasta;
      if (!aktifHasta || !aktifHasta.haftalar) {
        console.log('‚ÑπÔ∏è Yemek analizi i√ßin hasta se√ßilmedi veya hafta verisi yok');
        return;
      }
      
      let yeniEslesmeyenler = [];
      
      // √ñnce JSON'dan kaydedilmi≈ü e≈üle≈ümeyen tarifleri al
      aktifHasta.haftalar.forEach(hafta => {
        if (hafta.eslesmeyenTarifler && hafta.eslesmeyenTarifler.length > 0) {
          hafta.eslesmeyenTarifler.forEach(tarif => {
            if (!yeniEslesmeyenler.includes(tarif)) {
              yeniEslesmeyenler.push(tarif);
            }
          });
        }
      });
      
      // Eƒüer JSON'da e≈üle≈ümeyen tarif yoksa, eski y√∂ntemle hesapla
      if (yeniEslesmeyenler.length === 0) {
        aktifHasta.haftalar.forEach(hafta => {
          if (hafta.tarifler && hafta.tarifler.length > 0) {
            hafta.tarifler.forEach(tarif => {
              // Normalize et
              function normalizeLocal(str) {
                return str
                  .toLowerCase()
                  .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
                  .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i')
                  .replace(/iÃá/g, 'i')
                  .replace(/[_*\/()]/g, ' ')
                  .replace(/\s+/g, ' ')
                  .replace(/[^a-z0-9\s]/g, '')
                  .trim();
              }
              
              const normalizedTarif = normalizeLocal(tarif);
              
              // Otomatik e≈üle≈üme kontrol√º
              const otomatikEslesen = tariflerKlasoruGorselleri.some(kart => {
                const normalizedKart = normalizeLocal(kart.name.replace(/\.[^/.]+$/, ''));
                return normalizedKart.includes(normalizedTarif) || 
                       normalizedTarif.includes(normalizedKart) ||
                       normalizedKart === normalizedTarif;
              });
              
              // Manuel e≈üle≈üme kontrol√º  
              const manuelEslesen = manuelEslestirmeler[normalizedTarif];
              
              // Yasak kural kontrol√º
              const yasakMi = eslesmemeKurallari[normalizedTarif];
              
              // Eƒüer hi√ßbir yerde e≈üle≈ümiyor ve yasaklanmamƒ±≈üsa e≈üle≈ümeyen listesine ekle
              if (!otomatikEslesen && !manuelEslesen && !yasakMi && !yeniEslesmeyenler.includes(tarif)) {
                yeniEslesmeyenler.push(tarif);
              }
            });
          }
        });
      }
      
      // UI'ƒ± g√ºncelle
      if (yeniEslesmeyenler.length > 0) {
        eslesmeyenlerBaslik.textContent = `üö´ E≈üle≈ümeyen Tarifler (${yeniEslesmeyenler.length})`;
        eslesmeyenlerContent.innerHTML = '';
        
        yeniEslesmeyenler.forEach(tarif => {
          const p = document.createElement('p');
          p.textContent = tarif;
          p.style.color = '#dc3545';
          p.style.margin = '6px 0';
          p.style.padding = '4px 8px';
          p.style.background = '#fff5f5';
          p.style.borderLeft = '3px solid #dc3545';
          p.style.borderRadius = '4px';
          p.style.cursor = 'pointer';
          p.style.transition = 'background-color 0.2s';
          p.title = 'Tƒ±kla ve manuel e≈üle≈ütirme yap';
          
          p.onmouseenter = () => p.style.background = '#ffe6e6';
          p.onmouseleave = () => p.style.background = '#fff5f5';
          p.onclick = () => {
            console.log('üîó E≈üle≈ümeyen tarif adƒ±na tƒ±klandƒ±:', tarif);
            try {
              if (typeof eslesmeyenTarifManuelEslestir === 'function') {
                eslesmeyenTarifManuelEslestir(tarif);
              } else {
                console.error('‚ùå eslesmeyenTarifManuelEslestir fonksiyonu bulunamadƒ±!');
                alert('Manuel e≈üle≈ütirme fonksiyonu y√ºklenemedi. Sayfayƒ± yenileyin.');
              }
            } catch (error) {
              console.error('‚ùå E≈üle≈ümeyen tarif tƒ±klama hatasƒ±:', error);
              alert('Hata: ' + error.message);
            }
          };
          
          eslesmeyenlerContent.appendChild(p);
        });
      } else {
        eslesmeyenlerBaslik.textContent = 'üö´ E≈üle≈ümeyen Tarifler';
        eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">üéâ T√ºm tarifler e≈üle≈ütirildi!</div>';
      }
      
      console.log('üîÑ E≈üle≈ümeyenler listesi g√ºncellendi:', yeniEslesmeyenler.length, 'adet');
    }

    // Aktif hafta index'ini al
    function getAktifHaftaIndex() {
      const aktifTab = document.querySelector('.hafta-tab.active');
      if (aktifTab && aktifTab.dataset.haftaIndex !== undefined) {
        const index = parseInt(aktifTab.dataset.haftaIndex);
        console.log('üîç Aktif hafta index bulundu:', index);
        return index;
      }
      
      // Fallback: En son hafta
      if (seciliHasta?.haftalar?.length > 0) {
        const lastIndex = seciliHasta.haftalar.length - 1;
        console.log('‚ö†Ô∏è Aktif tab bulunamadƒ±, en son hafta kullanƒ±lƒ±yor:', lastIndex);
        return lastIndex;
      }
      
      console.error('‚ùå Hi√ß hafta bulunamadƒ±!');
      return 0;
    }
    
    // Token'ƒ± localStorage'da sakla ve input'a y√ºkle
    const TOKEN_KEY = 'github_api_token';
    function saveTokenToStorage() {
      const val = document.getElementById('githubToken').value;
      localStorage.setItem(TOKEN_KEY, val);
    }
    function loadTokenFromStorage() {
      return localStorage.getItem(TOKEN_KEY) || '';
    }
    // Sayfa a√ßƒ±lƒ±≈üƒ±nda token input'u doldur ve SADECE YENƒ∞ Sƒ∞STEMƒ∞ Y√úKLƒ∞
    window.addEventListener('DOMContentLoaded', function() {
      const token = loadTokenFromStorage();
      const input = document.getElementById('githubToken');
      if (input) input.value = token;
      
      // ESKƒ∞ Sƒ∞STEM DEVRE DI≈ûI - Sadece yeni JSON sistemi kullan
      console.log('üöÄ Yeni sistem ba≈ülatƒ±lƒ±yor...');
      
      // √ñnce manuel e≈üle≈ütirmeleri y√ºkle
      manuelEslestirmeleriYukle();
      eslesmemeKurallariniYukle();
      
      // Sadece yeni sistemi ba≈ülat
      loadHastaDataFromGitHub().then(() => {
        console.log('‚úÖ Yeni sistem hazƒ±r');
        
        // Sistem y√ºklendikten sonra yemek analizini ba≈ülat
        setTimeout(() => {
          updateYemekAnalizi();
          // E≈üle≈ümeyenler listesini de g√ºncelle
          setTimeout(() => {
            try {
              if (typeof eslesmeyenlerListesiniGuncelle === 'function') {
                eslesmeyenlerListesiniGuncelle();
              } else {
                console.warn('‚ö†Ô∏è eslesmeyenlerListesiniGuncelle fonksiyonu hen√ºz y√ºklenmemi≈ü');
              }
            } catch (error) {
              console.warn('‚ö†Ô∏è eslesmeyenlerListesiniGuncelle hatasƒ±:', error.message);
            }
          }, 500);
        }, 1500); // T√ºm veriler y√ºklenmesi i√ßin 1.5 saniye bekle
        
      }).catch(error => {
        console.warn('‚ö†Ô∏è Yeni sistem y√ºklenemedi:', error.message);
        // Bo≈ü yeni sistem ile ba≈ülat
        renderHastalarYeniSistem();
      });
    });

    // Data klas√∂r√ºnden hasta verilerini otomatik y√ºkle
    // T√ºrk√ße karakter d√ºzeltme fonksiyonu - YENƒ∞ VE G√úVENLƒ∞ VERSƒ∞YON
    function turkceKarakterDuzelt(text) {
      if (!text || typeof text !== 'string') return text;
      
      // SADECE BOZUK KARAKTERLERI TEMƒ∞ZLE, YENƒ∞ BOZUKLUK YARATMA!
      let temizMetin = text;
      
      // 1. Sadece ger√ßekten bozuk olan √É√Ç√É√Ç kalƒ±plarƒ±nƒ± temizle
      const bozukKaliplar = [
        /√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç/g,
        /√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç/g,
        /√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç√É√Ç/g,
        /√É√Ç√É√Ç√É√Ç√É√Ç/g,
        /√£√¢√£√¢/g,
        /√£√¢/g
      ];
      
      // Bozuk kalƒ±plarƒ± kaldƒ±r
      bozukKaliplar.forEach(kalip => {
        temizMetin = temizMetin.replace(kalip, '');
      });
      
      // 2. √ñNCE tam isim kalƒ±plarƒ±nƒ± d√ºzelt (en spesifik olanlar)
      temizMetin = temizMetin.replace(/\^EYDA E E√á0\^√á/gi, '≈ûEYDA EƒûE√áƒ∞≈û');
      
      // 2.1. PDF'de yaygƒ±n bozuk karakterleri d√ºzelt
      const karakterDuzeltmeleri = {
        '^': '≈û',    // PDF'de ≈û karakteri ^ olarak g√∂r√ºn√ºyor
        '0^': 'ƒ∞',   // PDF'de ƒ∞ karakteri 0^ olarak g√∂r√ºn√ºyor  
        '√á^': '√á',   // PDF'de √á karakteri √á^ olarak g√∂r√ºn√ºyor
        '¬∞': 'ƒ∞',    // Alternatif ƒ∞ g√∂sterimi
        '*': '≈û',    // Alternatif ≈û g√∂sterimi
        '¬ß': '≈û'     // Ba≈üka bir ≈û g√∂sterimi
      };
      
      // Karakter d√ºzeltmelerini uygula
      for (const [bozuk, dogru] of Object.entries(karakterDuzeltmeleri)) {
        temizMetin = temizMetin.replace(new RegExp(escapeRegex(bozuk), 'g'), dogru);
      }
      
      // 2.5. Diƒüer √∂zel kalƒ±plarƒ± d√ºzelt
      temizMetin = temizMetin.replace(/\^EYDA/g, '≈ûEYDA');
      temizMetin = temizMetin.replace(/E E√á0\^√á/g, 'EƒûE√áƒ∞≈û');
      temizMetin = temizMetin.replace(/EGE√á0\^/g, 'EƒûE√áƒ∞≈û');
      
      // 2. Sadece kesin bozuk karakterleri d√ºzelt (Dƒ∞KKATLƒ∞!)
      if (temizMetin.includes('¬∞')) {
        temizMetin = temizMetin.replace(/¬∞/g, 'ƒ∞');
      }
      if (temizMetin.includes('*')) {
        temizMetin = temizMetin.replace(/\*/g, '≈û');
      }
      
      // 3. Bilinen bozuk isimleri d√ºzelt
      const isimDuzeltmeleri = {
        'efKE BAY': '≈ûEFƒ∞KE BAY',
        'EF¬∞KE BAY': '≈ûEFƒ∞KE BAY',
        'EFKE BAY': '≈ûEFƒ∞KE BAY',
        'ATAY≈û': 'ATAY≈û', // Doƒüru halini koru
        'ATAYY≈û': 'ATAY≈û', // √áifte ≈û'yi d√ºzelt
        'KK': 'K√ñK',
        'KARAGZ': 'KARAG√ñZ',
        'FSUN': 'Fƒ∞SUN',
        'F¬∞SUN': 'Fƒ∞SUN'
      };
      
      // Sadece kesin bozuk isimleri d√ºzelt
      for (const [bozuk, dogru] of Object.entries(isimDuzeltmeleri)) {
        if (temizMetin.includes(bozuk)) {
          temizMetin = temizMetin.replace(new RegExp(bozuk, 'gi'), dogru);
        }
      }
      
      // 4. Fazla bo≈üluklarƒ± temizle
      temizMetin = temizMetin.replace(/\s+/g, ' ').trim();
      
      return temizMetin;
    }
    
    // Regex escape helper
    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // PDF i√ßin T√ºrk√ße karakterleri ASCII'ye √ßevir
    function pdfIcinASCII(text) {
      if (!text || typeof text !== 'string') return text;
      
      return text
        .replace(/≈û/g, 'S').replace(/≈ü/g, 's')
        .replace(/ƒû/g, 'G').replace(/ƒü/g, 'g')
        .replace(/ƒ∞/g, 'I').replace(/ƒ±/g, 'i')
        .replace(/√á/g, 'C').replace(/√ß/g, 'c')
        .replace(/√ñ/g, 'O').replace(/√∂/g, 'o')
        .replace(/√ú/g, 'U').replace(/√º/g, 'u');
    }

    // ACIL DURUM: LocalStorage'daki bozuk verileri temizle
    function localStorageTemizle() {
      console.log('üßπ LocalStorage bozuk veri temizliƒüi ba≈ülatƒ±lƒ±yor...');
      
      try {
        const hastaDataKey = 'hastaData';
        const hastalarKey = 'hastalar';
        
        // Her iki key'i de kontrol et
        const keys = [hastaDataKey, hastalarKey];
        let temizlenen = 0;
        
        keys.forEach(key => {
          const data = localStorage.getItem(key);
          if (data) {
            try {
              const hastalar = JSON.parse(data);
              let degisiklik = false;
              
              hastalar.forEach(hasta => {
                const eskiIsim = hasta.isim;
                hasta.isim = turkceKarakterDuzelt(hasta.isim);
                if (eskiIsim !== hasta.isim) {
                  degisiklik = true;
                  temizlenen++;
                }
                if (hasta.not) {
                  hasta.not = turkceKarakterDuzelt(hasta.not);
                }
              });
              
              if (degisiklik) {
                localStorage.setItem(key, JSON.stringify(hastalar));
                console.log(`üíæ ${key} g√ºncellendi`);
              }
            } catch (e) {
              console.error(`‚ùå ${key} parse hatasƒ±:`, e);
            }
          }
        });
        
        if (temizlenen > 0) {
          console.log(`üéâ ${temizlenen} hasta ismi temizlendi!`);
        } else {
          console.log('‚úÖ Veri zaten temiz!');
        }
        
      } catch (error) {
        console.error('‚ùå LocalStorage temizleme hatasƒ±:', error);
      }
    }
    
    // Sayfa y√ºklendiƒüinde otomatik temizleme yap
    setTimeout(() => {
      localStorageTemizle();
    }, 2000);

    // Manuel olarak mevcut hasta verilerini d√ºzeltme fonksiyonu
    // Manuel olarak mevcut hasta verilerini d√ºzeltme fonksiyonu
    function manuelHastaIsimleriniDuzelt() {
      console.log('üîß Hasta isimlerini d√ºzeltiliyor...');
      let degisiklikSayisi = 0;
      
      hastalar.forEach((hasta, index) => {
        if (hasta.isim) {
          const eskiIsim = hasta.isim;
          const yeniIsim = turkceKarakterDuzelt(eskiIsim);
          
          if (eskiIsim !== yeniIsim) {
            hasta.isim = yeniIsim;
            degisiklikSayisi++;
            console.log(`‚úÖ ${index + 1}. "${eskiIsim}" ‚Üí "${yeniIsim}"`);
          }
        }
        
        // Notlarƒ± da d√ºzelt
        if (hasta.not) {
          const eskiNot = hasta.not;
          const yeniNot = turkceKarakterDuzelt(eskiNot);
          if (eskiNot !== yeniNot) {
            hasta.not = yeniNot;
            console.log(`üìù Not d√ºzeltildi: "${eskiNot}" ‚Üí "${yeniNot}"`);
          }
        }
      });
      
      if (degisiklikSayisi > 0) {
        // Verileri kaydet
        saveToStorage();
        
        // Hasta listesini sƒ±rala ve yenile
        hastalar.sort((a, b) => a.isim.localeCompare(b.isim, 'tr'));
        renderHastalar();
        
        // Eƒüer bir hasta se√ßiliyse paneli g√ºncelle
        if (seciliHasta) {
          const secilenHastaIsim = document.getElementById('secilenHastaIsim');
          const secilenHastaNot = document.getElementById('secilenHastaNot');
          if (secilenHastaIsim) secilenHastaIsim.textContent = seciliHasta.isim;
          if (secilenHastaNot) secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
        }
        
        console.log(`üéâ RADIKAL D√úZELTMe TAmamlandƒ±: ${degisiklikSayisi} hasta ismi d√ºzeltildi!`);
        alert(`‚úÖ RADIKAL √á√ñZ√úM: ${degisiklikSayisi} hasta ismi d√ºzeltildi!\n\nArtƒ±k "AY≈û√ÇE" ‚Üí "AY≈ûE" gibi d√ºzeltmeler yapƒ±ldƒ±.`);
        
        // D√ºzeltilen hastalarƒ± yeni sisteme kaydet
        console.log('üì§ D√ºzeltilen hastalar yeni sisteme kaydediliyor...');
        tumHastalariAyriKaydet().then(() => {
          console.log('‚úÖ T√ºm d√ºzeltmeler yeni sisteme kaydedildi');
        }).catch(error => {
          console.error('‚ùå Yeni sisteme kaydetme hatasƒ±:', error);
          alert('‚ö†Ô∏è D√ºzeltmeler yapƒ±ldƒ± ama GitHub kaydƒ± ba≈üarƒ±sƒ±z. Token kontrol√º yapƒ±n.');
        });
      } else {
        console.log('‚úÖ T√ºm hasta isimleri zaten doƒüru!');
        alert('‚úÖ T√ºm hasta isimleri zaten doƒüru formatta!');
      }
    }
    window.manuelHastaIsimleriniDuzelt = manuelHastaIsimleriniDuzelt;

    // ESKƒ∞ Sƒ∞STEM DEVRE DI≈ûI - Artƒ±k sadece yeni JSON sistemi kullanƒ±lƒ±yor
    async function loadDataFromFolder() {
      const durumElement = document.getElementById('dataKlasoruDurumu');
      console.log('‚ö†Ô∏è ESKƒ∞ Sƒ∞STEM DEVRE DI≈ûI - Sadece yeni JSON sistemi kullanƒ±lƒ±yor');
      if (durumElement) {
        durumElement.innerHTML = '‚ùå ESKƒ∞ Sƒ∞STEM DEVRE DI≈ûI - Yeni JSON sistemi aktif';
      }
      // Eski sistem tamamen devre dƒ±≈üƒ± - data/hasta_kayitlari.json artƒ±k kullanƒ±lmƒ±yor
    }

    // Fresh veri y√ºkleme (cache'i bypass ederek)
    async function initFreshDataLoad() {
      console.log('üöÄ Fresh veri y√ºkleme ba≈ülƒ±yor...');
      
      // √ñnce localStorage'dan y√ºkle (temel veriler i√ßin)
      manuelEslestirmeleriYukle();
      eslesmemeKurallariniYukle();
      
      // Token varsa GitHub'dan fresh y√ºkle ve override et
      const token = document.getElementById('githubToken').value.trim();
      if (token) {
        try {
          console.log('üîÑ GitHub\'tan fresh veriler y√ºkleniyor...');
          
          // Cache timestamp kontrol√º - 5 dakikadan eski ise yenile
          const lastUpdate = localStorage.getItem('lastGithubUpdate');
          const now = Date.now();
          const fiveMinutes = 5 * 60 * 1000;
          
          if (!lastUpdate || (now - parseInt(lastUpdate)) > fiveMinutes) {
            console.log('‚è∞ Cache eski, GitHub\'tan yenileniyor...');
            
            // GitHub token kontrol√º
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
              console.warn('‚ö†Ô∏è GitHub token yok - Manuel e≈üle≈ütirme ve yasak kurallarƒ± y√ºklenemedi');
              console.log('üí° √á√∂z√ºm: GitHub token girin veya localStorage\'dan y√ºklenecek');
            } else {
              console.log('üîë GitHub token mevcut, veriler y√ºkleniyor...');
              
              await manuelEslestirmeleriGitHubYukle(true); // sessiz y√ºkleme
              await eslesmemeKurallariniGitHubYukle(true); // sessiz y√ºkleme
              
              console.log('‚úÖ GitHub data klas√∂r√º verileri y√ºklendi:', Object.keys(manuelEslestirmeler).length, 'manuel e≈üle≈ütirme,', Object.keys(eslesmemeKurallari).length, 'yasak');
            }
            
            // Token olmasa bile public GitHub dosyalarƒ±nƒ± dene
            if (!token || Object.keys(manuelEslestirmeler).length === 0) {
              console.log('üåê Public GitHub dosyalarƒ± deneniyor...');
              await loadPublicGitHubData();
            }
            
            // Hasta verilerini de GitHub'dan y√ºkle
            await loadHastaDataFromGitHub(true); // sessiz y√ºkleme
            
            // Cache timestamp'ini g√ºncelle
            localStorage.setItem('lastGithubUpdate', now.toString());
            
            console.log('‚úÖ GitHub veriler y√ºklendi:', Object.keys(manuelEslestirmeler).length, 'manuel e≈üle≈ütirme,', Object.keys(eslesmemeKurallari).length, 'yasak');
          } else {
            console.log('‚úÖ GitHub cache taze, localStorage kullanƒ±lƒ±yor');
          }
          
        } catch (error) {
          console.warn('‚ö†Ô∏è GitHub\'dan veri y√ºklenemedi, localStorage kullanƒ±lƒ±yor:', error.message);
        }
      }
      
      console.log('üìä Y√ºklenen veriler:');
      console.log('- Manuel e≈üle≈ütirmeler:', Object.keys(manuelEslestirmeler).length, 'adet');
      console.log('- E≈üle≈üme yasaklarƒ±:', Object.keys(eslesmemeKurallari).length, 'adet');
    }

    // Public GitHub dosyalarƒ±nƒ± token olmadan y√ºkle
    async function loadPublicGitHubData() {
      try {
        console.log('üì• Public manuel e≈üle≈ütirmeler y√ºkleniyor...');
        const manuelUrl = 'https://raw.githubusercontent.com/mustafasacar35/nutrition-planner/main/data/manuel_eslestirmeler.json';
        
        try {
          const manuelResp = await fetch(manuelUrl);
          if (manuelResp.ok) {
            const manuelData = await manuelResp.json();
            if (manuelData.eslestirmeler) {
              manuelEslestirmeler = manuelData.eslestirmeler;
            } else {
              manuelEslestirmeler = manuelData;
            }
            console.log('‚úÖ Public manuel e≈üle≈ütirmeler y√ºklendi:', Object.keys(manuelEslestirmeler).length, 'adet');
          } else {
            console.warn('‚ö†Ô∏è Public manuel e≈üle≈ütirmeler y√ºklenemedi:', manuelResp.status);
          }
        } catch (manuelError) {
          console.warn('‚ö†Ô∏è Public manuel e≈üle≈ütirme hatasƒ±:', manuelError.message);
        }

        console.log('üì• Public yasak kurallarƒ± y√ºkleniyor...');
        const yasakUrl = 'https://raw.githubusercontent.com/mustafasacar35/nutrition-planner/main/data/eslesmeme_kurallari.json';
        
        try {
          const yasakResp = await fetch(yasakUrl);
          if (yasakResp.ok) {
            const yasakData = await yasakResp.json();
            if (yasakData.kurallar) {
              eslesmemeKurallari = yasakData.kurallar;
            } else {
              eslesmemeKurallari = yasakData;
            }
            console.log('‚úÖ Public yasak kurallarƒ± y√ºklendi:', Object.keys(eslesmemeKurallari).length, 'adet');
          } else {
            console.warn('‚ö†Ô∏è Public yasak kurallarƒ± y√ºklenemedi:', yasakResp.status);
          }
        } catch (yasakError) {
          console.warn('‚ö†Ô∏è Public yasak kuralƒ± hatasƒ±:', yasakError.message);
        }

        // UI'yi g√ºncelle
        if (typeof manuelEslestirmeListesiniGoster === 'function') {
          manuelEslestirmeListesiniGoster();
        }
        if (typeof eslesmemeKurallariniGoster === 'function') {
          eslesmemeKurallariniGoster();
        }

      } catch (error) {
        console.error('‚ùå Public GitHub data y√ºkleme hatasƒ±:', error);
      }
    }

    // GitHub'dan hasta verilerini y√ºkle (YENƒ∞ Sƒ∞STEM)
    async function loadHastaDataFromGitHub(sessiz = false) {
      const durumElement = document.getElementById('githubDurumu');
      const token = document.getElementById('githubToken').value.trim();
      
      if (!token) {
        if (!sessiz) console.log('‚ÑπÔ∏è GitHub token girilmedi, offline modda √ßalƒ±≈üƒ±yor');
        if (durumElement) durumElement.innerHTML = '‚ÑπÔ∏è Offline Mod - GitHub token girilmedi';
        return;
      }
      
      try {
        if (!sessiz) console.log('üì• GitHub\'dan hasta listesi y√ºkleniyor (Yeni Sistem)...');
        if (durumElement) durumElement.innerHTML = 'üîÑ GitHub\'dan hasta listesi y√ºkleniyor...';
        
        // Hasta listesini y√ºkle ve sonucu al
        const yuklenmisList = await hastaListesiYukle();
        
        if (yuklenmisList.length > 0) {
          console.log('‚úÖ GitHub\'dan hasta listesi y√ºklendi:', yuklenmisList.length, 'hasta');
          
          // Hastalar listesini yeni sistemden render et
          await renderHastalarYeniSistem();
          
          if (durumElement) {
            durumElement.innerHTML = `‚úÖ GitHub'dan y√ºklendi (${yuklenmisList.length} hasta - Yeni Sistem)`;
          }
          
          // Alert kaldƒ±rƒ±ldƒ± - sadece console'da bilgi veriliyor
        } else {
          console.log('‚ö†Ô∏è Hasta listesi bo≈ü');
          if (durumElement) durumElement.innerHTML = '‚ö†Ô∏è Hasta listesi bo≈ü - Yeni hastalar ekleyebilirsiniz';
          
          // Alert kaldƒ±rƒ±ldƒ± - sadece console'da bilgi veriliyor
        }
      } catch (error) {
        if (!sessiz) console.warn('‚ö†Ô∏è GitHub\'dan hasta verileri y√ºklenemedi:', error.message);
        if (durumElement) durumElement.innerHTML = '‚ùå GitHub baƒülantƒ± hatasƒ±: ' + error.message;
      }
    }

    // GitHub token test fonksiyonu
    async function testGitHubToken() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('‚ùå GitHub token girilmedi!');
        return false;
      }
      
      try {
        console.log('üîç GitHub token test ediliyor...');
        
        const userResponse = await fetch('https://api.github.com/user', {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (!userResponse.ok) {
          alert(`‚ùå GitHub token ge√ßersiz!\nHata: ${userResponse.status}`);
          return false;
        }
        
        const user = await userResponse.json();
        console.log('‚úÖ GitHub kullanƒ±cƒ± bilgileri alƒ±ndƒ±:', user.login);
        
        alert(`‚úÖ GitHub token ge√ßerli!\n\nüë§ Kullanƒ±cƒ±: ${user.login}`);
        return true;
        
      } catch (error) {
        console.error('‚ùå GitHub token test hatasƒ±:', error);
        alert('‚ùå GitHub baƒülantƒ± hatasƒ±: ' + error.message);
        return false;
      }
    }

    // === YENƒ∞ Sƒ∞STEM: HASTA Lƒ∞STESƒ∞ Y√ñNETƒ∞Mƒ∞ ===
    
    // Hasta listesini GitHub'dan y√ºkle
    async function hastaListesiYukle() {
      try {
        const token = document.getElementById('githubToken').value.trim();
        if (!token) {
          console.log('‚ÑπÔ∏è GitHub token yok, offline modda √ßalƒ±≈üƒ±yor');
          return [];
        }
        
        const owner = 'mustafasacar35';
        const repo = 'nutrition-planner';
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/hastalar_listesi.json`, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Base64'√º UTF-8 olarak decode et (T√ºrk√ße karakterler i√ßin)
          const contentStr = decodeBase64UTF8(data.content).trim();
          
          // Bo≈ü dosya kontrol√º
          if (!contentStr || contentStr === '' || contentStr === '{}' || contentStr === 'null') {
            console.log('üìù Hasta listesi dosyasƒ± bo≈ü, yeni liste olu≈üturulacak');
            hastaListesi = []; // Global deƒüi≈ükeni sƒ±fƒ±rla
            return [];
          }
          
          try {
            const content = JSON.parse(contentStr);
            if (Array.isArray(content)) {
              console.log('‚úÖ Hasta listesi GitHub\'dan y√ºklendi:', content.length, 'hasta');
              hastaListesi = content; // Global deƒüi≈ükeni g√ºncelle
              return content;
            } else {
              console.log('‚ö†Ô∏è Hasta listesi array deƒüil, yeni liste olu≈üturulacak');
              hastaListesi = []; // Global deƒüi≈ükeni sƒ±fƒ±rla
              return [];
            }
          } catch (parseError) {
            console.error('‚ùå JSON parse hatasƒ±:', parseError);
            console.log('üìù Bozuk JSON, yeni liste olu≈üturulacak');
            hastaListesi = []; // Global deƒüi≈ükeni sƒ±fƒ±rla
            return [];
          }
        } else if (response.status === 404) {
          console.log('üìù Hasta listesi bulunamadƒ±, yeni liste olu≈üturulacak');
          hastaListesi = []; // Global deƒüi≈ükeni sƒ±fƒ±rla
          return [];
        } else {
          throw new Error(`GitHub API hatasƒ±: ${response.status}`);
        }
      } catch (error) {
        console.error('‚ùå Hasta listesi y√ºkleme hatasƒ±:', error);
        throw error;
      }
    }
    
    // Hasta listesini GitHub'a kaydet
    async function hastaListesiKaydet(hastaListesi) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        console.warn('‚ÑπÔ∏è GitHub token yok, offline modda √ßalƒ±≈üƒ±yor');
        return false;
      }
      
      try {
        const owner = 'mustafasacar35';
        const repo = 'nutrition-planner';
        
        // UTF-8 i√ßin doƒüru encoding
        const content = encodeUTF8ToBase64(hastaListesi);
        
        // √ñnce mevcut dosyanƒ±n SHA'sƒ±nƒ± al
        let sha = undefined;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/hastalar_listesi.json`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
          }
        } catch (e) {}
        
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/hastalar_listesi.json`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta listesi g√ºncellendi: ${hastaListesi.length} hasta`,
            content: content,
            sha: sha
          })
        });
        
        if (response.ok) {
          console.log('‚úÖ Hasta listesi GitHub\'a kaydedildi');
          return true;
        } else {
          throw new Error(`GitHub API hatasƒ±: ${response.status}`);
        }
      } catch (error) {
        console.error('‚ùå Hasta listesi kaydetme hatasƒ±:', error);
        return false;
      }
    }
    
    // Hasta listesinden hasta kaldƒ±r
    async function hastaListesindenKaldir(hastaId) {
      try {
        const mevcutListe = await hastaListesiYukle();
        
        // Hasta ID'sine g√∂re filtrele
        const yeniListe = mevcutListe.filter(hasta => hasta.id !== hastaId);
        
        console.log(`üóëÔ∏è Hasta listesinden kaldƒ±rƒ±lƒ±yor: ID=${hastaId}`);
        console.log(`üìä Liste boyutu: ${mevcutListe.length} ‚Üí ${yeniListe.length}`);
        
        // G√ºncellenmi≈ü listeyi kaydet
        const sonuc = await hastaListesiKaydet(yeniListe);
        if (sonuc) {
          console.log('‚úÖ Hasta listesinden ba≈üarƒ±yla kaldƒ±rƒ±ldƒ±');
          return true;
        } else {
          throw new Error('Hasta listesi g√ºncellenemedi');
        }
      } catch (error) {
        console.error('‚ùå Hasta listesinden kaldƒ±rma hatasƒ±:', error);
        return false;
      }
    }
    
    // Hasta listesine yeni hasta ekle
    async function hastaListesineEkle(hasta) {
      const mevcutListe = await hastaListesiYukle();
      
      // Hasta objesi veya string kontrol√º
      let hastaIsim, hastaId, hastaNot, hastaArsiv;
      
      if (typeof hasta === 'string') {
        // String olarak ge√ßirildiyse (eski kullanƒ±m)
        hastaIsim = hasta;
        hastaId = generatePatientId(hastaIsim);
        hastaNot = '';
        hastaArsiv = false;
      } else {
        // Obje olarak ge√ßirildiyse
        hastaIsim = hasta.isim || hasta.ad || hasta.name;
        hastaId = hasta.id || generatePatientId(hastaIsim);
        hastaNot = hasta.not || hasta.notes || '';
        hastaArsiv = hasta.arsiv || hasta.archived || false;
      }
      
      if (!hastaIsim) {
        console.error('‚ùå Hasta ismi bulunamadƒ±:', hasta);
        return false;
      }
      
      // Hasta zaten var mƒ± kontrol et
      const mevcutIndex = mevcutListe.findIndex(h => h.id === hastaId || h.isim === hastaIsim);
      
      if (mevcutIndex !== -1) {
        // Mevcut hastayƒ± g√ºncelle
        mevcutListe[mevcutIndex] = {
          id: hastaId,
          isim: hastaIsim,
          not: hastaNot,
          arsiv: hastaArsiv,
          sonGuncelleme: new Date().toISOString()
        };
        console.log('üìù Mevcut hasta g√ºncellendi:', hastaIsim);
      } else {
        // Yeni hasta ekle
        mevcutListe.push({
          id: hastaId,
          isim: hastaIsim,
          not: hastaNot,
          arsiv: hastaArsiv,
          olusturma: new Date().toISOString(),
          sonGuncelleme: new Date().toISOString()
        });
        console.log('‚ûï Yeni hasta eklendi:', hastaIsim);
      }
      
      // Listeyi sƒ±rala (arsiv olmayanlar √∂nce, sonra alfabetik)
      mevcutListe.sort((a, b) => {
        if (a.arsiv !== b.arsiv) return a.arsiv ? 1 : -1;
        return a.isim.localeCompare(b.isim, 'tr');
      });
      
      await hastaListesiKaydet(mevcutListe);
      return mevcutListe;
    }

    // === YENƒ∞ Sƒ∞STEM: PDF Y√ñNETƒ∞Mƒ∞ ===
    
    // PDF'i GitHub'a y√ºkleme fonksiyonu
    async function pdfYukleGithub(file, hastaId, haftaNo) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('GitHub token gerekli!');
        return {
          success: false,
          error: 'GitHub token gerekli!'
        };
      }
      
      try {
        console.log('üì§ PDF GitHub\'a y√ºkleniyor:', file.name);
        
        const owner = 'mustafasacar35';
        const repo = 'nutrition-planner';
        
        // G√ºvenli dosya adƒ± olu≈ütur (sadece problemli karakterleri temizle)
        const guvenliDosyaAdi = file.name
          .replace(/[\/\\*?"<>|:]/g, '_')  // Sadece ger√ßekten problemli olanlarƒ±
          .replace(/\s+/g, ' ')            // √áoklu bo≈üluklarƒ± tek yap
          .trim();
        
        const dosyaYolu = `pdfs/${guvenliDosyaAdi}`;
        
        // Dosyayƒ± base64'e √ßevir
        const base64Data = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve(base64);
          };
          reader.readAsDataURL(file);
        });
        
        // √ñnce dosyanƒ±n var olup olmadƒ±ƒüƒ±nƒ± kontrol et
        let sha = undefined;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaYolu}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
            console.log('‚ö†Ô∏è Aynƒ± isimde PDF bulundu, √ºzerine yazƒ±lacak');
          }
        } catch (e) {
          console.log('‚úÖ Yeni PDF dosyasƒ±');
        }
        
        // PDF'i GitHub'a y√ºkle
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaYolu}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `PDF y√ºklendi: ${file.name} (Hasta ID: ${hastaId}, Hafta: ${haftaNo})`,
            content: base64Data,
            sha: sha
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('‚úÖ PDF ba≈üarƒ±yla y√ºklendi:', dosyaYolu);
          
          return {
            success: true,
            dosyaYolu: dosyaYolu,
            orijinalAd: file.name,
            guvenliAd: guvenliDosyaAdi,
            githubUrl: `https://github.com/${owner}/${repo}/blob/main/${dosyaYolu}`,
            indirmeUrl: `https://raw.githubusercontent.com/${owner}/${repo}/main/${dosyaYolu}`,
            rawUrl: `https://raw.githubusercontent.com/${owner}/${repo}/main/${dosyaYolu}`,
            sha: result.content.sha,
            content: base64Data, // PDF'in base64 i√ßeriƒüi
            path: dosyaYolu,
            fileName: guvenliDosyaAdi
          };
        } else {
          throw new Error(`GitHub API hatasƒ±: ${response.status}`);
        }
        
      } catch (error) {
        console.error('‚ùå PDF y√ºkleme hatasƒ±:', error);
        alert(`PDF y√ºklenemedi: ${error.message}`);
        return {
          success: false,
          error: error.message
        };
      }
    }

    // === YENƒ∞ Sƒ∞STEM: HER HASTA ƒ∞√áƒ∞N AYRI JSON DOSYASI ===
    
    // Dosya adƒ± olu≈üturma fonksiyonu
    function generateFileName(hasta) {
      if (!hasta || !hasta.isim) {
        console.error('‚ùå generateFileName: Ge√ßersiz hasta objesi', hasta);
        return 'hasta_gecersiz.json';
      }
      
      const temizIsim = hasta.isim
        .toLowerCase()
        .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
        .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i')
        .replace(/[^a-z0-9]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '');
        
      // ID yoksa isimden olu≈ütur
      const hastaId = hasta.id || temizIsim;
      
      return `hasta_${hastaId}_${temizIsim}.json`;
    }
    
    function generatePatientId(isim) {
      if (!isim) return 'hasta_gecersiz';
      
      return isim
        .toLowerCase()
        .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
        .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i')
        .replace(/[^a-z0-9]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '');
    }
    
    // Patients klas√∂r√ºn√º olu≈üturma
    async function createPatientsFolder() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) return;
      
      try {
        const owner = 'mustafasacar35';
        const repo = 'nutrition-planner';
        
        // README.md dosyasƒ± ile klas√∂r olu≈ütur
        const content = btoa(`# Hasta Dosyalarƒ±

Bu klas√∂rde her hastanƒ±n ayrƒ± JSON dosyasƒ± bulunur.

## Dosya Adlandƒ±rma
- Formato: hasta_[ID]_[ISIM].json
- √ñrnek: hasta_1_ayse_yilmaz.json

## Dosya Yapƒ±sƒ±
Her hasta dosyasƒ± ≈üu bilgileri i√ßerir:
- Hasta bilgileri (id, isim, not)
- Hafta takip bilgileri
- PDF dosyalarƒ± (base64)
- E≈üle≈ütirme kartlarƒ±
- GPT mesajlarƒ±

## Ar≈üivleme
Kullanƒ±cƒ± 13+ hafta olan hastalarƒ± manuel olarak ar≈üivler.
`);
        
        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/README.md`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Patients klas√∂r√º olu≈üturuldu',
            content: content
          })
        });
        
        console.log('‚úÖ Patients klas√∂r√º olu≈üturuldu');
        
      } catch (error) {
        console.warn('Patients klas√∂r√º olu≈üturma hatasƒ±:', error);
      }
    }
    
    // Tek hasta kaydetme fonksiyonu
    async function hastayiAyriKaydet(hasta) {
      // G√ºvenlik kontrol√º
      if (!hasta || !hasta.isim) {
        alert('‚ùå Ge√ßersiz hasta verisi! L√ºtfen √∂nce bir hasta se√ßin.');
        return false;
      }
      
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('‚ùå GitHub token gerekli! L√ºtfen GitHub token girin.');
        return false;
      }
      
      try {
        console.log(`üíæ ${hasta.isim} hastasƒ± kaydediliyor...`);
        
        const owner = 'mustafasacar35';
        const repo = 'nutrition-planner';
        const branch = 'main';
        
        // Son g√ºncelleme tarihini ekle
        hasta.sonGuncelleme = new Date().toISOString();
        hasta.githubKaydedildi = true;
        
        const fileName = generateFileName(hasta);
        
        // Hasta verilerini kaydetmeden √∂nce hafta verilerinde GitHub linklerini g√ºncelle
        if (hasta.haftalar && hasta.haftalar.length > 0) {
          hasta.haftalar.forEach(hafta => {
            if (hafta.pdf) { // PDF varsa link olu≈ütur
              hafta.githubLink = `https://github.com/${owner}/${repo}/blob/${branch}/patients/${fileName}`;
              hafta.githubRawLink = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/patients/${fileName}`;
            }
          });
        }
        
        // UTF-8 i√ßin doƒüru encoding
        const content = encodeUTF8ToBase64(hasta);
        
        // √ñnce dosyanƒ±n SHA'sƒ±nƒ± kontrol et
        let sha = undefined;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${fileName}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
          }
        } catch (e) {}
        
        // Dosyayƒ± kaydet
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${fileName}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta kaydƒ± g√ºncellendi: ${hasta.isim}`,
            content: content,
            sha: sha
          })
        });
        
        if (response.ok) {
          console.log(`‚úÖ ${hasta.isim} ayrƒ± dosya olarak kaydedildi`);
          
          // Hasta listesine de ekle/g√ºncelle
          await hastaListesineEkle(hasta);
          
          return true;
        } else {
          throw new Error(`GitHub API hatasƒ±: ${response.status}`);
        }
        
      } catch (error) {
        console.error(`‚ùå ${hasta.isim} kaydetme hatasƒ±:`, error);
        return false;
      }
    }
    
    // T√ºm hastalarƒ± ayrƒ± dosyalar halinde kaydetme
    async function tumHastalariAyriKaydet() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('GitHub token gerekli!');
        return;
      }
      
      if (!confirm('T√ºm hastalarƒ± ayrƒ± JSON dosyalarƒ± halinde kaydetmek istediƒüinize emin misiniz?\n\nBu yeni sisteme ge√ßi≈ü i≈ülemidir.')) {
        return;
      }
      
      console.log('üöÄ Yeni sistem ba≈ülatƒ±lƒ±yor: Her hasta i√ßin ayrƒ± JSON dosyasƒ±...');
      
      // √ñnce patients klas√∂r√ºn√º olu≈ütur
      await createPatientsFolder();
      
      let basarili = 0;
      let hatali = 0;
      
      const durum = document.getElementById('githubDurumu');
      if (durum) durum.innerHTML = 'üíæ Yeni sisteme ge√ßiliyor...';
      
      for (const hasta of hastalar) {
        try {
          const sonuc = await hastayiAyriKaydet(hasta);
          if (sonuc) {
            basarili++;
          } else {
            hatali++;
          }
          
          // Rate limiting i√ßin bekleme
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // ƒ∞lerleme g√∂ster
          if (durum) {
            durum.innerHTML = `üíæ ƒ∞≈üleniyor: ${basarili + hatali}/${hastalar.length} hasta`;
          }
          
        } catch (error) {
          console.error(`${hasta.isim} kaydedilemedi:`, error);
          hatali++;
        }
      }
      
      if (durum) {
        durum.innerHTML = `‚úÖ Yeni sistem tamamlandƒ±: ${basarili} ba≈üarƒ±lƒ±, ${hatali} hatalƒ±`;
      }
      
      alert(`üéâ Yeni sisteme ge√ßi≈ü tamamlandƒ±!\n\n‚úÖ Ba≈üarƒ±lƒ±: ${basarili}\n‚ùå Hatalƒ±: ${hatali}\n\nArtƒ±k her hasta ayrƒ± JSON dosyasƒ±nda saklanƒ±yor.`);
      
      console.log('üéØ Yeni sistem bilgileri:');
      console.log('- Her hasta i√ßin ayrƒ± JSON dosyasƒ± olu≈üturuldu');
      console.log('- GitHub patients/ klas√∂r√ºnde saklaniyor');
      console.log('- 13+ hafta olan hastalar listede en altta g√∂r√ºn√ºr');
      console.log('- Manuel ar≈üivleme sistemi aktif');
    }

    async function uploadToGitHub() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) { 
        alert('‚ùå L√ºtfen √∂nce GitHub API token girin!'); 
        return; 
      }
      
      console.log('  Yeni sisteme g√∂re t√ºm hastalar kaydediliyor...');
      
      // Yeni sistemi kullan
      await tumHastalariAyriKaydet();
    }

    // --- E≈üle≈üme Yasaklarƒ± Paneli Fonksiyonlarƒ± ---
    const ESLESMEME_KURALLARI_KEY = 'lipedem_eslesmeme_kurallari';
    let eslesmemeKurallari = {};

    async function eslesmemeRegeleriPaneliGoster() {
      // Kartlarƒ± y√ºkle
      if (tariflerKlasoruGorselleri.length === 0) {
        await tariflerKlasoruGorselleriniYukle();
      }
      
      // Kart listesini doldur
      yasakKartListesiniGoster();
      
      // Arama i≈ülevi
      document.getElementById('yasakKartArama').oninput = function() {
        yasakKartListesiniGoster(this.value);
      };
      
      // E≈üle≈üme yasaklarƒ±nƒ± g√∂ster
      eslesmemeListesiniGoster();
      
      document.getElementById('eslesmemePanel').style.display = 'block';
    }

    function eslesmemeRegeleriPaneliGizle() {
      document.getElementById('eslesmemePanel').style.display = 'none';
      document.getElementById('yasakTarifAdi').value = '';
      document.getElementById('yasakKartArama').value = '';
      document.getElementById('eslesmemeStatus').style.display = 'none';
      yasakKartListesiniGoster(''); // Listeyi sƒ±fƒ±rla
    }

    function yasakKartListesiniGoster(aramaMetni = '') {
      const div = document.getElementById('yasakKartListesi');
      div.innerHTML = '';
      
      // Filtreleme
      const filtrelenmisKartlar = tariflerKlasoruGorselleri.filter(kart => {
        if (!aramaMetni) return true;
        return kart.name.toLowerCase().includes(aramaMetni.toLowerCase());
      });
      
      filtrelenmisKartlar.forEach(kart => {
        const label = document.createElement('label');
        label.style.cssText = 'display:block; margin:4px 0; cursor:pointer; padding:2px;';
        label.innerHTML = `
          <input type="checkbox" data-kart="${kart.name}" style="margin-right:8px;" />
          ${kart.name}
        `;
        div.appendChild(label);
      });
    }

    function eslesmemeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('eslesmemeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    function eslesmemeKuraliEkle() {
      const tarifAdi = document.getElementById('yasakTarifAdi').value.trim();
      const checkboxes = document.querySelectorAll('#yasakKartListesi input[type="checkbox"]:checked');
      const secilenKartlar = Array.from(checkboxes).map(cb => cb.getAttribute('data-kart'));
      
      if (!tarifAdi) {
        eslesmemeStatusGoster('Yemek adƒ± bo≈ü olamaz!', 'error');
        return;
      }
      
      if (secilenKartlar.length === 0) {
        eslesmemeStatusGoster('En az bir kart se√ßmelisiniz!', 'error');
        return;
      }
      
      // Normalize et
      function normalizeLocal(str) {
        return str
          .toLowerCase()
          .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
          .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i')
          .replace(/iÃá/g, 'i')
          .replace(/[_*\/()]/g, ' ')
          .replace(/\s+/g, ' ')
          .replace(/[^a-z0-9\s]/g, '')
          .trim();
      }
      
      const normalizeEdilmis = normalizeLocal(tarifAdi);
      
      // Kaydet
      eslesmemeKurallari[normalizeEdilmis] = {
        orijinalMetin: tarifAdi,
        yasakliKartlar: secilenKartlar,
        eklemeTarihi: new Date().toISOString()
      };
      
      eslesmemeKurallariniKaydet();
      eslesmemeListesiniGoster();
      
      eslesmemeStatusGoster(`‚úÖ Yasak eklendi! "${tarifAdi}" ‚Üí ${secilenKartlar.length} kart yasaklandƒ±`, 'success');
      
      // Formu temizle
      document.getElementById('yasakTarifAdi').value = '';
      document.querySelectorAll('#yasakKartListesi input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    function eslesmemeKurallariniKaydet() {
      try {
        localStorage.setItem(ESLESMEME_KURALLARI_KEY, JSON.stringify(eslesmemeKurallari));
        // Otomatik GitHub kaydƒ± (token varsa)
        const token = document.getElementById('githubToken').value.trim();
        if (token && Object.keys(eslesmemeKurallari).length > 0) {
          // 2 saniye bekle sonra otomatik kaydet
          setTimeout(() => {
            eslesmemeKurallariniGitHubKaydet(true); // true = sessiz kaydetme
          }, 2000);
        }
      } catch(e) {
        console.error('E≈üle≈üme yasaklarƒ± kaydetme hatasƒ±:', e);
      }
    }

    function eslesmemeKurallariniYukle() {
      try {
        const data = localStorage.getItem(ESLESMEME_KURALLARI_KEY);
        if (data) {
          eslesmemeKurallari = JSON.parse(data);
        }
      } catch(e) {
        console.error('E≈üle≈üme yasaklarƒ± y√ºkleme hatasƒ±:', e);
        eslesmemeKurallari = {};
      }
    }

    function eslesmemeKurallariniTemizle() {
      if (!confirm('T√ºm e≈üle≈üme yasaklarƒ±nƒ± silmek istediƒüinize emin misiniz?')) return;
      
      eslesmemeKurallari = {};
      eslesmemeKurallariniKaydet();
      eslesmemeListesiniGoster();
      eslesmemeStatusGoster('T√ºm e≈üle≈üme yasaklarƒ± temizlendi.', 'success');
    }

    function eslesmemeListesiniGoster() {
      const div = document.getElementById('eslesmemeListesi');
      div.innerHTML = '';
      
      const anahtarlar = Object.keys(eslesmemeKurallari);
      if (anahtarlar.length === 0) {
        div.innerHTML = '<em>Hen√ºz yasak yok</em>';
        return;
      }
      
      anahtarlar.forEach(anahtar => {
        const yasak = eslesmemeKurallari[anahtar];
        const yasakDiv = document.createElement('div');
        yasakDiv.style.cssText = 'border:1px solid #ddd; margin:8px 0; padding:8px; background:#fff; border-radius:4px;';
        yasakDiv.innerHTML = `
          <div style="font-weight:bold; color:#dc3545;">${yasak.orijinalMetin}</div>
          <div style="margin:5px 0; font-size:0.9em;">üö´ ${yasak.yasakliKartlar.join(', ')}</div>
          <button onclick="eslesmemeKuraliSil('${anahtar}')" style="background:#dc3545; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.8em; cursor:pointer;">Sil</button>
        `;
        div.appendChild(yasakDiv);
      });
    }

    function eslesmemeKuraliSil(anahtar) {
      if (!confirm('Bu yasaƒüƒ± silmek istediƒüinize emin misiniz?')) return;
      
      delete eslesmemeKurallari[anahtar];
      eslesmemeKurallariniKaydet();
      eslesmemeListesiniGoster();
      eslesmemeStatusGoster('Yasak silindi.', 'success');
    }

    // GitHub entegrasyonu i√ßin fonksiyonlar
    async function eslesmemeKurallariniGitHubKaydet(sessizKaydetme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizKaydetme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'nutrition-planner';
      const path = 'data/eslesmeme_kurallari.json';
      const branch = 'main';

      try {
        if (!sessizKaydetme) {
          eslesmemeStatusGoster('GitHub\'a kaydediliyor...', 'info');
        }

        // √ñnce mevcut dosyanƒ±n SHA'sƒ±nƒ± al
        let sha = undefined;
        try {
          const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          if (resp.ok) {
            const data = await resp.json();
            sha = data.sha;
          }
        } catch (e) {}

        // Veriyi hazƒ±rla
        const kayitVerisi = {
          version: '1.0',
          sonGuncelleme: new Date().toISOString(),
          eslesmemeKurallari: eslesmemeKurallari
        };

        // UTF-8 i√ßin doƒüru encoding
        const content = encodeUTF8ToBase64(kayitVerisi);

        // Dosyayƒ± y√ºkle
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'E≈üle≈üme yasaklarƒ± g√ºncellendi',
            content,
            branch,
            sha
          })
        });

        if (res.ok) {
          // Cache timestamp'ini g√ºncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizKaydetme) {
            eslesmemeStatusGoster('‚úÖ GitHub\'a ba≈üarƒ±yla kaydedildi!', 'success');
          }
        } else {
          throw new Error('GitHub kaydƒ± ba≈üarƒ±sƒ±z: ' + (await res.text()));
        }

      } catch (error) {
        console.error('GitHub kaydetme hatasƒ±:', error);
        if (!sessizKaydetme) {
          eslesmemeStatusGoster(`‚ùå GitHub kaydetme hatasƒ±: ${error.message}`, 'error');
        }
      }
    }

    async function eslesmemeKurallariniGitHubYukle(sessizYukleme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizYukleme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'nutrition-planner';
      const path = 'data/eslesmeme_kurallari.json';
      const branch = 'main';

      try {
        if (!sessizYukleme) {
          eslesmemeStatusGoster('GitHub\'dan y√ºkleniyor...', 'info');
        }

        const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (resp.ok) {
          const data = await resp.json();
          const jsonContent = decodeBase64UTF8(data.content);
          const kayitVerisi = JSON.parse(jsonContent);
          
          // Eski format kontrol√º
          if (kayitVerisi.eslesmemeKurallari) {
            eslesmemeKurallari = kayitVerisi.eslesmemeKurallari;
          } else {
            // Eski format (direkt object)
            eslesmemeKurallari = kayitVerisi;
          }
          
          // LocalStorage'a da kaydet
          localStorage.setItem(ESLESMEME_KURALLARI_KEY, JSON.stringify(eslesmemeKurallari));
          
          // Cache timestamp'ini g√ºncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          
          // Listeyi g√ºncelle (eƒüer panel a√ßƒ±ksa)
          if (document.getElementById('eslesmemePanel').style.display !== 'none') {
            eslesmemeListesiniGoster();
          }

          if (!sessizYukleme) {
            const kuralSayisi = Object.keys(eslesmemeKurallari).length;
            eslesmemeStatusGoster(`‚úÖ GitHub'dan ${kuralSayisi} yasak y√ºklendi!`, 'success');
          } else {
            const kuralSayisi = Object.keys(eslesmemeKurallari).length;
            console.log(`E≈üle≈üme yasaklarƒ± GitHub'dan g√ºncellendi: ${kuralSayisi} adet`);
          }

        } else if (resp.status === 404) {
          // Dosya hen√ºz yok, normal
          if (!sessizYukleme) {
            eslesmemeStatusGoster('‚ÑπÔ∏è GitHub\'da hen√ºz yasak dosyasƒ± yok', 'info');
          }
        } else {
          throw new Error('GitHub\'dan okuma ba≈üarƒ±sƒ±z: ' + resp.status);
        }

      } catch (error) {
        console.error('GitHub y√ºkleme hatasƒ±:', error);
        if (!sessizYukleme) {
          eslesmemeStatusGoster(`‚ùå GitHub y√ºkleme hatasƒ±: ${error.message}`, 'error');
        }
      }
    }

    // --- Manuel E≈üle≈ütirme Paneli Fonksiyonlarƒ± ---
    const MANUEL_ESLESTIRME_KEY = 'lipedem_manuel_eslestirmeler';
    let manuelEslestirmeler = {};

    // Global karakter d√ºzeltme fonksiyonu
    function karakterDuzelt(text) {
      if (!text) return text;
      return text
        .replace(/√Ñ¬±/g, 'ƒ±')
        .replace(/√Ñ/g, 'ƒü') 
        .replace(/√Ö/g, '≈ü')
        .replace(/ƒû/g, 'ƒü')
        .replace(/√É¬º/g, '√º')
        .replace(/√É¬∂/g, '√∂')
        .replace(/√É¬ß/g, '√ß')
        .replace(/√¢/g, 'a')
        .replace(/√Æ/g, 'i')
        .replace(/√ª/g, 'u')
        .replace(/√¥/g, 'o');
    }

    // Normalize fonksiyonu - Manuel e≈üle≈ütirme i√ßin
    function normalize(str) {
      return str
        .toLowerCase()
        .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
        .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i')
        .replace(/iÃá/g, 'i')
        .replace(/[_*\/()]/g, ' ')  // Sembolleri bo≈ülukla deƒüi≈ütir
        .replace(/\s+/g, ' ')       // √áoklu bo≈üluklarƒ± tek bo≈üluƒüa √ßevir
        .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve bo≈üluk bƒ±rak
        .trim();
    }

    function manuelEslestirmeleriYukle() {
      try {
        const data = localStorage.getItem(MANUEL_ESLESTIRME_KEY);
        if (data) {
          manuelEslestirmeler = JSON.parse(data);
        }
      } catch(e) {
        console.error('Manuel e≈üle≈ütirme y√ºkleme hatasƒ±:', e);
        manuelEslestirmeler = {};
      }
    }

    // Kaydetme throttle deƒüi≈ükenleri
    let kaydetmeZamanlayicisi = null;
    let gitHubKaydetmeDevamEdiyor = false;
    let sonKaydetmeZamani = 0;

    function manuelEslestirmeleriKaydet() {
      try {
        localStorage.setItem(MANUEL_ESLESTIRME_KEY, JSON.stringify(manuelEslestirmeler));
        console.log('üìÅ Manuel e≈üle≈ütirmeler localStorage\'a kaydedildi');
        
        // Otomatik GitHub kaydƒ± (token varsa)
        const token = document.getElementById('githubToken').value.trim();
        if (token && Object.keys(manuelEslestirmeler).length > 0) {
          const simdikiZaman = Date.now();
          const sonKaydetmedenGecenZaman = simdikiZaman - sonKaydetmeZamani;
          
          // Mevcut zamanlayƒ±cƒ±yƒ± iptal et
          if (kaydetmeZamanlayicisi) {
            clearTimeout(kaydetmeZamanlayicisi);
            console.log('üîÑ √ñnceki kaydetme zamanlayƒ±cƒ±sƒ± iptal edildi');
          }
          
          // Eƒüer son kaydetmeden 10 saniye ge√ßmemi≈üse, daha fazla bekle
          const beklemeZamani = sonKaydetmedenGecenZaman < 10000 ? 5000 : 3000;
          
          // Yeni zamanlayƒ±cƒ± ba≈ülat
          kaydetmeZamanlayicisi = setTimeout(async () => {
            if (!gitHubKaydetmeDevamEdiyor) {
              console.log(`‚è∞ Zamanlayƒ±cƒ± tetiklendi (${beklemeZamani}ms bekledikten sonra), GitHub\'a kaydediliyor...`);
              sonKaydetmeZamani = Date.now();
              await manuelEslestirmeleriGitHubKaydet(true); // true = sessiz kaydetme
            } else {
              console.log('‚ö†Ô∏è GitHub kaydetme devam ediyor, atlandƒ±');
            }
            kaydetmeZamanlayicisi = null;
          }, beklemeZamani);
          
          console.log(`‚è∞ GitHub kaydetme ${beklemeZamani}ms sonra yapƒ±lacak`);
        }
      } catch(e) {
        console.error('Manuel e≈üle≈ütirme kaydetme hatasƒ±:', e);
      }
    }

    async function manuelEslestirmePaneliGoster() {
      // Kartlarƒ± y√ºkle
      if (tariflerKlasoruGorselleri.length === 0) {
        await tariflerKlasoruGorselleriniYukle();
      }
      
      // Kart listesini doldur
      manuelKartListesiniGoster();
      
      // Arama i≈ülevi
      document.getElementById('manuelKartArama').oninput = function() {
        manuelKartListesiniGoster(this.value);
      };
      
      // Manuel e≈üle≈ütirmeleri g√∂ster (zaten y√ºkl√º olmalƒ±)
      manuelEslestirmeListesiniGoster();
      
      document.getElementById('manuelEslestirmePanel').style.display = 'block';
    }

    // E≈üle≈ümeyen tariften direkt manuel e≈üle≈ütirme
    async function eslesmeyenTarifManuelEslestir(tarifAdi) {
      console.log('üîó E≈üle≈ümeyen tarif i√ßin manuel e≈üle≈ütirme ba≈ülatƒ±lƒ±yor:', tarifAdi);
      
      // Manuel e≈üle≈ütirme panelini g√∂ster
      await manuelEslestirmePaneliGoster();
      
      // Sol kutucuƒüa tarif adƒ±nƒ± doldur
      const yeniTarifInput = document.getElementById('manuelTarifAdi');
      if (yeniTarifInput) {
        yeniTarifInput.value = tarifAdi;
        yeniTarifInput.focus();
      }
      
      // Saƒü tarafta arama kutucuƒüunu temizle (kullanƒ±cƒ± arayacak)
      const kartAramaInput = document.getElementById('eskiKartArama');
      if (kartAramaInput) {
        kartAramaInput.value = '';
        kartAramaInput.placeholder = `"${tarifAdi}" i√ßin e≈üle≈üecek kartƒ± ara...`;
      }
      
      // Kullanƒ±cƒ±ya bilgilendirme
      const statusDiv = document.getElementById('manuelEslestirmeStatus');
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
        statusDiv.innerHTML = `
          <strong>üéØ E≈üle≈ümeyen Tarif Se√ßildi:</strong> "${tarifAdi}"<br>
          <small>Saƒüdaki arama kutusundan uygun kartƒ± bulup e≈üle≈ütirin. E≈üle≈ütirme sonrasƒ± bu tarif "E≈üle≈ümeyenler" listesinden kaldƒ±rƒ±lacak.</small>
        `;
      }
    }

    // E≈üle≈üen tariften direkt manuel e≈üle≈ütirme (d√ºzenleme i√ßin)
    async function eslesenTarifManuelEslestir(tarifAdi, eslesenKartlar) {
      console.log('üîß E≈üle≈üen tarif i√ßin manuel e≈üle≈ütirme d√ºzenleme ba≈ülatƒ±lƒ±yor:', tarifAdi, eslesenKartlar);
      
      // Manuel e≈üle≈ütirme panelini g√∂ster
      await manuelEslestirmePaneliGoster();
      
      // Sol kutucuƒüa tarif adƒ±nƒ± doldur
      const yeniTarifInput = document.getElementById('manuelTarifAdi');
      if (yeniTarifInput) {
        yeniTarifInput.value = tarifAdi;
      }
      
      // Saƒü tarafta arama kutucuƒüunu temizle
      const kartAramaInput = document.getElementById('eskiKartArama');
      if (kartAramaInput) {
        kartAramaInput.value = '';
        kartAramaInput.placeholder = `"${tarifAdi}" i√ßin e≈üle≈üecek kartlarƒ± d√ºzenle...`;
      }
      
      // E≈üle≈üen kartlarƒ± otomatik se√ß
      setTimeout(() => {
        const kartCheckboxes = document.querySelectorAll('#manuelKartListesi input[type="checkbox"]');
        const secilenKartIsimleri = eslesenKartlar.map(kart => kart.name || kart.kartResmi);
        
        kartCheckboxes.forEach(checkbox => {
          const kartAdi = checkbox.getAttribute('data-kart');
          if (secilenKartIsimleri.includes(kartAdi)) {
            checkbox.checked = true;
            console.log('‚úÖ Kart otomatik se√ßildi:', kartAdi);
          }
        });
        
        console.log('üéØ Otomatik se√ßilen kartlar:', secilenKartIsimleri);
      }, 500); // Kartlarƒ±n y√ºklenmesi i√ßin kƒ±sa bir bekleme
      
      // Kullanƒ±cƒ±ya bilgilendirme
      const statusDiv = document.getElementById('manuelEslestirmeStatus');
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
        statusDiv.innerHTML = `
          <strong>üîß E≈üle≈üen Tarif D√ºzenleniyor:</strong> "${tarifAdi}"<br>
          <small>Mevcut e≈üle≈üen kartlar otomatik se√ßildi. ƒ∞stediƒüiniz deƒüi≈üiklikleri yapƒ±p kaydedin.</small>
        `;
      }
    }

    // Manuel e≈üle≈ütirme paneli i√ßin dinamik kart arama
    function manuelEslestirmeKartAra(aramaMetni) {
      console.log('üîç Manuel e≈üle≈ütirme kart arama:', aramaMetni);
      manuelKartListesiniGoster(aramaMetni);
    }

    function manuelKartListesiniGoster(aramaMetni = '') {
      const div = document.getElementById('manuelKartListesi');
      div.innerHTML = '';

      console.log('üîç Manuel kart listesi g√∂steriliyor, arama metni:', aramaMetni);
      
      // Arama metnini kelimelere ayƒ±r ve t√ºrk√ße karakterleri normalize et
      const aramaKelimeleri = aramaMetni.trim().split(/\s+/).filter(k => k.length > 0)
        .map(kelime => karakterDuzelt(kelime.toLowerCase()));
      
      console.log('üîç Arama kelimeleri:', aramaKelimeleri);
      
      // Filtreleme fonksiyonu
      function kartEslesiyorMu(kartAdi) {
        if (aramaKelimeleri.length === 0) return true;
        
        const kartMetni = karakterDuzelt(kartAdi.toLowerCase())
          .replace(/\.(jpg|jpeg|png)$/i, '') // dosya uzantƒ±sƒ±nƒ± kaldƒ±r
          .replace(/_/g, ' '); // alt √ßizgileri bo≈üluƒüa √ßevir
        
        // T√ºm arama kelimelerinin kart adƒ±nda bulunup bulunmadƒ±ƒüƒ±nƒ± kontrol et
        const eslesiyor = aramaKelimeleri.every(kelime => kartMetni.includes(kelime));
        
        if (aramaKelimeleri.length > 0) {
          console.log(`üîé "${kartAdi}" ‚Üí "${kartMetni}" e≈üle≈üme: ${eslesiyor}`);
        }
        
        return eslesiyor;
      }
      
      // Filtreleme
      const filtrelenmisKartlar = tariflerKlasoruGorselleri.filter(kart => 
        kartEslesiyorMu(kart.name)
      );
      
      console.log(`üìã Filtrelenmi≈ü kart sayƒ±sƒ±: ${filtrelenmisKartlar.length}`);
      
      // Sonu√ßlarƒ± e≈üle≈üme skoruna g√∂re sƒ±rala
      if (aramaKelimeleri.length > 0) {
        filtrelenmisKartlar.sort((a, b) => {
          const aAdi = karakterDuzelt(a.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
          const bAdi = karakterDuzelt(b.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
          
          // Tam arama metni e≈üle≈ümesi
          const aramaTam = aramaKelimeleri.join(' ');
          const aIceriyor = aAdi.includes(aramaTam);
          const bIceriyor = bAdi.includes(aramaTam);
          
          if (aIceriyor && !bIceriyor) return -1;
          if (!aIceriyor && bIceriyor) return 1;
          
          // Ba≈ülangƒ±√ß e≈üle≈ümesi
          const aBaslangic = aramaKelimeleri.some(kelime => aAdi.startsWith(kelime));
          const bBaslangic = aramaKelimeleri.some(kelime => bAdi.startsWith(kelime));
          
          if (aBaslangic && !bBaslangic) return -1;
          if (!aBaslangic && bBaslangic) return 1;
          
          // Alfabetik sƒ±ralama
          return a.name.localeCompare(b.name, 'tr-TR');
        });
      }
      
      filtrelenmisKartlar.forEach(kart => {
        const label = document.createElement('label');
        label.style.cssText = 'display:block; margin:4px 0; cursor:pointer; padding:2px;';
        
        const duzeltilmisKartAdi = kart.name; // Artƒ±k karakterDuzelt global fonksiyonu kullanƒ±lƒ±yor
        
        label.innerHTML = `
          <input type="checkbox" data-kart="${kart.name}" style="margin-right:8px;" />
          ${duzeltilmisKartAdi}
        `;
        div.appendChild(label);
      });
    }

    function manuelEslestirmePaneliGizle() {
      const panel = document.getElementById('manuelEslestirmePanel');
      const tarifAdi = document.getElementById('manuelTarifAdi');
      const kartSecimi = document.getElementById('manuelKartSecimi');
      const status = document.getElementById('manuelEslestirmeStatus');
      
      if (panel) panel.style.display = 'none';
      if (tarifAdi) tarifAdi.value = '';
      if (kartSecimi) kartSecimi.selectedIndex = -1;
      if (status) status.style.display = 'none';
    }

    function manuelEslestirmeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('manuelEslestirmeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    function manuelEslestirmeEkle() {
      const tarifAdi = document.getElementById('manuelTarifAdi').value.trim();
      const checkboxes = document.querySelectorAll('#manuelKartListesi input[type="checkbox"]:checked');
      const secilenKartlar = Array.from(checkboxes).map(cb => cb.getAttribute('data-kart'));
      
      if (!tarifAdi) {
        manuelEslestirmeStatusGoster('Yemek adƒ± bo≈ü olamaz!', 'error');
        return;
      }
      
      if (secilenKartlar.length === 0) {
        manuelEslestirmeStatusGoster('En az bir kart se√ßmelisiniz!', 'error');
        return;
      }
      
      // Normalize et - fonksiyonu burada tanƒ±mla
      function normalizeLocal(str) {
        return str
          .toLowerCase()
          .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
          .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i')
          .replace(/iÃá/g, 'i')
          .replace(/[_*\/()]/g, ' ')  // Sembolleri bo≈ülukla deƒüi≈ütir
          .replace(/\s+/g, ' ')       // √áoklu bo≈üluklarƒ± tek bo≈üluƒüa √ßevir
          .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve bo≈üluk bƒ±rak
          .trim();
      }
      
      const normalizeEdilmis = normalizeLocal(tarifAdi);
      
      // Kaydet
      manuelEslestirmeler[normalizeEdilmis] = {
        orijinalMetin: tarifAdi,
        kartlar: secilenKartlar,
        eklemeTarihi: new Date().toISOString()
      };
      
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();

      // Karakter d√ºzeltme fonksiyonu
      function karakterDuzelt(text) {
        if (!text) return text;
        return text
          .replace(/√Ñ¬±/g, 'ƒ±')
          .replace(/√Ñ/g, 'ƒü') 
          .replace(/√Ö/g, '≈ü')
          .replace(/ƒû/g, 'ƒü')
          .replace(/√É¬º/g, '√º')
          .replace(/√É¬∂/g, '√∂')
          .replace(/√É¬ß/g, '√ß')
          .replace(/√¢/g, 'a')
          .replace(/√Æ/g, 'i')
          .replace(/√ª/g, 'u')
          .replace(/√¥/g, 'o');
      }
      
      const duzeltilmisMetin = karakterDuzelt(tarifAdi);
      manuelEslestirmeStatusGoster(`‚úÖ E≈üle≈ütirme eklendi! "${duzeltilmisMetin}" ‚Üí ${secilenKartlar.length} kart`, 'success');
      
      // E≈üle≈ümeyenler listesini g√ºncelle - eklenen tarifi kaldƒ±r
      eslesmeyenlerListesiniGuncelle();
      
      // Formu temizle
      document.getElementById('manuelTarifAdi').value = '';
      document.querySelectorAll('#manuelKartListesi input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    function manuelEslestirmeleriTemizle() {
      if (!confirm('T√ºm manuel e≈üle≈ütirmeleri silmek istediƒüinize emin misiniz?')) return;
      
      manuelEslestirmeler = {};
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeStatusGoster('T√ºm manuel e≈üle≈ütirmeler temizlendi.', 'success');
    }

    function manuelEslestirmeListesiniGoster() {
      const div = document.getElementById('manuelEslestirmeListesi');
      div.innerHTML = '';
      
      const anahtarlar = Object.keys(manuelEslestirmeler);
      if (anahtarlar.length === 0) {
        div.innerHTML = '<em>Hen√ºz manuel e≈üle≈ütirme yok</em>';
        return;
      }

    function manuelEslestirmeSil(anahtar) {
      console.log('üóëÔ∏è Silme i≈ülemi ba≈ülatƒ±ldƒ±, anahtar:', anahtar);
      
      if (!confirm('Bu e≈üle≈ütirmeyi silmek istediƒüinize emin misiniz?')) {
        console.log('‚ùå Kullanƒ±cƒ± silme i≈ülemini iptal etti');
        return;
      }
      
      console.log('‚úÖ Kullanƒ±cƒ± silme i≈ülemini onayladƒ±');
      delete manuelEslestirmeler[anahtar];
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeStatusGoster('E≈üle≈ütirme silindi.', 'success');
      
      // E≈üle≈ütirme silindiƒüinde e≈üle≈ümeyenler listesini g√ºncelle
      eslesmeyenlerListesiniGuncelle();
      console.log('üîÑ Silme i≈ülemi tamamlandƒ±');
    }

    function manuelEslestirmeListesiniGoster() {
      const div = document.getElementById('manuelEslestirmeListesi');
      div.innerHTML = '';
      
      const anahtarlar = Object.keys(manuelEslestirmeler);
      if (anahtarlar.length === 0) {
        div.innerHTML = '<em>Hen√ºz manuel e≈üle≈ütirme yok</em>';
        return;
      }

      // Karakter d√ºzeltme fonksiyonu
      function karakterDuzelt(text) {
        if (!text) return text;
        return text
          .replace(/√Ñ¬±/g, 'ƒ±')
          .replace(/√Ñ/g, 'ƒü') 
          .replace(/√Ö/g, '≈ü')
          .replace(/ƒû/g, 'ƒü')
          .replace(/√É¬º/g, '√º')
          .replace(/√É¬∂/g, '√∂')
          .replace(/√É¬ß/g, '√ß')
          .replace(/√¢/g, 'a')
          .replace(/√Æ/g, 'i')
          .replace(/√ª/g, 'u')
          .replace(/√¥/g, 'o');
      }
      
      anahtarlar.forEach(anahtar => {
        const eslestirme = manuelEslestirmeler[anahtar];
        const eslestirmeDiv = document.createElement('div');
        eslestirmeDiv.style.cssText = 'border:1px solid #ddd; margin:8px 0; padding:8px; background:#fff; border-radius:4px;';
        
        // Orijinal metni ve kartlarƒ± d√ºzelt
        const duzeltilmisMetin = karakterDuzelt(eslestirme.orijinalMetin);
        const duzeltilmisKartlar = eslestirme.kartlar.map(kart => karakterDuzelt(kart));
        
        eslestirmeDiv.innerHTML = `
          <div style="font-weight:bold; color:#28a745;">${duzeltilmisMetin}</div>
          <div style="margin:5px 0; font-size:0.9em;">‚Üí ${duzeltilmisKartlar.join(', ')}</div>
          <div style="display:flex; gap:8px; margin-top:5px;">
            <button class="duzenle-btn" style="background:#17a2b8; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.8em; cursor:pointer;">‚úèÔ∏è D√ºzenle</button>
            <button class="sil-btn" style="background:#dc3545; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.8em; cursor:pointer;">üóëÔ∏è Sil</button>
          </div>
        `;
        
        // Event listener'larƒ± g√ºvenli ≈üekilde ekle
        const duzenleBtn = eslestirmeDiv.querySelector('.duzenle-btn');
        const silBtn = eslestirmeDiv.querySelector('.sil-btn');
        
        if (duzenleBtn && silBtn) {
          duzenleBtn.addEventListener('click', () => {
            console.log('üîß D√ºzenle butonuna tƒ±klandƒ±, anahtar:', anahtar);
            manuelEslestirmeDuzenle(anahtar);
          });
          
          silBtn.addEventListener('click', () => {
            console.log('üóëÔ∏è Sil butonuna tƒ±klandƒ±, anahtar:', anahtar);
            manuelEslestirmeSil(anahtar);
          });
          
          console.log('‚úÖ Event listener\'lar eklendi, anahtar:', anahtar);
        } else {
          console.error('‚ùå Butonlar bulunamadƒ±!', { duzenleBtn, silBtn });
        }
        
        div.appendChild(eslestirmeDiv);
      });
    }
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeStatusGoster('E≈üle≈ütirme silindi.', 'success');
    }

    function manuelEslestirmeDuzenle(anahtar) {
      // Mevcut e≈üle≈ütirme verilerini al
      const mevcutEslestirme = manuelEslestirmeler[anahtar];
      if (!mevcutEslestirme) {
        alert('E≈üle≈ütirme bulunamadƒ±!');
        return;
      }

      // D√ºzenle modalƒ± olu≈ütur
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <h3 style="margin-bottom: 20px; color: #17a2b8;">‚úèÔ∏è Manuel E≈üle≈ütirme D√ºzenle</h3>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Tarif Adƒ±:</label>
            <input type="text" id="duzenleOrijinalMetin" value="${karakterDuzelt(mevcutEslestirme.orijinalMetin)}" 
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">E≈üle≈üen Kartlar (virg√ºlle ayƒ±rƒ±n):</label>
            <textarea id="duzenleKartlar" rows="4" 
                      style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;">${mevcutEslestirme.kartlar.map(kart => karakterDuzelt(kart)).join(', ')}</textarea>
            <small style="color: #666;">√ñrnek: karnƒ±yarƒ±k, patlƒ±can yemeƒüi, et yemeƒüi</small>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
            <button onclick="manuelEslestirmeDuzenleKaydet('${anahtar}')" 
                    style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
              ‚úÖ Kaydet
            </button>
            <button onclick="manuelEslestirmeDuzenleYeniKaydet('${anahtar}')" 
                    style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
              ‚ûï Yeni Kaydet
            </button>
            <button onclick="manuelEslestirmeDuzenleIptal()" 
                    style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
              ‚ùå ƒ∞ptal
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      window.currentEditModal = modal;
      
      // ƒ∞lk input'a odaklan
      setTimeout(() => {
        document.getElementById('duzenleOrijinalMetin').focus();
      }, 100);
    }

    function manuelEslestirmeDuzenleKaydet(eskiAnahtar) {
      const yeniOrijinalMetin = document.getElementById('duzenleOrijinalMetin').value.trim();
      const yeniKartlarMetin = document.getElementById('duzenleKartlar').value.trim();

      if (!yeniOrijinalMetin || !yeniKartlarMetin) {
        alert('L√ºtfen t√ºm alanlarƒ± doldurun!');
        return;
      }

      // Kartlarƒ± virg√ºlle ayƒ±r ve temizle
      const yeniKartlar = yeniKartlarMetin.split(',').map(kart => kart.trim()).filter(kart => kart.length > 0);
      
      if (yeniKartlar.length === 0) {
        alert('En az bir kart adƒ± girmelisiniz!');
        return;
      }

      // Yeni anahtar olu≈ütur
      const yeniAnahtar = normalize(yeniOrijinalMetin);
      
      // Anahtar deƒüi≈ümi≈üse ve yeni anahtar zaten varsa uyar
      if (eskiAnahtar !== yeniAnahtar && manuelEslestirmeler[yeniAnahtar]) {
        if (!confirm('Bu tarif adƒ± zaten mevcut! Mevcut e≈üle≈ütirmeyi g√ºncellemek istediƒüinize emin misiniz?')) {
          return;
        }
      }

      // Eski e≈üle≈ütirmeyi sil (anahtar deƒüi≈ümi≈üse)
      if (eskiAnahtar !== yeniAnahtar) {
        delete manuelEslestirmeler[eskiAnahtar];
      }

      // Yeni e≈üle≈ütirmeyi kaydet
      manuelEslestirmeler[yeniAnahtar] = {
        orijinalMetin: yeniOrijinalMetin,
        kartlar: yeniKartlar
      };

      // Kaydet ve g√ºncelle
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeDuzenleIptal();
      
      manuelEslestirmeStatusGoster('E≈üle≈ütirme ba≈üarƒ±yla g√ºncellendi!', 'success');
    }

    function manuelEslestirmeDuzenleYeniKaydet(eskiAnahtar) {
      console.log('‚ûï Yeni e≈üle≈ütirme olarak kaydetme ba≈ülatƒ±ldƒ±, eski anahtar:', eskiAnahtar);
      
      const yeniOrijinalMetin = document.getElementById('duzenleOrijinalMetin').value.trim();
      const yeniKartlarMetin = document.getElementById('duzenleKartlar').value.trim();

      if (!yeniOrijinalMetin || !yeniKartlarMetin) {
        alert('L√ºtfen t√ºm alanlarƒ± doldurun!');
        return;
      }

      // Kartlarƒ± virg√ºlle ayƒ±r ve temizle
      const yeniKartlar = yeniKartlarMetin.split(',').map(kart => kart.trim()).filter(kart => kart.length > 0);
      
      if (yeniKartlar.length === 0) {
        alert('En az bir kart adƒ± girmelisiniz!');
        return;
      }

      // Yeni anahtar olu≈ütur
      function normalize(str) {
        return str
          .toLowerCase()
          .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
          .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i')
          .replace(/iÃá/g, 'i')
          .replace(/[_*\/()]/g, ' ')
          .replace(/\s+/g, ' ')
          .replace(/[^a-z0-9\s]/g, '')
          .trim();
      }
      
      const yeniAnahtar = normalize(yeniOrijinalMetin);
      
      // Yeni anahtar zaten varsa uyar
      if (manuelEslestirmeler[yeniAnahtar]) {
        if (!confirm('Bu tarif adƒ± zaten mevcut! Mevcut e≈üle≈ütirmeyi g√ºncellemek istediƒüinize emin misiniz?')) {
          return;
        }
      }

      // Yeni e≈üle≈ütirmeyi kaydet (eski e≈üle≈ütirmeyi silme!)
      manuelEslestirmeler[yeniAnahtar] = {
        orijinalMetin: yeniOrijinalMetin,
        kartlar: yeniKartlar,
        eklemeTarihi: new Date().toISOString()
      };

      // Kaydet ve g√ºncelle
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeDuzenleIptal();
      
      manuelEslestirmeStatusGoster(`‚úÖ Yeni e≈üle≈ütirme olu≈üturuldu: "${yeniOrijinalMetin}" ‚Üí ${yeniKartlar.length} kart`, 'success');
      
      // E≈üle≈ümeyenler listesini g√ºncelle (yeni e≈üle≈ütirme eklendiƒüinde)
      eslesmeyenlerListesiniGuncelle();
      
      console.log('‚úÖ Yeni e≈üle≈ütirme ba≈üarƒ±yla olu≈üturuldu:', yeniAnahtar);
    }

    function manuelEslestirmeDuzenleIptal() {
      if (window.currentEditModal) {
        document.body.removeChild(window.currentEditModal);
        window.currentEditModal = null;
      }
    }

    // Sayfa y√ºklenirken manuel e≈üle≈ütirmeleri y√ºkle
    window.addEventListener('DOMContentLoaded', function() {
      // Bu fonksiyon yukarƒ±da initManuelEslestirmeler() ile birle≈ütirildi
      // √áift y√ºklemeyi √∂nlemek i√ßin kaldƒ±rƒ±ldƒ±
    });

    // GitHub'a manuel e≈üle≈ütirmeleri kaydetme
    async function manuelEslestirmeleriGitHubKaydet(sessizKaydetme = false) {
      // Zaten kaydetme devam ediyorsa √ßƒ±k
      if (gitHubKaydetmeDevamEdiyor) {
        if (!sessizKaydetme) {
          console.log('‚ö†Ô∏è GitHub kaydetme zaten devam ediyor, i≈ülem atlandƒ±');
        }
        return;
      }
      
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizKaydetme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      // Kaydetme ba≈üladƒ± i≈üaretini koy
      gitHubKaydetmeDevamEdiyor = true;

      const owner = 'mustafasacar35';
      const repo = 'nutrition-planner';
      const path = 'data/manuel_eslestirmeler.json';
      const branch = 'main';

      try {
        if (!sessizKaydetme) {
          manuelEslestirmeStatusGoster('GitHub\'a kaydediliyor...', 'info');
        }

        // √ñnce mevcut dosyanƒ±n SHA'sƒ±nƒ± al (g√ºncelleme i√ßin gerekli)
        let sha = undefined;
        try {
          const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          if (resp.ok) {
            const data = await resp.json();
            sha = data.sha;
          }
        } catch (e) {}

        // Veriyi hazƒ±rla
        const kayitVerisi = {
          version: '1.0',
          sonGuncelleme: new Date().toISOString(),
          eslestirmeler: manuelEslestirmeler
        };

        // UTF-8 i√ßin doƒüru encoding
        const content = encodeUTF8ToBase64(kayitVerisi);

        // Dosyayƒ± y√ºkle
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Manuel e≈üle≈ütirmeler g√ºncellendi',
            content,
            branch,
            sha
          })
        });

        if (res.ok) {
          // Cache timestamp'ini g√ºncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizKaydetme) {
            manuelEslestirmeStatusGoster('‚úÖ GitHub\'a ba≈üarƒ±yla kaydedildi!', 'success');
          }
          console.log('‚úÖ GitHub kaydetme ba≈üarƒ±lƒ± - durum sƒ±fƒ±rlanacak');
        } else {
          throw new Error('GitHub kaydƒ± ba≈üarƒ±sƒ±z: ' + (await res.text()));
        }

      } catch (error) {
        console.error('GitHub kaydetme hatasƒ±:', error);
        
        // SHA conflict hatasƒ± varsa dosyayƒ± tekrar √ßek ve tekrar dene
        if (error.message && error.message.includes('but expected')) {
          console.log('üîÑ SHA conflict, tekrar deneniyor...');
          try {
            // En g√ºncel SHA'yƒ± al
            const sharedResp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
              headers: { 'Authorization': `token ${token}` }
            });
            
            if (sharedResp.ok) {
              const sharedData = await sharedResp.json();
              const guncelSha = sharedData.sha;
              
              console.log('üîÑ G√ºncel SHA alƒ±ndƒ±, tekrar kaydediliyor...');
              
              // Tekrar dene - aynƒ± veri yapƒ±sƒ±nƒ± kullan
              const retryKayitVerisi = {
                version: '1.0',
                sonGuncelleme: new Date().toISOString(),
                eslestirmeler: manuelEslestirmeler
              };
              
              const retryRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                method: 'PUT',
                headers: {
                  'Authorization': `token ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: 'Manuel e≈üle≈ütirmeler g√ºncellendi (retry)',
                  content: encodeUTF8ToBase64(retryKayitVerisi),
                  branch,
                  sha: guncelSha
                })
              });
              
              if (retryRes.ok) {
                console.log('‚úÖ Retry ba≈üarƒ±lƒ± - GitHub\'a kaydedildi!');
                localStorage.setItem('lastGithubUpdate', Date.now().toString());
                if (!sessizKaydetme) {
                  manuelEslestirmeStatusGoster('‚úÖ GitHub\'a ba≈üarƒ±yla kaydedildi! (retry)', 'success');
                }
                // Ba≈üarƒ±lƒ± retry sonrasƒ± da durumu sƒ±fƒ±rla
                gitHubKaydetmeDevamEdiyor = false;
                return;
              } else {
                console.error('‚ùå Retry de ba≈üarƒ±sƒ±z oldu:', await retryRes.text());
              }
            }
          } catch (retryError) {
            console.error('‚ùå Retry de ba≈üarƒ±sƒ±z:', retryError);
          }
        }
        
        if (!sessizKaydetme) {
          manuelEslestirmeStatusGoster(`‚ùå GitHub kaydetme hatasƒ±: ${error.message}`, 'error');
        }
      } finally {
        // Kaydetme durumunu her durumda sƒ±fƒ±rla
        gitHubKaydetmeDevamEdiyor = false;
        console.log('üîÑ GitHub kaydetme durumu sƒ±fƒ±rlandƒ±');
      }
    }

    // GitHub'dan manuel e≈üle≈ütirmeleri y√ºkleme
    async function manuelEslestirmeleriGitHubYukle(sessizYukleme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizYukleme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'nutrition-planner';
      const path = 'data/manuel_eslestirmeler.json';
      const branch = 'main';

      try {
        if (!sessizYukleme) {
          manuelEslestirmeStatusGoster('GitHub\'dan y√ºkleniyor...', 'info');
        }

        const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (resp.ok) {
          const data = await resp.json();
          const jsonContent = decodeBase64UTF8(data.content);
          const kayitVerisi = JSON.parse(jsonContent);
          
          // Eski format kontrol√º
          if (kayitVerisi.eslestirmeler) {
            manuelEslestirmeler = kayitVerisi.eslestirmeler;
          } else {
            // Eski format (direkt object)
            manuelEslestirmeler = kayitVerisi;
          }
          
          // LocalStorage'a da kaydet
          localStorage.setItem(MANUEL_ESLESTIRME_KEY, JSON.stringify(manuelEslestirmeler));
          
          // Cache timestamp'ini g√ºncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          
          // Listeyi g√ºncelle (eƒüer panel a√ßƒ±ksa)
          if (document.getElementById('manuelEslestirmePanel').style.display !== 'none') {
            manuelEslestirmeListesiniGoster();
          }

          if (!sessizYukleme) {
            const eslestirmeSayisi = Object.keys(manuelEslestirmeler).length;
            manuelEslestirmeStatusGoster(`‚úÖ GitHub'dan ${eslestirmeSayisi} e≈üle≈ütirme y√ºklendi!`, 'success');
          } else {
            // Sessiz y√ºkleme olsa bile konsola yazdƒ±r
            const eslestirmeSayisi = Object.keys(manuelEslestirmeler).length;
            console.log(`Manuel e≈üle≈ütirmeler GitHub'dan g√ºncellendi: ${eslestirmeSayisi} adet`);
          }

        } else if (resp.status === 404) {
          // Dosya hen√ºz yok, normal
          if (!sessizYukleme) {
            manuelEslestirmeStatusGoster('‚ÑπÔ∏è GitHub\'da hen√ºz e≈üle≈ütirme dosyasƒ± yok', 'info');
          }
        } else {
          throw new Error('GitHub\'dan okuma ba≈üarƒ±sƒ±z: ' + resp.status);
        }

      } catch (error) {
        console.error('GitHub y√ºkleme hatasƒ±:', error);
        if (!sessizYukleme) {
          manuelEslestirmeStatusGoster(`‚ùå GitHub y√ºkleme hatasƒ±: ${error.message}`, 'error');
        }
      }
    }

    // --- Kart Silme Fonksiyonlarƒ± ---
    function kartSilFormGoster() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('√ñnce GitHub API token girin!');
        return;
      }
      
      // Mevcut kartlarƒ± listele
      kartListesiniYenile();
      document.getElementById('kartSilFormu').style.display = 'block';
    }

    function kartSilFormGizle() {
      document.getElementById('kartSilFormu').style.display = 'none';
      document.getElementById('silinecekKart').value = '';
      document.getElementById('kartAramaInput').value = '';
      document.getElementById('onizlemeAlani').innerHTML = '';
      document.getElementById('silmeStatus').style.display = 'none';
    }

    async function kartListesiniYenile() {
      const select = document.getElementById('silinecekKart');
      const aramaInput = document.getElementById('kartAramaInput');
      
      // Eƒüer tarifler listesi bo≈üsa y√ºkle
      if (tariflerKlasoruGorselleri.length === 0) {
        await tariflerKlasoruGorselleriniYukle();
      }
      
      // T√ºm kartlarƒ± sakla (filtreleme i√ßin)
      window.tumKartListesi = [...tariflerKlasoruGorselleri];
      
      // ƒ∞lk y√ºklemede t√ºm kartlarƒ± g√∂ster
      kartListesiniFiltrele('');
      
      // Arama input'una olay dinleyicisi ekle
      aramaInput.oninput = function() {
        const aramaMetni = this.value.toLowerCase();
        kartListesiniFiltrele(aramaMetni);
      };
      
      // Kart se√ßildiƒüinde √∂nizleme g√∂ster
      select.onchange = function() {
        kartOnizlemeGoster(this.value);
      };
    }

    function kartListesiniFiltrele(aramaMetni) {
      const select = document.getElementById('silinecekKart');
      select.innerHTML = '<option value="">Kart se√ßin...</option>';
      
      if (!window.tumKartListesi) return;
      
      // Arama metnini kelimelere ayƒ±r ve t√ºrk√ße karakterleri normalize et
      const aramaKelimeleri = aramaMetni.trim().split(/\s+/).filter(k => k.length > 0)
        .map(kelime => karakterDuzelt(kelime.toLowerCase()));
      
      console.log('üîç Arama kelimeleri:', aramaKelimeleri);
      
      // Filtreleme fonksiyonu
      function kartEslesiyorMu(kartAdi) {
        if (aramaKelimeleri.length === 0) return true;
        
        const kartMetni = karakterDuzelt(kartAdi.toLowerCase())
          .replace(/\.(jpg|jpeg|png)$/i, '') // dosya uzantƒ±sƒ±nƒ± kaldƒ±r
          .replace(/_/g, ' '); // alt √ßizgileri bo≈üluƒüa √ßevir
        
        console.log(`üîé Kart "${kartAdi}" test ediliyor: "${kartMetni}"`);
        
        // T√ºm arama kelimelerinin kart adƒ±nda bulunup bulunmadƒ±ƒüƒ±nƒ± kontrol et
        const eslesiyor = aramaKelimeleri.every(kelime => {
          const eslesme = kartMetni.includes(kelime);
          console.log(`  ‚úì "${kelime}" kelimesi "${kartMetni}" i√ßinde: ${eslesme}`);
          return eslesme;
        });
        
        console.log(`üìä "${kartAdi}" sonu√ß: ${eslesiyor}`);
        return eslesiyor;
      }
      
      // Filtrelenmi≈ü kartlarƒ± ekle
      const filtrelenmisKartlar = window.tumKartListesi.filter(kart => 
        kartEslesiyorMu(kart.name)
      );
      
      console.log(`üìã Filtrelenmi≈ü kart sayƒ±sƒ±: ${filtrelenmisKartlar.length}`);
      
      // E≈üle≈üme skoruna g√∂re sƒ±rala (daha iyi e≈üle≈üenler √ºstte)
      filtrelenmisKartlar.sort((a, b) => {
        const aMetni = karakterDuzelt(a.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
        const bMetni = karakterDuzelt(b.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
        
        // Tam e≈üle≈üme kontrol√º
        if (aramaKelimeleri.length > 0) {
          const aramaMetniTam = aramaKelimeleri.join(' ');
          const aIceriyor = aMetni.includes(aramaMetniTam);
          const bIceriyor = bMetni.includes(aramaMetniTam);
          
          if (aIceriyor && !bIceriyor) return -1;
          if (!aIceriyor && bIceriyor) return 1;
        }
        
        // Alfabetik sƒ±ralama
        return a.name.localeCompare(b.name, 'tr-TR');
      });
      
      // Se√ßenekleri ekle
      filtrelenmisKartlar.forEach(kart => {
        const option = document.createElement('option');
        option.value = kart.name;
        option.textContent = kart.name;
        
        // E≈üle≈üen kelimeleri vurgula (sadece g√∂rsel ama√ßlƒ±)
        if (aramaKelimeleri.length > 0) {
          let vurguluMetin = kart.name;
          aramaKelimeleri.forEach(kelime => {
            const regex = new RegExp(`(${kelime})`, 'gi');
            vurguluMetin = vurguluMetin.replace(regex, '‚Üí$1‚Üê');
          });
          option.setAttribute('title', vurguluMetin.replace(/‚Üí/g, '').replace(/‚Üê/g, ''));
        }
        
        select.appendChild(option);
      });
      
      // Sonu√ß sayƒ±sƒ±nƒ± g√∂ster
      const sonucSayisi = filtrelenmisKartlar.length;
      if (aramaMetni && sonucSayisi === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'E≈üle≈üen kart bulunamadƒ±';
        option.disabled = true;
        select.appendChild(option);
      }
    }

    function kartOnizlemeGoster(seciliKart) {
      const onizleme = document.getElementById('onizlemeAlani');
      onizleme.innerHTML = '';
      
      if (seciliKart && window.tumKartListesi) {
        const kartBilgisi = window.tumKartListesi.find(k => k.name === seciliKart);
        if (kartBilgisi) {
          onizleme.innerHTML = `
            <p><strong>Silinecek kart:</strong> ${seciliKart}</p>
            <img src="${kartBilgisi.url}" alt="${seciliKart}" style="width:150px; border:1px solid #ccc;">
          `;
          
          // Arama input'unu se√ßilen kart adƒ±yla g√ºncelle
          const aramaInput = document.getElementById('kartAramaInput');
          if (aramaInput.value.trim() === '') {
            aramaInput.value = seciliKart.replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
          }
        }
      }
    }

    function silmeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('silmeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    async function kartSil() {
      const token = document.getElementById('githubToken').value.trim();
      const silinecekKart = document.getElementById('silinecekKart').value;
      
      if (!token) {
        alert('GitHub API token gerekli!');
        return;
      }
      
      if (!silinecekKart) {
        alert('Silinecek kartƒ± se√ßin!');
        return;
      }

      // Onay al
      if (!confirm(`"${silinecekKart}" kartƒ±nƒ± ger√ßekten silmek istiyorsan? Bu i≈ülem geri alƒ±namaz!`)) {
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'nutrition-planner';
      const branch = 'main';

      try {
        silmeStatusGoster('Dosya bilgisi alƒ±nƒ±yor...', 'info');

        // 1. √ñnce dosyanƒ±n SHA'sƒ±nƒ± al (silmek i√ßin gerekli)
        const dosyaPath = `tarifler/${silinecekKart}`;
        const dosyaRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaPath}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!dosyaRes.ok) {
          throw new Error('Dosya bulunamadƒ± veya eri≈üim hatasƒ±');
        }

        const dosyaData = await dosyaRes.json();

        silmeStatusGoster('Dosya GitHub\'dan siliniyor...', 'info');

        // 2. Dosyayƒ± sil
        const silRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaPath}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Tarif kartƒ± silindi: ${silinecekKart}`,
            sha: dosyaData.sha,
            branch
          })
        });

        if (!silRes.ok) {
          throw new Error('Dosya silme ba≈üarƒ±sƒ±z: ' + (await silRes.text()));
        }

        silmeStatusGoster('list.json g√ºncelleniyor...', 'info');

        // 3. list.json'u g√ºncelle
        const listRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!listRes.ok) {
          throw new Error('list.json dosyasƒ± alƒ±namadƒ±');
        }

        const listData = await listRes.json();
        const mevcutListe = JSON.parse(decodeBase64UTF8(listData.content));
        
        // Silinen dosyayƒ± listeden √ßƒ±kar
        const guncelListe = mevcutListe.filter(kart => kart !== silinecekKart);

        // G√ºncellenmi≈ü listeyi y√ºkle
        const yeniListeContent = encodeUTF8ToBase64(guncelListe);
        const listUpdateRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `list.json g√ºncellendi - ${silinecekKart} silindi`,
            content: yeniListeContent,
            sha: listData.sha,
            branch
          })
        });

        if (!listUpdateRes.ok) {
          throw new Error('list.json g√ºncelleme ba≈üarƒ±sƒ±z: ' + (await listUpdateRes.text()));
        }

        silmeStatusGoster(`‚úÖ Ba≈üarƒ±lƒ±! ${silinecekKart} kartƒ± silindi ve list.json g√ºncellendi.`, 'success');
        
        // Lokal listeyi de g√ºncelle
        await tariflerKlasoruGorselleriniYukle();
        
        // Liste g√ºncelle
        kartListesiniYenile();
        
        // Arama kutusunu ve se√ßimi temizle
        document.getElementById('kartAramaInput').value = '';
        document.getElementById('silinecekKart').value = '';
        
        // √ñnizlemeyi temizle
        document.getElementById('onizlemeAlani').innerHTML = '';

      } catch (error) {
        console.error('Kart silme hatasƒ±:', error);
        silmeStatusGoster(`‚ùå Hata: ${error.message}`, 'error');
      }
    }

    // --- Yeni Kart Ekleme Fonksiyonlarƒ± ---
    function yeniKartFormGoster() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('√ñnce GitHub API token girin!');
        return;
      }
      document.getElementById('yeniKartFormu').style.display = 'block';
    }

    function yeniKartFormGizle() {
      document.getElementById('yeniKartFormu').style.display = 'none';
      document.getElementById('yeniKartAdi').value = '';
      document.getElementById('yeniKartDosya').value = '';
      document.getElementById('yuklemeStatus').style.display = 'none';
    }

    // --- Kart D√ºzenleme Fonksiyonlarƒ± ---
    function kartDuzenleFormGoster() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('√ñnce GitHub API token girin!');
        return;
      }
      document.getElementById('kartDuzenleFormu').style.display = 'block';
      document.getElementById('seciliKartBilgileri').style.display = 'none';
      kartListesiniYenileForDuzenleme();
    }

    function kartDuzenleFormGizle() {
      document.getElementById('kartDuzenleFormu').style.display = 'none';
      document.getElementById('duzenleKartArama').value = '';
      document.getElementById('duzenleKartYeniAdi').value = '';
      document.getElementById('duzenleKartYeniDosya').value = '';
      document.getElementById('seciliKartBilgileri').style.display = 'none';
      document.getElementById('duzenlemeStatus').style.display = 'none';
      seciliDuzenleKart = null;
    }

    let seciliDuzenleKart = null;

    async function kartListesiniYenileForDuzenleme() {
      const listeDiv = document.getElementById('duzenleKartListesi');
      listeDiv.innerHTML = '<div style="color:#666;">Kart listesi y√ºkleniyor...</div>';
      
      try {
        const token = document.getElementById('githubToken').value.trim();
        const owner = 'mustafasacar35';
        const repo = 'nutrition-planner';
        
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (!response.ok) throw new Error('Kart listesi alƒ±namadƒ±');
        
        const data = await response.json();
        const content = JSON.parse(decodeBase64UTF8(data.content));
        
        kartListesiniGosterForDuzenleme(content);
        
      } catch (error) {
        console.error('Kart listesi yenileme hatasƒ±:', error);
        listeDiv.innerHTML = `<div style="color:red;">Hata: ${error.message}</div>`;
      }
    }

    function kartListesiniGosterForDuzenleme(kartlar, filtreMetni = '') {
      const listeDiv = document.getElementById('duzenleKartListesi');
      listeDiv.innerHTML = '';
      
      const filtrelenmisKartlar = kartlar.filter(kart => 
        kart.toLowerCase().includes(filtreMetni.toLowerCase())
      );
      
      if (filtrelenmisKartlar.length === 0) {
        listeDiv.innerHTML = '<div style="color:#666;">Kart bulunamadƒ±</div>';
        return;
      }
      
      // Mevcut olmayan dosyalarƒ± takip et
      
      filtrelenmisKartlar.forEach(kartAdi => {
        const kartDiv = document.createElement('div');
        kartDiv.style.cssText = 'padding:8px; margin:4px 0; border:1px solid #ddd; border-radius:4px; cursor:pointer; background:white; display:flex; align-items:center; gap:10px;';
        
        // Kart √∂nizlemesi
        const img = document.createElement('img');
        img.src = `https://mustafasacar35.github.io/nutrition-planner/tarifler/${kartAdi}`;
        img.style.cssText = 'width:40px; height:40px; object-fit:cover; border-radius:4px;';
        img.onerror = () => {
          img.style.display = 'none';
          dosyaBulunamadi(kartAdi);
          // Kart div'ini farklƒ± stil yap
          kartDiv.style.background = '#fff3cd';
          kartDiv.style.borderColor = '#ffc107';
          span.style.color = '#856404';
          span.title = 'Bu dosya bulunamƒ±yor - list.json\'dan temizlenebilir';
        };
        
        // Kart adƒ±
        const span = document.createElement('span');
        // Encoding sorunlarƒ±nƒ± temizleyip daha okunaklƒ± g√∂ster
        let gosterimAdi = kartAdi
          .replace(/√Ñ¬±/g, 'ƒ±').replace(/√Ñ/g, 'a')
          .replace(/√Ö/g, '≈ü').replace(/ƒû/g, 'ƒü')
          .replace(/√É¬º/g, '√º').replace(/√É¬∂/g, '√∂')
          .replace(/√¢/g, 'a').replace(/√Æ/g, 'i')
          .replace(/√ª/g, 'u').replace(/√¥/g, 'o')
          .replace(/_/g, ' ')
          .replace('.jpg', '');
        span.textContent = gosterimAdi;
        span.setAttribute('data-original', kartAdi); // Orijinal adƒ± sakla
        span.style.flex = '1';
        
        kartDiv.appendChild(img);
        kartDiv.appendChild(span);
        
        kartDiv.onclick = () => {
          const originalName = span.getAttribute('data-original');
          kartSecForDuzenleme(originalName);
        };
        
        // Hover efekti
        kartDiv.onmouseenter = () => kartDiv.style.background = '#e3f2fd';
        kartDiv.onmouseleave = () => {
          const originalName = span.getAttribute('data-original');
          kartDiv.style.background = seciliDuzenleKart === originalName ? '#bbdefb' : 'white';
        };
        
        const originalName = span.getAttribute('data-original');
        if (seciliDuzenleKart === originalName) {
          kartDiv.style.background = '#bbdefb';
        }
        
        listeDiv.appendChild(kartDiv);
      });
    }

    function kartListesiniFiltreleForDuzenleme(aramaMetni) {
      // T√ºrk√ße karakter normalizasyonu
      const normalizeText = (text) => {
        return text.toLowerCase()
          .replace(/√ß/g, 'c').replace(/√á/g, 'c')
          .replace(/ƒü/g, 'g').replace(/ƒû/g, 'g')
          .replace(/ƒ±/g, 'i').replace(/I/g, 'i').replace(/ƒ∞/g, 'i')
          .replace(/√∂/g, 'o').replace(/√ñ/g, 'o')
          .replace(/≈ü/g, 's').replace(/≈û/g, 's')
          .replace(/√º/g, 'u').replace(/√ú/g, 'u')
          // Encoding sorunlarƒ± i√ßin
          .replace(/√Ñ¬±/g, 'i').replace(/√Ñ/g, 'a')
          .replace(/√Ö/g, 's').replace(/ƒû/g, 'g')
          .replace(/√É¬º/g, 'u').replace(/√É¬∂/g, 'o')
          .replace(/√¢/g, 'a').replace(/√Æ/g, 'i')
          .replace(/√ª/g, 'u').replace(/√¥/g, 'o');
      };
      
      // Son y√ºklenen kart listesini tekrar filtrele
      kartListesiniYenileForDuzenleme().then(() => {
        // Liste yenilendikten sonra filtreyi uygula
        setTimeout(() => {
          const listeDiv = document.getElementById('duzenleKartListesi');
          const kartDivleri = Array.from(listeDiv.children);
          
          const normalizedArama = normalizeText(aramaMetni);
          
          kartDivleri.forEach(kartDiv => {
            const span = kartDiv.querySelector('span');
            const kartAdi = span?.getAttribute('data-original') || '';
            const gosterimAdi = span?.textContent || '';
            
            // Hem orijinal hem g√∂sterim adƒ±nda ara
            const normalizedKart = normalizeText(kartAdi);
            const normalizedGosterim = normalizeText(gosterimAdi);
            const goster = normalizedKart.includes(normalizedArama) || normalizedGosterim.includes(normalizedArama);
            kartDiv.style.display = goster ? 'flex' : 'none';
          });
          
          // Debug: Arama sonu√ßlarƒ±nƒ± g√∂ster
          if (aramaMetni.length > 2) {
            const goruntulenenKartlar = kartDivleri.filter(div => div.style.display !== 'none').length;
            console.log(`üîç "${aramaMetni}" aramasƒ±: ${goruntulenenKartlar} kart bulundu`);
            if (aramaMetni.includes('√Ñ') || aramaMetni.includes('ƒ±')) {
              console.log(`üí° Normalizasyon: "${aramaMetni}" ‚Üí "${normalizedArama}"`);
            }
          }
        }, 100);
      });
    }

    function kartSecForDuzenleme(kartAdi) {
      seciliDuzenleKart = kartAdi;
      
      // G√∂rsel se√ßimi g√ºncelle
      const listeDiv = document.getElementById('duzenleKartListesi');
      Array.from(listeDiv.children).forEach(div => {
        const span = div.querySelector('span');
        if (span) {
          const originalName = span.getAttribute('data-original');
          div.style.background = originalName === kartAdi ? '#bbdefb' : 'white';
        }
      });
      
      // Kart bilgilerini g√∂ster
      document.getElementById('seciliKartBilgileri').style.display = 'block';
      
      // Mevcut kart √∂nizlemesi
      const onizlemeDiv = document.getElementById('mevcutKartOnizleme');
      const temizAd = kartAdi
        .replace(/√Ñ¬±/g, 'ƒ±').replace(/√Ñ/g, 'a')
        .replace(/√Ö/g, '≈ü').replace(/ƒû/g, 'ƒü')
        .replace(/√É¬º/g, '√º').replace(/√É¬∂/g, '√∂')
        .replace(/_/g, ' ')
        .replace('.jpg', '');
      
      onizlemeDiv.innerHTML = `
        <div style="display:flex; align-items:center; gap:15px;">
          <img src="https://mustafasacar35.github.io/nutrition-planner/tarifler/${kartAdi}" 
               style="width:80px; height:80px; object-fit:cover; border-radius:8px; border:1px solid #ddd;" 
               onerror="this.style.display='none'; this.nextElementSibling.querySelector('.error-msg').style.display='block'">
          <div>
            <div style="font-weight:bold; font-size:16px;">${temizAd}</div>
            <div style="color:#666; font-size:12px;">Mevcut kart (${kartAdi})</div>
            <div class="error-msg" style="color:#dc3545; font-size:11px; display:none;">‚ùå G√∂rsel bulunamadƒ±</div>
          </div>
        </div>
      `;
      
      // Yeni adƒ± √∂nceden doldur (kullanƒ±cƒ± isterse deƒüi≈ütirebilir) - encoding temizleyerek
      const yeniAdiInput = document.getElementById('duzenleKartYeniAdi');
      if (yeniAdiInput) {
        // Dosya uzantƒ±sƒ±nƒ± kaldƒ±r ve encoding sorunlarƒ±nƒ± temizle
        let temizAd = kartAdi.replace('.jpg', '').replace('.jpeg', '').replace('.png', '');
        temizAd = temizAd
          .replace(/√Ñ¬±/g, 'i').replace(/√Ñ/g, 'a')
          .replace(/√Ö/g, 's').replace(/ƒû/g, 'g')
          .replace(/√É¬º/g, 'u').replace(/√É¬∂/g, 'o')
          .replace(/√¢/g, 'a').replace(/√Æ/g, 'i')
          .replace(/√ª/g, 'u').replace(/√¥/g, 'o');
        yeniAdiInput.value = temizAd;
        console.log(`üí° Kart se√ßildi: "${kartAdi}" ‚Üí Temizlenmi≈ü ad: "${temizAd}"`);
      }
    }

    // List.json'dan mevcut olmayan dosyalarƒ± temizle
    async function listjsonTemizle() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('GitHub token gerekli!');
        return;
      }
      
      if (!confirm('Mevcut olmayan dosyalar list.json\'dan temizlenecek. Emin misiniz?')) {
        return;
      }
      
      try {
        console.log('üîÑ List.json temizliƒüi ba≈ülatƒ±ldƒ±...');
        
        // √ñnce list.json'u al
        const response = await fetch('https://api.github.com/repos/mustafasacar35/nutrition-planner/contents/tarifler/list.json', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`List.json alƒ±namadƒ±: ${response.status}`);
        }
        
        const fileData = await response.json();
        const currentContent = JSON.parse(decodeBase64UTF8(fileData.content));
        
        // Her dosyanƒ±n varlƒ±ƒüƒ±nƒ± kontrol et
        const validFiles = [];
        let removedCount = 0;
        
        statusGoster('Dosyalar kontrol ediliyor...', 'info');
        
        for (const fileName of currentContent) {
          try {
            const checkResponse = await fetch(`https://mustafasacar35.github.io/nutrition-planner/tarifler/${fileName}`, {
              method: 'HEAD'
            });
            
            if (checkResponse.ok) {
              validFiles.push(fileName);
            } else {
              console.log(`‚ùå Kaldƒ±rƒ±ldƒ±: ${fileName}`);
              removedCount++;
            }
          } catch (error) {
            console.log(`‚ùå Kaldƒ±rƒ±ldƒ±: ${fileName} (hata)`);
            removedCount++;
          }
        }
        
        if (removedCount === 0) {
          statusGoster('Temizlenecek dosya bulunamadƒ±. T√ºm dosyalar mevcut.', 'success');
          return;
        }
        
        statusGoster(`${removedCount} dosya temizleniyor...`, 'info');
        
        // G√ºncellenmi≈ü list.json'u g√∂nder
        const updateResponse = await fetch('https://api.github.com/repos/mustafasacar35/nutrition-planner/contents/tarifler/list.json', {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `List.json temizlendi: ${removedCount} dosya kaldƒ±rƒ±ldƒ±`,
            content: encodeUTF8ToBase64(validFiles),
            sha: fileData.sha
          })
        });
        
        if (!updateResponse.ok) {
          throw new Error(`List.json g√ºncellenemedi: ${updateResponse.status}`);
        }
        
        alert(`‚úÖ Ba≈üarƒ±lƒ±! ${removedCount} mevcut olmayan dosya list.json'dan temizlendi.`);
        
        // Cache'i temizle ve listeyi yenile
        localStorage.removeItem('tarifKartlariCache');
        kartListesiniYenileForDuzenleme();
        
      } catch (error) {
        console.error('List.json temizleme hatasƒ±:', error);
        alert(`‚ùå Hata: ${error.message}`);
      }
    }

    // Mevcut olmayan dosyalarƒ± toplu raporla
    let mevcutOlmayanDosyalar = new Set();
    
    function dosyaBulunamadi(dosyaAdi) {
      mevcutOlmayanDosyalar.add(dosyaAdi);
      
      // 2 saniye sonra toplu rapor ver
      setTimeout(() => {
        if (mevcutOlmayanDosyalar.size > 0) {
          const eksikler = Array.from(mevcutOlmayanDosyalar);
          console.log(`üö® TOPLU RAPOR: ${eksikler.length} dosya bulunamadƒ±:`);
          eksikler.forEach(dosya => console.log(`  ‚ùå ${dosya}`));
          console.log('üí° Bu dosyalarƒ± temizlemek i√ßin "üßπ Temizle" butonunu kullanƒ±n');
          mevcutOlmayanDosyalar.clear();
        }
      }, 2000);
    }

    async function kartDuzenlemeKaydet() {
      const yeniAd = document.getElementById('duzenleKartYeniAdi').value.trim();
      const yeniDosya = document.getElementById('duzenleKartYeniDosya').files[0];
      
      if (!seciliDuzenleKart) {
        alert('L√ºtfen √∂nce d√ºzenlenecek kartƒ± se√ßin!');
        return;
      }
      
      if (!yeniAd) {
        alert('Yeni kart adƒ±nƒ± girin!');
        return;
      }
      
      // Dosya adƒ±nƒ± normalize et
      let normalizeEdilmisAd = yeniAd.toLowerCase()
        .replace(/[√ßƒüƒ±√∂≈ü√º]/g, c => ({'√ß':'c','ƒü':'g','ƒ±':'i','√∂':'o','≈ü':'s','√º':'u'}[c] || c))
        .replace(/[^a-z0-9_]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '');
      
      if (!normalizeEdilmisAd.endsWith('.jpg')) {
        normalizeEdilmisAd += '.jpg';
      }
      
      if (normalizeEdilmisAd === seciliDuzenleKart && !yeniDosya) {
        alert('Herhangi bir deƒüi≈üiklik yapmadƒ±nƒ±z!');
        return;
      }
      
      const token = document.getElementById('githubToken').value.trim();
      
      try {
        duzenlemeStatusGoster('Kart d√ºzenleniyor...', 'info');
        
        const owner = 'mustafasacar35';
        const repo = 'nutrition-planner';
        
        // 1. Eski kartƒ± sil
        if (normalizeEdilmisAd !== seciliDuzenleKart) {
          await kartSilGitHub(seciliDuzenleKart, token, owner, repo, false); // sessiz silme
        }
        
        // 2. Yeni kart ekle
        let gorselBase64;
        if (yeniDosya) {
          // Yeni dosya se√ßilmi≈üse onu kullan
          gorselBase64 = await dosyayiBase64Cevir(yeniDosya);
        } else {
          // Dosya se√ßilmemi≈üse mevcut dosyayƒ± indir ve tekrar y√ºkle
          const mevcutResponse = await fetch(`https://mustafasacar35.github.io/nutrition-planner/tarifler/${seciliDuzenleKart}`);
          const mevcutBlob = await mevcutResponse.blob();
          gorselBase64 = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(mevcutBlob);
          });
        }
        
        // GitHub'a yeni kartƒ± y√ºkle
        // √ñnce dosyanƒ±n var olup olmadƒ±ƒüƒ±nƒ± kontrol et (SHA i√ßin)
        let existingSha = null;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${normalizeEdilmisAd}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const existingData = await checkResponse.json();
            existingSha = existingData.sha;
            console.log(`üìÑ Mevcut dosya bulundu: ${normalizeEdilmisAd}, SHA: ${existingSha}`);
          }
        } catch (e) {
          console.log(`üìÑ Yeni dosya: ${normalizeEdilmisAd}`);
        }
        
        const uploadPayload = {
          message: `Kart d√ºzenlendi: ${seciliDuzenleKart} ‚Üí ${normalizeEdilmisAd}`,
          content: gorselBase64
        };
        
        // Eƒüer dosya varsa SHA'sƒ±nƒ± ekle
        if (existingSha) {
          uploadPayload.sha = existingSha;
        }
        
        const uploadResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${normalizeEdilmisAd}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(uploadPayload)
        });
        
        if (!uploadResponse.ok) {
          const errorText = await uploadResponse.text();
          console.error('Upload hatasƒ±:', uploadResponse.status, errorText);
          throw new Error(`Yeni kart y√ºklenemedi (${uploadResponse.status}): ${errorText}`);
        }
        
        // 3. list.json'u g√ºncelle
        await listJsonGuncelle(token, owner, repo);
        
        duzenlemeStatusGoster(`‚úÖ Kart ba≈üarƒ±yla d√ºzenlendi: ${normalizeEdilmisAd}`, 'success');
        
        // Cache'i temizle ve listeyi yenile
        tariflerKlasoruGorselleri = [];
        await tariflerKlasoruGorselleriniYukle();
        
        setTimeout(() => {
          kartDuzenleFormGizle();
        }, 2000);
        
      } catch (error) {
        console.error('Kart d√ºzenleme hatasƒ±:', error);
        duzenlemeStatusGoster(`‚ùå Hata: ${error.message}`, 'error');
      }
    }

    function duzenlemeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('duzenlemeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    // Yardƒ±mcƒ± fonksiyonlar
    function dosyayiBase64Cevir(dosya) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(dosya);
      });
    }

    async function kartSilGitHub(kartAdi, token, owner, repo, showAlert = true) {
      // √ñnce dosyanƒ±n SHA'sƒ±nƒ± al
      const getResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${kartAdi}`, {
        headers: { 'Authorization': `token ${token}` }
      });
      
      if (!getResponse.ok) {
        throw new Error('Dosya bulunamadƒ±');
      }
      
      const fileData = await getResponse.json();
      
      // Dosyayƒ± sil
      const deleteResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${kartAdi}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Kart silindi: ${kartAdi}`,
          sha: fileData.sha
        })
      });
      
      if (!deleteResponse.ok) {
        throw new Error('Dosya silinemedi');
      }
      
      if (showAlert) {
        console.log(`‚úÖ ${kartAdi} ba≈üarƒ±yla silindi`);
      }
    }

    async function listJsonGuncelle(token, owner, repo) {
      // Tarifler klas√∂r√ºndeki t√ºm dosyalarƒ± listele
      const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler`, {
        headers: { 'Authorization': `token ${token}` }
      });
      
      if (!response.ok) throw new Error('Klas√∂r i√ßeriƒüi alƒ±namadƒ±');
      
      const files = await response.json();
      const imageFiles = files
        .filter(file => file.type === 'file' && /\.(jpg|jpeg|png)$/i.test(file.name))
        .map(file => file.name)
        .sort();
      
      // list.json'un mevcut SHA'sƒ±nƒ± al
      const listResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
        headers: { 'Authorization': `token ${token}` }
      });
      
      let listSha;
      if (listResponse.ok) {
        const listData = await listResponse.json();
        listSha = listData.sha;
      }
      
      // list.json'u g√ºncelle
      const updateResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: 'list.json g√ºncellendi (kart d√ºzenleme)',
          content: encodeUTF8ToBase64(imageFiles),
          ...(listSha && { sha: listSha })
        })
      });
      
      if (!updateResponse.ok) {
        throw new Error('list.json g√ºncellenemedi');
      }
    }

    function statusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('yuklemeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    async function yeniKartKaydet() {
      const token = document.getElementById('githubToken').value.trim();
      const kartAdi = document.getElementById('yeniKartAdi').value.trim();
      const dosyaInput = document.getElementById('yeniKartDosya');
      
      // Validasyon
      if (!token) {
        alert('GitHub API token gerekli!');
        return;
      }
      
      if (!kartAdi) {
        alert('Kart adƒ± gerekli!');
        return;
      }
      
      if (!dosyaInput.files || !dosyaInput.files[0]) {
        alert('G√∂rsel dosyasƒ± se√ßin!');
        return;
      }

      // Dosya adƒ±nƒ± normalize et
      let dosyaAdi = kartAdi.toLowerCase()
        .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
        .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i')
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
      
      if (!dosyaAdi.endsWith('.jpg')) {
        dosyaAdi += '.jpg';
      }

      const dosya = dosyaInput.files[0];
      
      try {
        statusGoster('Dosya hazƒ±rlanƒ±yor...', 'info');
        
        // Dosyayƒ± base64'e √ßevir
        const dosyaBase64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1]; // data:image/jpeg;base64, kƒ±smƒ±nƒ± √ßƒ±kar
            resolve(base64);
          };
          reader.onerror = reject;
          reader.readAsDataURL(dosya);
        });

        const owner = 'mustafasacar35';
        const repo = 'nutrition-planner';
        const branch = 'main';

        statusGoster('G√∂rsel GitHub\'a y√ºkleniyor...', 'info');

        // 1. √ñnce dosya var mƒ± kontrol et
        const gorselPath = `tarifler/${dosyaAdi}`;
        let mevcutSha = null;
        
        try {
          const mevcutRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${gorselPath}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          
          if (mevcutRes.ok) {
            const mevcutData = await mevcutRes.json();
            mevcutSha = mevcutData.sha;
            console.log('üìÅ Mevcut dosya SHA bulundu:', mevcutSha);
          }
        } catch (e) {
          console.log('üìÅ Dosya mevcut deƒüil, yeni dosya olu≈üturulacak');
        }

        // 2. G√∂rseli tarifler klas√∂r√ºne y√ºkle
        const gorselPayload = {
          message: `Yeni tarif kartƒ± eklendi: ${dosyaAdi}`,
          content: dosyaBase64,
          branch
        };
        
        // SHA varsa ekle
        if (mevcutSha) {
          gorselPayload.sha = mevcutSha;
        }
        
        const gorselRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${gorselPath}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(gorselPayload)
        });

        if (!gorselRes.ok) {
          const errorText = await gorselRes.text();
          throw new Error('G√∂rsel y√ºkleme ba≈üarƒ±sƒ±z: ' + errorText);
        }

        statusGoster('list.json g√ºncelleniyor...', 'info');

        // 2. list.json dosyasƒ±nƒ± g√ºncelle
        // √ñnce mevcut list.json'u al
        const listRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!listRes.ok) {
          throw new Error('list.json dosyasƒ± alƒ±namadƒ±');
        }

        const listData = await listRes.json();
        const mevcutListe = JSON.parse(decodeBase64UTF8(listData.content));
        
        // Yeni dosyayƒ± listeye ekle (eƒüer yoksa)
        if (!mevcutListe.includes(dosyaAdi)) {
          mevcutListe.push(dosyaAdi);
          mevcutListe.sort(); // Alfabetik sƒ±rala
        }

        // G√ºncellenmi≈ü listeyi y√ºkle
        const yeniListeContent = encodeUTF8ToBase64(mevcutListe);
        const listUpdateRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `list.json g√ºncellendi - ${dosyaAdi} eklendi`,
            content: yeniListeContent,
            sha: listData.sha,
            branch
          })
        });

        if (!listUpdateRes.ok) {
          throw new Error('list.json g√ºncelleme ba≈üarƒ±sƒ±z: ' + (await listUpdateRes.text()));
        }

        statusGoster(`‚úÖ Ba≈üarƒ±lƒ±! ${dosyaAdi} kartƒ± eklendi ve list.json g√ºncellendi.`, 'success');
        
        // Lokal listeyi de g√ºncelle (anƒ±nda g√∂r√ºnmesi i√ßin)
        await tariflerKlasoruGorselleriniYukle();
        
        // Formu temizle
        setTimeout(() => {
          yeniKartFormGizle();
        }, 2000);

      } catch (error) {
        console.error('Kart y√ºkleme hatasƒ±:', error);
        statusGoster(`‚ùå Hata: ${error.message}`, 'error');
      }
    }
    // --- Tarifler klas√∂r√º g√∂rsellerini otomatik y√ºkle (GitHub Pages uyumlu) ---
    let tariflerKlasoruGorselleri = [];
    
    function durumGuncelle() {
      const durumElement = document.getElementById('tariflerKlasoruDurumu');
      if (durumElement) {
        if (tariflerKlasoruGorselleri.length > 0) {
          durumElement.innerHTML = `‚úÖ Tarifler klas√∂r√º: <span style="color:green; font-weight:bold;">${tariflerKlasoruGorselleri.length} g√∂rsel</span>`;
          durumElement.parentElement.style.borderLeftColor = '#28a745';
        } else {
          durumElement.innerHTML = `‚ö†Ô∏è Tarifler klas√∂r√º: <span style="color:orange; font-weight:bold;">G√∂rsel bulunamadƒ±</span> - Manuel y√ºkleme gerekli`;
          durumElement.parentElement.style.borderLeftColor = '#ffc107';
        }
      }
    }
    
    async function tariflerKlasoruGorselleriniYukle() {
      const durumElement = document.getElementById('tariflerKlasoruDurumu');
      if (durumElement) {
        durumElement.innerHTML = 'üîÑ Tarifler klas√∂r√º kontrol ediliyor...';
        durumElement.parentElement.style.borderLeftColor = '#6c757d';
      }
      
      try {
        // Her zaman bulunduƒüun dizinin k√∂k√ºne g√∂re tarifler/ yolunu olu≈ütur
        // √ñnce GitHub'dan tarifler y√ºklemeyi deneyelim
        console.log('üåê GitHub\'dan tarifler y√ºkleniyor...');
        const githubTariflerUrl = 'https://mustafasacar35.github.io/nutrition-planner/tarifler/list.json';
        
        try {
          const githubResp = await fetch(githubTariflerUrl);
          if (githubResp.ok) {
            const responseText = await githubResp.text();
            console.log('Tarifler GitHub\'dan y√ºklendi (ilk 200 karakter):', responseText.substring(0, 200));
            
            const files = JSON.parse(responseText);
            console.log('GitHub\'dan y√ºklenen tarif dosyalarƒ±:', files.length, 'adet');
            
            tariflerKlasoruGorselleri = files.map(name => ({
              name,
              url: 'https://mustafasacar35.github.io/nutrition-planner/tarifler/' + name
            }));
            
            window.tarifKartlari = files;
            console.log('üîß window.tarifKartlari GitHub\'dan ayarlandƒ±:', window.tarifKartlari.length, 'kart');
            console.log(`‚úÖ GitHub\'dan ${tariflerKlasoruGorselleri.length} tarif g√∂rsel y√ºklendi`);
            
            durumGuncelle();
            return; // Ba≈üarƒ±lƒ±, devam etme
          }
        } catch (githubError) {
          console.warn('‚ö†Ô∏è GitHub\'dan tarif y√ºkleme ba≈üarƒ±sƒ±z:', githubError.message);
        }
        
        // GitHub ba≈üarƒ±sƒ±z olduysa local denemeyi yap
        console.log('üìÅ Local dosya y√ºkleme deneniyor...');
        let basePath = window.location.pathname;
        if (!basePath.endsWith('/')) basePath = basePath.substring(0, basePath.lastIndexOf('/') + 1);
        const tariflerPath = window.location.origin + basePath + 'tarifler/';
        
        console.log('Tarifler klas√∂r√º aranƒ±yor:', tariflerPath);
        
        const resp = await fetch(tariflerPath + 'list.json');
        if (!resp.ok) {
          console.warn(`list.json bulunamadƒ± (${resp.status}): ${tariflerPath}list.json`);
          throw new Error(`list.json bulunamadƒ±: ${resp.status} - ${tariflerPath}list.json`);
        }
        
        const responseText = await resp.text();
        console.log('Tarifler klas√∂r√ºnden ham JSON (ilk 200 karakter):', responseText.substring(0, 200));
        
        let files;
        try {
          files = JSON.parse(responseText);
        } catch (jsonError) {
          console.error('‚ùå JSON parsing hatasƒ±:', jsonError.message);
          console.log('üìÑ Hatalƒ± JSON i√ßeriƒüi (ilk 1000 karakter):', responseText.substring(0, 1000));
          
          // JSON'u satƒ±r satƒ±r kontrol et
          const lines = responseText.split('\n');
          console.log('üìä Toplam satƒ±r sayƒ±sƒ±:', lines.length);
          
          // 200-210 arasƒ± satƒ±rlarƒ± g√∂ster (hata 204. satƒ±rda)
          for (let i = 200; i < Math.min(210, lines.length); i++) {
            console.log(`‚ùå Satƒ±r ${i + 1}: "${lines[i]}"`);
          }
          
          throw new Error(`JSON format hatasƒ±: ${jsonError.message}`);
        }
        
        console.log('Tarifler klas√∂r√ºnden y√ºklenen dosyalar:', files);
        
        tariflerKlasoruGorselleri = files.map(name => ({
          name,
          url: tariflerPath + name
        }));
        
        // Manuel kart ekleme i√ßin dosya adlarƒ±nƒ± da ayrƒ± bir diziye kaydet
        window.tarifKartlari = files;
        console.log('üîß window.tarifKartlari ayarlandƒ±:', window.tarifKartlari.length, 'kart');
        
        console.log(`‚úÖ Tarifler klas√∂r√ºnden ${tariflerKlasoruGorselleri.length} g√∂rsel y√ºklendi`);
        
      } catch (e) {
        console.warn('‚ö†Ô∏è Tarifler klas√∂r√º y√ºklenemedi:', e.message);
        console.log('üí° √á√∂z√ºm: Ana dizinde "tarifler/" klas√∂r√º olu≈üturun ve i√ßine list.json dosyasƒ± ekleyin');
        tariflerKlasoruGorselleri = [];
        window.tarifKartlari = []; // Manuel kart ekleme i√ßin bo≈ü dizi
        console.log('üîß window.tarifKartlari bo≈ü dizi olarak ayarlandƒ±');
      }
      
      durumGuncelle();
    }
    tariflerKlasoruGorselleriniYukle();

    // pdf.js worker ayarƒ± (uyumluluk i√ßin)
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    }
    // --- Hasta Y√∂netimi Mod√ºl√º ---
    // --- Kalƒ±cƒ± veri y√∂netimi ---
    const STORAGE_KEY = 'lipedem_hasta_kayitlari';
    function saveToStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(hastalar));
        console.log('üíæ Hastalar localStorage\'a kaydedildi');
        // Hasta sayƒ±larƒ±nƒ± g√ºncelle - async olarak √ßaƒüƒ±r
        if (typeof guncelleHastaSayilari === 'function') {
          guncelleHastaSayilari().catch(err => console.warn('Hasta sayƒ±larƒ± g√ºncelleme hatasƒ±:', err));
        }
      } catch(e) { console.error('localStorage kaydetme hatasƒ±:', e); }
    }
    
    // Veri deƒüi≈ütiƒüinde otomatik kaydetme
    function autoSaveHastaData(hasta) {
      try {
        if (!hasta) return;
        
        // Global hastalar dizisinde g√ºncelle
        const hastaIndex = hastalar.findIndex(h => h.id === hasta.id);
        if (hastaIndex >= 0) {
          hastalar[hastaIndex] = hasta;
          console.log('üîÑ Hasta verisi g√ºncellendi:', hasta.isim);
        } else {
          hastalar.push(hasta);
          console.log('‚ûï Yeni hasta eklendi:', hasta.isim);
        }
        
        // localStorage'a kaydet
        saveToStorage();
        
        return true;
      } catch(e) { 
        console.error('Otomatik kaydetme hatasƒ±:', e); 
        return false;
      }
    }
    function loadFromStorage() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) return JSON.parse(data);
      } catch(e) { console.error('localStorage okuma hatasƒ±:', e); }
      return null;
    }

    // Ba≈ülangƒ±√ß verisi veya storage'dan y√ºkle
    let hastalar = loadFromStorage() || [
      { id: 1, isim: "Ay≈üe Yƒ±lmaz", not: "Hashimoto tiroiditi var", arsiv: false },
      { id: 2, isim: "Fatma Demir", not: "Zeytin sevmez", arsiv: false },
      { id: 3, isim: "Zeynep Kaya", not: "3. haftada kabƒ±zlƒ±k ya≈üandƒ±", arsiv: true }
    ];
    
    // YENƒ∞ Sƒ∞STEM: Global hasta listesi
    let hastaListesi = [];
    
    // Temizlenmi≈ü verileri kaydet
    if (hastalar.length > 0) {
      saveToStorage();
      console.log('üíæ Temizlenmi≈ü veriler localStorage\'a kaydedildi');
    }
    
    // Hasta listesini otomatik sƒ±rala (isim sƒ±rasƒ±) - g√ºvenli sƒ±ralama
    hastalar.sort((a, b) => {
      const isimA = (a.isim || a.ad || '').toString();
      const isimB = (b.isim || b.ad || '').toString();
      return isimA.localeCompare(isimB, 'tr');
    });
    
    // === YENƒ∞ Sƒ∞STEM: SIDEBAR HASTA Lƒ∞STESƒ∞ ===
    
    // Yeni sistemden hasta listesini renderla
    async function renderHastalarYeniSistem() {
      const ul = document.getElementById('hastaListesi');
      const ara = document.getElementById('hastaAra').value.toLowerCase();
      const filtre = document.getElementById('arsivFiltre').value;
      ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #666;">Y√ºkleniyor...</li>';
      
      try {
        // Token kontrol√º
        const token = document.getElementById('githubToken').value.trim();
        if (!token) {
          ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #dc3545;">‚ö†Ô∏è GitHub token gerekli</li>';
          return;
        }
        
        // GitHub'dan hasta listesini al ve global deƒüi≈ükeni g√ºncelle
        const yuklenmisList = await hastaListesiYukle();
        
        if (yuklenmisList.length === 0) {
          ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #666;">Hen√ºz hasta kaydƒ± yok - Yeni hasta ekleyebilirsiniz</li>';
          return;
        }
        
        ul.innerHTML = '';
        
        // Filtreleme ve sƒ±ralama - y√ºklenen listeyi kullan
        const filtreliHastalar = yuklenmisList.filter(hasta => {
          const hastaIsim = hasta.isim || hasta.ad || '';
          const aramaUygun = hastaIsim.toLowerCase().includes(ara);
          const filtreUygun = filtre === 'hepsi' || 
                             (filtre === 'aktif' && !hasta.arsiv) || 
                             (filtre === 'arsiv' && hasta.arsiv);
          return aramaUygun && filtreUygun;
        });
        
        // Hasta sayƒ±larƒ±nƒ± g√ºncelle - y√ºklenen listeyi kullan
        const aktifSayisi = yuklenmisList.filter(h => !h.arsiv).length;
        const arsivSayisi = yuklenmisList.filter(h => h.arsiv).length;
        console.log(`üìä Yeni sistem hasta sayƒ±larƒ±: Aktif=${aktifSayisi}, Ar≈üiv=${arsivSayisi}, Toplam=${yuklenmisList.length}`);
        
        // Filtreleme ve hasta hafta verilerini analiz etme
        const hastalarVeriAnaliziIle = await Promise.all(filtreliHastalar.map(async (hasta) => {
          const hastaIsim = hasta.isim || hasta.ad || 'Bilinmeyen Hasta';
          
          // En b√ºy√ºk hafta sayƒ±sƒ±nƒ± bul - sadece localStorage'a bak (g√ºvenilir kaynak)
          let maxHafta = 0;
          let hastaDetayiBulundu = false;
          
          // √ñnce localStorage'dan kontrol et (√ñNCELIK: localStorage)
          const localHasta = hastalar.find(h => h && h.id === hasta.id);
          if (localHasta && localHasta.haftalar && localHasta.haftalar.length > 0) {
            const haftaNumaralari = localHasta.haftalar.map(h => h.haftaNo || h.hafta || 0);
            maxHafta = Math.max(...haftaNumaralari);
            hastaDetayiBulundu = true;
            console.log(`üìä Hasta ${hastaIsim} - localStorage'dan hafta bilgisi alƒ±ndƒ±: maxHafta=${maxHafta}, haftalar: [${haftaNumaralari.join(', ')}]`);
          }
          
          // localStorage'da bulunamadƒ±ysa GitHub'dan dene (opsiyonel ve sadece yedek)
          if (!hastaDetayiBulundu && hasta.id) {
            try {
              const dosyaAdlari = [
                generateFileName({ id: hasta.id, isim: hasta.isim }),
                generateFileName({ isim: hasta.isim })
              ];
              
              for (const dosyaAdi of dosyaAdlari) {
                try {
                  const response = await fetch(`https://api.github.com/repos/mustafasacar35/nutrition-planner/contents/patients/${dosyaAdi}`, {
                    headers: { 'Authorization': `token ${token}` }
                  });
                  
                  if (response.ok) {
                    const data = await response.json();
                    const hastaDetay = JSON.parse(decodeBase64UTF8(data.content));
                    if (hastaDetay.haftalar && hastaDetay.haftalar.length > 0) {
                      const haftaNumaralari = hastaDetay.haftalar.map(h => h.haftaNo || h.hafta || 0);
                      const githubMaxHafta = Math.max(...haftaNumaralari);
                      
                      // ‚ö†Ô∏è UYARI: GitHub verisi localStorage'ƒ± ge√ßersiz kƒ±lmasƒ±n
                      // Sadece localStorage bo≈üsa GitHub verisini kullan
                      maxHafta = githubMaxHafta;
                      hastaDetayiBulundu = true;
                      console.log(`üìä Hasta ${hastaIsim} - GitHub'dan yedek hafta bilgisi alƒ±ndƒ±: maxHafta=${githubMaxHafta}, haftalar: [${haftaNumaralari.join(', ')}]`);
                      break;
                    }
                  } else if (response.status === 404) {
                    // Hasta dosyasƒ± bulunamadƒ±, diƒüer dosya adlarƒ±nƒ± dene
                    continue;
                  }
                } catch (e) {
                  // Sessizce ge√ß
                }
              }
            } catch (e) {
              // Sessizce ge√ß
            }
          }
          
          return {
            ...hasta,
            maxHafta: maxHafta,
            hastaIsim: hastaIsim,
            hastaDetayiBulundu: hastaDetayiBulundu
          };
        }));
        
        // En b√ºy√ºk hafta numarasƒ±na g√∂re sƒ±rala, aynƒ± hafta numarasƒ± olanlarda alfabetik
        hastalarVeriAnaliziIle.sort((a, b) => {
          if (a.maxHafta !== b.maxHafta) {
            return a.maxHafta - b.maxHafta; // K√º√ß√ºk haftadan b√ºy√ºk haftaya
          }
          return a.hastaIsim.localeCompare(b.hastaIsim, 'tr'); // Alfabetik sƒ±ralama
        });
        
        hastalarVeriAnaliziIle.forEach((hasta, index) => {
          const li = document.createElement('li');
          
          // Hafta sayƒ±sƒ±na g√∂re renk belirleme
          const getHaftaRengi = (haftaNo) => {
            const renkPaleti = [
              // Hafta 0 - PDF Yok
              { background: 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)', borderColor: '#dee2e6', textColor: '#6c757d' },
              // Hafta 1 - A√ßƒ±k Mavi
              { background: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)', borderColor: '#2196f3', textColor: '#0d47a1' },
              // Hafta 2 - Cyan
              { background: 'linear-gradient(135deg, #e0f7fa 0%, #80deea 100%)', borderColor: '#00bcd4', textColor: '#006064' },
              // Hafta 3 - Teal
              { background: 'linear-gradient(135deg, #e0f2f1 0%, #80cbc4 100%)', borderColor: '#009688', textColor: '#004d40' },
              // Hafta 4 - Ye≈üil
              { background: 'linear-gradient(135deg, #e8f5e8 0%, #a5d6a7 100%)', borderColor: '#4caf50', textColor: '#1b5e20' },
              // Hafta 5 - A√ßƒ±k Ye≈üil
              { background: 'linear-gradient(135deg, #f1f8e9 0%, #c5e1a5 100%)', borderColor: '#8bc34a', textColor: '#33691e' },
              // Hafta 6 - Lime
              { background: 'linear-gradient(135deg, #f9fbe7 0%, #dcedc8 100%)', borderColor: '#cddc39', textColor: '#827717' },
              // Hafta 7 - Sarƒ±
              { background: 'linear-gradient(135deg, #fffde7 0%, #fff176 100%)', borderColor: '#ffeb3b', textColor: '#f57f17' },
              // Hafta 8 - Amber
              { background: 'linear-gradient(135deg, #fff8e1 0%, #ffcc02 100%)', borderColor: '#ffc107', textColor: '#ff6f00' },
              // Hafta 9 - Turuncu
              { background: 'linear-gradient(135deg, #fff3e0 0%, #ffb74d 100%)', borderColor: '#ff9800', textColor: '#e65100' },
              // Hafta 10 - Koyu Turuncu
              { background: 'linear-gradient(135deg, #fbe9e7 0%, #ffab91 100%)', borderColor: '#ff5722', textColor: '#d84315' },
              // Hafta 11 - Kƒ±rmƒ±zƒ±
              { background: 'linear-gradient(135deg, #ffebee 0%, #ef9a9a 100%)', borderColor: '#f44336', textColor: '#c62828' },
              // Hafta 12 - Pink
              { background: 'linear-gradient(135deg, #fce4ec 0%, #f48fb1 100%)', borderColor: '#e91e63', textColor: '#ad1457' },
              // Hafta 13 - Mor
              { background: 'linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%)', borderColor: '#9c27b0', textColor: '#6a1b9a' }
            ];

            if (haftaNo === 0) {
              return renkPaleti[0];
            } else if (haftaNo >= 1 && haftaNo <= 13) {
              return renkPaleti[haftaNo];
            } else {
              // 14+ hafta i√ßin √∂zel altƒ±n renk (ba≈üarƒ± ve deneyim)
              return {
                background: 'linear-gradient(135deg, #fff8e1 0%, #ffd54f 100%)',
                borderColor: '#ff8f00',
                textColor: '#e65100'
              };
            }
          };
          
          const renkSemasi = getHaftaRengi(hasta.maxHafta);
          
          li.style.cssText = `cursor: pointer; padding: 8px 12px; border-radius: 8px; margin-bottom: 3px; 
                             background: ${renkSemasi.background}; 
                             border-left: 4px solid ${renkSemasi.borderColor}; 
                             border: 1px solid ${renkSemasi.borderColor}20;
                             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                             transition: all 0.3s ease;`;
          
          // Hover efekti i√ßin
          li.onmouseenter = () => {
            li.style.transform = 'translateX(3px)';
            li.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
          };
          li.onmouseleave = () => {
            li.style.transform = 'translateX(0)';
            li.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
          };
          
          // ƒ∞sim div'ini ayrƒ± olu≈ütur - hafta bilgisiyle birlikte
          const isimDiv = document.createElement('div');
          isimDiv.style.cssText = `font-weight: bold; color: ${hasta.arsiv ? '#6c757d' : renkSemasi.textColor}; font-size: 13px;`;
          
          // Sƒ±ra numarasƒ±nƒ± ekle
          const siraSpan = document.createElement('span');
          siraSpan.style.cssText = `color: ${renkSemasi.textColor}80; font-weight: normal; margin-right: 8px;`;
          siraSpan.textContent = `${index + 1}.`;
          isimDiv.appendChild(siraSpan);
          
          // ƒ∞sim kƒ±smƒ±nƒ± ekle
          const isimSpan = document.createElement('span');
          isimSpan.textContent = `${hasta.arsiv ? '  ' : ''}${hasta.hastaIsim}`;
          isimDiv.appendChild(isimSpan);
          
          // Hafta bilgisini ekle (renkli)
          const haftaSpan = document.createElement('span');
          haftaSpan.style.cssText = `color: ${renkSemasi.borderColor}; font-weight: bold; font-size: 11px;`; // Border renginde ve bold
          if (hasta.maxHafta > 0) {
            haftaSpan.textContent = ` (${hasta.maxHafta}. hafta)`;
          } else {
            haftaSpan.textContent = ` (pdf yok)`;
          }
          isimDiv.appendChild(haftaSpan);
          
          li.appendChild(isimDiv);
          
          // Not varsa ekle
          if (hasta.not) {
            const notDiv = document.createElement('div');
            notDiv.style.cssText = `font-size: 11px; color: ${renkSemasi.textColor}90; margin-top: 2px;`;
            notDiv.textContent = hasta.not; // textContent kullan
            li.appendChild(notDiv);
          }
          
          li.onclick = () => hastaSecYeniSistem(hasta);
          li.dataset.hastaId = hasta.id;
          li.classList.add('hasta-item'); // CSS vurgulama i√ßin
          ul.appendChild(li);
        });
        
        console.log(`‚úÖ Yeni sistem hasta listesi g√ºncellendi: ${filtreliHastalar.length} hasta g√∂steriliyor`);
        
        // Sidebar'daki hasta sayƒ±larƒ±nƒ± g√ºncelle
        await guncelleHastaSayilari();
        
        // Toplu ZIP butonunu ekle
        ekleTopluZipButonu();
        
      } catch (error) {
        console.error('‚ùå Yeni sistem hasta listesi y√ºkleme hatasƒ±:', error);
        ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #dc3545;">Hasta listesi y√ºklenemedi</li>';
      }
    }
    
    // Yeni sistemde hasta se√ßme
    async function hastaSecYeniSistem(hastaBilgi) {
      try {
        console.log('üë§ Yeni sistemde hasta se√ßiliyor:', hastaBilgi.isim);
        
        const owner = 'mustafasacar35';
        const repo = 'nutrition-planner';
        
        // Dosya adƒ± alternatifleri dene
        const dosyaAdlari = [
          generateFileName({ id: hastaBilgi.id, isim: hastaBilgi.isim }),
          generateFileName({ id: hastaBilgi.id, isim: turkceKarakterDuzelt(hastaBilgi.isim) }),
          generateFileName({ isim: hastaBilgi.isim }),
          generateFileName({ isim: turkceKarakterDuzelt(hastaBilgi.isim) })
        ];
        
        // √áift entryleri kaldƒ±r
        const benzersizDosyaAdlari = [...new Set(dosyaAdlari)];
        
        console.log('üîç Denenen dosya adlarƒ±:', benzersizDosyaAdlari);
        
        let hastaDetay = null;
        let bulunanDosya = null;
        
        // Her dosya adƒ±nƒ± sƒ±rayla dene
        for (const dosyaAdi of benzersizDosyaAdlari) {
          try {
            console.log(`üîç Denenen dosya: ${dosyaAdi}`);
            const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${dosyaAdi}`);
            
            if (response.ok) {
              const data = await response.json();
              hastaDetay = JSON.parse(decodeBase64UTF8(data.content));
              bulunanDosya = dosyaAdi;
              console.log(`‚úÖ Dosya bulundu: ${dosyaAdi}`);
              break;
            }
          } catch (e) {
            console.log(`‚ùå Dosya bulunamadƒ±: ${dosyaAdi}`);
          }
        }
        
        if (hastaDetay) {
          // ‚≠ê YENƒ∞ YAKLA≈ûIM: localStorage'ƒ± temel al, GitHub'ƒ± sadece eksik PDF'ler i√ßin kullan
          if (seciliHasta && seciliHasta.id === hastaDetay.id && seciliHasta.haftalar) {
            console.log('üîÑ localStorage verisi temel alƒ±nƒ±yor, GitHub sadece eksik PDF baƒülantƒ±larƒ± i√ßin kullanƒ±lacak');
            
            // LocalStorage'daki hafta verilerini koru
            const mevcutHaftalar = seciliHasta.haftalar || [];
            const gitHubHaftalar = hastaDetay.haftalar || [];
            
            console.log('üîç MEVCUT HAFTALAR (localStorage - Temel):', mevcutHaftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis })));
            console.log('üîç GITHUB HAFTALAR (Sadece PDF link i√ßin):', gitHubHaftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis })));
            
            // LocalStorage verilerini temel al, sadece GitHub'dan PDF linklerini al
            const birlesikHaftalar = mevcutHaftalar.map(mevcutHafta => {
              const githubHafta = gitHubHaftalar.find(gh => gh.haftaNo === mevcutHafta.haftaNo);
              if (githubHafta) {
                // Sadece PDF ile ilgili alanlarƒ± GitHub'dan al
                return {
                  ...mevcutHafta, // localStorage verisi √∂ncelikli
                  // GitHub'dan sadece PDF linklerini al
                  ...(githubHafta.githubUrl && { githubUrl: githubHafta.githubUrl }),
                  ...(githubHafta.githubLink && { githubLink: githubHafta.githubLink }),
                  ...(githubHafta.indirmeUrl && { indirmeUrl: githubHafta.indirmeUrl }),
                  ...(githubHafta.githubRawLink && { githubRawLink: githubHafta.githubRawLink }),
                  ...(githubHafta.pdfGithubPath && { pdfGithubPath: githubHafta.pdfGithubPath })
                };
              }
              return mevcutHafta;
            });
            
            console.log('‚úÖ Hafta verileri localStorage temel alƒ±narak hazƒ±rlandƒ±:', birlesikHaftalar.length, 'hafta');
            
            // Hasta verisini g√ºncelle (localStorage √∂ncelikli)
            hastaDetay.haftalar = birlesikHaftalar;
            seciliHasta.haftalar = birlesikHaftalar;
            
          } else {
            // Yeni hasta veya hafta verisi yok - GitHub verisini al
            console.log('üÜï GitHub\'dan hasta verisi alƒ±nƒ±yor:', hastaDetay.isim);
          }
          
          // Cache'i de g√ºncelle (√ßoklu PDF i≈ülemi i√ßin)
          if (typeof cokluPdfHastaCache !== 'undefined') {
            const cacheKey = hastaDetay.isim.toUpperCase();
            cokluPdfHastaCache.set(cacheKey, hastaDetay);
            console.log(`üîÑ Cache g√ºncellendi: ${hastaDetay.isim} - Hafta sayƒ±sƒ±: ${hastaDetay.haftalar?.length || 0}`);
          }
          
          // Global deƒüi≈ükeni g√ºncelle
          seciliHasta = hastaDetay;
          
          // Otomatik kaydet - hasta verilerini localStorage'a kaydet
          autoSaveHastaData(seciliHasta);
          
          // UI'ƒ± g√ºncelle
          const secilenHastaIsim = document.getElementById('secilenHastaIsim');
          const secilenHastaNot = document.getElementById('secilenHastaNot');
          const hastaBilgiButonlar = document.getElementById('hastaBilgiButonlar');
          
          if (secilenHastaIsim) secilenHastaIsim.textContent = hastaDetay.isim;
          if (secilenHastaNot) secilenHastaNot.textContent = hastaDetay.not || 'Not yok';
          if (hastaBilgiButonlar) hastaBilgiButonlar.style.display = 'block'; // Butonlarƒ± g√∂ster
          
          // Se√ßili hastayƒ± vurgula
          vurgulaSeciliHasta(hastaBilgi.id);
          
          console.log('‚úÖ Yeni sistemde hasta bilgileri y√ºklendi:', hastaDetay.isim);
          
          // Hafta tablarƒ±nƒ± g√∂ster
          gosterHaftalar();
          
          // E≈üle≈ümeyenler listesini g√ºncelle (hasta deƒüi≈ütiƒüinde)
          setTimeout(() => {
            try {
              if (typeof eslesmeyenlerListesiniGuncelle === 'function') {
                eslesmeyenlerListesiniGuncelle();
              } else {
                console.warn('‚ö†Ô∏è eslesmeyenlerListesiniGuncelle fonksiyonu hen√ºz y√ºklenmemi≈ü (hasta deƒüi≈üimi)');
              }
            } catch (error) {
              console.warn('‚ö†Ô∏è eslesmeyenlerListesiniGuncelle hatasƒ± (hasta deƒüi≈üimi):', error.message);
            }
          }, 1000);
          
        } else {
          throw new Error(`Hasta dosyasƒ± bulunamadƒ±. Denenen dosyalar: ${benzersizDosyaAdlari.join(', ')}`);
        }
        
      } catch (error) {
        console.error('‚ùå Yeni sistemde hasta se√ßme hatasƒ±:', error);
        alert(`Hasta detaylarƒ± y√ºklenemedi: ${error.message}`);
      }
    }

    // === ESKƒ∞ Sƒ∞STEM (GERƒ∞YE UYUMLULUK) ===

    // ESKƒ∞ Sƒ∞STEM DEVRE DI≈ûI - Yeni sisteme y√∂nlendir
    function renderHastalar() {
      console.log('‚ö†Ô∏è renderHastalar √ßaƒürƒ±ldƒ±, yeni sisteme y√∂nlendiriliyor...');
      renderHastalarYeniSistem();
    }

    // Hastanƒ±n en son PDF y√ºklenen haftasƒ±nƒ± bul
    function getEnSonPdfHafta(hasta) {
      if (!hasta.haftalar || hasta.haftalar.length === 0) return 0;
      
      let enSonPdfHafta = 0;
      hasta.haftalar.forEach(hafta => {
        if (hafta.pdf && hafta.haftaNo > enSonPdfHafta) {
          enSonPdfHafta = hafta.haftaNo;
        }
      });
      
      return enSonPdfHafta;
    }

    function vurgulaSeciliHasta(hastaId) {
      // √ñnce t√ºm hasta vurgularƒ±nƒ± kaldƒ±r
      const tumHastalar = document.querySelectorAll('.hasta-item');
      tumHastalar.forEach(hasta => {
        hasta.classList.remove('secili-hasta');
      });
      
      // Se√ßilen hastayƒ± vurgula
      const secilenHasta = document.querySelector(`[data-hasta-id="${hastaId}"]`);
      if (secilenHasta) {
        secilenHasta.classList.add('secili-hasta');
        console.log('‚úÖ Hasta vurgulandƒ±:', hastaId);
      } else {
        console.log('‚ö†Ô∏è Vurgulanacak hasta bulunamadƒ±:', hastaId);
      }
    }

    function filtreleHastalar() { 
      // Yeni sistem kullanƒ±yorsa
      if (typeof renderHastalarYeniSistem === 'function') {
        renderHastalarYeniSistem();
      } else {
        // Eski sistem fallback
        renderHastalar();
      }
    }

    async function guncelleHastaSayilari() {
      try {
        // Yeni sistemden hasta listesini al
        const hastaData = await hastaListesiYukle();
        
        let aktifSayisi = 0;
        let arsivSayisi = 0;
        
        hastaData.forEach(hasta => {
          // arsiv property'sini kontrol et
          if (hasta.arsiv) {
            arsivSayisi++;
          } else {
            aktifSayisi++;
          }
        });
        
        const tumSayisi = hastaData.length;
        
        console.log(`üìä Yeni sistem hasta sayƒ±larƒ±: Aktif=${aktifSayisi}, Ar≈üiv=${arsivSayisi}, Toplam=${tumSayisi}`);
        
        // Select option'larƒ±nƒ± g√ºncelle
        const arsivFiltre = document.getElementById('arsivFiltre');
        if (arsivFiltre) {
          const mevcutSecim = arsivFiltre.value || 'aktif'; // Mevcut se√ßimi al
          
          arsivFiltre.innerHTML = `
            <option value="aktif">Aktif Hastalar (${aktifSayisi})</option>
            <option value="arsiv">Ar≈üiv (${arsivSayisi})</option>
            <option value="tum">T√ºm√º (${tumSayisi})</option>
          `;
          
          // Se√ßili deƒüeri geri y√ºkle
          arsivFiltre.value = mevcutSecim;
        }
        
      } catch (error) {
        console.error('Hasta sayƒ±larƒ± g√ºncellenirken hata:', error);
      }
    }

    function yeniHastaFormu() {
      console.log('üÜï Yeni hasta ekleme ba≈ülatƒ±ldƒ± (YENƒ∞ Sƒ∞STEM)');
      
      // Yeni hasta ismini iste
      const yeniIsim = prompt('Yeni hasta ismini girin:');
      if (yeniIsim === null) return; // ƒ∞ptal edildi
      
      const temizIsim = yeniIsim.trim();
      if (!temizIsim) {
        alert('ƒ∞sim bo≈ü olamaz!');
        return;
      }
      
      // Yeni hasta notunu iste
      const yeniNot = prompt('Hasta notu (opsiyonel):');
      if (yeniNot === null) return; // ƒ∞ptal edildi
      
      // ARTIK KARƒ∞KATER D√úZELTMESƒ∞ YAPMA - OLDUƒûU Gƒ∞Bƒ∞ KULLAN
      const duzeltilmisIsim = temizIsim;
      
      // Aynƒ± isimde hasta var mƒ± kontrol et (hem eski hem yeni sistemde)
      const mevcutHastaEski = hastalar.find(h => h && h.isim && h.isim.toLowerCase() === duzeltilmisIsim.toLowerCase());
      if (mevcutHastaEski) {
        alert('Bu isimde bir hasta zaten mevcut! (Eski sistem)');
        return;
      }
      
      // Yeni sistemde de kontrol et
      const mevcutHastaYeni = hastaListesi.find(h => h && h.isim && h.isim.toLowerCase() === duzeltilmisIsim.toLowerCase());
      if (mevcutHastaYeni) {
        alert('Bu isimde bir hasta zaten mevcut! (Yeni sistem)');
        return;
      }
      
      // Yeni hasta olu≈ütur
      const yeniHasta = {
        id: Date.now(),
        isim: duzeltilmisIsim,
        not: yeniNot ? yeniNot.trim() : '',
        arsiv: false,
        haftalar: [],
        olusturmaTarihi: new Date().toISOString(),
        yeniSistem: true
      };
      
      console.log('‚úÖ Yeni hasta olu≈üturuldu:', duzeltilmisIsim);
      
      // YENƒ∞ Sƒ∞STEME KAYDET
      // 1. √ñnce individual hasta dosyasƒ± olarak kaydet
      hastayiAyriKaydet(yeniHasta).then(basarili => {
        if (basarili) {
          console.log('‚úÖ Yeni hasta GitHub\'a kaydedildi:', duzeltilmisIsim);
          
          // 2. Global hasta listesini g√ºncelle
          const yeniHastaListeItem = {
            id: yeniHasta.id,
            isim: yeniHasta.isim,
            olusturmaTarihi: yeniHasta.olusturmaTarihi,
            arsiv: yeniHasta.arsiv || false
          };
          hastaListesi.push(yeniHastaListeItem);
          hastaListesi.sort((a, b) => {
            if (!a || !a.isim) return 1;
            if (!b || !b.isim) return -1;
            return a.isim.localeCompare(b.isim, 'tr');
          });
          console.log('‚úÖ Global hasta listesi g√ºncellendi');
          
          // 3. Hasta listesini yeniden render et
          renderHastalarYeniSistem();
          
          // 4. Yeni hastayƒ± se√ß
          seciliHasta = yeniHasta;
          
          // 5. Ba≈üarƒ± mesajƒ±
          alert(`‚úÖ Yeni hasta ba≈üarƒ±yla eklendi!\n\nüë§ ${duzeltilmisIsim}\nüìÅ Yeni sistem ile kaydedildi`);
          
        } else {
          console.error('‚ùå GitHub kaydetme ba≈üarƒ±sƒ±z');
          alert('‚ùå Hasta olu≈üturuldu ama GitHub\'a kaydedilemedi!\nL√ºtfen GitHub token kontrol√º yapƒ±n.');
        }
      }).catch(error => {
        console.error('‚ùå Hasta kaydetme hatasƒ±:', error);
        alert('‚ùå Hasta kaydetme hatasƒ±: ' + error.message);
      });
      
      // ESKƒ∞ Sƒ∞STEME EKLEME (sadece local olarak - geriye uyumluluk i√ßin)
      hastalar.push(yeniHasta);
      hastalar.sort((a, b) => {
        if (!a || !a.isim) return 1;
        if (!b || !b.isim) return -1;
        return a.isim.localeCompare(b.isim, 'tr');
      });
      saveToStorage();
      renderHastalar();
    }

    function iptalHastaFormu() {
      // Eski form elementleri kaldƒ±rƒ±ldƒ±
      console.log('Form iptal edildi');
    }

    function hastaDetayGoster(id) {
      seciliHasta = hastalar.find(h => h.id === id);
      if (!seciliHasta) return;
      
      const hastaIsim = seciliHasta.isim || seciliHasta.ad || 'Bilinmeyen Hasta';
      console.log(`üë§ Hasta se√ßildi: ${hastaIsim}`);
      
      // Hasta bilgi panelini g√ºncelle ve g√∂ster
      const hastaBilgiPanel = document.getElementById('hastaBilgiPanel');
      const secilenHastaIsim = document.getElementById('secilenHastaIsim');
      const secilenHastaNot = document.getElementById('secilenHastaNot');
      
      console.log('üîç Hasta bilgi paneli elementleri:', {
        hastaBilgiPanel: !!hastaBilgiPanel,
        secilenHastaIsim: !!secilenHastaIsim,
        secilenHastaNot: !!secilenHastaNot
      });
      
      if (hastaBilgiPanel && secilenHastaIsim && secilenHastaNot) {
        secilenHastaIsim.textContent = turkceKarakterDuzelt(hastaIsim);
        secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
        
        // Butonlarƒ± g√∂ster
        const hastaBilgiButonlar = document.getElementById('hastaBilgiButonlar');
        if (hastaBilgiButonlar) {
          hastaBilgiButonlar.style.display = 'block';
        }
        
        console.log('‚úÖ Hasta bilgi paneli g√ºncellendi:', hastaIsim);
      } else {
        console.log('‚ùå Hasta bilgi paneli elementleri bulunamadƒ±!');
      }
      
      // Sol sidebar'da aktif hastayƒ± vurgula
      renderHastalar();
      
      // Hafta listesini g√∂ster (center panel'de)
      gosterHaftalar();
      
      // Sidebar'larƒ± g√ºncelle
      hastaSecildiginde(hastalar.findIndex(h => h.id === id));
      
      console.log(`‚úÖ ${hastaIsim} i√ßin hafta tablarƒ± y√ºklendi ve aktif hafta otomatik se√ßilecek`);
    }

    function duzenleHasta() {
      if (!seciliHasta) return;
      
      const hastaIsim = seciliHasta.isim || seciliHasta.ad || 'Bilinmeyen Hasta';
      console.log('Hasta d√ºzenleme i√ßin:', hastaIsim);
      
      // Mevcut bilgileri al
      const mevcutIsim = seciliHasta.isim || seciliHasta.ad || '';
      const mevcutNot = seciliHasta.not || '';
      
      // Yeni isim iste
      const yeniIsim = prompt('Hasta ismini d√ºzenleyin:', mevcutIsim);
      if (yeniIsim === null) return; // ƒ∞ptal edildi
      
      const temizIsim = yeniIsim.trim();
      if (!temizIsim) {
        alert('ƒ∞sim bo≈ü olamaz!');
        return;
      }
      
      // Yeni not iste
      const yeniNot = prompt('Hasta notunu d√ºzenleyin:', mevcutNot);
      if (yeniNot === null) return; // ƒ∞ptal edildi
      
      // ARTIK KARƒ∞KATER D√úZELTMESƒ∞ YAPMA - OLDUƒûU Gƒ∞Bƒ∞ KULLAN
      const duzeltilmisIsim = temizIsim;
      
      // Deƒüi≈üiklikleri kaydet
      seciliHasta.isim = duzeltilmisIsim;
      seciliHasta.not = yeniNot.trim();
      
      // Verileri kaydet
      saveToStorage();
      
      // Ekranƒ± g√ºncelle
      const secilenHastaIsim = document.getElementById('secilenHastaIsim');
      const secilenHastaNot = document.getElementById('secilenHastaNot');
      
      if (secilenHastaIsim) {
        secilenHastaIsim.textContent = duzeltilmisIsim;
      }
      if (secilenHastaNot) {
        secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
      }
      
      // Hasta listesini yenile ve sƒ±rala
      hastalar.sort((a, b) => {
        if (!a || !a.isim) return 1;
        if (!b || !b.isim) return -1;
        return a.isim.localeCompare(b.isim, 'tr');
      });
      renderHastalar();
      
      console.log(`‚úÖ Hasta bilgileri g√ºncellendi: ${mevcutIsim} ‚Üí ${duzeltilmisIsim}`);
      
      // YENƒ∞ Sƒ∞STEM HASTA Lƒ∞STESƒ∞NDE ƒ∞SMƒ∞ G√úNCELLE
      const hastaListeItem = hastaListesi.find(h => h && h.id === seciliHasta.id);
      if (hastaListeItem) {
        hastaListeItem.isim = duzeltilmisIsim;
        console.log('‚úÖ Yeni sistem hasta listesinde isim g√ºncellendi');
      }
      
      // YENƒ∞ Sƒ∞STEME KAYDET
      hastayiAyriKaydet(seciliHasta).then(basarili => {
        if (basarili) {
          console.log('‚úÖ Hasta g√ºncellemesi GitHub\'a kaydedildi:', duzeltilmisIsim);
          renderHastalarYeniSistem(); // Yeni sistemi g√ºncelle
        } else {
          console.warn('‚ö†Ô∏è GitHub kaydƒ± ba≈üarƒ±sƒ±z oldu, ancak yerel deƒüi≈üiklikler kaydedildi');
        }
      }).catch(error => {
        console.error('‚ùå GitHub kaydetme hatasƒ±:', error);
      });
    }

    async function arsivleHasta() {
      if (!seciliHasta) {
        alert('‚ùå √ñnce bir hasta se√ßin!');
        return;
      }
      
      try {
        // Ar≈üiv durumunu deƒüi≈ütir
        seciliHasta.arsiv = !seciliHasta.arsiv;
        seciliHasta.sonGuncelleme = new Date().toISOString();
        
        const durum = seciliHasta.arsiv ? 'ar≈üivlendi' : 'ar≈üivden √ßƒ±karƒ±ldƒ±';
        console.log(`üì¶ ${seciliHasta.isim} ${durum}`);
        
        // GitHub'a kaydet
        const sonuc = await hastayiAyriKaydet(seciliHasta);
        if (sonuc) {
          alert(`‚úÖ ${seciliHasta.isim} ${durum}!`);
          
          // Hasta listesini yenile
          await renderHastalarYeniSistem();
          
          // Hasta bilgi panelini g√ºncelle
          const secilenHastaNot = document.getElementById('secilenHastaNot');
          if (secilenHastaNot) {
            secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
          }
        } else {
          // Hata durumunda geri al
          seciliHasta.arsiv = !seciliHasta.arsiv;
          alert(`‚ùå ${durum} i≈ülemi ba≈üarƒ±sƒ±z!`);
        }
      } catch (error) {
        console.error('‚ùå Ar≈üivleme hatasƒ±:', error);
        alert(`‚ùå Ar≈üivleme hatasƒ±: ${error.message}`);
      }
    }

    async function silHasta() {
      if (!seciliHasta) {
        alert('‚ùå √ñnce bir hasta se√ßin!');
        return;
      }
      
      const onay = confirm(`üóëÔ∏è "${seciliHasta.isim}" hasta kaydƒ±nƒ± silmek istediƒüinize emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!`);
      if (!onay) return;
      
      try {
        console.log(`üóëÔ∏è ${seciliHasta.isim} hasta kaydƒ± siliniyor...`);
        
        // GitHub'dan hasta dosyasƒ±nƒ± sil
        const owner = 'mustafasacar35';
        const repo = 'nutrition-planner';
        const token = document.getElementById('githubToken').value.trim();
        
        if (!token) {
          alert('‚ùå GitHub token gerekli!');
          return;
        }
        
        // Dosya adƒ± alternatifleri dene (hastaSecYeniSistem gibi)
        const dosyaAdlari = [
          generateFileName({ id: seciliHasta.id, isim: seciliHasta.isim }),
          generateFileName({ id: seciliHasta.id, isim: turkceKarakterDuzelt(seciliHasta.isim) }),
          generateFileName({ isim: seciliHasta.isim }),
          generateFileName({ isim: turkceKarakterDuzelt(seciliHasta.isim) })
        ];
        
        const benzersizDosyaAdlari = [...new Set(dosyaAdlari)];
        console.log('üîç Silinecek dosya adlarƒ± deneniyor:', benzersizDosyaAdlari);
        
        let bulunanDosya = null;
        let dosyaSHA = null;
        
        // Dosyayƒ± bul
        for (const dosyaAdi of benzersizDosyaAdlari) {
          try {
            console.log(`üîç Denenen dosya: ${dosyaAdi}`);
            const shaResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${dosyaAdi}`, {
              headers: { 'Authorization': `token ${token}` }
            });
            
            if (shaResponse.ok) {
              const shaData = await shaResponse.json();
              bulunanDosya = dosyaAdi;
              dosyaSHA = shaData.sha;
              console.log(`‚úÖ Silinecek dosya bulundu: ${dosyaAdi}`);
              break;
            }
          } catch (e) {
            console.log(`‚ùå Dosya bulunamadƒ±: ${dosyaAdi}`);
          }
        }
        
        if (!bulunanDosya) {
          throw new Error(`Hasta dosyasƒ± bulunamadƒ±. Denenen dosyalar: ${benzersizDosyaAdlari.join(', ')}`);
        }
        
        // Dosyayƒ± silmek yerine adƒ±nƒ± deƒüi≈ütir (timestamp ile benzersiz hale getir)
        const timestamp = new Date().getTime();
        const eskiDosyaAdi = bulunanDosya;
        const yeniDosyaAdi = `silindi_${timestamp}_${eskiDosyaAdi}`;
        
        console.log(`üîÑ Dosya adƒ± deƒüi≈ütiriliyor: ${eskiDosyaAdi} ‚Üí ${yeniDosyaAdi}`);
        
        // Yeni dosya adƒ±nƒ±n zaten var olup olmadƒ±ƒüƒ±nƒ± kontrol et
        try {
          const varlikKontrol = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${yeniDosyaAdi}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          
          if (varlikKontrol.ok) {
            console.warn(`‚ö†Ô∏è ${yeniDosyaAdi} zaten var, farklƒ± timestamp deneniyor`);
            const yeniTimestamp = timestamp + Math.floor(Math.random() * 1000);
            yeniDosyaAdi = `silindi_${yeniTimestamp}_${eskiDosyaAdi}`;
            console.log(`üîÑ Yeni dosya adƒ±: ${yeniDosyaAdi}`);
          }
        } catch (e) {
          // Dosya yok, bu iyi
          console.log(`‚úÖ ${yeniDosyaAdi} kullanƒ±labilir`);
        }
        
        // √ñnce dosyanƒ±n i√ßeriƒüini al
        const contentResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${eskiDosyaAdi}`, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (!contentResponse.ok) {
          throw new Error(`Dosya i√ßeriƒüi alƒ±namadƒ±: ${contentResponse.status}`);
        }
        
        const contentData = await contentResponse.json();
        const dosyaIcerigi = contentData.content; // Base64 i√ßerik
        
        // Yeni adla dosyayƒ± olu≈ütur
        const createResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${yeniDosyaAdi}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta dosyasƒ± ar≈üivlendi: ${seciliHasta.isim} - ${new Date().toLocaleString('tr-TR')}`,
            content: dosyaIcerigi // Base64 i√ßeriƒüi direkt kullan
          })
        });
        
        if (!createResponse.ok) {
          const errorText = await createResponse.text();
          console.error('‚ùå Ar≈üiv dosyasƒ± olu≈üturma hatasƒ±:', createResponse.status, errorText);
          
          if (createResponse.status === 422) {
            throw new Error(`Ar≈üiv dosyasƒ± zaten var veya ge√ßersiz: ${yeniDosyaAdi}. L√ºtfen tekrar deneyin.`);
          } else {
            throw new Error(`Ar≈üiv dosyasƒ± olu≈üturulamadƒ±: ${createResponse.status} - ${errorText}`);
          }
        }
        
        console.log(`‚úÖ Ar≈üiv dosyasƒ± olu≈üturuldu: ${yeniDosyaAdi}`);
        
        // Eski dosyayƒ± sil
        const deleteResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${eskiDosyaAdi}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta dosyasƒ± ar≈üivlendi (eski dosya silindi): ${seciliHasta.isim}`,
            sha: dosyaSHA
          })
        });
        
        if (deleteResponse.ok) {
          console.log(`‚úÖ Hasta dosyasƒ± ar≈üivlendi: ${eskiDosyaAdi} ‚Üí ${yeniDosyaAdi}`);
          
          // Hasta listesinden de kaldƒ±r
          const listeGuncellendi = await hastaListesindenKaldir(seciliHasta.id);
          if (listeGuncellendi) {
            alert(`‚úÖ ${seciliHasta.isim} hasta kaydƒ± ar≈üivlendi!\n\nDosya: ${yeniDosyaAdi}`);
            
            // Panel temizle ve listeyi yenile
            kapatDetay();
            await renderHastalarYeniSistem();
          } else {
            alert(`‚ö†Ô∏è Hasta dosyasƒ± ar≈üivlendi ama listeden kaldƒ±rƒ±lamadƒ±. Sayfayƒ± yenileyin.`);
          }
        } else {
          throw new Error(`Eski dosya silinemedi: ${deleteResponse.status}`);
        }
        
      } catch (error) {
        console.error('‚ùå Hasta silme hatasƒ±:', error);
        
        // 422 hatasƒ± √∂zel durumu - alternatif silme y√∂ntemi √∂ner
        if (error.message.includes('422') || error.message.includes('zaten var')) {
          const alternatifOnay = confirm(`‚ùå Ar≈üivleme ba≈üarƒ±sƒ±z (dosya √ßakƒ±≈ümasƒ±).\n\nüîÑ Alternatif y√∂ntem: Sadece hasta listesinden kaldƒ±rmak ister misiniz?\n\n(Dosya GitHub'da kalacak ama listede g√∂r√ºnmeyecek)`);
          
          if (alternatifOnay) {
            try {
              const listeGuncellendi = await hastaListesindenKaldir(seciliHasta.id);
              if (listeGuncellendi) {
                alert(`‚úÖ ${seciliHasta.isim} hasta listesinden kaldƒ±rƒ±ldƒ±!\n\n‚ö†Ô∏è Not: Dosya GitHub'da hala mevcut.`);
                kapatDetay();
                await renderHastalarYeniSistem();
                return;
              }
            } catch (listeError) {
              console.error('‚ùå Liste g√ºncelleme hatasƒ±:', listeError);
            }
          }
        }
        
        alert(`‚ùå Hasta silme hatasƒ±: ${error.message}\n\nüí° √ñneriler:\n- Aynƒ± hasta i√ßin √∂nceki silme i≈ülemi tamamlanmamƒ±≈ü olabilir\n- Birka√ß dakika bekleyip tekrar deneyin\n- Ya da sadece "listeden kaldƒ±r" se√ßeneƒüini kullanƒ±n`);
      }
    }

    // Sadece listeden kaldƒ±rma fonksiyonu (dosyayƒ± silmez)
    async function sadeceLisedenKaldir() {
      if (!seciliHasta) {
        alert('‚ùå √ñnce bir hasta se√ßin!');
        return;
      }
      
      const onay = confirm(`üìã "${seciliHasta.isim}" hastasƒ±nƒ± sadece listeden kaldƒ±rmak istediƒüinize emin misiniz?\n\n‚ö†Ô∏è Dosya GitHub'da kalacak, sadece listede g√∂r√ºnmeyecek.`);
      if (!onay) return;
      
      try {
        console.log(`üìã ${seciliHasta.isim} listeden kaldƒ±rƒ±lƒ±yor...`);
        
        const listeGuncellendi = await hastaListesindenKaldir(seciliHasta.id);
        if (listeGuncellendi) {
          alert(`‚úÖ ${seciliHasta.isim} listeden kaldƒ±rƒ±ldƒ±!\n\nüíæ Dosya GitHub'da korunuyor.`);
          kapatDetay();
          await renderHastalarYeniSistem();
        } else {
          throw new Error('Liste g√ºncellenemedi');
        }
        
      } catch (error) {
        console.error('‚ùå Listeden kaldƒ±rma hatasƒ±:', error);
        alert(`‚ùå Listeden kaldƒ±rma hatasƒ±: ${error.message}`);
      }
    }

    // Global eri≈üim i√ßin
    window.sadeceLisedenKaldir = sadeceLisedenKaldir;

    function kapatDetay() {
      // Hasta bilgi panelindeki bilgileri sƒ±fƒ±rla
      const secilenHastaIsim = document.getElementById('secilenHastaIsim');
      const secilenHastaNot = document.getElementById('secilenHastaNot');
      const hastaBilgiButonlar = document.getElementById('hastaBilgiButonlar');
      
      if (secilenHastaIsim) {
        secilenHastaIsim.textContent = 'Hasta Se√ßilmedi';
      }
      if (secilenHastaNot) {
        secilenHastaNot.textContent = 'L√ºtfen sol men√ºden bir hasta se√ßin';
      }
      if (hastaBilgiButonlar) {
        hastaBilgiButonlar.style.display = 'none';
      }
      
      // Se√ßili hastayƒ± temizle
      seciliHasta = null;
      
      // Hafta tablarƒ±nƒ± temizle
      const haftaTabs = document.getElementById('haftaTabs');
      const haftaTabContent = document.getElementById('haftaTabContent');
      if (haftaTabs) haftaTabs.innerHTML = '';
      if (haftaTabContent) haftaTabContent.innerHTML = '';
      
      // Cache'i temizle
      if (typeof cokluPdfHastaCache !== 'undefined') {
        console.log('üßπ Cache temizleniyor...');
        cokluPdfHastaCache.clear();
      }
      
      // Sol sidebar'da vurgulamayƒ± kaldƒ±r
      renderHastalar();
    }


    // --- Hasta Haftalarƒ± ---
    function getHaftaListesi() {
      if (!seciliHasta) {
        console.log('üîç getHaftaListesi: seciliHasta yok');
        return [];
      }
      if (!seciliHasta.haftalar) {
        console.log('üîç getHaftaListesi: haftalar array yok, olu≈üturuluyor');
        seciliHasta.haftalar = [];
      }
      
      console.log(`üîç getHaftaListesi: ${seciliHasta.haftalar.length} hafta bulundu`);
      console.log('üîç getHaftaListesi detay:', seciliHasta.haftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis, pdfName: h.pdfName })));
      
      // Hafta listesini hafta numarasƒ±na g√∂re sƒ±rala (k√º√ß√ºkten b√ºy√ºƒüe)
      const sorted = seciliHasta.haftalar.sort((a, b) => {
        const aHaftaNo = a.haftaNo || 1;
        const bHaftaNo = b.haftaNo || 1;
        return aHaftaNo - bHaftaNo;
      });
      
      console.log(`üîç getHaftaListesi: Sƒ±ralanmƒ±≈ü ${sorted.length} hafta d√∂nd√ºr√ºl√ºyor`);
      return sorted;
    }

    function haftaEkle() {
      if (!seciliHasta) return;
      if (!seciliHasta.haftalar) seciliHasta.haftalar = [];
      
      // Bir sonraki hafta numarasƒ±nƒ± hesapla
      let sonrakiHaftaNo = 1;
      if (seciliHasta.haftalar.length > 0) {
        const sonHafta = seciliHasta.haftalar[seciliHasta.haftalar.length - 1];
        sonrakiHaftaNo = (sonHafta.haftaNo || seciliHasta.haftalar.length) + 1;
      }
      
      let startDate = null;
      if (seciliHasta.haftalar.length > 0) {
        // Son haftanƒ±n pazarƒ±ndan bir g√ºn sonrasƒ±
        const last = seciliHasta.haftalar[seciliHasta.haftalar.length-1];
        try {
          if (last.baslangic) {
            startDate = new Date(new Date(last.baslangic).getTime() + 7*24*60*60*1000);
          } else {
            throw new Error('Ba≈ülangƒ±√ß tarihi yok');
          }
          
          // Tarih ge√ßerli mi kontrol et
          if (isNaN(startDate.getTime())) {
            throw new Error('Ge√ßersiz tarih');
          }
        } catch (e) {
          console.warn('Son hafta tarih hatasƒ±:', e);
          // Bug√ºnden ba≈üla
          const now = new Date();
          const day = now.getDay();
          const diff = (day === 0 ? 1 : 8 - day); // Gelecek pazartesi
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
        }
      } else {
        // ƒ∞lk hafta i√ßin bug√ºn√ºn pazartesisi
        const now = new Date();
        const day = now.getDay();
        const diff = (day === 0 ? -6 : 1) - day; // Pazartesiye √ßek
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
      }
      
      // Final g√ºvenlik kontrol√º
      if (!startDate || isNaN(startDate.getTime())) {
        startDate = new Date(); // En son √ßare olarak bug√ºn
      }
      
      const endDate = new Date(startDate.getTime() + 6*24*60*60*1000);
      seciliHasta.haftalar.push({
        haftaNo: sonrakiHaftaNo, // YENƒ∞: Hafta numarasƒ±
        baslangic: startDate.toISOString().slice(0,10),
        bitis: endDate.toISOString().slice(0,10),
        aciklama: '',
        pdf: null,
        pdfName: null,  // PDF g√ºvenli dosya adƒ±
        pdfOrijinalIsim: null,  // PDF'nin orijinal dosya adƒ±
        pdfYolu: null,  // GitHub'daki PDF yolu (pdfs/dosya.pdf)
        githubUrl: null,  // GitHub'da g√∂r√ºnt√ºleme linki
        indirmeUrl: null,  // Direkt indirme linki
        kayitTarihi: null, // PDF y√ºkleme tarihi
        tarifKartlar: [],
        tarifler: [],
        gptMesaj: '',
        kilitli: false, // YENƒ∞: Emniyet kilidi (false = a√ßƒ±k)
        kayitTarihi: null // Kaydedilme tarihi
      });
      saveToStorage();
      
      console.log('‚úÖ Yeni hafta eklendi:', sonrakiHaftaNo, 'numaralƒ± hafta');
      
      // Otomatik kaydetme - hafta eklendi
      autoSaveHastaData(seciliHasta);
      
      // Tab sistemini yeniden y√ºkle ve yeni tab'a ge√ß
      gosterHaftalar();
      const yeniTabIndex = seciliHasta.haftalar.length - 1;
      
      // 5. hafta kontrol√º - Lenf Drenaj Takvimi otomatik olu≈ütur
      if (sonrakiHaftaNo === 5) {
        setTimeout(() => {
          if (confirm(`üè• 5. hafta eklendi!\n\nLenf Drenaj Masajƒ± Takvimi otomatik olarak olu≈üturulsun mu?`)) {
            generateLenfDrenajTakvimi();
          }
        }, 500);
      }
      
      setTimeout(() => {
        switchTab(yeniTabIndex);
        // Sidebar'larƒ± g√ºncelle
        hastaSecildiginde(hastalar.findIndex(h => h.id === seciliHasta.id));
      }, 100);
    }

    // Hafta verilerini normalize et (eski data format uyumluluƒüu i√ßin)
    function normalizeHaftaData() {
      if (!seciliHasta || !seciliHasta.haftalar) return;
      
      let dataUpdated = false;
      
      seciliHasta.haftalar.forEach((hafta, index) => {
        // Hafta numarasƒ± yoksa ekle
        if (!hafta.haftaNo) {
          hafta.haftaNo = index + 1;
          dataUpdated = true;
        }
        
        // Tarif kartlarƒ± alanƒ± yoksa ekle
        if (!hafta.tarifKartlar) {
          hafta.tarifKartlar = [];
          dataUpdated = true;
        }
        
        // Tarifler alanƒ± yoksa ekle
        if (!hafta.tarifler) {
          hafta.tarifler = [];
          dataUpdated = true;
        }
        
        // GPT mesaj alanƒ± yoksa ekle
        if (hafta.gptMesaj === undefined) {
          hafta.gptMesaj = '';
          dataUpdated = true;
        }
        
        // A√ßƒ±klama alanƒ± yoksa ekle
        if (hafta.aciklama === undefined) {
          hafta.aciklama = '';
          dataUpdated = true;
        }
        
        // PDF alanƒ± yoksa ekle
        if (hafta.pdf === undefined) {
          hafta.pdf = null;
          dataUpdated = true;
        }
        
        // PDF dosya adƒ± yoksa ekle
        if (hafta.pdfName === undefined) {
          hafta.pdfName = null;
          dataUpdated = true;
        }
        
        // PDF orijinal isim yoksa ekle
        if (hafta.pdfOrijinalIsim === undefined) {
          hafta.pdfOrijinalIsim = hafta.pdfName; // Mevcut pdfName'i kopyala
          dataUpdated = true;
        }
        
        // PDF yolu yoksa ekle
        if (hafta.pdfYolu === undefined) {
          hafta.pdfYolu = null;
          dataUpdated = true;
        }
        
        // GitHub URL'leri yoksa ekle
        if (hafta.githubUrl === undefined) {
          hafta.githubUrl = null;
          dataUpdated = true;
        }
        
        if (hafta.indirmeUrl === undefined) {
          hafta.indirmeUrl = null;
          dataUpdated = true;
        }
        
        // Kayƒ±t tarihi yoksa ekle
        if (hafta.kayitTarihi === undefined) {
          hafta.kayitTarihi = null;
          dataUpdated = true;
        }
        
        // Kilit durumu yoksa ekle (varsayƒ±lan: kilitli deƒüil)
        if (hafta.kilitli === undefined) {
          hafta.kilitli = false;
          dataUpdated = true;
        }
        
        // Ba≈ülangƒ±√ß ve biti≈ü tarihleri yoksa olu≈ütur
        if (!hafta.baslangic || !hafta.bitis) {
          try {
            const now = new Date();
            // Bu haftanƒ±n pazartesini bul
            const thisWeekMonday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 1);
            // ƒ∞stenen hafta i√ßin pazartesi (index * 7 g√ºn ekle)
            const weekStart = new Date(thisWeekMonday.getTime() + (index * 7 * 24 * 60 * 60 * 1000));
            const weekEnd = new Date(weekStart.getTime() + 6*24*60*60*1000);
            
            hafta.baslangic = weekStart.toISOString().slice(0,10);
            hafta.bitis = weekEnd.toISOString().slice(0,10);
            dataUpdated = true;
          } catch (e) {
            console.warn('Tarih olu≈üturma hatasƒ± hafta', index + 1, ':', e);
          }
        } else {
          // Mevcut ba≈ülangƒ±√ß tarihinin pazartesi olmasƒ±nƒ± garanti altƒ±na al
          try {
            const baslangicTarihi = new Date(hafta.baslangic);
            const gunNo = baslangicTarihi.getDay(); // 0=Pazar, 1=Pazartesi
            
            if (gunNo !== 1) { // Pazartesi deƒüilse d√ºzelt
              const gunFarki = gunNo === 0 ? 1 : (1 - gunNo); // Pazartesiye kadar olan g√ºn farkƒ±
              baslangicTarihi.setDate(baslangicTarihi.getDate() + gunFarki);
              
              // Biti≈ü tarihini de g√ºncelle (6 g√ºn sonra pazar)
              const bitisTarihi = new Date(baslangicTarihi.getTime() + 6*24*60*60*1000);
              
              hafta.baslangic = baslangicTarihi.toISOString().slice(0,10);
              hafta.bitis = bitisTarihi.toISOString().slice(0,10);
              dataUpdated = true;
              
              console.log(`üìÖ ${index + 1}. hafta ba≈ülangƒ±cƒ± pazartesi olarak d√ºzeltildi:`, hafta.baslangic);
            }
          } catch (e) {
            console.warn('Tarih d√ºzeltme hatasƒ± hafta', index + 1, ':', e);
          }
        }
      });
      
      if (dataUpdated) {
        console.log('üîÑ Hafta verileri normalize edildi');
        saveToStorage();
      }
    }

    function gosterHaftalar() {
      const tabsDiv = document.getElementById('haftaTabs');
      const contentDiv = document.getElementById('haftaTabContent');
      
      if (!tabsDiv || !contentDiv) return;
      
      // CSS class'ƒ±nƒ± garanti et
      tabsDiv.className = 'hafta-tabs';
      tabsDiv.style.display = 'flex';
      tabsDiv.style.flexWrap = 'wrap';
      tabsDiv.style.gap = '5px';
      console.log('üè∑Ô∏è Hafta tabs CSS class atandƒ±:', tabsDiv.className);
      console.log('üè∑Ô∏è Hafta tabs computed style:', window.getComputedStyle(tabsDiv).display);
      
      tabsDiv.innerHTML = '';
      contentDiv.innerHTML = '';
      
      // Hafta verilerini normalize et
      normalizeHaftaData();
      
      const haftalar = getHaftaListesi();
      
      // DEBUG: Hafta verilerini detaylƒ± logla
      console.log('üîç HAFTA VERƒ∞LERƒ∞ DEBUG:');
      console.log('üîç SeciliHasta:', seciliHasta?.isim);
      console.log('üîç SeciliHasta haftalar count:', seciliHasta?.haftalar?.length);
      console.log('üîç GetHaftaListesi count:', haftalar?.length);
      console.log('üîç Hafta detaylarƒ±:', haftalar.map(h => ({
        haftaNo: h.haftaNo,
        baslangic: h.baslangic,
        bitis: h.bitis,
        hasPdf: !!h.pdf,
        pdfName: h.pdfName || h.pdfOrijinalIsim || 'yok'
      })));
      
      // Cache'i kontrol et
      if (typeof cokluPdfHastaCache !== 'undefined') {
        const cacheKey = seciliHasta?.isim?.toUpperCase();
        const cachedData = cokluPdfHastaCache.get(cacheKey);
        console.log('üîç Cache\'te bu hasta:', !!cachedData);
        if (cachedData) {
          console.log('üîç Cache\'teki hafta sayƒ±sƒ±:', cachedData.haftalar?.length);
          console.log('üîç Cache\'teki haftalar:', cachedData.haftalar?.map(h => ({
            haftaNo: h.haftaNo,
            baslangic: h.baslangic,
            bitis: h.bitis
          })));
        }
      }
      
      // Backward compatibility: Mevcut haftalara hafta numarasƒ± ekle
      let haftaNumarasiDegisti = false;
      haftalar.forEach((hafta, i) => {
        if (!hafta.haftaNo) {
          hafta.haftaNo = i + 1;
          haftaNumarasiDegisti = true;
        }
      });
      if (haftaNumarasiDegisti) {
        saveToStorage();
        console.log('üîÑ Mevcut haftalara hafta numaralarƒ± eklendi');
      }
      
      // Tablarƒ± olu≈ütur
      haftalar.forEach((hafta, i) => {
        const haftaNo = hafta.haftaNo || (i + 1);
        
        // Tab ba≈ülƒ±ƒüƒ± olu≈ütur - ƒ∞LK TAB AKTƒ∞F OLSUN (son tƒ±klanan kalacak)
        const tabDiv = document.createElement('div');
        tabDiv.className = `hafta-tab ${i === 0 ? 'active' : ''} ${hafta.kilitli ? 'locked' : ''}`;
        tabDiv.dataset.haftaIndex = i; // Dataset ekle
        tabDiv.onclick = () => switchTab(i);
        
        // Status g√∂stergeleri
        const hasPdf = hafta.pdf ? 'status-pdf' : 'status-empty';
        const hasKartlar = (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) ? 'status-kartlar' : 'status-empty';
        const hasEslesen = (hafta.tarifler && hafta.tarifler.length > 0) ? 'status-eslesen' : 'status-empty';
        const isLocked = hafta.kilitli ? 'status-locked' : 'status-empty';
        
        // Tarih bilgilerini g√ºvenli ≈üekilde kontrol et
        const baslangicTarih = hafta.baslangic || '';
        const bitisTarih = hafta.bitis || '';
        let tarihGosterim = '';
        
        if (baslangicTarih && bitisTarih) {
          try {
            const basParts = baslangicTarih.split('-');
            const bitParts = bitisTarih.split('-');
            if (basParts.length === 3 && bitParts.length === 3) {
              tarihGosterim = `${basParts[1]}/${basParts[2]} - ${bitParts[1]}/${bitParts[2]}`;
            }
          } catch (e) {
            console.warn('Tarih parse hatasƒ±:', e);
            tarihGosterim = 'Tarih belirtilmemi≈ü';
          }
        } else {
          tarihGosterim = 'Tarih belirtilmemi≈ü';
        }
        
        tabDiv.innerHTML = `
          <div style="font-weight: bold; font-size: 14px;">${haftaNo}. Hafta</div>
          <div style="font-size: 10px; color: #666; margin-top: 2px;">
            ${tarihGosterim}
          </div>
          <div class="tab-status-indicators">
            <span class="status-indicator ${hasPdf}" title="PDF durumu"></span>
            <span class="status-indicator ${hasKartlar}" title="Manuel kartlar"></span>
            <span class="status-indicator ${hasEslesen}" title="E≈üle≈üen kartlar"></span>
            <span class="status-indicator ${isLocked}" title="Kilit durumu"></span>
          </div>
          ${hafta.kilitli ? '<span class="tab-lock-icon">üîí</span>' : ''}
        `;
        tabsDiv.appendChild(tabDiv);
        console.log(`üè∑Ô∏è ${haftaNo}. hafta tab'ƒ± eklendi, CSS class:`, tabDiv.className);
        
        // Tab i√ßeriƒüi olu≈ütur - ƒ∞LK TAB AKTƒ∞F OLSUN (son tƒ±klanan kalacak)
        const contentTab = document.createElement('div');
        contentTab.className = `hafta-tab-content ${i === 0 ? 'active' : ''}`;
        contentTab.id = `haftaContent_${i}`;
        
        contentTab.innerHTML = `
          <div class="hafta-tab-header">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div style="display: flex; align-items: center; gap: 5px;">
                <span id="haftaNoDisplay_${i}" style="font-weight: bold; font-size: 18px; cursor: text; padding: 4px 8px; border-radius: 4px; min-width: 20px; text-align: center;" 
                      onclick="editHaftaNo(${i})" title="Hafta numarasƒ±nƒ± d√ºzenlemek i√ßin tƒ±klayƒ±n">${haftaNo}</span>
                <span style="font-weight: bold; font-size: 18px;">. Hafta</span>
                <input type="number" id="haftaNo_${i}" value="${haftaNo}" min="1" max="52" 
                       style="display: none; width: 50px; font-weight: bold; text-align: center; border: 2px solid #007bff; border-radius: 4px; padding: 4px;"
                       onblur="saveHaftaNo(${i})" onkeypress="if(event.key==='Enter') saveHaftaNo(${i})">
              </div>
              <span style="color: #666; font-size: 14px;">üìÖ ${hafta.baslangic} - ${hafta.bitis}</span>
            </div>
            <div style="display: flex; gap: 5px;">
              ${!hafta.kilitli ? `
                <button onclick="haftaKaydet(${i})" class="kayit-btn" style="padding: 5px 12px; font-size: 12px;">üíæ Kaydet</button>
              ` : `
                <button class="kayit-btn saved" style="padding: 5px 12px; font-size: 12px;">‚úÖ Kaydedildi</button>
                <button onclick="haftaKilidiAc(${i})" class="kilit-ac-btn" style="padding: 5px 10px; font-size: 11px;">üîì Kilidi A√ß</button>
              `}
              <button onclick="duzenleHafta(${i})" style="padding: 5px 10px; font-size: 12px;">D√ºzenle</button>
              <button onclick="silHafta(${i})" style="padding: 5px 10px; font-size: 12px; color: red;">Sil</button>
              ${haftaNo === 5 ? `<button onclick="haftaZipIndir(${i}, 5)" style="padding: 5px 10px; font-size: 12px; background: #17a2b8; color: white; border: none; border-radius: 4px;" title="5. hafta √∂zel ZIP (Kilitli durumda da kullanƒ±labilir)">üì¶ ZIP</button>` : ''}
              ${haftaNo === 9 ? `<button onclick="haftaZipIndir(${i}, 9)" style="padding: 5px 10px; font-size: 12px; background: #6f42c1; color: white; border: none; border-radius: 4px;" title="9. hafta √∂zel ZIP (Kilitli durumda da kullanƒ±labilir)">üì¶ ZIP</button>` : ''}
            </div>
          </div>
          
          <!-- Ana ƒ∞√ßerik - Horizontal Layout (2 kolon: PDF ve A√ßƒ±klama) -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            
            <!-- PDF B√∂l√ºm√º -->
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;" class="${hafta.kilitli ? 'locked-area' : ''}">
              <h4 style="margin: 0 0 10px 0; color: #28a745; font-size: 14px;">üìÑ PDF</h4>
              
              <!-- PDF Y√ºkleme Se√ßenekleri -->
              <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex: 1;">
                  <input type="file" accept="application/pdf" onchange="pdfYukleHafta(${i}, this)" 
                         style="width: 100%; font-size: 12px;" ${hafta.kilitli ? 'disabled' : ''}>
                </div>
                <button onclick="drivedenPdfYukle(${i})" 
                        style="padding: 8px 12px; font-size: 11px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 5px;" 
                        ${hafta.kilitli ? 'disabled' : ''} 
                        title="Google Drive'dan ${seciliHasta?.hastaIsim || 'hasta'} i√ßin ${i}. hafta PDF'ini y√ºkle">
                  <span style="font-size: 12px;">üíæ</span>
                  Drive'dan Y√ºkle
                </button>
              </div>
              
              ${hafta.pdf || hafta.pdfYolu ? `
                <div style="color: green; font-weight: bold; font-size: 12px; background: #d4edda; padding: 8px; border-radius: 4px; border-left: 3px solid #28a745;">
                  ‚úÖ <strong style="color: #155724; font-size: 13px;">${hafta.pdfOrijinalIsim || hafta.pdfName || 'hafta.pdf'}</strong>
                  ${hafta.pdfOrijinalIsim && hafta.pdfName && hafta.pdfOrijinalIsim !== hafta.pdfName ? `
                    <div style="color: #6c757d; font-size: 11px; margin-top: 2px;">
                      üìÅ G√ºvenli ad: ${hafta.pdfName}
                    </div>
                  ` : ''}
                  <div style="color: #666; font-weight: normal; margin-top: 5px; font-size: 11px;">
                    üìä ${hafta.tarifler ? hafta.tarifler.length : 0} tarif tespit edildi
                  </div>
                  <div style="color: #495057; font-weight: normal; margin-top: 3px; font-size: 10px;">
                    üìÖ Y√ºklenme: ${hafta.kayitTarihi ? new Date(hafta.kayitTarihi).toLocaleString('tr-TR') : 'Bilinmiyor'}
                  </div>
                  ${hafta.githubUrl || hafta.githubLink ? `
                    <div style="margin-top: 8px; padding-top: 5px; border-top: 1px solid #c3e6cb;">
                      <a href="javascript:void(0)" onclick="pdfGoruntule('${hafta.indirmeUrl || hafta.githubRawLink || hafta.githubUrl}')" style="color: #0066cc; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                        <span style="font-size: 12px;">üëÅÔ∏è</span> PDF G√∂r√ºnt√ºle
                      </a>
                      <span style="margin: 0 5px; color: #dee2e6;">|</span>
                      <a href="${hafta.githubUrl || hafta.githubLink}" target="_blank" style="color: #666; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                        <span style="font-size: 12px;">üîó</span> GitHub'da G√∂r√ºnt√ºle
                      </a>
                      ${hafta.indirmeUrl || hafta.githubRawLink ? `
                        <span style="margin: 0 5px; color: #dee2e6;">|</span>
                        <a href="javascript:void(0)" onclick="pdfIndir('${hafta.indirmeUrl || hafta.githubRawLink}', '${hafta.pdfOrijinalIsim || hafta.pdfName}')" style="color: #28a745; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                          <span style="font-size: 12px;">üíæ</span> ƒ∞ndir
                        </a>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>
              ` : '<div style="color: #666; font-size: 12px; background: #f8f9fa; padding: 8px; border-radius: 4px;">üìÑ PDF hen√ºz y√ºklenmedi</div>'}
              
              ${hafta.pdf && (hafta.pdfMetinYok || hafta.googleSheetsPdf || hafta.pdfBoyutHatasi) ? `
                <div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 4px; border-left: 3px solid #ffc107; font-size: 11px; color: #856404;">
                  ${hafta.pdfBoyutHatasi ? 
                    '‚ö†Ô∏è PDF dosyasƒ± √ßok k√º√ß√ºk (hatalƒ± y√ºklenmi≈ü olabilir). Manuel e≈üle≈ütirme gerekebilir.' :
                    '‚ö†Ô∏è PDF y√ºklendi ama analiz edilemedi (Google Sheets formatƒ±). Manuel e≈üle≈ütirme gerekebilir.'
                  }
                </div>
              ` : ''}
            </div>
            
            <!-- Tarif Kartlarƒ± B√∂l√ºm√º - Gƒ∞ZLENDƒ∞ -->
            <div style="display: none; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
              <h4 style="margin: 0 0 10px 0; color: #856404; font-size: 14px;">üñºÔ∏è Tarif Kartlarƒ±</h4>
              <input type="file" accept="image/jpeg,image/jpg,image/png" multiple 
                     onchange="tarifKartYukleHafta(${i}, this)" style="width: 100%; font-size: 12px;">
              <div id="haftaKartGorsel_${i}" style="margin-top: 10px;"></div>
            </div>
            
            <!-- A√ßƒ±klama B√∂l√ºm√º -->
            <div style="padding: 15px; background: #d1ecf1; border-radius: 8px; border-left: 4px solid #17a2b8;" class="${hafta.kilitli ? 'locked-area' : ''}">
              <h4 style="margin: 0 0 10px 0; color: #0c5460; font-size: 14px;">üìù A√ßƒ±klama</h4>
              <input type="text" id="aciklama_${i}" value="${hafta.aciklama||''}" 
                     placeholder="Bu hafta hakkƒ±nda not..." 
                     style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #bee5eb; font-size: 12px;"
                     onchange="aciklamaKaydet(${i})" ${hafta.kilitli ? 'readonly' : ''}>>
            </div>

            <!-- GPT Analiz B√∂l√ºm√º -->
            <div style="padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #007bff; margin-top: 15px;" class="${hafta.kilitli ? 'locked-area' : ''}">
              <h4 style="margin: 0 0 15px 0; color: #004085; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                <span>ü§ñ</span> GPT Beslenme Analizi
              </h4>
              
              <!-- Prompt Se√ßim Alanƒ± -->
              <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                  <label style="display: flex; align-items: center; gap: 5px; font-size: 12px;">
                    <input type="checkbox" id="genelPrompt_${i}" checked style="margin: 0;">
                    <span>üé® Genel Prompt</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px; font-size: 12px;">
                    <input type="checkbox" id="haftalikPrompt_${i}" checked style="margin: 0;">
                    <span>üìÖ ${i+1}. Hafta Temasƒ±</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px; font-size: 12px;">
                    <input type="checkbox" id="hastaPrompt_${i}" checked style="margin: 0;">
                    <span>üë§ Hasta Bilgileri</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px; font-size: 12px;">
                    <input type="checkbox" id="oncekiAnalizler_${i}" ${i > 0 ? 'checked' : ''} style="margin: 0;">
                    <span>üìö √ñnceki Analizler</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px; font-size: 12px;">
                    <input type="checkbox" id="ekPrompt_${i}" checked style="margin: 0;">
                    <span>üìù Ek Notlar</span>
                  </label>
                </div>
                <button onclick="gptAnalizeEt(${i})" style="
                  padding: 8px 15px; 
                  background: linear-gradient(135deg, #007bff, #0056b3); 
                  color: white; 
                  border: none; 
                  border-radius: 4px; 
                  cursor: pointer; 
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 5px;
                " ${hafta.kilitli ? 'disabled' : ''}>
                  <span>üöÄ</span> GPT ile Analiz Et
                </button>
              </div>

              <!-- Ek Notlar Alanƒ± -->
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #004085; font-size: 12px;">üìù Bu Hafta ƒ∞√ßin Ek Bilgiler:</label>
                <textarea id="ekNotlar_${i}" rows="2" 
                          style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #b8daff; font-size: 12px; resize: vertical;"
                          placeholder="Bu haftaya √∂zel ek bilgiler, hastanƒ±n durumu, deƒüi≈üiklikler..."
                          ${hafta.kilitli ? 'disabled' : ''}>${hafta.ekNotlar||''}</textarea>
              </div>

              <!-- GPT Yanƒ±t Alanƒ± -->
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #004085; font-size: 12px;">üéØ GPT Analiz Sonucu:</label>
                <textarea id="gptMesaj_${i}" rows="6" 
                          style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #b8daff; font-size: 12px; resize: vertical; background: #ffffff;"
                          placeholder="GPT analiz sonucu burada g√∂r√ºnecek..."
                          onchange="gptMesajKaydet(${i})"
                          ${hafta.kilitli ? 'disabled' : ''}>${hafta.gptMesaj||''}</textarea>
              </div>
            </div>
          </div>
          
          <!-- GPT Mesajƒ± - Grid'in Altƒ±nda -->
          <div style="margin-bottom: 20px;" class="${hafta.kilitli ? 'locked-area' : ''}">
            <h4 style="margin: 0 0 10px 0; color: #dc3545; font-size: 16px;">üí¨ GPT Mesajƒ±</h4>
            <textarea id="gptMesaj_${i}" rows="3" 
                      style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; resize: vertical;"
                      placeholder="Bu hafta i√ßin GPT mesajƒ± veya not..."
                      ${hafta.kilitli ? 'disabled' : ''}>${hafta.gptMesaj||''}</textarea>
            <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <button onclick="gptMesajKaydet(${i})" style="padding: 8px 15px; font-size: 12px;" ${hafta.kilitli ? 'disabled' : ''}>üíæ Kaydet</button>
                <button onclick="kopyalaGptMesaj(${i})" style="padding: 8px 15px; margin-left: 10px; font-size: 12px;">üìã Kopyala</button>
              </div>
              <div>
                <button onclick="zipEslesenGorseller(${i})" style="
                  padding: 8px 12px; 
                  font-size: 12px; 
                  background: #17a2b8; 
                  color: white; 
                  border: none; 
                  border-radius: 4px; 
                  cursor: pointer;
                  font-weight: bold;
                " title="Haftalƒ±k PDF, e≈üle≈üen tarif kartlarƒ± ve GPT mesajƒ±nƒ± tek ZIP dosyasƒ±nda indirir${hafta.kilitli ? ' (Kilitli haftada da kullanƒ±labilir)' : ''}">üóúÔ∏è ZIP ƒ∞ndir</button>
              </div>
            </div>
          </div>
          
          <!-- E≈üle≈üen Kartlar - Full Width (Eski, Gizli) -->
          <div style="margin-bottom: 20px; display: none;">
            <h4 style="margin: 0 0 10px 0; color: #6f42c1; font-size: 16px;">üîó E≈üle≈üen Kartlar</h4>
            <div id="eslesenKartlar_${i}" style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9; min-height: 80px;"></div>
          </div>
          
          <!-- GPT Mesajƒ± - Full Width (Eski, Gizli) -->
          <div style="margin-bottom: 20px; display: none;">
            <h4 style="margin: 0 0 10px 0; color: #dc3545; font-size: 16px;">üí¨ GPT Mesajƒ±</h4>
            <textarea id="gptMesaj_${i}" rows="3" 
                      style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; resize: vertical;"
                      placeholder="Bu hafta i√ßin GPT mesajƒ± veya not...">${hafta.gptMesaj||''}</textarea>
            <div style="margin-top: 10px;">
              <button onclick="gptMesajKaydet(${i})" style="padding: 8px 15px; font-size: 12px;">üíæ Kaydet</button>
              <button onclick="kopyalaGptMesaj(${i})" style="padding: 8px 15px; margin-left: 10px; font-size: 12px;">üìã Kopyala</button>
            </div>
          </div>
        `;
        
        contentDiv.appendChild(contentTab);
        
        // Alt i≈ülemleri √ßalƒ±≈ütƒ±r (async olarak)
        setTimeout(() => {
          gosterTariflerHafta(i);
          gosterKartlarHafta(i);
          
          // PDF y√ºkl√º ama tarifler yoksa otomatik tara
          if (hafta.pdf && (!hafta.tarifler || hafta.tarifler.length === 0)) {
            pdfOkuVeEsleHafta(i);
          } else if (hafta.tarifler && hafta.tarifler.length > 0) {
            otomatikEsleHafta(i);
          }
        }, 100 * i); // Sƒ±ralƒ± y√ºkleme
      });
      
      // "Hafta Ekle" tab'ƒ±nƒ± ekle
      const haftaEkleTab = document.createElement('div');
      haftaEkleTab.className = 'hafta-tab hafta-ekle-tab';
      haftaEkleTab.style.background = '#28a745';
      haftaEkleTab.style.color = 'white';
      haftaEkleTab.style.border = '2px solid #28a745';
      haftaEkleTab.onclick = () => haftaEkle();
      
      haftaEkleTab.innerHTML = `
        <div style="font-weight: bold; font-size: 14px;">+ Hafta Ekle</div>
        <div style="font-size: 10px; margin-top: 2px;">Yeni hafta olu≈ütur</div>
      `;
      tabsDiv.appendChild(haftaEkleTab);
      
      // En y√ºksek hafta numaralƒ± tab'ƒ± aktif yap
      if (haftalar.length > 0) {
        // En b√ºy√ºk hafta numarasƒ±nƒ± bul
        let enBuyukHaftaIndex = 0;
        let enBuyukHaftaNo = haftalar[0].haftaNo || 1;
        
        haftalar.forEach((hafta, index) => {
          const haftaNo = hafta.haftaNo || (index + 1);
          if (haftaNo > enBuyukHaftaNo) {
            enBuyukHaftaNo = haftaNo;
            enBuyukHaftaIndex = index;
          }
        });
        
        console.log(`üéØ En b√ºy√ºk hafta numarasƒ±: ${enBuyukHaftaNo}, index: ${enBuyukHaftaIndex}`);
        
        // Hafta tabƒ±nƒ±n i√ßerikleri ve e≈üle≈üen kartlar tamamen y√ºklendikten sonra aktif tab'ƒ± se√ß
        setTimeout(() => {
          console.log(`üîÑ ${enBuyukHaftaIndex}. hafta tab'ƒ± i√ßin e≈üle≈üen kartlar kontrol ediliyor...`);
          
          // E≈üle≈üen kartlarƒ±n y√ºklenip y√ºklenmediƒüini kontrol et (maksimum 10 deneme)
          let denemeSayisi = 0;
          const maxDeneme = 10;
          
          const checkAndActivate = () => {
            denemeSayisi++;
            const eslesenDiv = document.getElementById(`eslesenKartlar_${enBuyukHaftaIndex}`);
            
            if (eslesenDiv && (eslesenDiv.children.length > 0 || eslesenDiv.innerHTML.includes('hen√ºz e≈üle≈üme yok'))) {
              console.log(`‚úÖ ${enBuyukHaftaIndex}. hafta i√ßin e≈üle≈üen kartlar hazƒ±r, tab aktif hale getiriliyor`);
              switchTab(enBuyukHaftaIndex);
            } else if (denemeSayisi < maxDeneme) {
              console.log(`‚è≥ ${enBuyukHaftaIndex}. hafta i√ßin e≈üle≈üen kartlar hen√ºz hazƒ±r deƒüil, 200ms daha bekleniyor... (${denemeSayisi}/${maxDeneme})`);
              setTimeout(checkAndActivate, 200);
            } else {
              console.log(`‚ö†Ô∏è ${enBuyukHaftaIndex}. hafta i√ßin e≈üle≈üen kartlar ${maxDeneme} denemede hazƒ±r olamadƒ±, tab zorla aktif hale getiriliyor`);
              switchTab(enBuyukHaftaIndex);
            }
          };
          
          checkAndActivate();
        }, 500); // ƒ∞lk gecikmeyi artƒ±rdƒ±k
      }
    }
    
    // Tab deƒüi≈ütirme fonksiyonu
    function switchTab(activeIndex) {
      // T√ºm tablarƒ± pasif yap
      document.querySelectorAll('.hafta-tab').forEach((tab, index) => {
        tab.classList.toggle('active', index === activeIndex);
      });
      
      // T√ºm i√ßerikleri gizle
      document.querySelectorAll('.hafta-tab-content').forEach((content, index) => {
        content.classList.toggle('active', index === activeIndex);
      });
      
      // Sidebar'larƒ± g√ºncelle
      haftaTabSecildiginde(activeIndex);
      
      console.log(`üè∑Ô∏è ${activeIndex + 1}. hafta tab'ƒ±na ge√ßildi`);
    }
    
    // Tab deƒüi≈ütirme fonksiyonunu global yap
    window.switchTab = switchTab;

// Hafta a√ßƒ±klama kaydet (otomatik)
function aciklamaKaydet(i) {
  const haftalar = getHaftaListesi();
  const hafta = haftalar[i];
  const aciklamaInput = document.getElementById('aciklama_' + i);
  
  // Kilit kontrol√º
  if (hafta.kilitli) {
    alert('üîí Bu hafta kilitli! A√ßƒ±klama deƒüi≈ütirmek i√ßin √∂nce kilidi a√ßƒ±n.');
    // Eski deƒüeri geri y√ºkle
    aciklamaInput.value = hafta.aciklama || '';
    return;
  }
  
  hafta.aciklama = aciklamaInput.value;
  saveToStorage();
  
  // Visual feedback
  aciklamaInput.style.backgroundColor = '#d4edda';
  aciklamaInput.style.borderColor = '#28a745';
  setTimeout(() => {
    aciklamaInput.style.backgroundColor = '';
    aciklamaInput.style.borderColor = '';
  }, 800);
  
  console.log('‚úÖ A√ßƒ±klama otomatik kaydedildi:', aciklamaInput.value);
  
  // YENƒ∞ Sƒ∞STEM: GitHub'a da kaydet
  if (seciliHasta) {
    hastayiAyriKaydet(seciliHasta).then(basarili => {
      if (basarili) {
        console.log('‚úÖ A√ßƒ±klama GitHub\'a da kaydedildi');
      } else {
        console.warn('‚ö†Ô∏è A√ßƒ±klama localStorage\'a kaydedildi ama GitHub kaydƒ± ba≈üarƒ±sƒ±z');
      }
    }).catch(error => {
      console.error('‚ùå GitHub kaydetme hatasƒ±:', error);
    });
  }
}

// Hafta numarasƒ± d√ºzenleme (inline editing)
function editHaftaNo(i) {
  const displaySpan = document.getElementById(`haftaNoDisplay_${i}`);
  const inputField = document.getElementById(`haftaNo_${i}`);
  
  // Display'i gizle, input'u g√∂ster
  displaySpan.style.display = 'none';
  inputField.style.display = 'inline-block';
  inputField.focus();
  inputField.select();
  
  // Visual feedback
  inputField.style.backgroundColor = '#e3f2fd';
}

function saveHaftaNo(i) {
  const displaySpan = document.getElementById(`haftaNoDisplay_${i}`);
  const inputField = document.getElementById(`haftaNo_${i}`);
  const yeniHaftaNo = parseInt(inputField.value);
  
  if (yeniHaftaNo < 1 || yeniHaftaNo > 52 || isNaN(yeniHaftaNo)) {
    alert('Hafta numarasƒ± 1-52 arasƒ±nda olmalƒ±dƒ±r!');
    const haftalar = getHaftaListesi();
    inputField.value = haftalar[i].haftaNo || (i + 1);
    return;
  }
  
  // Veriyi kaydet
  const haftalar = getHaftaListesi();
  haftalar[i].haftaNo = yeniHaftaNo;
  saveToStorage();
  
  // UI'ƒ± g√ºncelle
  displaySpan.textContent = yeniHaftaNo;
  displaySpan.style.display = 'inline-block';
  inputField.style.display = 'none';
  inputField.style.backgroundColor = '';
  
  // Tab ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
  const tablar = document.querySelectorAll('.hafta-tab');
  if (tablar[i]) {
    const tabBaslik = tablar[i].querySelector('div:first-child');
    if (tabBaslik) {
      tabBaslik.textContent = `${yeniHaftaNo}. Hafta`;
    }
  }
  
  // Success feedback
  displaySpan.style.backgroundColor = '#d4edda';
  displaySpan.style.color = '#155724';
  setTimeout(() => {
    displaySpan.style.backgroundColor = '';
    displaySpan.style.color = '';
  }, 1000);
  
  console.log(`Hafta numarasƒ± g√ºncellendi: ${yeniHaftaNo}. hafta`);
}

// Global fonksiyonlar
window.editHaftaNo = editHaftaNo;
window.saveHaftaNo = saveHaftaNo;

// Hafta numarasƒ± kaydet (eski fonksiyon - backward compatibility)
function haftaNoKaydet(i) {
  saveHaftaNo(i);
}

// PDF dosya adƒ±ndan hafta numarasƒ±nƒ± √ßƒ±kar
function pdfDosyaAdindenHaftaNoAl(dosyaAdi) {
  if (!dosyaAdi) return null;
  
  // Farklƒ± hafta formatlarƒ±nƒ± kontrol et
  const patterns = [
    /(\d+)\.?\s*hafta/i,           // "8. hafta", "8 hafta", "8.hafta"
    /hafta\s*(\d+)/i,              // "hafta 8", "hafta8"
    /week\s*(\d+)/i,               // "week 8", "week8"
    /(\d+)\.?\s*week/i,            // "8. week", "8 week"
    /w(\d+)/i,                     // "w8", "W8"
    /(\d+)\.?\s*hf/i,              // "8. hf", "8 hf", "8hf"
    /hf\s*(\d+)/i,                 // "hf 8", "hf8"
    /(\d+)\.?\s*h(?![a-z])/i,      // "8. h", "8 h", "8h" (ama "hafta" olmayacak)
  ];
  
  for (let pattern of patterns) {
    const match = dosyaAdi.match(pattern);
    if (match) {
      const haftaNo = parseInt(match[1]);
      if (haftaNo >= 1 && haftaNo <= 52) {
        console.log(`üìÖ PDF dosya adƒ±ndan hafta numarasƒ± bulundu: "${dosyaAdi}" ‚Üí ${haftaNo}. hafta`);
        return haftaNo;
      }
    }
  }
  
  console.log(`‚ö†Ô∏è PDF dosya adƒ±ndan hafta numarasƒ± √ßƒ±karƒ±lamadƒ±: "${dosyaAdi}"`);
  return null;
}

// PDF i√ßeriƒüinden hafta numarasƒ±nƒ± √ßƒ±kar
function pdfIcerigindenhaftaNoAl(pdfIcerik) {
  if (!pdfIcerik) return null;
  
  // ƒ∞lk birka√ß satƒ±rdan hafta numarasƒ±nƒ± ara
  const ilkSatirlar = pdfIcerik.split('\n').slice(0, 20).join(' ');
  
  const patterns = [
    /(\d+)\.?\s*hafta/i,
    /hafta\s*(\d+)/i,
    /week\s*(\d+)/i,
    /(\d+)\.?\s*week/i,
  ];
  
  for (let pattern of patterns) {
    const match = ilkSatirlar.match(pattern);
    if (match) {
      const haftaNo = parseInt(match[1]);
      if (haftaNo >= 1 && haftaNo <= 52) {
        console.log(`üìÑ PDF i√ßeriƒüinden hafta numarasƒ± bulundu: ${haftaNo}. hafta`);
        return haftaNo;
      }
    }
  }
  
  return null;
}

// Hafta sil
async function silHafta(i) {
  if (!seciliHasta) {
    alert('‚ùå L√ºtfen √∂nce bir hasta se√ßin!');
    return;
  }

  const haftalar = getHaftaListesi();
  const silinecekHafta = haftalar[i];
  
  if (!silinecekHafta) {
    alert('‚ùå Silinecek hafta bulunamadƒ±!');
    return;
  }

  if (!confirm(`Bu haftayƒ± silmek istediƒüinize emin misiniz?\n\nHafta: ${silinecekHafta.haftaNo}\nTarih Aralƒ±ƒüƒ±: ${silinecekHafta.baslangic} - ${silinecekHafta.bitis}\n\n‚ö†Ô∏è Bu i≈ülem geri alƒ±namaz!`)) {
    return;
  }

  try {
    console.log(`üóëÔ∏è Hafta ${silinecekHafta.haftaNo} siliniyor...`);
    
    // 1. Web aray√ºz√ºnden sil
    haftalar.splice(i, 1);
    console.log('‚úÖ Hafta web aray√ºz√ºnden silindi');
    
    // 2. Cache'den sil (localStorage)
    try {
      const cacheKey = `hasta_${seciliHasta.id}`;
      const cachedData = localStorage.getItem(cacheKey);
      if (cachedData) {
        const parsedData = JSON.parse(cachedData);
        if (parsedData.haftalar) {
          parsedData.haftalar = parsedData.haftalar.filter(h => h.haftaNo !== silinecekHafta.haftaNo);
          localStorage.setItem(cacheKey, JSON.stringify(parsedData));
          console.log('‚úÖ Hafta cache\'den silindi');
        }
      }
    } catch (cacheError) {
      console.warn('‚ö†Ô∏è Cache temizleme hatasƒ±:', cacheError);
    }
    
    // 3. Hasta JSON dosyasƒ±ndan sil (GitHub'a kaydet)
    try {
      // seciliHasta nesnesini de g√ºncelle
      if (seciliHasta.haftalar) {
        seciliHasta.haftalar = seciliHasta.haftalar.filter(h => h.haftaNo !== silinecekHafta.haftaNo);
      }
      
      // GitHub'a kaydet
      const kaydedildi = await hastayiAyriKaydet(seciliHasta);
      if (kaydedildi) {
        console.log('‚úÖ Hafta hasta JSON dosyasƒ±ndan silindi ve GitHub\'a kaydedildi');
      } else {
        console.warn('‚ö†Ô∏è GitHub\'a kaydetme ba≈üarƒ±sƒ±z, sadece yerel silme yapƒ±ldƒ±');
      }
    } catch (githubError) {
      console.warn('‚ö†Ô∏è GitHub kaydetme hatasƒ±:', githubError);
    }
    
    // 4. UI'ƒ± g√ºncelle
    gosterHaftalar();
    
    // 5. Hasta listesini g√ºncelle
    if (typeof updateHastaListesi === 'function') {
      updateHastaListesi();
    }
    
    console.log(`‚úÖ Hafta ${silinecekHafta.haftaNo} ba≈üarƒ±yla silindi`);
    alert(`‚úÖ Hafta ${silinecekHafta.haftaNo} ba≈üarƒ±yla silindi!`);
    
  } catch (error) {
    console.error('‚ùå Hafta silme hatasƒ±:', error);
    alert(`‚ùå Hafta silinirken hata olu≈ütu: ${error.message}`);
  }
}

// Hafta d√ºzenle (tarih ve a√ßƒ±klama)
function duzenleHafta(i) {
  const haftalar = getHaftaListesi();
  const hafta = haftalar[i];
  const yeniBaslangic = prompt('Yeni ba≈ülangƒ±√ß tarihi (YYYY-MM-DD):', hafta.baslangic);
  if (!yeniBaslangic) return;
  const yeniBitis = prompt('Yeni biti≈ü tarihi (YYYY-MM-DD):', hafta.bitis);
  if (!yeniBitis) return;
  hafta.baslangic = yeniBaslangic;
  hafta.bitis = yeniBitis;
  hafta.aciklama = document.getElementById('aciklama_' + i).value;
  
  // Otomatik kaydetme - hafta d√ºzenlendi
  autoSaveHastaData(seciliHasta);
  
  gosterHaftalar();
}

    // PDF'i GitHub'dan indirme fonksiyonu
    async function pdfIndir(githubRawLink, dosyaAdi) {
      try {
        console.log('üì• PDF indiriliyor:', dosyaAdi);
        
        const response = await fetch(githubRawLink);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = dosyaAdi;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('‚úÖ PDF ba≈üarƒ±yla indirildi:', dosyaAdi);
        
      } catch (error) {
        console.error('‚ùå PDF indirme hatasƒ±:', error);
        alert(`PDF indirilemedi: ${error.message}`);
      }
    }

    // PDF'i browser'da g√∂r√ºnt√ºleme fonksiyonu
    function pdfGoruntule(pdfUrl) {
      try {
        console.log('üëÅÔ∏è PDF g√∂r√ºnt√ºleniyor:', pdfUrl);
        
        if (!pdfUrl) {
          alert('PDF URL\'si bulunamadƒ±.');
          return;
        }
        
        // Yeni sekmede PDF'i a√ß
        window.open(pdfUrl, '_blank');
        
      } catch (error) {
        console.error('‚ùå PDF g√∂r√ºnt√ºleme hatasƒ±:', error);
        alert(`PDF g√∂r√ºnt√ºlenemedi: ${error.message}`);
      }
    }

    async function haftaZipIndir(haftaIndex, haftaNo) {
      try {
        console.log('üöÄ ZIP fonksiyonu ba≈ülatƒ±ldƒ±, hafta:', haftaNo);
        
        if (!seciliHasta) {
          alert('L√ºtfen √∂nce bir hasta se√ßin!');
          return;
        }

        // GitHub deƒüi≈ükenlerini kontrol et
        console.log('üîç GITHUB_REPO:', GITHUB_REPO);
        console.log('üîç GITHUB_TOKEN var mƒ±:', !!GITHUB_TOKEN);
        console.log('üîç Se√ßili hasta:', seciliHasta.id);

        const haftalar = getHaftaListesi();
        if (!haftalar[haftaIndex]) {
          alert('Hafta bulunamadƒ±!');
          return;
        }

        const hafta = haftalar[haftaIndex];
        console.log('üîç Hafta bilgileri:', hafta);
        
        const hasta = await getHastaData(seciliHasta.id);
        
        // ZIP dosya adƒ±nƒ± olu≈ütur
        const tarihAraligi = `${hafta.baslangic}_${hafta.bitis}`.replace(/\./g, '_').replace(/\s/g, '_');
        const hastaAdi = hasta.isim.toUpperCase().replace(/\s/g, '_').replace(/[ƒ∞ƒ±√á√ßƒûƒü√ú√º≈û≈ü√ñ√∂]/g, match => {
          const trMap = {'ƒ∞': 'I', 'ƒ±': 'i', '√á': 'C', '√ß': 'c', 'ƒû': 'G', 'ƒü': 'g', '√ú': 'U', '√º': 'u', '≈û': 'S', '≈ü': 's', '√ñ': 'O', '√∂': 'o'};
          return trMap[match] || match;
        });
        const zipAdi = `${hastaAdi}_${tarihAraligi}_${haftaNo}_HAFTA.ZIP`;

        // JSZip instance olu≈ütur
        const zip = new JSZip();

        // 5. hafta i√ßin √∂zel i√ßerik
        if (haftaNo === 5) {
          // Men√º PDF'si (5. hafta)
          if (hafta.pdfName || hafta.pdfOrijinalIsim) {
            try {
              if (!GITHUB_TOKEN) {
                console.warn('‚ö†Ô∏è GitHub token bulunamadƒ±, PDF eklenemeyecek');
                return;
              }
              
              const pdfFileName = hafta.pdfName || hafta.pdfOrijinalIsim;
              const pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/patients/${seciliHasta.id}/hafta_${haftaNo}_${pdfFileName}`;
              
              console.log('üîç 5. hafta PDF URL:', pdfUrl);
              console.log('üîç PDF dosya adƒ±:', pdfFileName);
              
              const pdfResponse = await fetch(pdfUrl, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
              });
              
              console.log('üîç PDF response status:', pdfResponse.status);
              
              if (pdfResponse.ok) {
                const pdfData = await pdfResponse.json();
                const pdfBlob = base64ToBlob(pdfData.content, 'application/pdf');
                zip.file(`MENU_PDF_${hafta.pdfOrijinalIsim || hafta.pdfName || 'menu.pdf'}`, pdfBlob);
                console.log('‚úÖ 5. hafta Men√º PDF eklendi:', pdfFileName);
              } else {
                const errorText = await pdfResponse.text();
                console.warn('‚ùå PDF yanƒ±tƒ± ba≈üarƒ±sƒ±z:', pdfResponse.status, errorText);
              }
            } catch (error) {
              console.warn('‚ùå Men√º PDF eklenemedi:', error);
            }
          } else {
            console.warn('‚ö†Ô∏è 5. hafta PDF bilgisi bulunamadƒ±');
          }

          // E≈üle≈üen tarif kartlarƒ± (5. hafta) - JPG dosyalarƒ±
          if (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) {
            for (const kart of hafta.tarifKartlar) {
              try {
                const response = await fetch(kart.data);
                if (response.ok) {
                  const blob = await response.blob();
                  zip.file(`TARIF_KARTI_${kart.name}`, blob);
                  console.log(`‚úÖ 5. hafta tarif kartƒ± eklendi: ${kart.name}`);
                } else {
                  console.warn(`‚ùå Tarif kartƒ± indirilemedi: ${kart.name}`);
                }
              } catch (error) {
                console.warn(`‚ùå Tarif kartƒ± hatasƒ±: ${kart.name}`, error);
              }
            }
          } else {
            console.warn('‚ö†Ô∏è 5. hafta tarif kartƒ± bulunamadƒ±');
          }

          // GPT Mesajƒ± (5. hafta)
          if (hafta.gptMesaj && hafta.gptMesaj.trim()) {
            zip.file('GPT_MESAJI.txt', hafta.gptMesaj.trim());
            console.log('‚úÖ 5. hafta GPT mesajƒ± eklendi');
          } else {
            console.warn('‚ö†Ô∏è 5. hafta GPT mesajƒ± bulunamadƒ±');
          }

          // 5. hafta i√ßin otomatik masaj planƒ± PDF'si ekle
          console.log('üè• 5. hafta masaj PDF fonksiyonu √ßaƒürƒ±lƒ±yor...');
          console.log('üîç √áAƒûRI: haftalar verisi:', JSON.stringify(haftalar.slice(3, 6), null, 2)); // 4,5,6. haftalarƒ± g√∂ster
          await createAndAddLenfMasajPDF(zip, hasta, haftalar);
        }
        
        // 9. hafta i√ßin √∂zel i√ßerik
        if (haftaNo === 9) {
          // Men√º PDF'si (9. hafta)
          if (hafta.pdfName || hafta.pdfOrijinalIsim) {
            try {
              if (!GITHUB_TOKEN) {
                console.warn('‚ö†Ô∏è GitHub token bulunamadƒ±, PDF eklenemeyecek');
                return;
              }
              
              const pdfFileName = hafta.pdfName || hafta.pdfOrijinalIsim;
              const pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/patients/${seciliHasta.id}/hafta_${haftaNo}_${pdfFileName}`;
              
              console.log('üîç 9. hafta PDF URL:', pdfUrl);
              console.log('üîç PDF dosya adƒ±:', pdfFileName);
              
              const pdfResponse = await fetch(pdfUrl, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
              });
              
              console.log('üîç PDF response status:', pdfResponse.status);
              
              if (pdfResponse.ok) {
                const pdfData = await pdfResponse.json();
                const pdfBlob = base64ToBlob(pdfData.content, 'application/pdf');
                zip.file(`MENU_PDF_${hafta.pdfOrijinalIsim || hafta.pdfName || 'menu.pdf'}`, pdfBlob);
                console.log('‚úÖ 9. hafta Men√º PDF eklendi:', pdfFileName);
              } else {
                const errorText = await pdfResponse.text();
                console.warn('‚ùå PDF yanƒ±tƒ± ba≈üarƒ±sƒ±z:', pdfResponse.status, errorText);
              }
            } catch (error) {
              console.warn('‚ùå Men√º PDF eklenemedi:', error);
            }
          } else {
            console.warn('‚ö†Ô∏è 9. hafta PDF bilgisi bulunamadƒ±');
          }

          // E≈üle≈üen tarif kartlarƒ± (9. hafta) - JPG dosyalarƒ±
          if (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) {
            for (const kart of hafta.tarifKartlar) {
              try {
                const response = await fetch(kart.data);
                if (response.ok) {
                  const blob = await response.blob();
                  zip.file(`TARIF_KARTI_${kart.name}`, blob);
                  console.log(`‚úÖ 9. hafta tarif kartƒ± eklendi: ${kart.name}`);
                } else {
                  console.warn(`‚ùå Tarif kartƒ± indirilemedi: ${kart.name}`);
                }
              } catch (error) {
                console.warn(`‚ùå Tarif kartƒ± hatasƒ±: ${kart.name}`, error);
              }
            }
          } else {
            console.warn('‚ö†Ô∏è 9. hafta tarif kartƒ± bulunamadƒ±');
          }

          // GPT Mesajƒ± (9. hafta)
          if (hafta.gptMesaj && hafta.gptMesaj.trim()) {
            zip.file('GPT_MESAJI.txt', hafta.gptMesaj.trim());
            console.log('‚úÖ 9. hafta GPT mesajƒ± eklendi');
          } else {
            console.warn('‚ö†Ô∏è 9. hafta GPT mesajƒ± bulunamadƒ±');
          }

          // 9. hafta i√ßin otomatik egzersiz takvimi PDF'si ekle
          console.log('üèÉ 9. hafta egzersiz PDF fonksiyonu √ßaƒürƒ±lƒ±yor...');
          await createAndAddEgzersizPDF(zip, hasta, haftalar);
        }

        // ZIP dosyasƒ±nƒ± olu≈ütur ve indir
        const zipBlob = await zip.generateAsync({type: 'blob'});
        
        const url = window.URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = zipAdi;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log(`‚úÖ ${haftaNo}. hafta ZIP dosyasƒ± ba≈üarƒ±yla indirildi:`, zipAdi);
        
      } catch (error) {
        console.error('‚ùå ZIP indirme hatasƒ±:', error);
        alert(`ZIP dosyasƒ± olu≈üturulamadƒ±: ${error.message}`);
      }
    }

    // 5. hafta i√ßin Lenf Masaj PDF'si olu≈ütur ve ZIP'e ekle
    async function createAndAddLenfMasajPDF(zip, hasta, haftalar, klasorYolu = '') {
      try {
        console.log('ü§≤ 5. hafta Lenf Masaj PDF olu≈üturuluyor...', { hasta: hasta.isim });
        
        // K√ºt√ºphane kontrol√º
        if (!window.jspdf) {
          console.error('‚ùå jsPDF k√ºt√ºphanesi y√ºklenmemi≈ü');
          return;
        }
        
        console.log('‚úÖ jsPDF k√ºt√ºphanesi bulundu:', typeof window.jspdf);
        
        // JSON verisinden doƒürudan 5. hafta ba≈ülangƒ±√ß tarihini al
        let haftaBaslangici = new Date();
        
        if (haftalar.length >= 5 && haftalar[4]?.baslangic) {
            console.log('  5. HAFTA RAW VERƒ∞:', haftalar[4].baslangic, typeof haftalar[4].baslangic);
            haftaBaslangici = new Date(haftalar[4].baslangic);
            console.log('  5. HAFTA PARSED TARƒ∞H:', haftaBaslangici.toISOString(), '|', haftaBaslangici.toLocaleDateString('tr-TR'));
        } else {
            console.log('‚ö†Ô∏è 5. hafta verisi bulunamadƒ±, g√ºncel tarih kullanƒ±lƒ±yor');
            console.log('üîç Toplam hafta sayƒ±sƒ±:', haftalar.length);
            console.log('üîç 5. hafta verisi (index 4):', haftalar[4]);
        }

        // Tarihi o haftanƒ±n Pazartesi'sine hizala
        const gunIndex = haftaBaslangici.getDay(); // 0=Pazar, 1=Pazartesi, ..., 6=Cumartesi
        const pazartesiyeKadarGun = gunIndex === 0 ? -6 : 1 - gunIndex; // Pazar ise -6, diƒüer g√ºnler i√ßin Pazartesi'ye kadar g√ºn sayƒ±sƒ±
        haftaBaslangici.setDate(haftaBaslangici.getDate() + pazartesiyeKadarGun);
        console.log('üóìÔ∏è MASAJ PDF PAZARTESƒ∞ HIZALAMA:', haftaBaslangici.toLocaleDateString('tr-TR'), '(g√ºn:', haftaBaslangici.getDay(), ')');

        // PDF olu≈ütur - tekli tab versiyonuyla aynƒ± format
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
          console.error('‚ùå jsPDF constructor bulunamadƒ±');
          return;
        }
        
        console.log('‚úÖ jsPDF constructor bulundu, PDF olu≈üturuluyor...');
        
        const doc = new jsPDF('p', 'mm', 'a4'); // Tekli tab versiyonuyla aynƒ± format
        
        // Hasta adƒ±nƒ± ASCII'ye √ßevir (tekli tab versiyonuyla aynƒ±)
        console.log('üîç Orijinal hasta adƒ±:', hasta.isim);
        const asciiHastaAdi = hasta.isim
            .replace(/≈û/g, 'S').replace(/≈ü/g, 's')
            .replace(/ƒû/g, 'G').replace(/ƒü/g, 'g')
            .replace(/√ú/g, 'U').replace(/√º/g, 'u')
            .replace(/ƒ∞/g, 'I').replace(/ƒ±/g, 'i')
            .replace(/√ñ/g, 'O').replace(/√∂/g, 'o')
            .replace(/√á/g, 'C').replace(/√ß/g, 'c')
            .replace(/∆è/g, 'E').replace(/…ô/g, 'e');
        console.log('üîç ASCII hasta adƒ±:', asciiHastaAdi);
        
        // Ba≈ülƒ±k - tekli tab versiyonuyla aynƒ±
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Lenf masaj ba≈ülƒ±ƒüƒ± - ASCII karakterlerle
        const subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // A√ßƒ±klama kutusu - tekli tab versiyonuyla aynƒ±
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler'), 20, 40);
        
        // 5. haftanƒ±n ba≈ülangƒ±cƒ±
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalƒ±k program (5-12. haftalar) - tekli tab versiyonuyla aynƒ±
        console.log('  PDF OLU≈ûTURMA: Ana tarih:', haftaBaslangici.toLocaleDateString('tr-TR'));
        
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan ba≈ülar
          const haftaBaslangic = new Date(haftaBaslangici.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          if (lenfHaftaIndex === 0) { // Sadece ilk hafta (5. hafta) i√ßin log
            console.log('üü¢ PDF ƒ∞LK HAFTA:', haftaBaslangic.toLocaleDateString('tr-TR'));
          }
          
          // Sayfa sonu kontrol√º - hafta ba≈ülƒ±ƒüƒ± i√ßin yer var mƒ±?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta ba≈ülƒ±ƒüƒ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // 5. hafta PDF'si i√ßin 9-12. haftalar soluk renkte olsun
          if (gercekHaftaNo >= 9) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo ba≈ülƒ±klarƒ± - tekli tab versiyonuyla aynƒ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, G√ºn, Sabah, Ak≈üam
          let zipTableStartX = 15;
          
          // Ba≈ülƒ±k satƒ±rƒ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her g√ºn i√ßin satƒ±r - tekli tab versiyonuyla aynƒ±
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrol√º - satƒ±r i√ßin yer var mƒ±?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo ba≈ülƒ±klarƒ±nƒ± tekrar olu≈ütur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // Ba≈ülƒ±k satƒ±rƒ±
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrol√º - lenf masajƒ± versiyonu (tekli tab versiyonuyla aynƒ± mantƒ±k)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // ƒ∞lk 2 hafta (5-6): G√ºnde 2 kez lenf masajƒ±
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): G√ºnde 1 kez lenf masajƒ± (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else {
              // 9-12. haftalar: lenf masajƒ± yok (egzersiz ba≈ülamƒ±≈ü)
              sabahUygulama = '-';
              aksamUygulama = '-';
            }
            
            zipTableStartX = 15;
            
            // 5. hafta PDF'si i√ßin 5-8. haftalar ye≈üil check'li olsun
            if (gercekHaftaNo <= 8) {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            } else {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            }
            
            // Tablo √ßizgi ayarlarƒ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 5. hafta PDF'si ve aktif haftalar (5-8) ye≈üil check simgesi ekle
            if (gercekHaftaNo <= 8) {
              // Ye≈üil check kutusu √ßiz
              doc.setFillColor(0, 128, 0); // Ye≈üil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // Ye≈üil dikd√∂rtgen
              
              // Beyaz check √ßizgisi √ßiz
              doc.setDrawColor(255, 255, 255); // Beyaz √ßizgi
              doc.setLineWidth(0.5);
              // Check i≈üareti √ßizgisi (V ≈üekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo √ßizgi ayarlarƒ±nƒ± geri y√ºkle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi normal renkte yaz
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Gelecek haftalar i√ßin tarih soluk renkte
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // G√ºn s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // Ak≈üam s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arasƒ± bo≈üluk
        }
        
        // PDF'i blob olarak al ve ZIP'e ekle
        const pdfBlob = doc.output('blob');
        const dosyaAdi = `${asciiHastaAdi}_Lenf_Masaj_Takvimi.pdf`;
        zip.file(klasorYolu + dosyaAdi, pdfBlob);
        
        console.log('‚úÖ 5. hafta Lenf Masaj PDF ZIP\'e eklendi:', dosyaAdi);
        
      } catch (error) {
        console.error('‚ùå Lenf Masaj PDF olu≈üturma hatasƒ±:', error);
      }
    }

    async function createAndAddEgzersizPDF(zip, hasta, haftalar, klasorYolu = '') {
      try {
        console.log('üèÉ 9. hafta Egzersiz PDF olu≈üturuluyor...', { hasta: hasta.isim });
        
        // K√ºt√ºphane kontrol√º
        if (!window.jspdf) {
          console.error('‚ùå jsPDF k√ºt√ºphanesi y√ºklenmemi≈ü');
          return;
        }
        
        console.log('‚úÖ jsPDF k√ºt√ºphanesi bulundu:', typeof window.jspdf);
        
        // JSON verisinden doƒürudan 9. hafta ba≈ülangƒ±√ß tarihini al
        let haftaBaslangici = new Date();
        
        if (haftalar.length >= 9 && haftalar[8]?.baslangic) {
            // 9. hafta verisi mevcut
            console.log('  9. HAFTA RAW VERƒ∞:', haftalar[8].baslangic);
            haftaBaslangici = new Date(haftalar[8].baslangic);
            console.log('üîµ 9. HAFTA PARSED:', haftaBaslangici.toLocaleDateString('tr-TR'));
        } else if (haftalar.length >= 5 && haftalar[4]?.baslangic) {
            // 5. haftadan 4 hafta sonrasƒ±nƒ± hesapla
            console.log('  5. HAFTA RAW (9. hafta i√ßin):', haftalar[4].baslangic);
            const besinciHafta = new Date(haftalar[4].baslangic);
            haftaBaslangici = new Date(besinciHafta.getTime() + (4 * 7 * 24 * 60 * 60 * 1000));
            console.log('üîµ 9. HAFTA HESAPLANAN:', haftaBaslangici.toLocaleDateString('tr-TR'));
        } else {
            console.log('‚ö†Ô∏è Hafta verisi bulunamadƒ±, g√ºncel tarih kullanƒ±lƒ±yor');
            console.log('üîç Toplam hafta sayƒ±sƒ±:', haftalar.length);
        }

        // Tarihi o haftanƒ±n Pazartesi'sine hizala
        const gunIndex = haftaBaslangici.getDay(); // 0=Pazar, 1=Pazartesi, ..., 6=Cumartesi
        const pazartesiyeKadarGun = gunIndex === 0 ? -6 : 1 - gunIndex; // Pazar ise -6, diƒüer g√ºnler i√ßin Pazartesi'ye kadar g√ºn sayƒ±sƒ±
        haftaBaslangici.setDate(haftaBaslangici.getDate() + pazartesiyeKadarGun);
        console.log('üóìÔ∏è EGZERSƒ∞Z PDF PAZARTESƒ∞ HIZALAMA:', haftaBaslangici.toLocaleDateString('tr-TR'), '(g√ºn:', haftaBaslangici.getDay(), ')');

        // PDF olu≈ütur - tekli tab versiyonuyla aynƒ± format
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
          console.error('‚ùå jsPDF constructor bulunamadƒ±');
          return;
        }
        
        console.log('‚úÖ jsPDF constructor bulundu, PDF olu≈üturuluyor...');
        
        const doc = new jsPDF('p', 'mm', 'a4'); // Tekli tab versiyonuyla aynƒ± format
        
        // Hasta adƒ±nƒ± ASCII'ye √ßevir (tekli tab versiyonuyla aynƒ±)
        console.log('üîç Orijinal hasta adƒ±:', hasta.isim);
        const asciiHastaAdi = hasta.isim
            .replace(/≈û/g, 'S').replace(/≈ü/g, 's')
            .replace(/ƒû/g, 'G').replace(/ƒü/g, 'g')
            .replace(/√ú/g, 'U').replace(/√º/g, 'u')
            .replace(/ƒ∞/g, 'I').replace(/ƒ±/g, 'i')
            .replace(/√ñ/g, 'O').replace(/√∂/g, 'o')
            .replace(/√á/g, 'C').replace(/√ß/g, 'c')
            .replace(/∆è/g, 'E').replace(/…ô/g, 'e');
        console.log('üîç ASCII hasta adƒ±:', asciiHastaAdi);
        
        // Ba≈ülƒ±k - tekli tab versiyonuyla aynƒ±
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Egzersiz + lenf masaj ba≈ülƒ±ƒüƒ± - ASCII karakterlerle
        const subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // A√ßƒ±klama kutusu - tekli tab versiyonuyla aynƒ±
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler'), 20, 40);
        
        // 9. haftanƒ±n ba≈ülangƒ±cƒ± (baslangicTarihi 9. hafta ba≈ülangƒ±cƒ± kabul edilir)
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalƒ±k program (5-12. haftalar) - tekli tab versiyonuyla aynƒ±
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan ba≈ülar
          
          // 9. haftayƒ± referans alarak diƒüer hafta ba≈ülangƒ±√ßlarƒ±nƒ± hesapla
          // 5. hafta: 9. haftadan 4 hafta √∂nce (-4 * 7 g√ºn)
          // 6. hafta: 9. haftadan 3 hafta √∂nce (-3 * 7 g√ºn)
          // ...
          // 9. hafta: 9. haftadan 0 hafta √∂nce (0 * 7 g√ºn)
          // 10. hafta: 9. haftadan 1 hafta sonra (+1 * 7 g√ºn)
          const haftaFarki = gercekHaftaNo - 9; // 5. hafta=-4, 6. hafta=-3, ..., 9. hafta=0, 10. hafta=+1
          const haftaBaslangic = new Date(haftaBaslangici.getTime() + (haftaFarki * 7 * 24 * 60 * 60 * 1000));
          
          // Sayfa sonu kontrol√º - hafta ba≈ülƒ±ƒüƒ± i√ßin yer var mƒ±?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta ba≈ülƒ±ƒüƒ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // 9. hafta PDF'si i√ßin 5-8. haftalar soluk renkte olsun
          if (gercekHaftaNo <= 8) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo ba≈ülƒ±klarƒ± - tekli tab versiyonuyla aynƒ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, G√ºn, Sabah, Ak≈üam
          let zipTableStartX = 15;
          
          // Ba≈ülƒ±k satƒ±rƒ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her g√ºn i√ßin satƒ±r - tekli tab versiyonuyla aynƒ±
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrol√º - satƒ±r i√ßin yer var mƒ±?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo ba≈ülƒ±klarƒ±nƒ± tekrar olu≈ütur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // Ba≈ülƒ±k satƒ±rƒ±
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrol√º - egzersiz dahil versiyonu (tekli tab versiyonuyla aynƒ± mantƒ±k)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // ƒ∞lk 2 hafta (5-6): G√ºnde 2 kez lenf masajƒ±
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): G√ºnde 1 kez lenf masajƒ± (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): G√ºna≈üƒ±rƒ± lenf masajƒ± + egzersiz
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                // Pazartesi, √áar≈üamba, Cuma, Pazar: Lenf masajƒ± + ak≈üam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                // Salƒ±, Per≈üembe, Cumartesi: Sabah ve ak≈üam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            } else {
              // Son 2 hafta (11-12): Haftada 2 g√ºn lenf masajƒ± + s√ºrekli egzersiz
              if (gunIndex === 1 || gunIndex === 4) { // Salƒ±, Cuma
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            }
            
            zipTableStartX = 15;
            
            // 9. hafta PDF'si i√ßin 5-8. haftalar soluk renkte olsun
            if (gercekHaftaNo <= 8) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tablo √ßizgi ayarlarƒ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 9. hafta PDF'si ve ge√ßmi≈ü haftalarda (5-8) ye≈üil check simgesi ekle
            if (gercekHaftaNo <= 8) {
              // Ye≈üil check kutusu √ßiz
              doc.setFillColor(0, 128, 0); // Ye≈üil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // Ye≈üil dikd√∂rtgen
              
              // Beyaz check √ßizgisi √ßiz
              doc.setDrawColor(255, 255, 255); // Beyaz √ßizgi
              doc.setLineWidth(0.5);
              // Check i≈üareti √ßizgisi (V ≈üekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo √ßizgi ayarlarƒ±nƒ± geri y√ºkle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi soluk renkte yaz
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Normal tarih
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // G√ºn s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // Ak≈üam s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arasƒ± bo≈üluk
        }
        
        // PDF'i blob olarak al ve ZIP'e ekle
        const pdfBlob = doc.output('blob');
        const dosyaAdi = `${asciiHastaAdi}_Egzersiz_Takvimi.pdf`;
        zip.file(klasorYolu + dosyaAdi, pdfBlob);
        
        console.log('‚úÖ 9. hafta Egzersiz PDF ZIP\'e eklendi:', dosyaAdi);
        
      } catch (error) {
        console.error('‚ùå Egzersiz PDF olu≈üturma hatasƒ±:', error);
      }
    }

    async function pdfYukleHafta(i, input) {
      const file = input.files[0];
      if (!file) return;
      console.log('üîç PDF y√ºkleniyor:', file.name);
      console.log('üîç Se√ßili hasta:', seciliHasta);
      
      if (!seciliHasta) {
        alert('L√ºtfen √∂nce bir hasta se√ßin!');
        return;
      }
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[i];
      
      // Kilit kontrol√º
      if (hafta.kilitli) {
        alert('üîí Bu hafta kilitli! PDF y√ºklemek i√ßin √∂nce kilidi a√ßƒ±n.');
        input.value = ''; // Input'u temizle
        return;
      }
      
      // PDF dosya adƒ±ndan tarih ve hafta numarasƒ±nƒ± √ßƒ±kar
      const parsedPdf = parseProfessionalPdfName(file.name);
      console.log('üìã PDF dosya adƒ± parse sonucu:', parsedPdf);
      
      let haftaNo = hafta.haftaNo || (i + 1);
      
      // PDF'den hafta numarasƒ± varsa g√ºncelle
      if (parsedPdf && parsedPdf.haftaNo) {
        console.log(`üìÖ PDF'den hafta numarasƒ± alƒ±ndƒ±: ${haftaNo} ‚Üí ${parsedPdf.haftaNo}`);
        haftaNo = parsedPdf.haftaNo;
        haftalar[i].haftaNo = parsedPdf.haftaNo;
      }
      
      // PDF'den tarih aralƒ±ƒüƒ± varsa g√ºncelle
      if (parsedPdf && parsedPdf.baslangicGun && parsedPdf.baslangicAy) {
        const parsedTarihler = parseEdilmistarihleriDateOlarak(parsedPdf);
        if (parsedTarihler) {
          console.log(`üìÖ PDF'den tarih aralƒ±ƒüƒ± alƒ±ndƒ±:`, parsedTarihler);
          haftalar[i].baslangic = parsedTarihler.baslangic;
          haftalar[i].bitis = parsedTarihler.bitis;
          
          // Ba≈üarƒ± mesajƒ± g√∂ster
          const basTarih = new Date(parsedTarihler.baslangic).toLocaleDateString('tr-TR');
          const bitTarih = new Date(parsedTarihler.bitis).toLocaleDateString('tr-TR');
          console.log(`‚úÖ Tab tarihleri g√ºncellendi: ${basTarih} - ${bitTarih}`);
        }
      }
      
      // GitHub'a PDF y√ºkle
      console.log('  PDF GitHub\'a y√ºkleniyor...');
      const pdfSonuc = await pdfYukleGithub(file, seciliHasta.id, haftaNo);
      
      if (!pdfSonuc) {
        console.error('‚ùå PDF y√ºkleme ba≈üarƒ±sƒ±z');
        return;
      }
      
      // Hafta verilerini g√ºncelle
      haftalar[i].pdfFile = file; // Ge√ßici olarak File objesi (analiz i√ßin)
      haftalar[i].pdfOrijinalIsim = pdfSonuc.orijinalAd;
      haftalar[i].pdfName = pdfSonuc.guvenliAd;
      haftalar[i].pdfYolu = pdfSonuc.dosyaYolu;
      haftalar[i].githubUrl = pdfSonuc.githubUrl;
      haftalar[i].indirmeUrl = pdfSonuc.indirmeUrl;
      haftalar[i].kayitTarihi = new Date().toISOString();
      
      // YENƒ∞ PDF Y√úKLENINCE ESKƒ∞ KARTLARI TEMƒ∞ZLE
      console.log('üßπ Yeni PDF y√ºkleniyor, eski kartlar temizleniyor...');
      console.log('üîç Temizleme √∂ncesi hafta verileri:', {
        haftaIndex: i,
        eskiTarifKartlar: haftalar[i].tarifKartlar?.length || 0,
        eskiManuelKartlar: haftalar[i].manuelKartlar?.length || 0,
        eskiTarifler: haftalar[i].tarifler?.length || 0
      });
      
      // 1. LocalStorage'daki hafta verilerinden eski kartlarƒ± temizle
      haftalar[i].tarifKartlar = []; // Otomatik e≈üle≈üen kartlarƒ± sƒ±fƒ±rla
      haftalar[i].manuelKartlar = []; // Manuel eklenen kartlarƒ± sƒ±fƒ±rla
      haftalar[i].tarifler = []; // Eski tarifleri sƒ±fƒ±rla
      
      console.log('‚úÖ LocalStorage hafta verileri temizlendi');
      
      console.log('‚úÖ PDF verileri g√ºncellendi:', {
        pdfOrijinalIsim: haftalar[i].pdfOrijinalIsim,
        pdfYolu: haftalar[i].pdfYolu,
        githubUrl: haftalar[i].githubUrl,
        indirmeUrl: haftalar[i].indirmeUrl
      });
      
      // Se√ßili hasta objesini de g√ºncelle
      if (seciliHasta && seciliHasta.haftalar) {
        const seciliHaftaIndex = seciliHasta.haftalar.findIndex(h => (h.haftaNo || 0) === haftaNo);
        if (seciliHaftaIndex !== -1) {
          seciliHasta.haftalar[seciliHaftaIndex].pdfFile = file;
          seciliHasta.haftalar[seciliHaftaIndex].pdfOrijinalIsim = pdfSonuc.orijinalAd;
          seciliHasta.haftalar[seciliHaftaIndex].pdfName = pdfSonuc.guvenliAd;
          seciliHasta.haftalar[seciliHaftaIndex].pdfYolu = pdfSonuc.dosyaYolu;
          seciliHasta.haftalar[seciliHaftaIndex].githubUrl = pdfSonuc.githubUrl;
          seciliHasta.haftalar[seciliHaftaIndex].indirmeUrl = pdfSonuc.indirmeUrl;
          seciliHasta.haftalar[seciliHaftaIndex].kayitTarihi = haftalar[i].kayitTarihi;
          
          // YENƒ∞ PDF Y√úKLENINCE ESKƒ∞ KARTLARI HASTA JSON'UNDAN DA TEMƒ∞ZLE
          console.log('üîç Hasta JSON temizleme √∂ncesi:', {
            haftaIndex: seciliHaftaIndex,
            eskiTarifKartlar: seciliHasta.haftalar[seciliHaftaIndex].tarifKartlar?.length || 0,
            eskiManuelKartlar: seciliHasta.haftalar[seciliHaftaIndex].manuelKartlar?.length || 0,
            eskiTarifler: seciliHasta.haftalar[seciliHaftaIndex].tarifler?.length || 0
          });
          
          seciliHasta.haftalar[seciliHaftaIndex].tarifKartlar = []; // Otomatik e≈üle≈üen kartlarƒ± sƒ±fƒ±rla
          seciliHasta.haftalar[seciliHaftaIndex].manuelKartlar = []; // Manuel eklenen kartlarƒ± sƒ±fƒ±rla
          seciliHasta.haftalar[seciliHaftaIndex].tarifler = []; // Eski tarifleri sƒ±fƒ±rla
          
          console.log('üßπ Hasta JSON\'undan da eski kartlar temizlendi');
        }
      }

      // PDF dosya adƒ±ndan hafta numarasƒ±nƒ± ve tarih aralƒ±ƒüƒ±nƒ± otomatik tespit et
      const parsed = parseProfessionalPdfName(file.name);
      if (parsed) {
        console.log('üìã PDF parse sonucu:', parsed);
        
        const eskiHaftaNo = haftalar[i].haftaNo || (i + 1);
        haftalar[i].haftaNo = parsed.haftaNo;
        
        // Tarih aralƒ±ƒüƒ±nƒ± da g√ºncelle
        if (parsed.tarihAraligi) {
          const tarihBilgisi = parseTarihAraligi(parsed.tarihAraligi);
          haftalar[i].baslangic = tarihBilgisi.baslangic;
          haftalar[i].bitis = tarihBilgisi.bitis;
          console.log('üìÖ Hafta tarihleri g√ºncellendi:', tarihBilgisi);
          
          // Se√ßili hasta objesinde de g√ºncelle
          if (seciliHasta && seciliHasta.haftalar) {
            const seciliHaftaIndex = seciliHasta.haftalar.findIndex(h => (h.haftaNo || 0) === parsed.haftaNo);
            if (seciliHaftaIndex !== -1) {
              seciliHasta.haftalar[seciliHaftaIndex].baslangic = tarihBilgisi.baslangic;
              seciliHasta.haftalar[seciliHaftaIndex].bitis = tarihBilgisi.bitis;
            }
          }
        }
        
        setTimeout(() => {
          const haftaNoInput = document.getElementById('haftaNo_' + i);
          if (haftaNoInput) {
            haftaNoInput.value = parsed.haftaNo;
            haftaNoInput.style.backgroundColor = '#d4edda';
            haftaNoInput.style.borderColor = '#28a745';
            setTimeout(() => {
              haftaNoInput.style.backgroundColor = '';
              haftaNoInput.style.borderColor = '';
            }, 2000);
          }
          
          // Tarih inputlarƒ±nƒ± da g√ºncelle
          if (parsed.tarihAraligi) {
            const tarihBilgisi = parseTarihAraligi(parsed.tarihAraligi);
            const baslangicInput = document.getElementById('baslangic_' + i);
            const bitisInput = document.getElementById('bitis_' + i);
            
            if (baslangicInput) {
              baslangicInput.value = tarihBilgisi.baslangic;
              baslangicInput.style.backgroundColor = '#d4edda';
              baslangicInput.style.borderColor = '#28a745';
              setTimeout(() => {
                baslangicInput.style.backgroundColor = '';
                baslangicInput.style.borderColor = '';
              }, 2000);
            }
            
            if (bitisInput) {
              bitisInput.value = tarihBilgisi.bitis;
              bitisInput.style.backgroundColor = '#d4edda';
              bitisInput.style.borderColor = '#28a745';
              setTimeout(() => {
                bitisInput.style.backgroundColor = '';
                bitisInput.style.borderColor = '';
              }, 2000);
            }
          }
        }, 100);
      } else {
        // Fallback: Sadece hafta numarasƒ±nƒ± √ßƒ±karmaya √ßalƒ±≈ü
        const dosyaAdindenHaftaNo = pdfDosyaAdindenHaftaNoAl(file.name);
        if (dosyaAdindenHaftaNo) {
          haftalar[i].haftaNo = dosyaAdindenHaftaNo;
          setTimeout(() => {
            const haftaNoInput = document.getElementById('haftaNo_' + i);
            if (haftaNoInput) {
              haftaNoInput.value = dosyaAdindenHaftaNo;
              haftaNoInput.style.backgroundColor = '#fff3cd';
              haftaNoInput.style.borderColor = '#ffc107';
              setTimeout(() => {
                haftaNoInput.style.backgroundColor = '';
                haftaNoInput.style.borderColor = '';
              }, 2000);
            }
          }, 100);
        }
      }

      // Hasta verisini GitHub'a kaydet (yeni sisteme g√∂re)
      if (seciliHasta) {
        await hastayiAyriKaydet(seciliHasta);
      }

      // Otomatik kaydetme - hasta verileri deƒüi≈üti
      autoSaveHastaData(seciliHasta);
      
      renderHastalar();
      gosterHaftalar();

      // Eƒüer bu hafta ≈üu anda aktif hafta ise, ekrandan da eski kartlarƒ± temizle
      const aktifTab = document.querySelector('.hafta-tab.active');
      const aktifHaftaIndex = aktifTab ? parseInt(aktifTab.dataset.haftaIndex) : null;
      
      if (aktifTab && aktifHaftaIndex === i) {
        console.log('üßπ Aktif haftada PDF yenileniyor, ekrandaki kartlar temizleniyor...');
        const currentDiv = document.getElementById('eslesenContent');
        if (currentDiv) {
          currentDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">PDF analiz ediliyor...</div>';
        }
      }

      // PDF'i analiz et ve tarifleri √ßƒ±kar
      const reader = new FileReader();
      reader.onload = async function(e) {
        const bytes = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
        let fullText = '';
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          fullText += strings.join('\n') + '\n';
        }

        // PDF i√ßeriƒüinden hafta numarasƒ±nƒ± kontrol et
        const iceriktenHaftaNo = pdfIcerigindenhaftaNoAl(fullText);
        if (iceriktenHaftaNo && !pdfDosyaAdindenHaftaNoAl(haftalar[i].pdfName)) {
          const eskiHaftaNo = haftalar[i].haftaNo || (i + 1);
          haftalar[i].haftaNo = iceriktenHaftaNo;
          setTimeout(() => {
            const haftaNoInput = document.getElementById('haftaNo_' + i);
            if (haftaNoInput) {
              haftaNoInput.value = iceriktenHaftaNo;
              haftaNoInput.style.backgroundColor = '#d1ecf1';
              haftaNoInput.style.borderColor = '#17a2b8';
              setTimeout(() => {
                haftaNoInput.style.backgroundColor = '';
                haftaNoInput.style.borderColor = '';
              }, 2000);
            }
          }, 100);
        }

        haftalar[i].tarifler = extractTariflerDetay(fullText);
        
        // E≈üle≈ütirme yap ve sonu√ßlarƒ± kaydet
        const eslestirmeSonucu = await otomatikEsleHafta(i);
        
        // JSON'a sadece e≈üle≈üen kartlarƒ± kaydet (e≈üle≈ümeyenleri kaydetme)
        if (eslestirmeSonucu) {
          console.log('‚úÖ E≈üle≈ütirme sonu√ßlarƒ± hafta verilerine kaydediliyor...');
          haftalar[i].tarifKartlar = eslestirmeSonucu.eslesenKartlar || [];
          // E≈üle≈ümeyen tarifleri JSON'a kaydetmiyoruz - sadece UI'da g√∂stereceƒüiz
          console.log('üìù JSON\'a kaydedilecek e≈üle≈üen kart sayƒ±sƒ±:', eslestirmeSonucu.eslesenKartlar?.length || 0);
          console.log('üìù E≈üle≈ümeyen tarifler JSON\'a kaydedilmiyor (sadece UI\'da g√∂r√ºn√ºr)');
        }
        
        // Hasta JSON dosyasƒ±nƒ± g√ºncelle
        if (seciliHasta) {
          const seciliHaftaIndex = seciliHasta.haftalar.findIndex(h => (h.haftaNo || 0) === (haftalar[i].haftaNo || (i + 1)));
          if (seciliHaftaIndex !== -1) {
            seciliHasta.haftalar[seciliHaftaIndex].tarifler = haftalar[i].tarifler;
            seciliHasta.haftalar[seciliHaftaIndex].tarifKartlar = haftalar[i].tarifKartlar || [];
            // E≈üle≈ümeyen tarifleri JSON'a kaydetmiyoruz - JSON boyutunu k√º√ß√ºk tutmak i√ßin
            // seciliHasta.haftalar[seciliHaftaIndex].eslesmeyenTarifler = haftalar[i].eslesmeyenTarifler || [];
            
            // Mevcut JSON'da eslesmeyenTarifler varsa sil (temizlik)
            if (seciliHasta.haftalar[seciliHaftaIndex].eslesmeyenTarifler) {
              delete seciliHasta.haftalar[seciliHaftaIndex].eslesmeyenTarifler;
              console.log('üßπ Eski eslesmeyenTarifler verisi JSON\'dan temizlendi');
            }
          }
          
          // Hasta verilerini GitHub'a kaydet
          await hastayiAyriKaydet(seciliHasta);
          console.log('üíæ PDF analizi sonrasƒ± hasta verileri JSON\'a kaydedildi (sadece e≈üle≈üenler)');
        }
        
        saveToStorage();
        
        // Eƒüer bu hafta ≈üu anda aktif hafta ise, kartlarƒ± hemen g√∂ster
        const aktifTab = document.querySelector('.hafta-tab.active');
        const aktifHaftaIndex = aktifTab ? parseInt(aktifTab.dataset.haftaIndex) : null;
        
        console.log('üîç PDF analizi sonrasƒ± kart g√ºncelleme kontrol√º:', {
          pdfYuklenenHaftaIndex: i,
          aktifHaftaIndex: aktifHaftaIndex,
          aktifTabVar: !!aktifTab,
          eslestirmeSonucu: eslestirmeSonucu ? 'var' : 'yok'
        });
        
        // Verileri kaydet
        saveToStorage();
        
        // YENƒ∞ Sƒ∞STEM: GitHub'a da kaydet
        if (seciliHasta) {
          hastayiAyriKaydet(seciliHasta).then(basarili => {
            if (basarili) {
              console.log('‚úÖ PDF g√ºncellenen hafta verileri GitHub\'a kaydedildi');
            }
          }).catch(error => {
            console.error('‚ùå GitHub kaydetme hatasƒ±:', error);
          });
        }
        
        // Tab ba≈ülƒ±ƒüƒ±nƒ± ve tarihlerini g√ºncelle
        gosterHaftalar();
        
        // Aktif tab'ƒ± koru
        setTimeout(() => {
          switchTab(i);
          if (aktifTab && aktifHaftaIndex === i) {
            console.log('üéØ PDF y√ºklenen hafta aktif hafta, kartlarƒ± g√ºncelleniyor...');
            setTimeout(() => {
              gosterEslesenKartlarSidebar(i);
            }, 500); // Kƒ±sa bir gecikme ile g√ºncelle
          } else {
            console.log('üîç PDF y√ºklenen hafta aktif hafta deƒüil, kart g√ºncelleme yapƒ±lmƒ±yor');
          }
        }, 200);
      };
      reader.readAsArrayBuffer(file);
    }

    // PDF'den otomatik tara ve e≈üle≈ütir
    async function pdfOkuVeEsleHafta(i) {
      const hafta = getHaftaListesi()[i];
      if (!hafta.pdf) {
        console.log(`‚ö†Ô∏è ${i}. hafta i√ßin PDF bulunamadƒ±`);
        return;
      }
      
      try {
        // Base64 verisini kontrol et ve temizle
        let base64Data = hafta.pdf;
        if (base64Data.includes(',')) {
          base64Data = base64Data.split(',')[1];
        }
        
        // Base64 verisini doƒürula
        if (!base64Data || base64Data.length === 0) {
          console.error(`‚ùå ${i}. hafta i√ßin ge√ßersiz PDF verisi`);
          return;
        }
        
        // Minimum PDF boyutu kontrol√º (74KB olmalƒ±, en az 50KB olsun)
        const minPdfSize = 50000; // 50KB
        if (base64Data.length < minPdfSize) {
          console.warn(`‚ö†Ô∏è ${i}. hafta PDF verisi √ßok k√º√ß√ºk: ${base64Data.length} karakter (${Math.round(base64Data.length * 0.75)} byte)`);
          console.warn(`üìã Beklenen minimum: ${minPdfSize} karakter (~${Math.round(minPdfSize * 0.75)} byte)`);
          
          // K√º√ß√ºk PDF dosyasƒ±, muhtemelen hatalƒ± y√ºklenmi≈ü
          hafta.tarifler = [];
          hafta.pdfMetinYok = true;
          hafta.pdfBoyutHatasi = true;
          hafta.googleSheetsPdf = true;
          
          saveToStorage();
          console.log(`üìã ${i}. hafta: PDF boyutu yetersiz, tarif analizi atlandƒ±`);
          
          // Otomatik e≈üle≈ütirmeyi dene
          try {
            otomatikEsleHafta(i);
          } catch (eslemeHatasi) {
            console.error(`‚ùå ${i}. hafta otomatik e≈üle≈ütirme hatasƒ±:`, eslemeHatasi);
          }
          return;
        }
        
        // Base64 karakterlerini temizle (sadece ge√ßerli karakterler)
        base64Data = base64Data.replace(/[^A-Za-z0-9+/=]/g, '');
        
        console.log(`üîç ${i}. hafta PDF analizi ba≈ülƒ±yor...`);
        console.log(`üìä PDF veri kontrol√º: ${base64Data.length} karakter`);
        
        // PDF validasyonu i√ßin farklƒ± y√∂ntemler dene
        let pdf = null;
        let pdfAnalysisSuccess = false;
        
        try {
          // Y√∂ntem 1: Normal Uint8Array yakla≈üƒ±mƒ±
          const binary = atob(base64Data);
          const len = binary.length;
          const bytes = new Uint8Array(len);
          for (let j = 0; j < len; j++) bytes[j] = binary.charCodeAt(j);
          
          console.log(`üìã PDF bytes olu≈üturuldu: ${bytes.length} byte`);
          
          pdf = await pdfjsLib.getDocument({ 
            data: bytes,
            useSystemFonts: true,
            disableFontFace: false,
            verbosity: 0 // Hata detaylarƒ±nƒ± azalt
          }).promise;
          
          pdfAnalysisSuccess = true;
          console.log(`‚úÖ PDF ba≈üarƒ±yla y√ºklendi (${pdf.numPages} sayfa)`);
          
        } catch (error1) {
          console.log(`‚ö†Ô∏è ƒ∞lk y√∂ntem ba≈üarƒ±sƒ±z: ${error1.name} - ${error1.message}`);
          
          try {
            // Y√∂ntem 2: Base64 URL yakla≈üƒ±mƒ±
            const dataUrl = `data:application/pdf;base64,${base64Data}`;
            pdf = await pdfjsLib.getDocument({ 
              url: dataUrl,
              useSystemFonts: true,
              disableFontFace: true,
              verbosity: 0
            }).promise;
            
            pdfAnalysisSuccess = true;
            console.log(`‚úÖ PDF data URL ile y√ºklendi (${pdf.numPages} sayfa)`);
            
          } catch (error2) {
            console.log(`‚ö†Ô∏è ƒ∞kinci y√∂ntem ba≈üarƒ±sƒ±z: ${error2.name} - ${error2.message}`);
            
            try {
              // Y√∂ntem 3: Blob yakla≈üƒ±mƒ±
              const binary = atob(base64Data);
              const bytes = new Array(binary.length);
              for (let j = 0; j < binary.length; j++) {
                bytes[j] = binary.charCodeAt(j);
              }
              
              const blob = new Blob([new Uint8Array(bytes)], { type: 'application/pdf' });
              const blobUrl = URL.createObjectURL(blob);
              
              pdf = await pdfjsLib.getDocument({ 
                url: blobUrl,
                useSystemFonts: true,
                verbosity: 0
              }).promise;
              
              pdfAnalysisSuccess = true;
              console.log(`‚úÖ PDF blob URL ile y√ºklendi (${pdf.numPages} sayfa)`);
              
              // Blob URL'yi temizle
              setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
              
            } catch (error3) {
              console.error(`‚ùå T√ºm PDF y√ºkleme y√∂ntemleri ba≈üarƒ±sƒ±z:`);
              console.error(`  1. Uint8Array: ${error1.name} - ${error1.message}`);
              console.error(`  2. Data URL: ${error2.name} - ${error2.message}`);
              console.error(`  3. Blob URL: ${error3.name} - ${error3.message}`);
              throw error3;
            }
          }
        }
        
        if (!pdfAnalysisSuccess || !pdf) {
          throw new Error('PDF analizi ba≈üarƒ±sƒ±z');
        }
        if (!pdfAnalysisSuccess || !pdf) {
          throw new Error('PDF analizi ba≈üarƒ±sƒ±z');
        }
        
        let fullText = '';
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          fullText += strings.join('\n') + '\n';
        }
        
        console.log(`‚úÖ ${i}. hafta PDF metni √ßƒ±karƒ±ldƒ±: ${fullText.length} karakter`);
        
        // Eƒüer PDF'den metin √ßƒ±karƒ±lamadƒ±ysa, manuel e≈üle≈ütirme yap
        if (fullText.trim().length === 0) {
          console.log(`‚ö†Ô∏è ${i}. hafta PDF'den metin √ßƒ±karƒ±lamadƒ±, manuel e≈üle≈ütirme deneniyor...`);
          hafta.tarifler = []; // Bo≈ü tarif listesi
          hafta.pdfMetinYok = true; // PDF'den metin √ßƒ±karƒ±lamadƒ±ƒüƒ±nƒ± i≈üaretle
        } else {
          hafta.pdfMetinYok = false;
        }
        
        // Eƒüer PDF'den metin √ßƒ±karƒ±lamadƒ±ysa, manuel e≈üle≈ütirme yap
        if (fullText.trim().length === 0) {
          console.log(`‚ö†Ô∏è ${i}. hafta PDF'den metin √ßƒ±karƒ±lamadƒ±, manuel e≈üle≈ütirme deneniyor...`);
          hafta.tarifler = []; // Bo≈ü tarif listesi
          hafta.pdfMetinYok = true; // PDF'den metin √ßƒ±karƒ±lamadƒ±ƒüƒ±nƒ± i≈üaretle
        } else {
          hafta.pdfMetinYok = false;
        }
        
        // PDF i√ßeriƒüinden de hafta numarasƒ±nƒ± kontrol et (dosya adƒ±ndan tespit edilmediyse)
      const haftalar = getHaftaListesi();
      
      // Sadece metin varsa i√ßerikten hafta no almaya √ßalƒ±≈ü
      if (fullText.trim().length > 0) {
        const iceriktenHaftaNo = pdfIcerigindenhaftaNoAl(fullText);
        if (iceriktenHaftaNo && !pdfDosyaAdindenHaftaNoAl(hafta.pdfName)) {
          const eskiHaftaNo = haftalar[i].haftaNo || (i + 1);
          haftalar[i].haftaNo = iceriktenHaftaNo;
          
          console.log(`üìÑ PDF i√ßeriƒüinden hafta numarasƒ± g√ºncellendi: ${eskiHaftaNo}. hafta ‚Üí ${iceriktenHaftaNo}. hafta`);
          
          // UI'da g√∂rsel feedback g√∂ster
          setTimeout(() => {
            const haftaNoInput = document.getElementById('haftaNo_' + i);
            if (haftaNoInput) {
              haftaNoInput.value = iceriktenHaftaNo;
              haftaNoInput.style.backgroundColor = '#d1ecf1';
              haftaNoInput.style.borderColor = '#17a2b8';
              setTimeout(() => {
                haftaNoInput.style.backgroundColor = '';
                haftaNoInput.style.borderColor = '';
              }, 2000);
            }
          }, 100);
        }
      }
      
      // Tarif √ßƒ±karma
      if (fullText.trim().length > 0) {
        hafta.tarifler = extractTariflerDetay(fullText);
      } else {
        hafta.tarifler = [];
        console.log(`‚ö†Ô∏è ${i}. hafta: PDF'den metin √ßƒ±karƒ±lamadƒ±ƒüƒ± i√ßin tarif listesi bo≈ü`);
      }
      saveToStorage();
      // Otomatik e≈üle≈ütir
      otomatikEsleHafta(i);
      
      } catch (error) {
        console.error(`‚ùå ${i}. hafta PDF analizi hatasƒ±:`, error);
        console.error('PDF veri uzunluƒüu:', hafta.pdf ? hafta.pdf.length : 'N/A');
        console.error('Error type:', error.name);
        console.error('Error message:', error.message);
        
        // Google Sheets PDF formatƒ± i√ßin √∂zel mesaj
        if (error.name === 'InvalidPDFException' || error.message.includes('Invalid PDF')) {
          console.log(`‚ö†Ô∏è ${i}. hafta: Google Sheets PDF formatƒ± PDF.js ile uyumsuz olabilir`);
          
          // PDF y√ºkl√º ama analiz edilemiyor, bo≈ü tarif listesi ver
          if (hafta.pdf) {
            hafta.tarifler = [];
            hafta.pdfMetinYok = true;
            hafta.googleSheetsPdf = true; // Google Sheets PDF i≈üareti
            console.log(`üìã ${i}. hafta: PDF kaydedildi ama tarif analizi atlandƒ± (Google Sheets uyumsuzluƒüu)`);
          }
        }
        
        // PDF analizi ba≈üarƒ±sƒ±z olsa da, eƒüer PDF y√ºklendi ise otomatik e≈üle≈ütirmeyi dene
        if (hafta.pdf) {
          console.log(`üîÑ ${i}. hafta i√ßin PDF analizi ba≈üarƒ±sƒ±z ama otomatik e≈üle≈ütirme deneniyor...`);
          try {
            otomatikEsleHafta(i);
          } catch (eslemeHatasi) {
            console.error(`‚ùå ${i}. hafta otomatik e≈üle≈ütirme hatasƒ±:`, eslemeHatasi);
          }
        }
      }
    }

    // pdfOkuHafta fonksiyonu artƒ±k kullanƒ±lmƒ±yor (otomatikle≈ütirildi)

    // Test fonksiyonu - PDF yapƒ±sƒ±nƒ± analiz etmek i√ßin
    async function testPdfAnalyze(fileInput) {
      const file = fileInput.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        const bytes = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
        let fullText = '';
        
        console.log('üìÑ PDF Analiz Raporu:');
        console.log('- Sayfa sayƒ±sƒ±:', pdf.numPages);
        
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          const pageText = strings.join('\n');
          fullText += pageText + '\n';
          
          console.log(`- Sayfa ${p}:`, pageText.substring(0, 200) + '...');
        }
        
        console.log('üìù Tam ƒ∞√ßerik:', fullText);
        
        // PDF format analizi
        const lines = fullText.split('\n').filter(line => line.trim());
        console.log('üìä ƒ∞√ßerik analizi:');
        console.log('- Toplam satƒ±r:', lines.length);
        console.log('- ƒ∞lk 10 satƒ±r:', lines.slice(0, 10));
        
        // Hasta adƒ±, tarih, hafta bilgisi arama
        const hastaPattern = /([A-Z√áƒûƒ∞√ñ≈û√ú][a-z√ßƒüƒ±√∂≈ü√º]+\s+[A-Z√áƒûƒ∞√ñ≈û√ú][a-z√ßƒüƒ±√∂≈ü√º]+)/g;
        const tarihPattern = /(\d{1,2}[\.\/\-]\d{1,2}[\.\/\-]\d{2,4})/g;
        const haftaPattern = /(\d+)\.\s*hafta/gi;
        
        console.log('üîç Tespit edilen veriler:');
        console.log('- Hasta adlarƒ±:', fullText.match(hastaPattern));
        console.log('- Tarihler:', fullText.match(tarihPattern));
        console.log('- Hafta bilgileri:', fullText.match(haftaPattern));
      };
      reader.readAsArrayBuffer(file);
    }

    // PDF Generator - Hasta Takip Tablosu Olu≈ütur
    function generatePatientPDF() {
      console.log('üéØ PDF Generator ba≈ülatƒ±lƒ±yor...');
      
      if (!seciliHasta) {
        alert('L√ºtfen √∂nce bir hasta se√ßin!');
        console.log('‚ùå Hasta se√ßilmemi≈ü');
        return;
      }
      
      console.log('‚úÖ Se√ßili hasta:', seciliHasta.isim);
      
      const haftalar = getHaftaListesi();
      if (haftalar.length === 0) {
        alert('Bu hasta i√ßin hi√ß hafta kaydƒ± bulunamadƒ±!');
        console.log('‚ùå Hafta kaydƒ± bulunamadƒ±');
        return;
      }
      
      console.log('‚úÖ Hafta sayƒ±sƒ±:', haftalar.length);
      
      // Sadece 5. haftada lenf drenaj programƒ± olu≈üturulacak
      const mevcutHaftaNo = haftalar.length;
      if (mevcutHaftaNo === 5) {
        console.log('‚úÖ 5. hafta tespit edildi, Lenf Drenaj Masajƒ± programƒ± hazƒ±rlanƒ±yor');
      } else {
        console.log(`üìã ${mevcutHaftaNo}. hafta - Genel takip PDF\'i olu≈üturuluyor`);
      }
      
      // Sabit 12 haftalƒ±k program 
      const haftaSayisi = 12;
      console.log('‚úÖ PDF i√ßin hafta sayƒ±sƒ±:', haftaSayisi);
      
      // T√ºrk√ße karakter d√ºzeltme uygula
      const duzeltilenHastaAdi = turkceKarakterDuzelt(seciliHasta.isim);
      
      if (mevcutHaftaNo === 5) {
        generateLenfDrenajPDF(duzeltilenHastaAdi, haftalar, haftaSayisi);
      } else {
        generateGenelTakipPDF(duzeltilenHastaAdi, haftalar, haftaSayisi);
      }
    }
    
    function generateLenfDrenajPDF(hastaAdi, mevcutHaftalar, toplamHaftaSayisi) {
      console.log('üìÑ Lenf Drenaj Masajƒ± PDF olu≈üturuluyor...', { hastaAdi, toplamHaftaSayisi });
      
      // jsPDF k√ºt√ºphanesini kontrol et
      console.log('jsPDF kontrol:', typeof window.jspdf, typeof jsPDF);
      
      let jsPDFLib;
      if (typeof window.jspdf !== 'undefined') {
        jsPDFLib = window.jspdf.jsPDF;
        console.log('‚úÖ jsPDF window.jspdf.jsPDF √ºzerinden y√ºklendi');
      } else if (typeof jsPDF !== 'undefined') {
        jsPDFLib = jsPDF;
        console.log('‚úÖ jsPDF global jsPDF √ºzerinden y√ºklendi');
      } else {
        console.log('‚ùå jsPDF bulunamadƒ±, dinamik y√ºkleme yapƒ±lƒ±yor...');
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        script.onload = () => {
          console.log('‚úÖ jsPDF dinamik olarak y√ºklendi');
          setTimeout(() => generateLenfDrenajPDF(hastaAdi, mevcutHaftalar, toplamHaftaSayisi), 100);
        };
        script.onerror = () => {
          console.log('‚ùå jsPDF y√ºklenemedi');
          alert('PDF k√ºt√ºphanesi y√ºklenemedi. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin.');
        };
        document.head.appendChild(script);
        return;
      }
      
      try {
        console.log('üìù Lenf Drenaj Masajƒ± PDF d√∂k√ºmanƒ± olu≈üturuluyor...');
        const doc = new jsPDFLib('p', 'mm', 'a4'); // Portrait format
        
        // T√ºrk√ße karakter desteƒüi
        doc.setFont('helvetica');
        
        // Ba≈ülƒ±k
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        
        // Hasta adƒ±nƒ± T√ºrk√ße karakter d√ºzeltme ile hazƒ±rla
        const temizHastaAdi = turkceKarakterDuzelt(hastaAdi);
        const title = `${temizHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        // Alt ba≈ülƒ±k
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        const subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // Program a√ßƒ±klamasƒ±
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(window.fixTurkishChars('8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi (5. Haftadan itibaren)'), 20, 38);
        
        // Se√ßili haftayƒ± al - ge√ßmi≈ü haftalarda soluk renk i√ßin
        const seciliHaftaIndex = parseInt(document.getElementById('haftaSelect').value);
        const seciliHaftaNo = seciliHaftaIndex + 1;
        
        // 5. haftanƒ±n pazartesi tarihini hesapla
        const besinciHafta = mevcutHaftalar[4];
        if (!besinciHafta || !besinciHafta.baslangic) {
          throw new Error('5. hafta bilgisi bulunamadi!');
        }
        
        const besinciHaftaBaslangic = new Date(besinciHafta.baslangic);
        
        // 5. hafta ba≈ülangƒ±√ß tarihinin pazartesi olmasƒ±nƒ± garanti altƒ±na al
        const haftaGunu = besinciHaftaBaslangic.getDay(); // 0=Pazar, 1=Pazartesi, ... 6=Cumartesi
        if (haftaGunu !== 1) { // Eƒüer pazartesi deƒüilse
          const gunFarki = haftaGunu === 0 ? 1 : (1 - haftaGunu); // Pazartesiye kadar olan g√ºn farkƒ±
          besinciHaftaBaslangic.setDate(besinciHaftaBaslangic.getDate() + gunFarki);
        }
        
        console.log('‚úÖ 5. hafta ba≈ülangƒ±cƒ± (Pazartesi):', besinciHaftaBaslangic);
        
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'];
        
        // Her hafta i√ßin basit tablo
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5;
          const haftaBaslangic = new Date(besinciHaftaBaslangic.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          // Hafta ba≈ülƒ±ƒüƒ±
          // Se√ßili haftadan √∂nceki haftalar soluk renkte olsun
          if (gercekHaftaNo < seciliHaftaNo) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(10);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          doc.text(window.fixTurkishChars(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo ba≈ülƒ±klarƒ± - 4 s√ºtun
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, G√ºn, Sabah, Ak≈üam
          let tableStartX = 15;
          
          // Ba≈ülƒ±k satƒ±rƒ±
          doc.rect(tableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[0];
          
          doc.rect(tableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[1];
          
          doc.rect(tableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[2];
          
          doc.rect(tableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', tableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her g√ºn i√ßin satƒ±r
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrol√º
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // ƒ∞lk 2 hafta (5-6): G√ºnde 2 kez lenf masajƒ±
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = 'Lenf Masaji';
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): G√ºnde 1 kez lenf masajƒ± (sabah)
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): G√ºna≈üƒ±rƒ± lenf masajƒ± + s√ºrekli ak≈üam egzersiz
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                // Pazartesi, √áar≈üamba, Cuma, Pazar: Lenf masajƒ± + ak≈üam egzersiz
                sabahUygulama = 'Lenf Masaji';
                aksamUygulama = 'Egzersiz-2';
              } else {
                // Salƒ±, Per≈üembe, Cumartesi: Sabah ve ak≈üam egzersiz
                sabahUygulama = 'Egzersiz-1';
                aksamUygulama = 'Egzersiz-2';
              }
            } else {
              // Son 2 hafta (11-12): Salƒ±, Cuma lenf masajƒ± + s√ºrekli ak≈üam egzersiz
              if (gunIndex === 1 || gunIndex === 4) {
                // Salƒ±, Cuma: Lenf masajƒ± + ak≈üam egzersiz
                sabahUygulama = 'Lenf Masaji';
                aksamUygulama = 'Egzersiz-2';
              } else {
                // Diƒüer g√ºnler: Sabah ve ak≈üam egzersiz
                sabahUygulama = 'Egzersiz-1';
                aksamUygulama = 'Egzersiz-2';
              }
            }
            
            tableStartX = 15;
            
            // Se√ßili haftadan √∂nceki haftalar soluk renkte olsun
            if (gercekHaftaNo < seciliHaftaNo) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tarih s√ºtunu
            doc.rect(tableStartX, currentY, colWidths[0], 5);
            doc.text(tarihStr, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[0];
            
            // G√ºn s√ºtunu
            doc.rect(tableStartX, currentY, colWidths[1], 5);
            doc.text(gun, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[1];
            
            // Sabah s√ºtunu
            doc.rect(tableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[2];
            
            // Ak≈üam s√ºtunu
            doc.rect(tableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, tableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 5; // Haftalar arasƒ± bo≈üluk
          
          // Sayfa sonu kontrol√º
          if (currentY > 240 && lenfHaftaIndex < 7) {
            doc.addPage('p');
            currentY = 20;
          }
        }
        
        
        console.log('‚úÖ Basit lenf drenaj tablosu tamamlandƒ±, PDF indiriliyor...');
        
        // PDF'yi indir
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${hastaAdi}_Lenf_Drenaj_Programi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('‚úÖ Lenf Drenaj PDF ba≈üarƒ±yla olu≈üturuldu:', dosyaAdi);
        alert(`Lenf Drenaj Masajƒ± Programƒ± PDF'i ba≈üarƒ±yla olu≈üturuldu!\n\nDosya: ${dosyaAdi}\n\n8 haftalƒ±k program 5. haftanƒ±zƒ±n pazartesi g√ºn√º (${besinciHaftaBaslangic.toLocaleDateString('tr-TR')}) ba≈ülayacak ≈üekilde hazƒ±rlandƒ±.`);
        
      } catch (error) {
        console.error('‚ùå Lenf Drenaj PDF olu≈üturma hatasƒ±:', error);
        alert('Lenf Drenaj PDF olu≈ütururken hata olu≈ütu: ' + error.message);
      }
    }

    function generateGenelTakipPDF(hastaAdi, mevcutHaftalar, toplamHaftaSayisi) {
      console.log('üìÑ Genel Takip PDF olu≈üturuluyor...', { hastaAdi, toplamHaftaSayisi });
      alert('Hen√ºz 5. hafta kaydƒ±nƒ±z yok. Genel takip PDF\'i olu≈üturuluyor.\n5. hafta sonrasƒ± Lenf Drenaj Masajƒ± programƒ± otomatik eklenecektir.');
      
      // Basit takip PDF olu≈ütur (eski sistem)
      try {
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.setFont('helvetica');
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        const temizHastaAdi = turkceKarakterDuzelt(hastaAdi);
        
        // jsPDF i√ßin T√ºrk√ße karakterleri ASCII'ye √ßevir
        const pdfUygunHastaAdi = temizHastaAdi
          .replace(/≈û/g, 'S').replace(/≈ü/g, 's')
          .replace(/ƒû/g, 'G').replace(/ƒü/g, 'g')
          .replace(/ƒ∞/g, 'I').replace(/ƒ±/g, 'i')
          .replace(/√á/g, 'C').replace(/√ß/g, 'c')
          .replace(/√ñ/g, 'O').replace(/√∂/g, 'o')
          .replace(/√ú/g, 'U').replace(/√º/g, 'u');
        
        doc.text(`${pdfUygunHastaAdi.toUpperCase()} - GENEL TAKIP`, 20, 20);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('Hasta takip tablosu (Lenf drenaj programƒ± 5. hafta sonrasƒ± eklenecektir)', 20, 30);
        
        // Basit tablo
        const startY = 45;
        let currentY = startY;
        
        doc.setFontSize(9);
        doc.text('Hafta', 20, currentY);
        doc.text('Durum', 60, currentY);
        doc.text('Notlar', 120, currentY);
        currentY += 10;
        
        for (let i = 0; i < Math.min(mevcutHaftalar.length, toplamHaftaSayisi); i++) {
          const hafta = mevcutHaftalar[i];
          doc.text(`${i + 1}. Hafta`, 20, currentY);
          doc.text(hafta ? 'Tamamlandƒ±' : 'Beklemede', 60, currentY);
          doc.text(hafta && hafta.aciklama ? hafta.aciklama.substring(0, 30) : '', 120, currentY);
          currentY += 8;
        }
        
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${hastaAdi}_Genel_Takip_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('‚úÖ Genel Takip PDF ba≈üarƒ±yla olu≈üturuldu:', dosyaAdi);
        
      } catch (error) {
        console.error('‚ùå Genel Takip PDF hatasƒ±:', error);
        alert('PDF olu≈ütururken hata olu≈ütu: ' + error.message);
      }
    }

    // ZIP i√ßin Lenf Drenaj PDF Blob olu≈üturucu (indirmeden, sadece memory'de)
    async function generateLenfDrenajPDFBlob(belirliHaftaNo = null) {
      try {
        console.log('üìÑ Lenf Drenaj PDF Blob olu≈üturuluyor...');
        
        if (!seciliHasta) {
          console.warn('‚ùå Se√ßili hasta yok');
          return null;
        }
        
        const haftalar = getHaftaListesi();
        console.log('üîç Hafta listesi uzunluƒüu:', haftalar.length);
        
        // Hasta ve hafta bilgilerini detaylƒ± kontrol et
        if (!haftalar || haftalar.length === 0) {
          console.warn('‚ùå Hi√ß hafta verisi yok');
          return null;
        }
        
        console.log('üîç Hasta bilgileri:', {
          id: seciliHasta.id,
          isim: seciliHasta.isim,
          haftaSayisi: haftalar.length,
          belirliHaftaNo: belirliHaftaNo
        });
        
        // Hafta sayƒ±sƒ± kontrol√ºn√º kaldƒ±r - tek hafta bile olsa masaj takvimi olu≈üturulabilir
        // if (haftalar.length < 5) return null; // KALDIRILDI
        
        // Se√ßili haftayƒ± al - eƒüer belirli hafta belirtilmi≈üse onu kullan
        let egzersizDahilMi;
        let dokuzuncuHaftaOzelModu = false; // 9. hafta i√ßin √∂zel mod
        
        if (belirliHaftaNo !== null) {
          // ZIP i√ßin belirli bir hafta belirtilmi≈ü
          egzersizDahilMi = belirliHaftaNo >= 9; // 9. hafta ve sonrasƒ± i√ßin egzersiz dahil
          dokuzuncuHaftaOzelModu = belirliHaftaNo === 9; // 9. hafta √∂zel modu
          console.log(`üéØ ZIP i√ßin ${belirliHaftaNo}. hafta PDF'i olu≈üturuluyor, egzersiz dahil: ${egzersizDahilMi}, 9. hafta √∂zel mod: ${dokuzuncuHaftaOzelModu}`);
        } else {
          // Normal PDF indirme i√ßin se√ßili haftayƒ± kullan
          const seciliHaftaIndex = parseInt(document.getElementById('haftaSelect').value);
          egzersizDahilMi = seciliHaftaIndex >= 8; // 9. hafta ve sonrasƒ± i√ßin egzersiz dahil
        }
        
        console.log('üîç jsPDF kontrol√º ba≈ülƒ±yor...');
        // jsPDF kontrol√º
        let jsPDFLib;
        if (typeof window.jspdf !== 'undefined') {
          jsPDFLib = window.jspdf.jsPDF;
          console.log('‚úÖ window.jspdf bulundu');
        } else if (typeof jsPDF !== 'undefined') {
          jsPDFLib = jsPDF;
          console.log('‚úÖ global jsPDF bulundu');
        } else {
          console.warn('‚ùå jsPDF bulunamadƒ±');
          return null;
        }
        
        console.log('üîç Hasta adƒ± alƒ±nƒ±yor...');
        const hastaAdi = turkceKarakterDuzelt(seciliHasta.isim);
        console.log('üîç Hasta adƒ±:', hastaAdi);
        
        console.log('üîç PDF dok√ºmanƒ± olu≈üturuluyor...');
        const doc = new jsPDFLib('p', 'mm', 'a4'); // Portrait - mobil uyumlu
        
        console.log('üîç PDF ayarlarƒ± yapƒ±lƒ±yor...');
        // PDF i√ßeriƒüini olu≈ütur (yeni mobil dostu stil ile)
        
        // üîß T√ºrk√ße karakter sorunu i√ßin √∂zel encoding
        console.log('üîß T√ºrk√ße karakter encoding ayarlarƒ±...');
        
        // Ham hasta adƒ±nƒ± al (t√ºrkce d√ºzeltme yapmadan)
        const rawHastaAdi = seciliHasta.isim;
        console.log('üîç Ham hasta adƒ±:', rawHastaAdi);
        console.log('üîç seciliHasta objesi:', seciliHasta);
        
        // T√ºrk√ße karakterleri ASCII'ye √ßevir - KEKesin √ß√∂z√ºm
        const asciiHastaAdi = rawHastaAdi
            .replace(/≈û/g, 'S').replace(/≈ü/g, 's')
            .replace(/ƒû/g, 'G').replace(/ƒü/g, 'g')
            .replace(/√ú/g, 'U').replace(/√º/g, 'u')
            .replace(/ƒ∞/g, 'I').replace(/ƒ±/g, 'i')
            .replace(/√ñ/g, 'O').replace(/√∂/g, 'o')
            .replace(/√á/g, 'C').replace(/√ß/g, 'c')
            .replace(/∆è/g, 'E').replace(/…ô/g, 'e'); // Azerbaijan karakteri de varsa
            
        console.log('üîç ASCII hasta adƒ±:', asciiHastaAdi);
        
        doc.setFont('helvetica');
        doc.setLanguage('tr');
        
        // Ba≈ülƒ±k - Merkezi
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        console.log('‚úÖ PDF ba≈ülƒ±ƒüƒ±nda ASCII kullanƒ±ldƒ±:', title);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Hangi hafta i√ßin PDF olu≈üturulduƒüuna g√∂re farklƒ± ba≈ülƒ±k
        let subtitle, programBasligi;
        if (egzersizDahilMi) {
          subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
          programBasligi = '8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi';
        } else {
          subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
          programBasligi = '8 Haftalik Lenf Drenaj Masaji Uygulama Programi';
        }
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // A√ßƒ±klama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        if (egzersizDahilMi) {
          doc.text('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler', 20, 40);
        } else {
          doc.text('(5. Haftadan itibaren)', 20, 40);
        }
        
        console.log('üîç Hafta verilerini belirleniyor...');
        // Ba≈ülangƒ±√ß haftasƒ±nƒ± belirle
        let baslangicHaftaIndex;
        let baslangicHafta;
        
        if (dokuzuncuHaftaOzelModu) {
          // 9. hafta √∂zel modu: 4 hafta geriden ba≈üla (5. haftadan ba≈üla)
          baslangicHaftaIndex = 4; // 5. hafta = index 4
          console.log('üéØ 9. hafta √∂zel modu: 5. haftadan ba≈ülayacak (4 hafta geri)');
        } else {
          // Normal mod
          baslangicHaftaIndex = belirliHaftaNo ? belirliHaftaNo - 1 : 4; // 5. hafta = index 4
        }
        
        if (baslangicHaftaIndex < haftalar.length) {
          // Belirtilen hafta mevcut
          baslangicHafta = haftalar[baslangicHaftaIndex];
          console.log('‚úÖ Belirtilen hafta bulundu:', baslangicHafta);
        } else {
          // Belirtilen hafta yok, mevcut ilk haftayƒ± kullan
          baslangicHafta = haftalar[0];
          console.log('‚ö†Ô∏è Belirtilen hafta yok, ilk hafta kullanƒ±lƒ±yor:', baslangicHafta);
        }
        
        console.log('üîç Ba≈ülangƒ±√ß tarihi hesaplanƒ±yor...');
        const baslangicTarihi = new Date(baslangicHafta.baslangic);
        
        // Tab ba≈ülangƒ±√ß tarihini olduƒüu gibi kullan - zaten doƒüru tarihlendirilmi≈ü
        console.log('‚úÖ Ba≈ülangƒ±√ß tarihi (tab tarihinden):', baslangicTarihi);
        
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'];
        
        // Kompakt tablo (Blob i√ßin)
        const haftaSayisi = dokuzuncuHaftaOzelModu ? 8 : 8; // 9. hafta √∂zel modunda 8 hafta (5-12), normal modda 8 hafta
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < haftaSayisi; lenfHaftaIndex++) {
          // 9. hafta √∂zel modunda 5. haftadan ba≈üla (5,6,7,8,9,10,11,12), normal modda belirtilen haftadan
          const gercekHaftaNo = dokuzuncuHaftaOzelModu ? (lenfHaftaIndex + 5) : (lenfHaftaIndex + (belirliHaftaNo || 5));
          
          // Tarih hesaplamasƒ± d√ºzeltildi
          let haftaBaslangic;
          if (dokuzuncuHaftaOzelModu) {
            // 9. hafta √∂zel modu: 5. haftadan ba≈ülayarak 8 hafta g√∂ster
            // baslangicTarihi = 9. hafta ba≈ülangƒ±√ß tarihi
            // 5. hafta = 9. haftadan 4 hafta √∂nce
            // 6. hafta = 9. haftadan 3 hafta √∂nce
            // ...
            // 9. hafta = 9. haftadan 0 hafta √∂nce
            // 10. hafta = 9. haftadan 1 hafta sonra
            const haftaFarki = (lenfHaftaIndex + 5) - 9; // 5. hafta=-4, 6. hafta=-3, ..., 9. hafta=0, 10. hafta=+1
            haftaBaslangic = new Date(baslangicTarihi.getTime() + (haftaFarki * 7 * 24 * 60 * 60 * 1000));
          } else {
            // Normal mod: ba≈ülangƒ±√ß tarihinden itibaren hafta hafta ilerle
            haftaBaslangic = new Date(baslangicTarihi.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          }
          
          // Hafta ba≈ülƒ±ƒüƒ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // 9. hafta PDF'si i√ßin 5-8. haftalar soluk renkte olsun, 9-12. haftalar normal
          const eskiHaftaMi = dokuzuncuHaftaOzelModu && gercekHaftaNo >= 5 && gercekHaftaNo <= 8; // Sadece 5-8. haftalar
          if (eskiHaftaMi) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          
          doc.text(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`, 20, currentY + 4);
          
          // 9. hafta √∂zel modunda 5-8. haftalar i√ßin tamamlandƒ± i≈üareti
          if (eskiHaftaMi) {
            doc.setTextColor(0, 128, 0); // Ye≈üil renk
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('‚úì TAMAMLANDI', 120, currentY + 4);
            doc.setFont('helvetica', 'normal');
          }
          currentY += 8;
          
          // Tablo ba≈ülƒ±klarƒ± - 4 s√ºtun
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, G√ºn, Sabah, Ak≈üam
          let zipTableStartX = 15;
          
          // Ba≈ülƒ±k satƒ±rƒ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her g√ºn i√ßin satƒ±r
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrol√º - se√ßili haftaya g√∂re egzersiz dahil edilir
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // ƒ∞lk 2 hafta (5-6): G√ºnde 2 kez lenf masajƒ±
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = 'Lenf Masaji';
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): G√ºnde 1 kez lenf masajƒ± (sabah)
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): G√ºna≈üƒ±rƒ± lenf masajƒ±
              if (egzersizDahilMi) {
                // Egzersiz dahil versiyonu (9. hafta se√ßiliyse)
                if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                  // Pazartesi, √áar≈üamba, Cuma, Pazar: Lenf masajƒ± + ak≈üam egzersiz
                  sabahUygulama = 'Lenf Masaji';
                  aksamUygulama = 'Egzersiz-2';
                } else {
                  // Salƒ±, Per≈üembe, Cumartesi: Sabah ve ak≈üam egzersiz
                  sabahUygulama = 'Egzersiz-1';
                  aksamUygulama = 'Egzersiz-2';
                }
              } else {
                // Sadece lenf masajƒ± versiyonu (5-8. hafta se√ßiliyse)
                if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                  sabahUygulama = 'Lenf Masaji';
                } else {
                  sabahUygulama = '-';
                }
                aksamUygulama = '-';
              }
            } else {
              // Son 2 hafta (11-12): Salƒ±, Cuma lenf masajƒ±
              if (egzersizDahilMi) {
                // Egzersiz dahil versiyonu (9+ hafta se√ßiliyse)
                if (gunIndex === 1 || gunIndex === 4) {
                  // Salƒ±, Cuma: Lenf masajƒ± + ak≈üam egzersiz
                  sabahUygulama = 'Lenf Masaji';
                  aksamUygulama = 'Egzersiz-2';
                } else {
                  // Diƒüer g√ºnler: Sabah ve ak≈üam egzersiz
                  sabahUygulama = 'Egzersiz-1';
                  aksamUygulama = 'Egzersiz-2';
                }
              } else {
                // Sadece lenf masajƒ± versiyonu (5-8. hafta se√ßiliyse)
                if (gunIndex === 1 || gunIndex === 4) {
                  sabahUygulama = 'Lenf Masaji';
                } else {
                  sabahUygulama = '-';
                }
                aksamUygulama = '-';
              }
            }
            
            zipTableStartX = 15;
            
            // 9. hafta PDF'si i√ßin 5-8. haftalar soluk renkte olsun, 9-12. haftalar normal
            const eskiHaftaMi = dokuzuncuHaftaOzelModu && gercekHaftaNo >= 5 && gercekHaftaNo <= 8; // Sadece 5-8. haftalar
            if (eskiHaftaMi) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tablo √ßizgi ayarlarƒ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 9. hafta PDF'si ve ge√ßmi≈ü haftalarda (5-8) ye≈üil check simgesi ekle
            if (egzersizDahilMi && gercekHaftaNo <= 8) {
              // Ye≈üil check kutusu √ßiz
              doc.setFillColor(0, 128, 0); // Ye≈üil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // Ye≈üil dikd√∂rtgen
              
              // Beyaz check √ßizgisi √ßiz
              doc.setDrawColor(255, 255, 255); // Beyaz √ßizgi
              doc.setLineWidth(0.5);
              // Check i≈üareti √ßizgisi (V ≈üekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo √ßizgi ayarlarƒ±nƒ± geri y√ºkle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi soluk renkte yaz
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Normal tarih
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // G√ºn s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // Ak≈üam s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 5; // Haftalar arasƒ± bo≈üluk
          
          // Sayfa kontrol√º
          if (currentY > 250 && lenfHaftaIndex < 7) {
            doc.addPage('p');
            currentY = 20;
          }
        }
        
        // Blob olarak d√∂nd√ºr (indirmeden)
        const pdfBlob = doc.output('blob');
        console.log('‚úÖ Basit Lenf Drenaj PDF Blob olu≈üturuldu');
        return pdfBlob;
        
      } catch (error) {
        console.error('‚ùå Lenf Drenaj PDF Blob hatasƒ±:', error);
        console.error('‚ùå Hata detaylarƒ±:', {
          message: error.message,
          stack: error.stack,
          belirliHaftaNo: belirliHaftaNo,
          seciliHasta: seciliHasta ? seciliHasta.isim : 'null'
        });
        return null;
      }
    }

    // Lenf Drenaj Masajƒ± Takvimi PDF Olu≈üturucu
    function generateLenfDrenajTakvimi() {
      console.log('üè• Lenf Drenaj Masajƒ± Takvimi PDF olu≈üturuluyor...');
      
      if (!seciliHasta) {
        alert('L√ºtfen √∂nce bir hasta se√ßin!');
        return;
      }
      
      const haftalar = getHaftaListesi();
      if (haftalar.length < 5) {
        alert('En az 5 hafta kaydƒ± olmalƒ±! Mevcut hafta sayƒ±sƒ±: ' + haftalar.length);
        return;
      }
      
      // 5. haftanƒ±n ba≈ülangƒ±√ß tarihini al
      const besinciHafta = haftalar[4]; // 5. hafta (index 4)
      if (!besinciHafta || !besinciHafta.baslangic) {
        alert('5. hafta ba≈ülangƒ±√ß tarihi bulunamadƒ±!');
        return;
      }
      
      const baslangicTarihi = new Date(besinciHafta.baslangic);
      
      // 5. hafta ba≈ülangƒ±√ß tarihinin pazartesi olmasƒ±nƒ± garanti altƒ±na al
      const haftaGunu = baslangicTarihi.getDay(); // 0=Pazar, 1=Pazartesi, ... 6=Cumartesi
      if (haftaGunu !== 1) { // Eƒüer pazartesi deƒüilse
        const gunFarki = haftaGunu === 0 ? 1 : (1 - haftaGunu); // Pazartesiye kadar olan g√ºn farkƒ±
        baslangicTarihi.setDate(baslangicTarihi.getDate() + gunFarki);
      }
      
      try {
        const doc = new jsPDFLib('p', 'mm', 'a4'); // Portrait format
        
        // T√ºrk√ße karakter desteƒüi i√ßin font encoding ayarla
        doc.setFont('helvetica');
        doc.setLanguage('tr-TR');
        
        // Ba≈ülƒ±k
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        const hastaAdi = turkceKarakterDuzelt(seciliHasta.isim);
        console.log('üéØ PDF i√ßin hasta adƒ± d√ºzeltmesi:', seciliHasta.isim, ' ‚Üí ', hastaAdi);
        
        // Manuel ASCII d√∂n√º≈üt√ºrme - Kesin √áalƒ±≈üan Versiyon
        const asciiHastaAdi = hastaAdi
          .replace(/≈û/g, 'S').replace(/≈ü/g, 's')
          .replace(/ƒû/g, 'G').replace(/ƒü/g, 'g')  
          .replace(/ƒ∞/g, 'I').replace(/ƒ±/g, 'i')
          .replace(/√á/g, 'C').replace(/√ß/g, 'c')
          .replace(/√ñ/g, 'O').replace(/√∂/g, 'o')
          .replace(/√ú/g, 'U').replace(/√º/g, 'u');
        
        console.log('üîç FINAL ASCII:', hastaAdi, ' ‚Üí ', asciiHastaAdi);
        doc.text(asciiHastaAdi.toUpperCase(), 20, 20);
        
        // Debug: Hem orijinal hem ASCII versiyonu deneyelim
        console.log('üîç Debug - orijinal isim:', hastaAdi);
        const pdfUygunHastaAdi = window.fixTurkishChars(hastaAdi);
        console.log('  Debug - ASCII isim:', pdfUygunHastaAdi);
        
        // ƒ∞ki versiyon da deneyelim
        try {
          // √ñnce ASCII versiyonu dene
          doc.text(pdfUygunHastaAdi.toUpperCase(), 20, 20);
          console.log('‚úÖ ASCII versiyon kullanƒ±ldƒ±');
        } catch (e) {
          // ASCII ba≈üarƒ±sƒ±z olursa orijinali dene
          doc.text(hastaAdi.toUpperCase(), 20, 20);
          console.log('‚ö†Ô∏è Orijinal versiyon kullanƒ±ldƒ±');
        }
        
        doc.setFontSize(14);
        doc.text(window.fixTurkishChars('LENF DRENAJ MASAJI TAKVIMI'), 20, 35);
        
        // A√ßƒ±klama
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('5. hafta ba≈ülangƒ±cƒ±ndan itibaren 8 haftalƒ±k program', 20, 50);
        
        // Tablo parametreleri
        const startX = 20;
        const startY = 65;
        const rowHeight = 12;
        const colWidths = [15, 50, 50, 50]; // Hafta, Tarih, Sabah, Ak≈üam
        const tableWidth = colWidths.reduce((a, b) => a + b, 0);
        
        // Tablo ba≈ülƒ±klarƒ±
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        
        // Ba≈ülƒ±k satƒ±rƒ± arka planƒ±
        doc.setFillColor(230, 230, 230);
        doc.rect(startX, startY, tableWidth, rowHeight, 'F');
        
        // Ba≈ülƒ±k metinleri
        doc.setTextColor(0, 0, 0);
        doc.text('Hafta', startX + 5, startY + 8);
        doc.text('Tarih Aralƒ±ƒüƒ±', startX + colWidths[0] + 5, startY + 8);
        doc.text('Sabah', startX + colWidths[0] + colWidths[1] + 5, startY + 8);
        doc.text('Ak≈üam', startX + colWidths[0] + colWidths[1] + colWidths[2] + 5, startY + 8);
        
        // Tablo √ßer√ßevesi
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.3);
        doc.rect(startX, startY, tableWidth, rowHeight);
        
        // S√ºtun ayƒ±rƒ±cƒ±larƒ± (ba≈ülƒ±k satƒ±rƒ± i√ßin)
        let currentX = startX;
        for (let i = 0; i < colWidths.length - 1; i++) {
          currentX += colWidths[i];
          doc.line(currentX, startY, currentX, startY + rowHeight);
        }
        
        // 8 haftalƒ±k veri satƒ±rlarƒ±
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        
        for (let hafta = 1; hafta <= 8; hafta++) {
          const currentY = startY + (hafta * rowHeight);
          
          // Hafta ba≈ülangƒ±√ß tarihini hesapla
          const haftaBaslangic = new Date(baslangicTarihi);
          haftaBaslangic.setDate(haftaBaslangic.getDate() + ((hafta - 1) * 7));
          
          const haftaSonu = new Date(haftaBaslangic);
          haftaSonu.setDate(haftaSonu.getDate() + 6);
          
          // Tarih formatƒ±
          const baslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const bitisStr = haftaSonu.toLocaleDateString('tr-TR');
          const tarihAraligi = `${baslangicStr} - ${bitisStr}`;
          
          // Lenf drenaj programƒ±na g√∂re metin
          let sabahMetin = '';
          let aksamMetin = '';
          
          if (hafta === 1) {
            // 1. hafta: G√ºnde 2 kez (sabah + ak≈üam)
            sabahMetin = '‚úì Uygulanacak';
            aksamMetin = '‚úì Uygulanacak';
          } else if (hafta === 2 || hafta === 3) {
            // 2-3. hafta: Sadece sabahlarƒ±
            sabahMetin = '‚úì Uygulanacak';
            aksamMetin = '-';
          } else if (hafta === 4 || hafta === 5) {
            // 4-5. hafta: G√ºna≈üƒ±rƒ± sabahlarƒ±
            sabahMetin = '‚úì G√ºna≈üƒ±rƒ±';
            aksamMetin = '-';
          } else if (hafta === 6 || hafta === 7 || hafta === 8) {
            // 6-7-8. hafta: Haftada 2 g√ºn (Salƒ±-Cuma)
            sabahMetin = '‚úì Salƒ±-Cuma';
            aksamMetin = '-';
          }
          
          // Satƒ±r arka planƒ± (her iki satƒ±rda bir)
          if (hafta % 2 === 0) {
            doc.setFillColor(248, 248, 248);
            doc.rect(startX, currentY, tableWidth, rowHeight, 'F');
          }
          
          // Satƒ±r √ßer√ßevesi
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          doc.rect(startX, currentY, tableWidth, rowHeight);
          
          // S√ºtun ayƒ±rƒ±cƒ±larƒ±
          currentX = startX;
          for (let i = 0; i < colWidths.length - 1; i++) {
            currentX += colWidths[i];
            doc.line(currentX, currentY, currentX, currentY + rowHeight);
          }
          
          // Metinleri ekle
          doc.setTextColor(0, 0, 0);
          doc.text(`${hafta}. Hafta`, startX + 3, currentY + 8);
          doc.text(tarihAraligi, startX + colWidths[0] + 3, currentY + 8);
          doc.text(sabahMetin, startX + colWidths[0] + colWidths[1] + 3, currentY + 8);
          doc.text(aksamMetin, startX + colWidths[0] + colWidths[1] + colWidths[2] + 3, currentY + 8);
        }
        
        // Alt a√ßƒ±klama
        const aciklamaY = startY + (9 * rowHeight) + 10;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.text('UYGULAMA TALƒ∞MATI:', startX, aciklamaY);
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.text('‚Ä¢ 1. hafta: G√ºnde 2 kez (sabah + ak≈üam) uygulanacak', startX, aciklamaY + 12);
        doc.text('‚Ä¢ 2-3. hafta: Sadece sabahlarƒ± uygulanacak', startX, aciklamaY + 22);
        doc.text('‚Ä¢ 4-5. hafta: G√ºna≈üƒ±rƒ± sabahlarƒ± uygulanacak', startX, aciklamaY + 32);
        doc.text('‚Ä¢ 6-7-8. hafta: Haftada 2 g√ºn (Salƒ±-Cuma) sabahlarƒ± uygulanacak', startX, aciklamaY + 42);
        
        // PDF'yi kaydet
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${hastaAdi}_Lenf_Drenaj_Takvimi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('‚úÖ Lenf Drenaj Takvimi PDF olu≈üturuldu:', dosyaAdi);
        alert(`‚úÖ Lenf Drenaj Masajƒ± Takvimi PDF olu≈üturuldu!\n\nDosya: ${dosyaAdi}`);
        
      } catch (error) {
        console.error('‚ùå Lenf Drenaj Takvimi PDF hatasƒ±:', error);
        alert('PDF olu≈ütururken hata olu≈ütu: ' + error.message);
      }
    }

    // √ñzelle≈ütirilebilir Lenf Masaj Takvimi
    async function generateCustomLenfMasajTakvimi() {
      try {
        // Default deƒüerleri hazƒ±rla
        let defaultHastaAdi = '';
        let defaultBaslangicTarihi = '';
        
        // Mevcut se√ßili hasta varsa al
        if (seciliHasta) {
          defaultHastaAdi = seciliHasta.isim || '';
        }
        
        // 5. hafta ba≈ülangƒ±√ß tarihini bulmaya √ßalƒ±≈ü
        try {
          const haftalar = getHaftaListesi();
          if (haftalar.length >= 5 && haftalar[4].baslangic) {
            const besinciHaftaTarihi = new Date(haftalar[4].baslangic);
            // Pazartesi kontrol√º
            const gunNo = besinciHaftaTarihi.getDay();
            if (gunNo !== 1) {
              const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
              besinciHaftaTarihi.setDate(besinciHaftaTarihi.getDate() + gunFarki);
            }
            defaultBaslangicTarihi = besinciHaftaTarihi.toISOString().slice(0, 10);
          } else {
            // Bug√ºnden itibaren bir sonraki pazartesi
            const bugun = new Date();
            const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
            defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
          }
        } catch (e) {
          // Hata durumunda bir sonraki pazartesi
          const bugun = new Date();
          const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
          defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
        }
        
        // Kullanƒ±cƒ±dan bilgileri al
        const hastaAdi = prompt('Hasta Adƒ±:', defaultHastaAdi);
        if (!hastaAdi) {
          alert('Hasta adƒ± girilmedi, i≈ülem iptal edildi.');
          return;
        }
        
        const baslangicTarihi = prompt('Ba≈ülangƒ±√ß Tarihi (YYYY-MM-DD):', defaultBaslangicTarihi);
        if (!baslangicTarihi) {
          alert('Ba≈ülangƒ±√ß tarihi girilmedi, i≈ülem iptal edildi.');
          return;
        }
        
        // Tarih kontrol√º
        const tarihObj = new Date(baslangicTarihi);
        if (isNaN(tarihObj.getTime())) {
          alert('Ge√ßersiz tarih formatƒ±! YYYY-MM-DD formatƒ±nda giriniz.');
          return;
        }
        
        // Pazartesi kontrol√º
        const gunNo = tarihObj.getDay();
        if (gunNo !== 1) {
          const gunIsimleri = ['Pazar', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi'];
          const mevcutGun = gunIsimleri[gunNo];
          if (!confirm(`Se√ßilen tarih ${mevcutGun} g√ºn√º. Lenf masaj programƒ± pazartesi g√ºnleri ba≈ülar.\n\nEn yakƒ±n pazartesi g√ºn√ºne otomatik ayarlansƒ±n mƒ±?`)) {
            return;
          }
          
          // En yakƒ±n pazartesiye ayarla
          const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
          tarihObj.setDate(tarihObj.getDate() + gunFarki);
        }
        
        // √ñzel lenf masaj PDF'i olu≈ütur (5. hafta benzeri)
        await generateCustomLenfMasajPDF(hastaAdi, tarihObj);
        
      } catch (error) {
        console.error('‚ùå √ñzel Lenf Masaj Takvimi hatasƒ±:', error);
        alert('PDF olu≈ütururken hata olu≈ütu: ' + error.message);
      }
    }

    // √ñzelle≈ütirilebilir Egzersiz Takvimi 
    async function generateCustomEgzersizTakvimi() {
      try {
        // Default deƒüerleri hazƒ±rla
        let defaultHastaAdi = '';
        let defaultBaslangicTarihi = '';
        
        // Mevcut se√ßili hasta varsa al
        if (seciliHasta) {
          defaultHastaAdi = seciliHasta.isim || '';
        }
        
        // 9. hafta ba≈ülangƒ±√ß tarihini bulmaya √ßalƒ±≈ü (5. haftadan 4 hafta sonra)
        try {
          const haftalar = getHaftaListesi();
          if (haftalar.length >= 5 && haftalar[4].baslangic) {
            const besinciHaftaTarihi = new Date(haftalar[4].baslangic);
            // Pazartesi kontrol√º
            const gunNo = besinciHaftaTarihi.getDay();
            if (gunNo !== 1) {
              const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
              besinciHaftaTarihi.setDate(besinciHaftaTarihi.getDate() + gunFarki);
            }
            // 9. hafta = 5. haftadan 4 hafta (28 g√ºn) sonra
            const dokuzuncuHaftaTarihi = new Date(besinciHaftaTarihi.getTime() + (4 * 7 * 24 * 60 * 60 * 1000));
            defaultBaslangicTarihi = dokuzuncuHaftaTarihi.toISOString().slice(0, 10);
          } else {
            // Bug√ºnden itibaren bir sonraki pazartesi
            const bugun = new Date();
            const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
            defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
          }
        } catch (e) {
          // Hata durumunda bir sonraki pazartesi
          const bugun = new Date();
          const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
          defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
        }
        
        // Kullanƒ±cƒ±dan bilgileri al
        const hastaAdi = prompt('Hasta Adƒ±:', defaultHastaAdi);
        if (!hastaAdi) {
          alert('Hasta adƒ± girilmedi, i≈ülem iptal edildi.');
          return;
        }
        
        const baslangicTarihi = prompt('Ba≈ülangƒ±√ß Tarihi (YYYY-MM-DD):', defaultBaslangicTarihi);
        if (!baslangicTarihi) {
          alert('Ba≈ülangƒ±√ß tarihi girilmedi, i≈ülem iptal edildi.');
          return;
        }
        
        // Tarih kontrol√º
        const tarihObj = new Date(baslangicTarihi);
        if (isNaN(tarihObj.getTime())) {
          alert('Ge√ßersiz tarih formatƒ±! YYYY-MM-DD formatƒ±nda giriniz.');
          return;
        }
        
        // Pazartesi kontrol√º
        const gunNo = tarihObj.getDay();
        if (gunNo !== 1) {
          const gunIsimleri = ['Pazar', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi'];
          const mevcutGun = gunIsimleri[gunNo];
          if (!confirm(`Se√ßilen tarih ${mevcutGun} g√ºn√º. Egzersiz programƒ± pazartesi g√ºnleri ba≈ülar.\n\nEn yakƒ±n pazartesi g√ºn√ºne otomatik ayarlansƒ±n mƒ±?`)) {
            return;
          }
          
          // En yakƒ±n pazartesiye ayarla
          const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
          tarihObj.setDate(tarihObj.getDate() + gunFarki);
        }
        
        // √ñzel egzersiz + lenf masaj PDF'i olu≈ütur (9. hafta benzeri)
        await generateCustomEgzersizPDF(hastaAdi, tarihObj);
        
      } catch (error) {
        console.error('‚ùå √ñzel Egzersiz Takvimi hatasƒ±:', error);
        alert('PDF olu≈ütururken hata olu≈ütu: ' + error.message);
      }
    }

    function gosterTariflerHafta(i) {
      const hafta = getHaftaListesi()[i];
      const ul = document.getElementById('haftaTarifListesi_' + i);
      if (!ul) return;
      ul.innerHTML = '';
      (hafta.tarifler||[]).forEach(t => {
        const li = document.createElement('li');
        li.textContent = t;
        ul.appendChild(li);
      });
    }

    function tarifKartYukleHafta(i, input) {
      const hafta = getHaftaListesi()[i];
      hafta.tarifKartlar = [];
      const gorselDiv = document.getElementById('haftaKartGorsel_' + i);
      gorselDiv.innerHTML = '';
      Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function (e) {
          hafta.tarifKartlar.push({ name: file.name, data: e.target.result });
          const img = document.createElement('img');
          img.src = e.target.result;
          img.alt = file.name;
          img.style.width = '100px';
          img.style.margin = '4px';
          gorselDiv.appendChild(img);
          saveToStorage();
          
          console.log('‚úÖ Tarif kartƒ± eklendi:', file.name, 'hafta:', i + 1);
          
          // Otomatik GitHub kaydetme kaldƒ±rƒ±ldƒ± (√ßakƒ±≈ümalarƒ± √∂nlemek i√ßin)
          // Manuel kaydetme i√ßin GitHub'a Kaydet butonunu kullanƒ±n
        };
        reader.readAsDataURL(file);
      });
    }

    function gosterKartlarHafta(i) {
      const hafta = getHaftaListesi()[i];
      const gorselDiv = document.getElementById('haftaKartGorsel_' + i);
      if (!gorselDiv) return;
      gorselDiv.innerHTML = '';
      (hafta.tarifKartlar||[]).forEach(kart => {
        const img = document.createElement('img');
        // G√ºvenli src atama - undefined hatasƒ± √∂nleme
        img.src = kart.data || kart.kartData || `https://mustafasacar35.github.io/nutrition-planner/tarifler/${kart.kartResmi || 'default.jpg'}`;
        img.alt = kart.name || kart.tarifAdi || 'Tarif kartƒ±';
        img.style.width = '100px';
        img.style.margin = '4px';
        gorselDiv.appendChild(img);
      });
    }

    async function otomatikEsleHafta(i) {
  // Tarif satƒ±rƒ±ndan alternatifli yemek adlarƒ±nƒ± ayƒ±kla
  function extractYemekAdlari(satir) {
    // Ba≈ütaki * ve miktarlarƒ± temizle
    let s = satir.replace(/^\*+\s*/, '');
    // Parantez i√ßini, + ile eklenenleri, miktarlarƒ± temizle
    s = s.replace(/\(.*?\)/g, '');
    s = s.replace(/\+.*$/, '');
    s = s.replace(/([0-9]+\s*(gram|gr|adet|yemek\s*ka≈üƒ±ƒüƒ±|tatlƒ±\s*ka≈üƒ±ƒüƒ±|su\s*bardaƒüƒ±|dilim|kase|√ßay\s*bardaƒüƒ±|bardak|ka≈üƒ±k|tbsp|tsp|ml|kg|g))($|\s)/gi, '');
    s = s.replace(/(istenilen baharatlarla|istenirse|isteƒüe baƒülƒ±|arzuya g√∂re|isteƒüe g√∂re|isteƒüe baƒülƒ± olarak|isteƒüe g√∂re baharat|isteƒüe g√∂re malzeme|isteƒüe g√∂re eklenebilir)/gi, '');
    
    // √ñnce "ya da", "veya" ile ayrƒ±lmƒ±≈ü alternatifleri ayƒ±r
    let alternatifler = s.split(/\s*(ya da|veya)\s*/i).map(a => a.trim()).filter(a => a.length > 0);
    let tumAdlar = [];
    
    // Her alternatif i√ßin ayrƒ± i≈ülem yap
    alternatifler.forEach(alt => {
      // "ile", "i√ßin", "ve" kelimelerini temizle
      alt = alt.replace(/\b(ile|i√ßin|ve)\b/gi, '');
      // "/" ve "," ile ayrƒ±lmƒ±≈ü alt se√ßenekleri de ayƒ±r - YENƒ∞: / i≈üaretini de dahil et
      let adlar = alt.split(/\s*[\/|,]\s*/).map(a => a.trim()).filter(a => a.length > 0);
      // Sadece ana yemek adƒ±nƒ± ayƒ±kla: ba≈ütaki ve sondaki bo≈üluklarƒ±, miktarlarƒ±, "i√ßin" ve fazlalƒ±klarƒ± sil
      adlar = adlar.map(a => a.replace(/^[0-9]+\s*/, '').replace(/\s*[0-9]+\s*(gram|gr|adet|dilim|kase|bardak|ml|kg|tsp|tbsp)?\s*$/i, '').replace(/\s*icin?$/i, '').replace(/\s*ile$/i, '').trim());
      // √áok kƒ±sa olanlarƒ± atma - sadece bo≈ü olanlarƒ± at
      adlar = adlar.filter(a => a.length > 0);
      tumAdlar = tumAdlar.concat(adlar);
    });
    
    return tumAdlar;
  }

  // Manuel e≈üle≈ütirme kontrol√º
  function manuelEslestirmeKontrol(tarifSatir) {
    // Normalize fonksiyonu burada da tanƒ±mla
    function normalizeLocal(str) {
      return str
        .toLowerCase()
        .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
        .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i')
        .replace(/iÃá/g, 'i')
        .replace(/[_*\/()]/g, ' ')  // Sembolleri bo≈ülukla deƒüi≈ütir
        .replace(/\s+/g, ' ')       // √áoklu bo≈üluklarƒ± tek bo≈üluƒüa √ßevir
        .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve bo≈üluk bƒ±rak
        .trim();
    }
    
    const normalizeEdilmis = normalizeLocal(tarifSatir);
    
    if (manuelEslestirmeler[normalizeEdilmis]) {
      const eslestirme = manuelEslestirmeler[normalizeEdilmis];
      return eslestirme.kartlar.map(kartAdi => {
        const kart = tumKartlar.find(k => k.name === kartAdi);
        return kart || null;
      }).filter(k => k !== null);
    }
    
    return null;
  }

  // E≈üle≈üme yasaƒüƒ± kontrol√º
  function eslesmemeKontrolu(tarifSatir, kartAdi) {
    // Normalize fonksiyonu
    function normalizeLocal(str) {
      return str
        .toLowerCase()
        .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
        .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i')
        .replace(/iÃá/g, 'i')
        .replace(/[_*\/()]/g, ' ')
        .replace(/\s+/g, ' ')
        .replace(/[^a-z0-9\s]/g, '')
        .trim();
    }
    
    const normalizeEdilmis = normalizeLocal(tarifSatir);
    
    if (eslesmemeKurallari[normalizeEdilmis]) {
      const yasak = eslesmemeKurallari[normalizeEdilmis];
      return yasak.yasakliKartlar.includes(kartAdi);
    }
    
    return false; // Yasak yok, e≈üle≈üebilir
  }
  // Dosya adƒ±ndaki miktar ve a√ßƒ±klama kelimelerini temizle
  function temizleDosyaAdi(ad) {
    if (!ad || typeof ad !== 'string') return ''; // G√ºvenlik kontrol√º
    let s = ad.replace(/\.(jpg|jpeg|png)$/i, '');
    s = s.replace(/_\d+(gr|gram|adet|dilim|kase|bardak|ml|kg|tsp|tbsp)?/gi, '');
    s = s.replace(/\(.*?\)/g, '');
    s = s.replace(/_?(istenilen_baharatlarla|istenirse|istege_bagli|arzuya_gore|istege_gore|istege_bagli_olarak|istege_gore_baharat|istege_gore_malzeme|istege_gore_eklenebilir)/gi, '');
    s = s.replace(/_+/g, '_');
    s = s.replace(/\s+/g, '_');
    s = s.replace(/\+.*$/, '');
    return s.trim();
  }
   // Normalize fonksiyonu - sembolleri ve T√ºrk√ße karakterleri temizle
  function normalize(str) {
    return str
      .toLowerCase()
      .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
      .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i')
      .replace(/iÃá/g, 'i')
      .replace(/[_*\/()]/g, ' ')  // Sembolleri bo≈ülukla deƒüi≈ütir
      .replace(/\s+/g, ' ')       // √áoklu bo≈üluklarƒ± tek bo≈üluƒüa √ßevir
      .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve bo≈üluk bƒ±rak
      .trim();
  }

  // Tarif kartƒ±ndaki T√úM kelimelerin PDF yemeƒüinde ardƒ±≈üƒ±k olarak bulunup bulunmadƒ±ƒüƒ±nƒ± kontrol et
  function kartKelimeleriniKontrolEt(kartKelimeler, tarifKelimeler) {
    if (kartKelimeler.length === 0) return false;
    
    // Kart kelimelerini birle≈ütir (ardƒ±≈üƒ±k arama i√ßin)
    const kartMetni = kartKelimeler.join(' ');
    const tarifMetni = tarifKelimeler.join(' ');
    
    // Kart metninin tarif metninde ardƒ±≈üƒ±k olarak bulunup bulunmadƒ±ƒüƒ±nƒ± kontrol et
    return tarifMetni.includes(kartMetni);
  }
 // Eƒüer g√∂rseller hen√ºz y√ºklenmediyse, √∂nce y√ºkle
  if (tariflerKlasoruGorselleri.length === 0) {
    await tariflerKlasoruGorselleriniYukle();
  }

  const hafta = getHaftaListesi()[i];
  const eslesenDiv = document.getElementById('eslesenKartlar_' + i);
  
  // DOM element kontrol√º - √ßoklu PDF i≈üleminde element olmayabilir
  const domElementMevcut = eslesenDiv !== null;
  if (domElementMevcut) {
    eslesenDiv.innerHTML = '';
  }

  if (!hafta.tarifler.length) {
    if (domElementMevcut) {
      eslesenDiv.innerHTML = '<i>√ñnce PDF y√ºkleyin ve tarifleri √ßƒ±karƒ±n.</i>';
    }
    return [];
  }

  // Hem manuel y√ºklenen hem tarifler klas√∂r√º g√∂rsellerini birle≈ütir
  const tumKartlar = [].concat(
    hafta.tarifKartlar || [],
    tariflerKlasoruGorselleri.map(g => ({ name: g.name, data: g.url, url: g.url }))
  ).filter(kart => kart && kart.name); // Null/undefined kartlarƒ± filtrele

  if (!tumKartlar.length) {
    // Daha detaylƒ± hata mesajƒ± ve √ß√∂z√ºm √∂nerileri
    const hataDiv = document.createElement('div');
    hataDiv.style.padding = '15px';
    hataDiv.style.border = '2px solid #dc3545';
    hataDiv.style.borderRadius = '8px';
    hataDiv.style.backgroundColor = '#f8d7da';
    hataDiv.style.color = '#721c24';
    hataDiv.innerHTML = `
      <h4 style="margin-top:0; color:#721c24;">‚ùå Tarif kartlarƒ± bulunamadƒ±</h4>
      <p><strong>Sebep:</strong> Bu hafta i√ßin e≈üle≈üme yapƒ±labilecek hi√ßbir tarif kartƒ± bulunamadƒ±.</p>
      <div style="margin-top:15px;">
        <p><strong>√á√∂z√ºm se√ßenekleri:</strong></p>
        <ol style="margin-left:20px;">
          <li><strong>Manuel g√∂rsel y√ºkle:</strong> Bu hafta i√ßin "Tarif Kartlarƒ±" b√∂l√ºm√ºnden g√∂rsel dosyalarƒ± y√ºkleyin</li>
          <li><strong>Tarifler klas√∂r√º olu≈ütur:</strong> Web sitenizin ana dizininde "tarifler/" klas√∂r√º olu≈üturun ve i√ßine g√∂rsel dosyalarƒ±nƒ± ekleyin</li>
          <li><strong>list.json dosyasƒ±:</strong> "tarifler/" klas√∂r√ºnde dosya listesini i√ßeren "list.json" dosyasƒ± olu≈üturun</li>
        </ol>
      </div>
      <div style="margin-top:15px; padding:10px; background:#fff3cd; border:1px solid #ffeaa7; border-radius:5px;">
        <strong>üí° ƒ∞pucu:</strong> Tarifler klas√∂r√º durumu: 
        <span style="color:${tariflerKlasoruGorselleri.length > 0 ? 'green' : 'red'};">
          ${tariflerKlasoruGorselleri.length} g√∂rsel bulundu
        </span>
        <br>
        Manuel y√ºklenen kartlar: 
        <span style="color:${(hafta.tarifKartlar && hafta.tarifKartlar.length > 0) ? 'green' : 'red'};">
          ${(hafta.tarifKartlar && hafta.tarifKartlar.length) || 0} adet
        </span>
      </div>
      <div style="margin-top:15px; text-align:center;">
        <button onclick="yeniBirDenemeEt(${i})" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-right:10px;">
          üîÑ Tarifler Klas√∂r√ºn√º Yeniden Y√ºkle
        </button>
        <button onclick="debugTariflerKlasoru()" style="background:#17a2b8; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
          üîç Detaylƒ± Debug
        </button>
      </div>
    `;
    if (domElementMevcut) {
      eslesenDiv.appendChild(hataDiv);
    }
    return [];
  }

  // Normalize fonksiyonu - sembolleri ve T√ºrk√ße karakterleri temizle
  function normalize(str) {
    return str
      .toLowerCase()
      .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
      .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i')
      .replace(/iÃá/g, 'i')
      .replace(/[_*\/()]/g, ' ')  // Sembolleri bo≈ülukla deƒüi≈ütir
      .replace(/\s+/g, ' ')       // √áoklu bo≈üluklarƒ± tek bo≈üluƒüa √ßevir
      .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve bo≈üluk bƒ±rak
      .trim();
  }

  // Basit Levenshtein mesafesi (benzerlik i√ßin)
  function levenshtein(a, b) {
    const matrix = Array(a.length + 1).fill(null).map(() => Array(b.length + 1).fill(null));
    for (let i = 0; i <= a.length; i++) matrix[i][0] = i;
    for (let j = 0; j <= b.length; j++) matrix[0][j] = j;
    for (let i = 1; i <= a.length; i++) {
      for (let j = 1; j <= b.length; j++) {
        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
        matrix[i][j] = Math.min(
          matrix[i - 1][j] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j - 1] + cost
        );
      }
    }
    return matrix[a.length][b.length];
  }

  const kullanilanKartlar = new Set();
  let eslesenKartlarListesi = [];
  let eslesmeyenTarifler = [];
  let eslesmeyenOneriler = [];

  // Her tarif i√ßin e≈üle≈ütirme yap
  hafta.tarifler.forEach(tarif => {
    let tarifSatir = tarif.replace(/^\*+\s*/, '').trim();
    let eslesen = null;
    let eslesenKartlar = [];
    let eslesenTip = '';

    // Debug: mantarlƒ± tavuk sote i√ßin √∂zel √ßƒ±ktƒ±
    if (tarifSatir.toLowerCase().includes('mantarlƒ± tavuk sote') || tarifSatir.toLowerCase().includes('mantarli tavuk sote')) {
      console.log('DEBUG - Mantarlƒ± tavuk sote analizi:');
      console.log('Orijinal tarif:', tarifSatir);
      console.log('DEBUG - Toplam kart sayƒ±sƒ±:', tumKartlar.length);
      console.log('DEBUG - mantarli_tavuk_sote.jpg var mƒ±?', tumKartlar.some(k => k.name === 'mantarli_tavuk_sote.jpg'));
    }

    // 1. √ñnce manuel e≈üle≈ütirme kontrol et
    const manuelEslesenler = manuelEslestirmeKontrol(tarif);
    if (manuelEslesenler && manuelEslesenler.length > 0) {
      // Manuel e≈üle≈ütirme bulundu
      const kullanilamayacaklar = manuelEslesenler.filter(kart => kullanilanKartlar.has(kart.name));
      const kullanilabilirler = manuelEslesenler.filter(kart => !kullanilanKartlar.has(kart.name));
      
      if (kullanilabilirler.length > 0) {
        eslesenKartlar = kullanilabilirler;
        eslesenTip = 'manuel e≈üle≈ütirme';
        kullanilabilirler.forEach(kart => kullanilanKartlar.add(kart.name));
      }
    } else {
      // 2. Otomatik e≈üle≈ütirme dene
      let yemekAdlari = extractYemekAdlari(tarifSatir);

      // Her yemek adƒ± i√ßin e≈üle≈ütirme dene
      for (let yemekAdi of yemekAdlari) {
        const tarifNorm = normalize(yemekAdi);
        const tarifKelimeler = tarifNorm.split(' ').filter(k => k.length > 0);

        // Kullanƒ±lmayan kartlar arasƒ±nda ara
        for (let kart of tumKartlar) {
          if (kullanilanKartlar.has(kart.name)) continue;

          // E≈üle≈üme yasaƒüƒ± kontrol√º - √ñNCE BU KONTROL EDƒ∞Lƒ∞R
          if (eslesmemeKontrolu(tarif, kart.name)) {
            continue; // Bu kart yasaklƒ±, sonrakine ge√ß
          }

          const kartNorm = normalize(temizleDosyaAdi(kart.name));
          const kartKelimeler = kartNorm.split(' ').filter(k => k.length > 0);

          // 1. √ñnce tam e≈üle≈üme kontrol et
          if (tarifNorm === kartNorm) {
            eslesen = kart;
            eslesenKartlar = [kart];
            eslesenTip = 'tam e≈üle≈üme';
            break;
          }

          // 2. Kart kelimelerinin tarif i√ßinde ardƒ±≈üƒ±k olarak bulunup bulunmadƒ±ƒüƒ±nƒ± kontrol et
          if (kartKelimeleriniKontrolEt(kartKelimeler, tarifKelimeler)) {
            eslesen = kart;
            eslesenKartlar = [kart];
            eslesenTip = 'ardƒ±≈üƒ±k e≈üle≈üme';
            break;
          }
        }

        // E≈üle≈üme bulunursa bu yemek adƒ± i√ßin dur
        if (eslesen) {
          kullanilanKartlar.add(eslesen.name);
          break;
        }
      }
    }

    // E≈üle≈üme bulunduysa kaydet
    if (eslesenKartlar.length > 0) {
      eslesenKartlar.forEach(kart => {
        eslesenKartlarListesi.push({ 
          tarif: tarif, 
          kart: kart, 
          tip: eslesenTip 
        });
      });
    } else {
      eslesmeyenTarifler.push(tarif);
    }
  });

  // Sonu√ßlarƒ± g√∂ster (sadece DOM element varsa)
  if (domElementMevcut) {
    if (eslesenKartlarListesi.length === 0) {
      eslesenDiv.innerHTML = '<p>E≈üle≈üme bulunamadƒ±.</p>';
    } else {
      // Tarifleri grupla ve g√∂ster
      const tarifGruplari = {};
      eslesenKartlarListesi.forEach(({ tarif, kart, tip }) => {
        if (!tarifGruplari[tarif]) {
          tarifGruplari[tarif] = { kartlar: [], tip: tip };
        }
        tarifGruplari[tarif].kartlar.push(kart);
      });

      Object.keys(tarifGruplari).forEach(tarif => {
        const grup = tarifGruplari[tarif];
        const p = document.createElement('p');
        const kartIsimleri = grup.kartlar.map(k => k.name).join(', ');
        
        // Tarif adƒ±nƒ± tƒ±klanabilir span i√ßine al
        const tarifSpan = document.createElement('span');
        tarifSpan.innerHTML = `<b>${tarif}</b>`;
        tarifSpan.style.cursor = 'pointer';
        tarifSpan.style.textDecoration = 'underline';
        tarifSpan.style.color = '#007bff';
        tarifSpan.title = 'Tƒ±kla ve manuel e≈üle≈ütirme panelini a√ß';
        
        // Tƒ±klama olayƒ± - Manuel e≈üle≈ütirme panelini a√ß ve bilgileri doldur
        tarifSpan.onclick = () => {
          console.log('üîß E≈üle≈üen tarif adƒ±na tƒ±klandƒ±:', tarif, grup.kartlar);
          try {
            if (typeof eslesenTarifManuelEslestir === 'function') {
              eslesenTarifManuelEslestir(tarif, grup.kartlar);
            } else {
              console.error('‚ùå eslesenTarifManuelEslestir fonksiyonu bulunamadƒ±!');
              alert('Manuel e≈üle≈ütirme fonksiyonu y√ºklenemedi. Sayfayƒ± yenileyin.');
            }
          } catch (error) {
            console.error('‚ùå E≈üle≈üen tarif tƒ±klama hatasƒ±:', error);
            alert('Hata: ' + error.message);
          }
        };
        
        // Full p elementi olu≈ütur (innerHTML += kullanmadan)
        p.appendChild(tarifSpan);
        
        const okSpan = document.createElement('span');
        okSpan.innerHTML = ` ‚Üí <span style="color:green;">${kartIsimleri}</span> <small style="color:blue;">(${grup.tip})</small>`;
        p.appendChild(okSpan);
        
        eslesenDiv.appendChild(p);
        
        // Her kart i√ßin g√∂rsel ekle
        grup.kartlar.forEach(kart => {
          const img = document.createElement('img');
          // G√ºvenli src atama - undefined hatasƒ± √∂nleme
          img.src = kart.data || kart.kartData || `https://mustafasacar35.github.io/nutrition-planner/tarifler/${kart.kartResmi || kart.name || 'default.jpg'}`;
          img.alt = tarif;
          img.title = kart.name || kart.tarifAdi || 'Tarif kartƒ±';
          img.style.width = '120px';
          img.style.margin = '4px';
          eslesenDiv.appendChild(img);
        });
      });
      
      // ƒ∞ndir butonlarƒ± ekle
      const indirDiv = document.createElement('div');
      indirDiv.style.marginTop = '15px';
      indirDiv.style.display = 'flex';
      indirDiv.style.gap = '10px';
      indirDiv.style.flexWrap = 'wrap';
      
      // ZIP olarak indir butonu
      const zipBtn = document.createElement('button');
      zipBtn.textContent = 'üì¶ T√ºm Dosyalarƒ± ZIP ƒ∞ndir';
      zipBtn.style.background = '#28a745';
      zipBtn.style.color = 'white';
      zipBtn.style.border = 'none';
      zipBtn.style.padding = '10px 15px';
      zipBtn.style.borderRadius = '5px';
    zipBtn.style.cursor = 'pointer';
    zipBtn.style.marginBottom = '10px';
    zipBtn.title = 'Haftalƒ±k PDF, e≈üle≈üen tarif kartlarƒ± ve GPT mesajƒ±nƒ± tek ZIP dosyasƒ±nda indirir';
    zipBtn.onclick = function() { 
      console.log('üîç ZIP butonuna tƒ±klandƒ±, hafta index:', i);
      zipEslesenGorseller(i); 
    };
    
    // PDF Takip Tablosu olu≈ütur butonu
    const pdfBtn = document.createElement('button');
    pdfBtn.textContent = 'üìÑ Takip Tablosu PDF';
    pdfBtn.style.background = '#dc3545';
    pdfBtn.style.color = 'white';
    pdfBtn.style.border = 'none';
    pdfBtn.style.padding = '10px 15px';
    pdfBtn.style.borderRadius = '5px';
    pdfBtn.style.cursor = 'pointer';
    pdfBtn.onclick = function() { generatePatientPDF(); };
    
    // ZIP + PDF Combo butonu
    const comboBtn = document.createElement('button');
    comboBtn.textContent = 'üéØ Kartlar + PDF Tablosu';
    comboBtn.style.background = '#6f42c1';
    comboBtn.style.color = 'white';
    comboBtn.style.border = 'none';
    comboBtn.style.padding = '10px 15px';
    comboBtn.style.borderRadius = '5px';
    comboBtn.style.cursor = 'pointer';
    comboBtn.onclick = function() { 
      zipEslesenGorseller(i); 
      setTimeout(() => generatePatientPDF(), 1000); 
    };
    
    // Sidebar butonlarƒ± artƒ±k GPT alanƒ±nda olduƒüu i√ßin kaldƒ±rƒ±ldƒ±
  }
  } // domElementMevcut kapanƒ±≈üƒ±

  // E≈üle≈ümeyen tarifleri yeni accordion sistemine ekle (sadece DOM varsa)
  if (domElementMevcut && eslesmeyenTarifler.length > 0) {
    const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
    const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
    
    if (eslesmeyenlerContent && eslesmeyenlerBaslik) {
      // Ba≈ülƒ±ƒüƒ± g√ºncelle
      eslesmeyenlerBaslik.textContent = `üö´ E≈üle≈ümeyen Tarifler (${eslesmeyenTarifler.length})`;
      
      // ƒ∞√ßeriƒüi temizle ve yeniden doldur
      eslesmeyenlerContent.innerHTML = '';
      
      eslesmeyenTarifler.forEach(tarif => {
        const p = document.createElement('p');
        p.textContent = tarif;
        p.style.color = '#dc3545';
        p.style.margin = '6px 0';
        p.style.padding = '4px 8px';
        p.style.background = '#fff5f5';
        p.style.borderLeft = '3px solid #dc3545';
        p.style.borderRadius = '4px';
        p.style.cursor = 'pointer';
        p.style.transition = 'background-color 0.2s';
        p.title = 'Tƒ±kla ve manuel e≈üle≈ütirme yap';
        
        // Hover efekti
        p.onmouseenter = () => p.style.background = '#ffe6e6';
        p.onmouseleave = () => p.style.background = '#fff5f5';
        
        // Tƒ±klama olayƒ± - Manuel e≈üle≈ütirme panelini a√ß ve tarif adƒ±nƒ± doldur
        p.onclick = () => {
          eslesmeyenTarifManuelEslestir(tarif);
        };
        
        eslesmeyenlerContent.appendChild(p);
      });
    }
  } else if (domElementMevcut) {
    // E≈üle≈ümeyen tarif yoksa ba≈ülƒ±ƒüƒ± sƒ±fƒ±rla
    const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
    const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
    
    if (eslesmeyenlerBaslik) {
      eslesmeyenlerBaslik.textContent = 'üö´ E≈üle≈ümeyen Tarifler';
    }
    if (eslesmeyenlerContent) {
      eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">E≈üle≈ümeyen tarif bulunamadƒ±</div>';
    }
  }

  // E≈üle≈üen kartlarƒ± hafta verisine JSON uyumlu formatta kaydet
  hafta.tarifKartlar = eslesenKartlarListesi.map(e => ({
    tarifAdi: e.tarif,
    kartResmi: e.kart.name,
    kartData: e.kart.data || `https://mustafasacar35.github.io/nutrition-planner/tarifler/${e.kart.name}`,
    eslesmeTuru: e.tip
  }));
  
  // E≈üle≈ümeyen tarifleri ayrƒ± array'de sakla (JSON'a da kaydedilsin)
  const eslesenTarifIsimleri = eslesenKartlarListesi.map(e => e.tarif.toLowerCase());
  hafta.eslesmeyenTarifler = eslesmeyenTarifler; // JSON'a kaydet
  
  // Orijinal tarifler listesini koruyalƒ±m ama e≈üle≈üen/e≈üle≈ümeyen diye ayƒ±ralƒ±m
  hafta.eslesenTarifler = hafta.tarifler ? hafta.tarifler.filter(tarif => 
    eslesenTarifIsimleri.includes(tarif.toLowerCase())
  ) : [];
  
  console.log('üìù E≈üle≈ütirme √∂ncesi toplam tarif:', hafta.tarifler ? hafta.tarifler.length : 0);
  console.log('üìù E≈üle≈üen tarif isimleri:', eslesenTarifIsimleri);
  console.log('üìù E≈üle≈üen tarif sayƒ±sƒ±:', hafta.eslesenTarifler.length);
  console.log('üö´ E≈üle≈ümeyen tarifler:', eslesmeyenTarifler.length, 'adet kaydedildi');
  
  // Otomatik kaydetme - hafta verileri deƒüi≈üti
  if (seciliHasta) {
    autoSaveHastaData(seciliHasta);
  } else {
    saveToStorage(); // Fallback
  }
  
  // E≈üle≈ütirme sonu√ßlarƒ±nƒ± d√∂nd√ºr (JSON'a sadece e≈üle≈üenler kaydedilecek)
  const sonuc = {
    eslesenKartlar: hafta.tarifKartlar,
    eslesmeyenTarifler: eslesmeyenTarifler // UI i√ßin d√∂nd√ºr ama JSON'a kaydetme
  };
  
  console.log('‚úÖ otomatikEsleHafta tamamlandƒ±:', {
    haftaIndex: i,
    eslesenKartSayisi: hafta.tarifKartlar ? hafta.tarifKartlar.length : 0,
    eslesmeyenTarifSayisi: eslesmeyenTarifler.length
  });
  
  // E≈üle≈ütirme sonrasƒ± yemek analizini g√ºncelle
  setTimeout(() => {
    updateYemekAnalizi();
  }, 300); // Veriler tamamen g√ºncellenmesi i√ßin kƒ±sa bir gecikme
  
  return sonuc;
}

    function gptMesajKaydet(i) {
      const hafta = getHaftaListesi()[i];
      
      // Kilit kontrol√º
      if (hafta.kilitli) {
        alert('üîí Bu hafta kilitli! GPT mesajƒ±nƒ± deƒüi≈ütirmek i√ßin √∂nce kilidi a√ßƒ±n.');
        return;
      }
      
      hafta.gptMesaj = document.getElementById('gptMesaj_' + i).value;
      saveToStorage();
      
      console.log('‚úÖ GPT mesajƒ± kaydedildi hafta:', i + 1);
      
      // YENƒ∞ Sƒ∞STEM: GitHub'a da kaydet
      if (seciliHasta) {
        hastayiAyriKaydet(seciliHasta).then(basarili => {
          if (basarili) {
            console.log('‚úÖ GPT mesajƒ± GitHub\'a da kaydedildi');
          } else {
            console.warn('‚ö†Ô∏è GPT mesajƒ± localStorage\'a kaydedildi ama GitHub kaydƒ± ba≈üarƒ±sƒ±z');
          }
        }).catch(error => {
          console.error('‚ùå GitHub kaydetme hatasƒ±:', error);
        });
      }
      
      alert('GPT mesajƒ± kaydedildi.');
    }
    // --- JSON dƒ±≈üa aktar/y√ºkle fonksiyonlarƒ± ---
    function exportData() {
      // Kullanƒ±cƒ±ya se√ßenek sun
      const tariflerDahil = confirm('Tarif verilerini de dahil etmek istiyor musunuz?\n\n‚úÖ EVET: Tam veri (daha b√ºy√ºk dosya)\n‚ùå HAYIR: Sadece √∂nemli veriler (k√º√ß√ºk dosya, GitHub ile uyumlu)');
      
      let dataToExport;
      
      if (tariflerDahil) {
        // T√ºm veriler dahil
        dataToExport = hastalar;
        console.log('üì§ Tam veriler (tarifler dahil) JSON olarak hazƒ±rlanƒ±yor...');
      } else {
        // Tarifler olmadan
        dataToExport = hastalar.map(hasta => {
          return {
            ...hasta,
            haftalar: (hasta.haftalar || []).map(hafta => {
              const { tarifler, ...haftaWithoutTarifler } = hafta;
              return haftaWithoutTarifler;
            })
          };
        });
        console.log('üì§ Kompakt veriler (tarifler hari√ß) JSON olarak hazƒ±rlanƒ±yor...');
      }
      
      const dataStr = JSON.stringify(dataToExport, null, 2);
      const blob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = tariflerDahil ? 'hasta_kayitlari_tam.json' : 'hasta_kayitlari.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
      
      console.log('üì§ Hasta verileri JSON olarak indirildi:', tariflerDahil ? '(tam veri)' : '(kompakt veri)');
      console.log('üíæ Data klas√∂r√ºne kaydetmek i√ßin indirilen dosyayƒ± ./data/hasta_kayitlari.json olarak kaydedin');
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            hastalar = data;
            
            // Hasta listesini otomatik sƒ±rala (isim sƒ±rasƒ±)
            hastalar.sort((a, b) => a.isim.localeCompare(b.isim, 'tr'));
            
            saveToStorage();
            renderHastalar();
            alert('Veriler ba≈üarƒ±yla y√ºklendi ve sƒ±ralandƒ±!');
          } else {
            alert('Ge√ßersiz JSON formatƒ±!');
          }
        } catch(err) {
          alert('JSON okuma hatasƒ±: ' + err);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function kopyalaGptMesaj(i) {
      const textarea = document.getElementById('gptMesaj_' + i);
      textarea.select();
      textarea.setSelectionRange(0, 99999); // mobile uyumlu
      document.execCommand('copy');
      alert('GPT mesajƒ± kopyalandƒ±!');
    }
    window.kopyalaGptMesaj = kopyalaGptMesaj;

    // Ortak fonksiyonlar
    
    // T√ºm hasta JSON'larƒ±ndan eslesmeyenTarifler verilerini temizle
    async function temizleEslesmeyenTarifleriJSON() {
      console.log('üßπ T√ºm hasta JSON\'larƒ±ndan eslesmeyenTarifler verileri temizleniyor...');
      
      const hastalar = getHastaListesi();
      let temizlenenSayisi = 0;
      
      for (const hasta of hastalar) {
        let temizlemeYapildi = false;
        
        if (hasta.haftalar) {
          hasta.haftalar.forEach(hafta => {
            if (hafta.eslesmeyenTarifler) {
              delete hafta.eslesmeyenTarifler;
              temizlemeYapildi = true;
            }
          });
        }
        
        if (temizlemeYapildi) {
          await hastayiAyriKaydet(hasta);
          temizlenenSayisi++;
          console.log(`‚úÖ ${hasta.isim} - eslesmeyenTarifler verileri temizlendi`);
        }
      }
      
      console.log(`üéØ Toplam ${temizlenenSayisi} hasta JSON'u temizlendi`);
      
      if (temizlenenSayisi > 0) {
        alert(`‚úÖ ${temizlenenSayisi} hasta JSON dosyasƒ±ndan e≈üle≈ümeyen tarif verileri temizlendi!\n\nArtƒ±k JSON dosyalarƒ± daha k√º√ß√ºk ve hƒ±zlƒ± olacak.`);
      } else {
        alert('‚úÖ T√ºm JSON dosyalarƒ± zaten temiz!');
      }
    }
    
    // Global olarak eri≈üilebilir yap
    window.temizleEslesmeyenTarifleriJSON = temizleEslesmeyenTarifleriJSON;

    function extractTariflerDetay(text) {
      console.log('üîç extractTariflerDetay ba≈ülƒ±yor...');
      console.log('üìÑ Ham metin uzunluƒüu:', text.length);
      
      // Her satƒ±rƒ± temizle, ba≈üƒ±nda * veya miktar varsa da al
      const lines = text.split('\n').map(line => line.trim()).filter(l => l.length > 1);
      console.log('üìù Toplam satƒ±r sayƒ±sƒ± (>1 karakter):', lines.length);
      
      // * ile ba≈ülayan satƒ±rlarƒ± √∂zel olarak logla
      const yildizliSatirlar = lines.filter(l => /^\*/.test(l));
      console.log('‚≠ê * ile ba≈ülayan satƒ±rlar:', yildizliSatirlar);
      
      // Avokado i√ßeren satƒ±rlarƒ± bul
      const avokadoSatirlar = lines.filter(l => l.toLowerCase().includes('avokado'));
      console.log('ü•ë "avokado" i√ßeren satƒ±rlar:', avokadoSatirlar);
      
      // Tavuk i√ßeren satƒ±rlarƒ± bul
      const tavukSatirlar = lines.filter(l => l.toLowerCase().includes('tavuk'));
      console.log('üêî "tavuk" i√ßeren satƒ±rlar:', tavukSatirlar);
      
      // Pirzola i√ßeren satƒ±rlarƒ± bul
      const pirzolaSatirlar = lines.filter(l => l.toLowerCase().includes('pirzola'));
      console.log('ü•© "pirzola" i√ßeren satƒ±rlar:', pirzolaSatirlar);
      
      // Satƒ±r ba≈üƒ±nda rakam, *, miktar, b√ºy√ºk harf, veya yemek adƒ± olabilecek her ≈üeyi al
      const filtered = lines.filter(l =>
        /^[0-9]+\./.test(l) || // 1. ...
        /^\*/.test(l) || // * ...
        /^[0-9]+[\.,]?\s*(gram|gr|adet|yemek\s*ka≈üƒ±ƒüƒ±|tatlƒ±\s*ka≈üƒ±ƒüƒ±|su\s*bardaƒüƒ±|dilim|kase|√ßay\s*bardaƒüƒ±|bardak|ka≈üƒ±k|tbsp|tsp|ml|kg|g)(\s|\.|\,|$)/i.test(l) || // miktar ile ba≈ülayan (nokta, virg√ºl, bo≈üluk veya satƒ±r sonu ile biter)
        /^[A-Zƒ∞ƒû√ú≈û√ñ√á]/.test(l) // b√ºy√ºk harf ile ba≈ülayan
      );
      
      console.log('üîç Filtrelenmi≈ü satƒ±r sayƒ±sƒ±:', filtered.length);
      console.log('üìã Filtrelenmi≈ü satƒ±rlar:', filtered);
      
      // Ba≈ütaki numara, * i≈üareti ve miktar kƒ±smƒ±nƒ± temizle, ama yemek adƒ±nƒ± koru
      const result = filtered.map(line => {
        let temizlenmis = line;
        
        // Ba≈ütaki numara temizle
        temizlenmis = temizlenmis.replace(/^[0-9]+\.\s*/, '');
        
        // Ba≈ütaki yƒ±ldƒ±z temizle
        temizlenmis = temizlenmis.replace(/^\*+\s*/, '');
        
        // Miktar kƒ±smƒ±nƒ± akƒ±llƒ±ca temizle - sadece ba≈üƒ±ndakini al, ortadakini bƒ±rak
        // "150 gr. Tavuk pirzola" ‚Üí "Tavuk pirzola"
        // "150gr K√∂fte" ‚Üí "K√∂fte" 
        // "100 gram Et" ‚Üí "Et"
        // "150 gr." ‚Üí "" (sadece miktar varsa bo≈ü d√∂ner)
        const miktarRegex = /^([0-9]+[\.,]?\s*)(gram|gr|adet|yemek\s*ka≈üƒ±ƒüƒ±|tatlƒ±\s*ka≈üƒ±ƒüƒ±|su\s*bardaƒüƒ±|dilim|kase|√ßay\s*bardaƒüƒ±|bardak|ka≈üƒ±k|tbsp|tsp|ml|kg|g)[\.,]?\s*/i;
        temizlenmis = temizlenmis.replace(miktarRegex, '');
        
        // Fazla bo≈üluklarƒ± temizle
        temizlenmis = temizlenmis.replace(/\s+/g, ' ').trim().toLowerCase();
        
        // Miktar i√ßeren satƒ±rlarƒ± √∂zel logla
        if (line.match(/^[0-9]+\s*(gram|gr|adet|yemek\s*ka≈üƒ±ƒüƒ±|tatlƒ±\s*ka≈üƒ±ƒüƒ±|su\s*bardaƒüƒ±|dilim|kase|√ßay\s*bardaƒüƒ±|bardak|ka≈üƒ±k|tbsp|tsp|ml|kg|g)/i)) {
          console.log(`‚öñÔ∏è MIKTAR SATIRI: "${line}" ‚Üí "${temizlenmis}"`);
        }
        
        // Avokado i√ßeren satƒ±rlarƒ± √∂zel logla
        if (line.toLowerCase().includes('avokado')) {
          console.log(`ü•ë AVOKADO SATIRI: "${line}" ‚Üí "${temizlenmis}"`);
        }
        
        // Tavuk i√ßeren satƒ±rlarƒ± √∂zel logla
        if (line.toLowerCase().includes('tavuk')) {
          console.log(`üêî TAVUK SATIRI: "${line}" ‚Üí "${temizlenmis}"`);
        }
        
        // Pirzola i√ßeren satƒ±rlarƒ± √∂zel logla
        if (line.toLowerCase().includes('pirzola')) {
          console.log(`ü•© PIRZOLA SATIRI: "${line}" ‚Üí "${temizlenmis}"`);
        }
        
        return temizlenmis;
      });
      
      console.log('‚úÖ Final tarif listesi:', result);
      console.log('ü•ë Final listede avokado var mƒ±?', result.filter(r => r.includes('avokado')));
      console.log('üêî Final listede tavuk var mƒ±?', result.filter(r => r.includes('tavuk')));
      console.log('ü•© Final listede pirzola var mƒ±?', result.filter(r => r.includes('pirzola')));
      
      return result;
    }

    function normalizeNameDetay(name) {
      return name
        .toLowerCase()
        .replace(/√ß/g, 'c').replace(/ƒü/g, 'g').replace(/≈ü/g, 's')
        .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/ƒ±/g, 'i')
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
    }

    // Sayfa a√ßƒ±lƒ±≈üƒ±nda storage'dan y√ºkle ve listele
    renderHastalar();

    // √ñzel Lenf Masaj PDF olu≈üturucu (5. hafta ZIP benzeri)
    async function generateCustomLenfMasajPDF(hastaAdi, baslangicTarihi) {
      try {
        console.log('üíÜ √ñzel Lenf Masaj PDF olu≈üturuluyor...', { hastaAdi, baslangicTarihi });
        
        // jsPDF k√ºt√ºphane kontrol√º
        let jsPDFLib;
        if (typeof window.jspdf !== 'undefined') {
          jsPDFLib = window.jspdf.jsPDF;
          console.log('‚úÖ jsPDF window.jspdf.jsPDF √ºzerinden y√ºklendi');
        } else if (typeof jsPDF !== 'undefined') {
          jsPDFLib = jsPDF;
          console.log('‚úÖ jsPDF global jsPDF √ºzerinden y√ºklendi');
        } else {
          console.log('‚ùå jsPDF bulunamadƒ±, dinamik y√ºkleme yapƒ±lƒ±yor...');
          
          // Dinamik jsPDF y√ºkleme
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          script.onload = () => {
            console.log('‚úÖ jsPDF dinamik olarak y√ºklendi');
            setTimeout(() => generateCustomLenfMasajPDF(hastaAdi, baslangicTarihi), 100);
          };
          script.onerror = () => {
            console.log('‚ùå jsPDF y√ºklenemedi');
            alert('PDF k√ºt√ºphanesi y√ºklenemedi. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin.');
          };
          document.head.appendChild(script);
          return; // Fonksiyondan √ßƒ±k, y√ºkleme sonrasƒ± tekrar √ßalƒ±≈üacak
        }
        
        const doc = new jsPDFLib('p', 'mm', 'a4'); // ZIP sistemiyle ayn  format
        
        // Hasta adƒ±nƒ± ASCII'ye √ßevir (ZIP sistemiyle aynƒ±)
        console.log('üîç Orijinal hasta adƒ±:', hastaAdi);
        const asciiHastaAdi = hastaAdi
            .replace(/≈û/g, 'S').replace(/≈ü/g, 's')
            .replace(/ƒû/g, 'G').replace(/ƒü/g, 'g')
            .replace(/√ú/g, 'U').replace(/√º/g, 'u')
            .replace(/ƒ∞/g, 'I').replace(/ƒ±/g, 'i')
            .replace(/√ñ/g, 'O').replace(/√∂/g, 'o')
            .replace(/√á/g, 'C').replace(/√ß/g, 'c')
            .replace(/∆è/g, 'E').replace(/…ô/g, 'e');
        console.log('üîç ASCII hasta adƒ±:', asciiHastaAdi);
        
        // Ba≈ülƒ±k - ZIP sistemindeki gibi
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Lenf masaj ba≈ülƒ±ƒüƒ± - ASCII karakterlerle
        const subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // A√ßƒ±klama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren)'), 20, 40);
        
        // Tab ba≈ülangƒ±√ß tarihi zaten pazartesi olarak planlanmƒ±≈ü, deƒüi≈ütirme
        console.log('üîç Tekli lenf masaj - 5. hafta tab ba≈ülangƒ±√ß tarihi (pazartesi olarak kabul):', baslangicTarihi.toLocaleDateString('tr-TR'));
        
        // Tab tarihi direkt kullan - zaten hafta ba≈üƒ± olarak planlanmƒ±≈ü
        const hizalanmisBaslangic = baslangicTarihi;
        
        // 5. haftanƒ±n ba≈ülangƒ±cƒ±
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalƒ±k lenf masaj programƒ± (ZIP sistemindeki gibi)
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan ba≈ülar
          const haftaBaslangic = new Date(hizalanmisBaslangic.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          // Sayfa sonu kontrol√º - hafta ba≈ülƒ±ƒüƒ± i√ßin yer var mƒ±?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta ba≈ülƒ±ƒüƒ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo ba≈ülƒ±klarƒ± - ZIP sistemindeki gibi
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, G√ºn, Sabah, Ak≈üam
          let zipTableStartX = 15;
          
          // Ba≈ülƒ±k satƒ±rƒ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her g√ºn i√ßin satƒ±r - ZIP sistemindeki gibi
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrol√º - satƒ±r i√ßin yer var mƒ±?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo ba≈ülƒ±klarƒ±nƒ± tekrar olu≈ütur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // Ba≈ülƒ±k satƒ±rƒ±
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Lenf masaj uygulama kontrol√º (ZIP sistemindeki aynƒ± mantƒ±k)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // ƒ∞lk 2 hafta (5-6): G√ºnde 2 kez lenf masajƒ±
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): G√ºnde 1 kez lenf masajƒ± (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): G√ºna≈üƒ±rƒ± lenf masajƒ±
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = '-';
              } else {
                sabahUygulama = '-';
                aksamUygulama = '-';
              }
            } else {
              // Son 2 hafta (11-12): Haftada 2 g√ºn (Salƒ±-Cuma)
              if (gunIndex === 1 || gunIndex === 4) { // Salƒ±, Cuma
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = '-';
              } else {
                sabahUygulama = '-';
                aksamUygulama = '-';
              }
            }
            
            zipTableStartX = 15;
            
            // Tablo √ßizgi ayarlarƒ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            doc.setTextColor(0, 0, 0);
            doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[0];
            
            // G√ºn s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // Ak≈üam s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arasƒ± bo≈üluk
        }
        
        // PDF'yi kaydet
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${asciiHastaAdi}_Lenf_Masaj_Takvimi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('‚úÖ √ñzel Lenf Masaj Takvimi PDF olu≈üturuldu:', dosyaAdi);
        alert(`‚úÖ Lenf Masaj Takvimi PDF olu≈üturuldu!\n\nDosya: ${dosyaAdi}\n\nBa≈ülangƒ±√ß Tarihi: ${baslangicTarihi.toLocaleDateString('tr-TR')}`);
        
      } catch (error) {
        console.error('‚ùå √ñzel Lenf Masaj PDF hatasƒ±:', error);
        throw error;
      }
    }

    // √ñzel Egzersiz + Lenf Masaj PDF olu≈üturucu (9. hafta ZIP benzeri)
    async function generateCustomEgzersizPDF(hastaAdi, baslangicTarihi) {
      try {
        console.log('üèÉ √ñzel Egzersiz + Lenf Masaj PDF olu≈üturuluyor...', { hastaAdi, baslangicTarihi });
        
        // jsPDF k√ºt√ºphane kontrol√º
        let jsPDFLib;
        if (typeof window.jspdf !== 'undefined') {
          jsPDFLib = window.jspdf.jsPDF;
          console.log('‚úÖ jsPDF window.jspdf.jsPDF √ºzerinden y√ºklendi');
        } else if (typeof jsPDF !== 'undefined') {
          jsPDFLib = jsPDF;
          console.log('‚úÖ jsPDF global jsPDF √ºzerinden y√ºklendi');
        } else {
          console.log('‚ùå jsPDF bulunamadƒ±, dinamik y√ºkleme yapƒ±lƒ±yor...');
          
          // Dinamik jsPDF y√ºkleme
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          script.onload = () => {
            console.log('‚úÖ jsPDF dinamik olarak y√ºklendi');
            setTimeout(() => generateCustomEgzersizPDF(hastaAdi, baslangicTarihi), 100);
          };
          script.onerror = () => {
            console.log('‚ùå jsPDF y√ºklenemedi');
            alert('PDF k√ºt√ºphanesi y√ºklenemedi. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin.');
          };
          document.head.appendChild(script);
          return; // Fonksiyondan √ßƒ±k, y√ºkleme sonrasƒ± tekrar √ßalƒ±≈üacak
        }
        
        const doc = new jsPDFLib('p', 'mm', 'a4'); // ZIP sistemiyle ayn  format
        
        // Hasta adƒ±nƒ± ASCII'ye √ßevir (ZIP sistemiyle aynƒ±)
        console.log('üîç Orijinal hasta adƒ±:', hastaAdi);
        const asciiHastaAdi = hastaAdi
            .replace(/≈û/g, 'S').replace(/≈ü/g, 's')
            .replace(/ƒû/g, 'G').replace(/ƒü/g, 'g')
            .replace(/√ú/g, 'U').replace(/√º/g, 'u')
            .replace(/ƒ∞/g, 'I').replace(/ƒ±/g, 'i')
            .replace(/√ñ/g, 'O').replace(/√∂/g, 'o')
            .replace(/√á/g, 'C').replace(/√ß/g, 'c')
            .replace(/∆è/g, 'E').replace(/…ô/g, 'e');
        console.log('üîç ASCII hasta adƒ±:', asciiHastaAdi);
        
        // Ba≈ülƒ±k - ZIP sistemindeki gibi
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Egzersiz + lenf masaj ba≈ülƒ±ƒüƒ± - ASCII karakterlerle
        const subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // A√ßƒ±klama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler'), 20, 40);
        
        // Tab ba≈ülangƒ±√ß tarihi zaten pazartesi olarak planlanmƒ±≈ü, deƒüi≈ütirme
        console.log('üîç Tekli egzersiz - 9. hafta tab ba≈ülangƒ±√ß tarihi (pazartesi olarak kabul):', baslangicTarihi.toLocaleDateString('tr-TR'));
        
        // Tab tarihi direkt kullan - zaten hafta ba≈üƒ± olarak planlanmƒ±≈ü
        const hizalanmisBaslangic = baslangicTarihi;
        
        // 9. haftanƒ±n ba≈ülangƒ±cƒ± (baslangicTarihi 9. hafta ba≈ülangƒ±cƒ± kabul edilir)
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalƒ±k program (5-12. haftalar) - ZIP sistemindeki gibi
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan ba≈ülar
          
          // 9. haftayƒ± referans alarak diƒüer hafta ba≈ülangƒ±√ßlarƒ±nƒ± hesapla
          // 5. hafta: 9. haftadan 4 hafta √∂nce (-4 * 7 g√ºn)
          // 6. hafta: 9. haftadan 3 hafta √∂nce (-3 * 7 g√ºn)
          // ...
          // 9. hafta: 9. haftadan 0 hafta √∂nce (0 * 7 g√ºn)
          // 10. hafta: 9. haftadan 1 hafta sonra (+1 * 7 g√ºn)
          const haftaFarki = gercekHaftaNo - 9; // 5. hafta=-4, 6. hafta=-3, ..., 9. hafta=0, 10. hafta=+1
          const haftaBaslangic = new Date(hizalanmisBaslangic.getTime() + (haftaFarki * 7 * 24 * 60 * 60 * 1000));
          
          // Sayfa sonu kontrol√º - hafta ba≈ülƒ±ƒüƒ± i√ßin yer var mƒ±?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta ba≈ülƒ±ƒüƒ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // 9. hafta PDF'si i√ßin 5-8. haftalar soluk renkte olsun
          if (gercekHaftaNo <= 8) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo ba≈ülƒ±klarƒ± - ZIP sistemindeki gibi
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, G√ºn, Sabah, Ak≈üam
          let zipTableStartX = 15;
          
          // Ba≈ülƒ±k satƒ±rƒ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her g√ºn i√ßin satƒ±r - ZIP sistemindeki gibi
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrol√º - satƒ±r i√ßin yer var mƒ±?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo ba≈ülƒ±klarƒ±nƒ± tekrar olu≈ütur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // Ba≈ülƒ±k satƒ±rƒ±
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrol√º - egzersiz dahil versiyonu (ZIP sistemindeki aynƒ± mantƒ±k)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // ƒ∞lk 2 hafta (5-6): G√ºnde 2 kez lenf masajƒ±
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): G√ºnde 1 kez lenf masajƒ± (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): G√ºna≈üƒ±rƒ± lenf masajƒ± + egzersiz
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                // Pazartesi, √áar≈üamba, Cuma, Pazar: Lenf masajƒ± + ak≈üam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                // Salƒ±, Per≈üembe, Cumartesi: Sabah ve ak≈üam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            } else {
              // Son 2 hafta (11-12): Haftada 2 g√ºn lenf masajƒ± + s√ºrekli egzersiz
              if (gunIndex === 1 || gunIndex === 4) { // Salƒ±, Cuma
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            }
            
            zipTableStartX = 15;
            
            // 9. hafta PDF'si i√ßin 5-8. haftalar soluk renkte olsun
            if (gercekHaftaNo <= 8) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tablo √ßizgi ayarlarƒ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 9. hafta PDF'si ve ge√ßmi≈ü haftalarda (5-8) ye≈üil check simgesi ekle
            if (gercekHaftaNo <= 8) {
              // Ye≈üil check kutusu √ßiz
              doc.setFillColor(0, 128, 0); // Ye≈üil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // Ye≈üil dikd√∂rtgen
              
              // Beyaz check √ßizgisi √ßiz
              doc.setDrawColor(255, 255, 255); // Beyaz √ßizgi
              doc.setLineWidth(0.5);
              // Check i≈üareti √ßizgisi (V ≈üekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo √ßizgi ayarlarƒ±nƒ± geri y√ºkle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi soluk renkte yaz
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Normal tarih
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // G√ºn s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // Ak≈üam s√ºtunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arasƒ± bo≈üluk
        }
        
        // PDF'yi kaydet
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${asciiHastaAdi}_Egzersiz_Takvimi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('‚úÖ √ñzel Egzersiz + Lenf Masaj Takvimi PDF olu≈üturuldu:', dosyaAdi);
        alert(`‚úÖ Egzersiz + Lenf Masaj Takvimi PDF olu≈üturuldu!\n\nDosya: ${dosyaAdi}\n\nBa≈ülangƒ±√ß Tarihi: ${baslangicTarihi.toLocaleDateString('tr-TR')}`);
        
      } catch (error) {
        console.error('‚ùå √ñzel Egzersiz PDF hatasƒ±:', error);
        throw error;
      }
    }

    async function zipEslesenGorseller(i) {
      try {
        console.log('üéØ ZIP fonksiyonu ba≈ülatƒ±ldƒ±, hafta indeksi:', i);
        
        // Hemen scope test edelim
        console.log('üîç Scope test - i deƒüeri:', i);
        
        // GitHub deƒüi≈ükenlerini input'lardan al - null check ile
        const tokenElement = document.getElementById('githubToken');
        const repoElement = document.getElementById('githubRepo');
        
        const GITHUB_TOKEN = tokenElement ? tokenElement.value.trim() : '';
        const GITHUB_REPO = repoElement ? repoElement.value.trim() || 'mustafasacar35/nutrition-planner' : 'mustafasacar35/nutrition-planner';
        
        if (!GITHUB_TOKEN) {
          console.warn('‚ö†Ô∏è GitHub token bulunamadƒ±');
          alert('GitHub token ayarlanmamƒ±≈ü. PDF dosyalarƒ± eklenemeyecek.');
        } else {
          console.log('‚úÖ GitHub token mevcut');
        }
        
        console.log('üîç GITHUB_REPO:', GITHUB_REPO);
        
        // K√ºt√ºphane kontrol√º
        if (typeof JSZip === 'undefined') {
          console.error('‚ùå JSZip k√ºt√ºphanesi y√ºklenmemi≈ü!');
          alert('JSZip k√ºt√ºphanesi y√ºklenmemi≈ü! Sayfayƒ± yenileyin.');
          return;
        }
        
        if (typeof saveAs === 'undefined') {
          console.error('‚ùå FileSaver k√ºt√ºphanesi y√ºklenmemi≈ü!');
          alert('FileSaver k√ºt√ºphanesi y√ºklenmemi≈ü! Sayfayƒ± yenileyin.');
          return;
        }
        
        console.log('‚úÖ K√ºt√ºphaneler y√ºkl√º: JSZip:', typeof JSZip, 'saveAs:', typeof saveAs);
        
      const haftalar = getHaftaListesi();
      console.log('üîç Hafta listesi alƒ±ndƒ±, uzunluk:', haftalar ? haftalar.length : 'null');
      
      const hafta = haftalar[i];
      console.log('  Hafta objesi alƒ±ndƒ±:', hafta);
      
      console.log('üîç Hafta objesi tamamƒ±:', JSON.stringify(hafta, null, 2));
      
      // haftaNo tanƒ±mƒ±ndan √∂nce hafta objesi kontrol√º
      if (!hafta) {
        console.error('‚ùå Hafta objesi bulunamadƒ±, index:', i);
        alert('Hafta bilgisi bulunamadƒ±!');
        return;
      }
      
      console.log('üîç hafta.haftaNo deƒüeri:', hafta.haftaNo);
      console.log('üîç i + 1 deƒüeri:', i + 1);
      
      // Hafta numarasƒ±nƒ± √∂nce tanƒ±mla - DEBUG ile
      console.log('üîç haftaNo tanƒ±mlanmadan √∂nce...');
      const haftaNo = hafta.haftaNo || (i + 1);
      console.log('üîç haftaNo tanƒ±mlandƒ±:', haftaNo);
      
      // Eƒüer PDF varsa ama pdfName yoksa, bunu d√ºzelt
      if (hafta.pdf && !hafta.pdfName) {
        console.log('üîß PDF var ama pdfName yok, d√ºzeltiliyor...');
        // Hasta adƒ±ndan PDF adƒ± olu≈ütur (T√ºrk√ße karakter d√ºzeltme ile)
        const hastaAdi = seciliHasta && seciliHasta.isim ? turkceKarakterDuzelt(seciliHasta.isim).replace(/\s+/g, '_') : 'Hasta';
        const tarih = new Date().toISOString().slice(0,10);
        hafta.pdfName = `${hastaAdi}_Hafta_${haftaNo}_${tarih}.pdf`;
        saveToStorage(); // Deƒüi≈üikliƒüi kaydet
        console.log('‚úÖ PDF adƒ± olu≈üturuldu:', hafta.pdfName);
      }
      
      const eslesenDiv = document.getElementById('eslesenKartlar_' + i);
      const imgs = eslesenDiv.querySelectorAll('img');
      
      // ƒ∞√ßerik kontrol√º
      const hasPdf = hafta.pdf;
      const hasGptMessage = hafta.gptMesaj && hafta.gptMesaj.trim();
      const hasImages = imgs.length > 0;
      
      if (!hasImages && !hasPdf && !hasGptMessage) {
        alert('ƒ∞ndirilecek i√ßerik yok!\n\n‚Ä¢ PDF dosyasƒ±\n‚Ä¢ E≈üle≈üen tarif kartlarƒ±\n‚Ä¢ GPT mesajƒ±');
        return;
      }
      
      const zip = new JSZip();
      let fileCount = 0;      let baseName, zipName, pdfFileName, txtFileName;
      
      console.log('üîç Debug - hafta objesi:', hafta);
      console.log('üîç Debug - hafta.pdfName:', hafta.pdfName);
      console.log('üîç Debug - hafta indeksi:', i);
      console.log('üîç Debug - t√ºm hafta listesi:', getHaftaListesi().map(h => ({haftaNo: h.haftaNo, pdfName: h.pdfName})));
      
      if (hafta.pdfName && hafta.pdfName.trim()) {
        // Y√ºklenen PDF dosyasƒ±nƒ±n adƒ±nƒ± kullan - T√ºrk√ße karakterleri d√ºzelt
        const duzeltilmisPdfName = turkceKarakterDuzelt(hafta.pdfName);
        baseName = duzeltilmisPdfName.replace(/\.[^.]+$/, '');  // Uzantƒ±sƒ±z ad
        zipName = duzeltilmisPdfName.replace(/\.pdf$/i, '.zip');  // PDF uzantƒ±sƒ±nƒ± ZIP ile deƒüi≈ütir
        pdfFileName = duzeltilmisPdfName;  // D√ºzeltilmi≈ü PDF adƒ±nƒ± kullan
        txtFileName = baseName + '.txt';
        console.log('‚úÖ PDF adƒ± kullanƒ±lƒ±yor (d√ºzeltilmi≈ü):', duzeltilmisPdfName);
      } else {
        // PDF adƒ± yoksa, PDF i√ßeriƒüinden veya hasta adƒ±ndan t√ºretelim
        console.log('‚ö†Ô∏è PDF adƒ± yok, alternatif √ß√∂z√ºm arƒ±yor...');
        
        // Hasta adƒ±ndan ve hafta numarasƒ±ndan dosya adƒ± olu≈ütur (T√ºrk√ße karakter d√ºzeltme ile)
        const hastaAdi = seciliHasta && seciliHasta.isim ? turkceKarakterDuzelt(seciliHasta.isim).replace(/\s+/g, '_') : 'Hasta';
        const tarih = new Date().toISOString().slice(0,10);
        
        baseName = `${hastaAdi}_Hafta_${haftaNo}_${tarih}`;
        zipName = baseName + '.zip';
        pdfFileName = baseName + '.pdf';
        txtFileName = baseName + '.txt';
        console.log('üìù Olu≈üturulan dosya adƒ±:', baseName);
      }
      
      console.log('üì¶ ZIP olu≈üturuluyor:', {
        hasPdf,
        hasGptMessage,
        hasImages,
        pdfName: hafta.pdfName,
        zipName: zipName,
        pdfFileName: pdfFileName,
        txtFileName: txtFileName
      });
      
      // 2. E≈üle≈üen tarif kartlarƒ±nƒ± ana dizine ekle
      for (let img of imgs) {
        try {
          const url = img.src;
          const name = img.title || img.alt || `eslesen_kart_${fileCount + 1}.jpg`;
          const response = await fetch(url);
          const blob = await response.blob();
          zip.file(name, blob);  // Ana dizine ekle
          fileCount++;
          console.log('‚úÖ E≈üle≈üen kart eklendi:', name);
        } catch (e) {
          console.warn('‚ö†Ô∏è E≈üle≈üen kart eklenemedi:', img.alt, e);
        }
      }
      
      // 2b. Manuel eklenen kartlarƒ± da ana dizine ekle
      if (hafta.manuelKartlar && hafta.manuelKartlar.length > 0) {
        console.log('üìù Manuel kartlar ZIP\'e ekleniyor...', hafta.manuelKartlar);
        for (let manuelKart of hafta.manuelKartlar) {
          try {
            const response = await fetch(manuelKart.data);
            const blob = await response.blob();
            const manuelName = `MANUEL_${manuelKart.name}`;
            zip.file(manuelName, blob);  // Ana dizine ekle, MANUEL_ prefix ile
            fileCount++;
            console.log('‚úÖ Manuel kart eklendi:', manuelName);
          } catch (e) {
            console.warn('‚ö†Ô∏è Manuel kart eklenemedi:', manuelKart.name, e);
          }
        }
      }
      
      // 2c. √áoklu PDF'den eklenen kartlarƒ± da ana dizine ekle
      if (hafta.cokluPdfVerileri && hafta.cokluPdfVerileri.length > 0) {
        console.log('üìÅ √áoklu PDF kartlarƒ± ZIP\'e ekleniyor...', hafta.cokluPdfVerileri);
        for (let veri of hafta.cokluPdfVerileri) {
          if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
            for (let cokluKart of veri.tarifKartlar) {
              try {
                const response = await fetch(cokluKart.data);
                const blob = await response.blob();
                const cokluName = `COKLU_PDF_${cokluKart.name}`;
                zip.file(cokluName, blob);  // Ana dizine ekle, COKLU_PDF_ prefix ile
                fileCount++;
                console.log('‚úÖ √áoklu PDF kartƒ± eklendi:', cokluName);
              } catch (e) {
                console.warn('‚ö†Ô∏è √áoklu PDF kartƒ± eklenemedi:', cokluKart.name, e);
              }
            }
          }
        }
      }
      
      // 3. PDF dosyasƒ±nƒ± ekle
      if (hasPdf) {
        try {
          const base64 = hafta.pdf.split(',')[1];
          if (base64 && base64.length > 0) {
            // Base64 string boyutunu kontrol et (minimum 100 karakter olmalƒ± - √ßok k√º√ß√ºk PDF'leri engelle)
            if (base64.length < 100) {
              console.warn('‚ö†Ô∏è PDF √ßok k√º√ß√ºk (100 karakterden az), eklenmedi:', base64.length, 'karakter');
            } else {
              zip.file(pdfFileName, base64, {base64: true});
              fileCount++;
              console.log('‚úÖ PDF eklendi:', pdfFileName, 'boyut:', base64.length, 'karakter');
            }
          } else {
            console.warn('‚ö†Ô∏è PDF base64 verisi bo≈ü');
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è PDF eklenemedi:', e);
        }
      }
      
      // 5. GPT mesajƒ±nƒ± txt dosyasƒ± olarak ekle (sadece i√ßerik)
      if (hasGptMessage) {
        try {
          const mesajIcerigi = hafta.gptMesaj.trim();  // Sadece GPT mesajƒ± i√ßeriƒüi
          
          zip.file(txtFileName, mesajIcerigi);
          fileCount++;
          console.log('‚úÖ GPT mesajƒ± eklendi:', txtFileName);
        } catch (e) {
          console.warn('‚ö†Ô∏è GPT mesajƒ± eklenemedi:', e);
        }
      }
      
      // MEN√ú PDF'Si EKLEME (T√úM HAFTALAR ƒ∞√áƒ∞N)
      if ((hafta.pdfName || hafta.pdfOrijinalIsim) && GITHUB_TOKEN) {
        try {
          console.log(`üîç ${haftaNo}. hafta Men√º PDF ekleniyor...`);
          console.log('üîç PDF bilgileri:', {
            pdfName: hafta.pdfName,
            pdfOrijinalIsim: hafta.pdfOrijinalIsim,
            hastaId: seciliHasta.id,
            haftaNo: haftaNo
          });
          
          const pdfFileName = hafta.pdfName || hafta.pdfOrijinalIsim;
          
          // pdfYolu varsa √∂nce onu dene
          let pdfUrl;
          if (hafta.pdfYolu) {
            pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${hafta.pdfYolu}`;
            console.log('üîç ƒ∞lk denenen PDF URL (pdfYolu):', pdfUrl);
          } else {
            // √ñnce patients klas√∂r√ºnde dene
            pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/patients/${seciliHasta.id}/hafta_${haftaNo}_${pdfFileName}`;
            console.log('üîç ƒ∞lk denenen PDF URL (patients):', pdfUrl);
          }
          
          let pdfResponse = await fetch(pdfUrl, {
            headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
          });
          
          console.log('üîç ƒ∞lk PDF response status:', pdfResponse.status);
          
          // Eƒüer bulunamazsa pdfs klas√∂r√ºn√º dene
          if (!pdfResponse.ok && !hafta.pdfYolu) {
            console.log('üîç patients klas√∂r√ºnde bulunamadƒ±, pdfs klas√∂r√ºn√º deniyor...');
            pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/pdfs/${pdfFileName}`;
            
            console.log('üîç ƒ∞kinci denenen PDF URL (pdfs):', pdfUrl);
            
            pdfResponse = await fetch(pdfUrl, {
              headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            
            console.log('üîç ƒ∞kinci PDF response status:', pdfResponse.status);
          }
          
          if (pdfResponse.ok) {
            const pdfData = await pdfResponse.json();
            const pdfBlob = base64ToBlob(pdfData.content, 'application/pdf');
            
            // PDF boyutunu kontrol et (minimum 1KB olmalƒ±)
            if (pdfBlob && pdfBlob.size > 1024) {
              const menuPdfName = `MENU_PDF_${hafta.pdfOrijinalIsim || hafta.pdfName || 'menu.pdf'}`;
              zip.file(menuPdfName, pdfBlob);
              fileCount++;
              console.log(`‚úÖ ${haftaNo}. hafta Men√º PDF eklendi:`, menuPdfName, 'boyut:', pdfBlob.size, 'bytes');
            } else {
              console.warn(`‚ö†Ô∏è ${haftaNo}. hafta Men√º PDF √ßok k√º√ß√ºk (1KB altƒ±), eklenmedi:`, pdfBlob ? pdfBlob.size : 'null', 'bytes');
            }
          } else {
            const errorText = await pdfResponse.text();
            console.warn(`‚ùå ${haftaNo}. hafta PDF yanƒ±tƒ± ba≈üarƒ±sƒ±z:`, pdfResponse.status, errorText);
            
            // API yanƒ±tƒ±nƒ± detaylƒ± logla
            console.warn('‚ùå PDF API yanƒ±t detaylarƒ±:', {
              url: pdfUrl,
              status: pdfResponse.status,
              statusText: pdfResponse.statusText,
              errorText: errorText
            });
          }
        } catch (error) {
          console.warn(`‚ùå ${haftaNo}. hafta Men√º PDF eklenemedi:`, error);
          console.warn('‚ùå PDF ekleme hatasƒ± detaylarƒ±:', {
            errorMessage: error.message,
            errorStack: error.stack,
            pdfUrl: pdfUrl
          });
        }
      } else {
        console.warn(`‚ÑπÔ∏è ${haftaNo}. hafta PDF bilgisi bulunamadƒ±`, {
          haftaNo: haftaNo,
          pdfName: hafta.pdfName,
          pdfOrijinalIsim: hafta.pdfOrijinalIsim,
          hasToken: !!GITHUB_TOKEN
        });
      }

      // 6. Sadece 5. haftada "Sadece Masaj" Takvim PDF'ini ekle
      if (haftaNo === 5) {
        try {
          console.log('üè• 5. hafta tespit edildi, Sadece Masaj Takvim PDF\'i olu≈üturuluyor...');
          
          // Sadece masaj i√ßeren takvim PDF'ini olu≈ütur (5. hafta i√ßin, egzersiz dahil deƒüil)
          console.log('üîç generateLenfDrenajPDFBlob(5) √ßaƒürƒ±lƒ±yor...');
          const masajTakvimBlob = await generateLenfDrenajPDFBlob(5);
          console.log('üîç generateLenfDrenajPDFBlob sonucu:', masajTakvimBlob ? 'Blob var' : 'Blob yok');
          
          if (masajTakvimBlob && masajTakvimBlob.size > 0) {
            const masajTakvimFileName = `${baseName}_Masaj_Takvimi.pdf`;
            console.log('üîç Masaj PDF boyutu:', masajTakvimBlob.size, 'bytes');
            console.log('üîç Masaj PDF dosya adƒ±:', masajTakvimFileName);
            zip.file(masajTakvimFileName, masajTakvimBlob);
            fileCount++;
            console.log('‚úÖ Masaj Takvim PDF\'i ZIP\'e eklendi:', masajTakvimFileName);
          } else {
            console.warn('‚ùå Masaj Takvim PDF Blob olu≈üturulamadƒ± veya boyutu 0 KB:', masajTakvimBlob ? masajTakvimBlob.size : 'null');
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Masaj Takvim PDF\'i eklenemedi:', e);
          console.warn('‚ùå Masaj PDF hatasƒ± detaylarƒ±:', e.stack);
        }
      }
      
      // 7. Sadece 9. haftada "Masaj + Egzersiz" Takvim PDF'ini ekle
      if (haftaNo === 9) {
        try {
          console.log('üèãÔ∏è 9. hafta tespit edildi, Masaj + Egzersiz Takvim PDF\'i olu≈üturuluyor...');
          
          // Masaj + egzersiz i√ßeren takvim PDF'ini olu≈ütur (9. hafta i√ßin, egzersiz dahil)
          const masajEgzersizTakvimBlob = await generateLenfDrenajPDFBlob(9);
          if (masajEgzersizTakvimBlob && masajEgzersizTakvimBlob.size > 0) {
            const masajEgzersizTakvimFileName = `${baseName}_Masaj_Egzersiz_Takvimi.pdf`;
            console.log('üîç Masaj+Egzersiz PDF boyutu:', masajEgzersizTakvimBlob.size, 'bytes');
            zip.file(masajEgzersizTakvimFileName, masajEgzersizTakvimBlob);
            fileCount++;
            console.log('‚úÖ Masaj + Egzersiz Takvim PDF\'i ZIP\'e eklendi:', masajEgzersizTakvimFileName);
          } else {
            console.warn('‚ùå Masaj + Egzersiz Takvim PDF Blob olu≈üturulamadƒ± veya boyutu 0 KB:', masajEgzersizTakvimBlob ? masajEgzersizTakvimBlob.size : 'null');
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Masaj + Egzersiz Takvim PDF\'i eklenemedi:', e);
        }
      }
      
      // 8. ZIP dosyasƒ±nƒ± olu≈ütur ve indir
      if (fileCount === 0) {
        alert('Hi√ßbir dosya eklenemedi!');
        return;
      }
      
      console.log(`üì¶ ZIP hazƒ±rlanƒ±yor: ${fileCount} dosya, adƒ±: ${zipName}`);
      
      zip.generateAsync({type:'blob'}).then(function(content) {
        saveAs(content, zipName);
        console.log('‚úÖ ZIP indirildi:', zipName);
        alert(`ZIP dosyasƒ± hazƒ±rlandƒ±!\n\nüìÅ ${zipName}\nüìÑ ${fileCount} dosya dahil`);
      }).catch(function(error) {
        console.error('‚ùå ZIP olu≈üturma hatasƒ±:', error);
        alert('ZIP dosyasƒ± olu≈üturulurken hata olu≈ütu: ' + error.message);
      });
      
    } catch (error) {
        console.error('‚ùå ZIP fonksiyonu genel hatasƒ±:', error);
        alert('ZIP olu≈üturma hatasƒ±: ' + error.message);
      }
    }
    
    window.zipEslesenGorseller = zipEslesenGorseller;
    window.generatePatientPDF = generatePatientPDF;
    
    // PDF Test fonksiyonu
    function testPDFGenerator() {
      console.log('üß™ PDF Test ba≈ülatƒ±lƒ±yor...');
      console.log('jsPDF kontrol:', typeof window.jspdf, typeof jsPDF);
      
      if (typeof window.jspdf !== 'undefined') {
        console.log('‚úÖ jsPDF mevcut, test PDF olu≈üturuluyor...');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text('Test PDF - T√ºrk√ße karakter: √ßƒüƒ±√∂≈ü√º√áƒûI√ñ≈û√ú', 10, 10);
        doc.save('test.pdf');
        console.log('‚úÖ Test PDF olu≈üturuldu!');
      } else {
        console.log('‚ùå jsPDF bulunamadƒ±');
        alert('jsPDF k√ºt√ºphanesi y√ºklenmemi≈ü');
      }
    }
    window.testPDFGenerator = testPDFGenerator;

    // Debug fonksiyonu - Tarifler klas√∂r√º durumunu kontrol et
    async function debugTariflerKlasoru() {
      console.log('üîç Tarifler Klas√∂r√º Debug Ba≈ülƒ±yor...');
      
      // Mevcut durum
      console.log('üìä Mevcut tariflerKlasoruGorselleri:', tariflerKlasoruGorselleri);
      console.log('üìä G√∂rsel sayƒ±sƒ±:', tariflerKlasoruGorselleri.length);
      
      // Yol hesaplama
      let basePath = window.location.pathname;
      if (!basePath.endsWith('/')) basePath = basePath.substring(0, basePath.lastIndexOf('/') + 1);
      const tariflerPath = window.location.origin + basePath + 'tarifler/';
      console.log('üåê Hesaplanan tarifler yolu:', tariflerPath);
      
      // list.json kontrol√º
      try {
        console.log('üìÇ list.json dosyasƒ± kontrol ediliyor...');
        const resp = await fetch(tariflerPath + 'list.json');
        console.log('üìÑ list.json response status:', resp.status);
        
        if (resp.ok) {
          const responseText = await resp.text();
          console.log('üìÑ Ham list.json i√ßeriƒüi (ilk 500 karakter):', responseText.substring(0, 500));
          
          try {
            const files = JSON.parse(responseText);
            console.log('‚úÖ list.json ba≈üarƒ±yla okundu:', files);
            console.log('üìÅ Dosya sayƒ±sƒ±:', files.length);
            
            // Her dosyanƒ±n eri≈üilebilirliƒüini test et
            for (let fileName of files.slice(0, 3)) { // ƒ∞lk 3 dosyayƒ± test et
              try {
                const fileResp = await fetch(tariflerPath + fileName);
                console.log(`üñºÔ∏è ${fileName}: ${fileResp.ok ? '‚úÖ Eri≈üilebilir' : '‚ùå Eri≈üilemez'} (${fileResp.status})`);
              } catch (e) {
                console.log(`üñºÔ∏è ${fileName}: ‚ùå Hata - ${e.message}`);
              }
            }
          } catch (jsonError) {
            console.log('‚ùå JSON parsing hatasƒ±:', jsonError.message);
            console.log('üìÑ Hatalƒ± JSON i√ßeriƒüi:', responseText);
            
            // JSON'u satƒ±r satƒ±r kontrol et
            const lines = responseText.split('\n');
            console.log('üìä Toplam satƒ±r sayƒ±sƒ±:', lines.length);
            
            // 200-210 arasƒ± satƒ±rlarƒ± g√∂ster (hata 204. satƒ±rda)
            for (let i = 200; i < Math.min(210, lines.length); i++) {
              console.log(`Satƒ±r ${i + 1}: "${lines[i]}"`);
            }
          }
        } else {
          console.log('‚ùå list.json bulunamadƒ±');
        }
      } catch (e) {
        console.log('‚ùå list.json okuma hatasƒ±:', e.message);
      }
      
      // Hasta verilerini kontrol et
      console.log('üë• Toplam hasta sayƒ±sƒ±:', hastalar.length);
      
      if (hastalar.length > 0) {
        const mevcutSeciliHasta = hastalar.find(h => h.secili);
        if (mevcutSeciliHasta) {
          console.log('üë§ Se√ßili hasta:', mevcutSeciliHasta.ad);
          const haftalar = mevcutSeciliHasta.haftalar || [];
          console.log('üìÖ Hafta sayƒ±sƒ±:', haftalar.length);
          
          haftalar.forEach((hafta, index) => {
            const manuelKartSayisi = (hafta.tarifKartlar && hafta.tarifKartlar.length) || 0;
            const tarifSayisi = (hafta.tarifler && hafta.tarifler.length) || 0;
            const haftaNo = hafta.haftaNo || (index + 1);
            const pdfDurum = hafta.pdf ? '‚úÖ PDF var' : '‚ùå PDF yok';
            console.log(`üìÖ Hafta ${haftaNo} (sƒ±ra: ${index + 1}): ${manuelKartSayisi} manuel kart, ${tarifSayisi} tarif, ${pdfDurum}`);
          });
        } else {
          console.log('‚ö†Ô∏è Se√ßili hasta yok');
        }
      }
      
      // Sonu√ß √∂zeti
      alert(`üîç Debug Sonu√ßlarƒ± (Konsolu kontrol edin):
      
üìä Tarifler klas√∂r√º g√∂rsel sayƒ±sƒ±: ${tariflerKlasoruGorselleri.length}
üåê Tarifler yolu: ${tariflerPath}
üë• Hasta sayƒ±sƒ±: ${hastalar.length}

Detaylƒ± bilgiler i√ßin tarayƒ±cƒ± konsolunu (F12) a√ßƒ±n.`);
    }
    window.debugTariflerKlasoru = debugTariflerKlasoru;

    // Tarifler klas√∂r√ºn√º yeniden y√ºkleme ve e≈üle≈ütirme fonksiyonu
    async function yeniBirDenemeEt(haftaIndex) {
      console.log('üîÑ Yeniden deneme ba≈ülƒ±yor...');
      
      // √ñnce tarifler klas√∂r√ºn√º sƒ±fƒ±rla ve yeniden y√ºkle
      tariflerKlasoruGorselleri = [];
      await tariflerKlasoruGorselleriniYukle();
      
      // Durum g√ºncelle
      durumGuncelle();
      
      // Sonra o hafta i√ßin e≈üle≈ütirmeyi yeniden √ßalƒ±≈ütƒ±r
      await otomatikEsleHafta(haftaIndex);
      
      console.log('‚úÖ Yeniden deneme tamamlandƒ±');
    }
    window.yeniBirDenemeEt = yeniBirDenemeEt;

    // GitHub'tan fresh y√ºkleme (cache'i temizle ve GitHub'tan y√ºkle)
    async function githubdanYenileVeYukle() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('‚ùå GitHub token gerekli!\n\n√ñnce GitHub API token\'ƒ±nƒ±zƒ± girin.');
        return;
      }
      
      if (!confirm('üîÑ FRESH Y√úKLEME\n\nBu i≈ülem:\n‚Ä¢ Yerel cache\'i temizleyecek\n‚Ä¢ GitHub\'tan en g√ºncel verileri y√ºkleyecek\n‚Ä¢ Tarifler klas√∂r√ºn√º yeniden tarayacak\n\nDevam etmek istiyor musunuz?')) {
        return;
      }
      
      try {
        console.log('üîÑ GitHub\'tan fresh y√ºkleme ba≈ülƒ±yor...');
        
        // Sadece veri cache'lerini temizle (hasta kayƒ±tlarƒ±nƒ± tutmak i√ßin)
        manuelEslestirmeler = {};
        eslesmemeKurallari = {};
        tariflerKlasoruGorselleri = [];
        
        // GitHub'tan y√ºkle
        await manuelEslestirmeleriGitHubYukle(false); // sessiz deƒüil
        await eslesmemeKurallariniGitHubYukle(false); // sessiz deƒüil
        
        // Tarifler klas√∂r√ºn√º yeniden y√ºkle
        await tariflerKlasoruGorselleriniYukle();
        
        // Durumu g√ºncelle
        durumGuncelle();
        
        alert('‚úÖ GitHub\'tan fresh y√ºkleme tamamlandƒ±!\n\n' +
              `‚Ä¢ Manuel e≈üle≈ütirmeler: ${Object.keys(manuelEslestirmeler).length} adet\n` +
              `‚Ä¢ E≈üle≈üme yasaklarƒ±: ${Object.keys(eslesmemeKurallari).length} adet\n` +
              `‚Ä¢ Tarifler klas√∂r√º: ${tariflerKlasoruGorselleri.length} g√∂rsel`);
              
      } catch (error) {
        console.error('GitHub fresh y√ºkleme hatasƒ±:', error);
        alert('‚ùå GitHub\'tan y√ºkleme hatasƒ±:\n\n' + error.message);
      }
    }
    window.githubdanYenileVeYukle = githubdanYenileVeYukle;

    // Sadece tarifler klas√∂r√ºn√º yenile
    async function sadeceTariflerKlasoruYenile() {
      try {
        console.log('üìÅ Tarifler klas√∂r√º yenileniyor...');
        
        // Cache'i temizle
        tariflerKlasoruGorselleri = [];
        
        // Yeniden y√ºkle
        await tariflerKlasoruGorselleriniYukle();
        
        // Durumu g√ºncelle
        durumGuncelle();
        
        alert(`‚úÖ Tarifler klas√∂r√º yenilendi!\n\n${tariflerKlasoruGorselleri.length} g√∂rsel bulundu.`);
        
      } catch (error) {
        console.error('Tarifler klas√∂r√º yenileme hatasƒ±:', error);
        alert('‚ùå Tarifler klas√∂r√º yenileme hatasƒ±:\n\n' + error.message);
      }
    }
    window.sadeceTariflerKlasoruYenile = sadeceTariflerKlasoruYenile;

    // ========================
    // YENƒ∞ SIDEBAR LAYOUT FONKSƒ∞YONLARI
    // ========================

    // Aktif hastayƒ± se√ßtiƒüimizde e≈üle≈üen kartlarƒ± g√∂ster
    function hastaSecildiginde(hastaIndex) {
      console.log(`üë§ Hasta se√ßildi: ${hastaIndex}`);
      
      // Mevcut aktif hafta i√ßin e≈üle≈üen kartlarƒ± sidebar'da g√∂ster
      const actTab = document.querySelector('.hafta-tab.active');
      if (actTab) {
        const haftaIndex = parseInt(actTab.dataset.haftaIndex);
        if (!isNaN(haftaIndex)) {
          gosterEslesenKartlarSidebar(haftaIndex);
        }
      }
      
      // Hasta se√ßildiƒüinde yemek analizini g√ºncelle
      setTimeout(() => {
        updateYemekAnalizi();
      }, 500); // Hasta verilerinin y√ºklenmesi i√ßin kƒ±sa gecikme
    }
    window.hastaSecildiginde = hastaSecildiginde;

    // Hafta tab'ƒ± se√ßildiƒüinde sidebar'larƒ± g√ºncelle
    function haftaTabSecildiginde(haftaIndex) {
      console.log(`üîÑ Hafta tab'ƒ± se√ßildi: ${haftaIndex}`);
      aktifHaftaIndex = haftaIndex;
      gosterEslesenKartlarSidebar(haftaIndex);
      
      // Yemek analizini her hafta deƒüi≈üiminde otomatik g√ºncelle
      updateYemekAnalizi();
    }
    window.haftaTabSecildiginde = haftaTabSecildiginde;

    // E≈üle≈üen kartlarƒ± saƒü sidebar'da g√∂ster
    function gosterEslesenKartlarSidebar(haftaIndex) {
      console.log(`üîç gosterEslesenKartlarSidebar √ßaƒürƒ±ldƒ±, hafta index: ${haftaIndex}`);
      
      const currentDiv = document.getElementById('eslesenContent');
      if (!currentDiv) {
        console.log('‚ùå eslesenContent div bulunamadƒ±!');
        return;
      }
      
      const eskiDiv = document.getElementById(`eslesenKartlar_${haftaIndex}`);
      console.log(`üîç eslesenKartlar_${haftaIndex} div:`, eskiDiv);
      console.log(`üîç eskiDiv children count:`, eskiDiv ? eskiDiv.children.length : 'div null');
      
      // √ñnce temizle
      currentDiv.innerHTML = '';
      
      // E≈üle≈üen kartlar ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
      const eslesenBaslik = document.getElementById('eslesenBaslik');
      
      let kartVarMi = false;
      
      // 1. Otomatik e≈üle≈üen kartlarƒ± ekle
      if (eskiDiv && eskiDiv.children.length > 0) {
        console.log('‚úÖ Otomatik e≈üle≈üen kartlar bulundu, sidebar\'a klonlanƒ±yor...');
        
        // Her child elementi klonla ve onclick eventleri yeniden ekle
        Array.from(eskiDiv.children).forEach(child => {
          const clonedChild = child.cloneNode(true);
          
          // Klonlanan element i√ßindeki tƒ±klanabilir span'larƒ± bul ve onclick ekle
          const clickableSpans = clonedChild.querySelectorAll('span[style*="cursor: pointer"]');
          clickableSpans.forEach(span => {
            const tarifText = span.textContent.replace(/^[^:]*:\s*/, '').trim(); // "Tarif: xyz" formatƒ±ndan "xyz" al
            console.log('üîß Sidebar klonuna onclick ekleniyor:', tarifText);
            
            span.onclick = () => {
              console.log('üîß Sidebar\'dan e≈üle≈üen tarif adƒ±na tƒ±klandƒ±:', tarifText);
              try {
                if (typeof eslesenTarifManuelEslestir === 'function') {
                  // Orjinal kartlarƒ± bul
                  const aktifHaftaIndex = getAktifHaftaIndex();
                  const hafta = seciliHasta?.haftalar?.[aktifHaftaIndex];
                  if (hafta?.tarifKartlar) {
                    const eslesmeTarifKartlari = hafta.tarifKartlar.filter(kart => 
                      kart.tarifAdi.toLowerCase() === tarifText.toLowerCase()
                    );
                    eslesenTarifManuelEslestir(tarifText, eslesmeTarifKartlari);
                  }
                } else {
                  console.error('‚ùå eslesenTarifManuelEslestir fonksiyonu bulunamadƒ±!');
                  alert('Manuel e≈üle≈ütirme fonksiyonu y√ºklenemedi. Sayfayƒ± yenileyin.');
                }
              } catch (error) {
                console.error('‚ùå Sidebar e≈üle≈üen tarif tƒ±klama hatasƒ±:', error);
                alert('Hata: ' + error.message);
              }
            };
          });
          
          currentDiv.appendChild(clonedChild);
        });
        
        kartVarMi = true;
      }
      
      // 2. Manuel eklenen kartlarƒ± ekle
      if (seciliHasta && seciliHasta.haftalar && seciliHasta.haftalar[haftaIndex]) {
        const hafta = seciliHasta.haftalar[haftaIndex];
        if (hafta.manuelKartlar && hafta.manuelKartlar.length > 0) {
          console.log('‚úÖ Manuel kartlar bulundu, ekleniyor...', hafta.manuelKartlar);
          
          hafta.manuelKartlar.forEach(kart => {
            const kartDiv = document.createElement('div');
            kartDiv.style.cssText = 'display: inline-block; margin: 10px; position: relative; vertical-align: top;';
            kartDiv.className = 'manuel-kart';
            
            // Kart adƒ±nƒ± d√ºzenle
            const kartBaslik = kart.name.replace('.jpg', '').replace(/_/g, ' ');
            
            kartDiv.innerHTML = `
              <div style="background: white; border: 3px solid #ffd700; border-radius: 12px; padding: 15px; width: 200px; box-shadow: 0 4px 8px rgba(255,215,0,0.3);">
                <img src="${kart.data}" alt="${kart.name}" title="${kartBaslik}" 
                     style="width: 100%; height: 120px; object-fit: cover; object-position: top; border-radius: 8px; margin-bottom: 10px;">
                
                <div style="font-size: 13px; font-weight: bold; color: #333; margin-bottom: 5px; text-align: center;">
                  ${kartBaslik}
                </div>
                
                <div style="background: #ffd700; color: #333; text-align: center; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-bottom: 8px;">
                  üñêÔ∏è MANUEL EKLENEN
                </div>
                
                <div style="text-align: center;">
                  <button onclick="manuelKartSil('${kart.name}', ${haftaIndex})" 
                          style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                    üóëÔ∏è Sil
                  </button>
                </div>
              </div>
            `;
            
            currentDiv.appendChild(kartDiv);
          });
          
          kartVarMi = true;
        }
        
        // 3. √áoklu PDF'den eklenen kartlarƒ± ekle
        if (hafta.cokluPdfVerileri && hafta.cokluPdfVerileri.length > 0) {
          console.log('‚úÖ √áoklu PDF kartlarƒ± bulundu, ekleniyor...', hafta.cokluPdfVerileri);
          
          hafta.cokluPdfVerileri.forEach((veri, veriIndex) => {
            if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
              veri.tarifKartlar.forEach(kart => {
                const kartDiv = document.createElement('div');
                kartDiv.style.cssText = 'display: inline-block; margin: 10px; position: relative; vertical-align: top;';
                kartDiv.className = 'coklu-pdf-kart';
                kartDiv.setAttribute('data-kart-name', kart.name);
                
                // Kart adƒ±nƒ± d√ºzenle
                const kartBaslik = kart.name.replace('.jpg', '').replace(/_/g, ' ');
                
                kartDiv.innerHTML = `
                  <div style="background: white; border: 3px solid #17a2b8; border-radius: 12px; padding: 15px; width: 200px; box-shadow: 0 4px 8px rgba(23,162,184,0.3);">
                    <img src="${kart.data}" alt="${kart.name}" title="${kartBaslik}" 
                         style="width: 100%; height: 120px; object-fit: cover; object-position: top; border-radius: 8px; margin-bottom: 10px;">
                    
                    <div style="font-size: 13px; font-weight: bold; color: #333; margin-bottom: 5px; text-align: center;">
                      ${kartBaslik}
                    </div>
                    
                    <div style="background: #17a2b8; color: white; text-align: center; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-bottom: 8px;">
                      üìÅ √áOKLU PDF'DEN
                    </div>
                    
                    <div style="text-align: center;">
                      <button onclick="cokluPdfKartSil('${kart.name}', ${haftaIndex}, ${veriIndex})" 
                              style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        üóëÔ∏è Sil
                      </button>
                    </div>
                  </div>
                `;
                
                currentDiv.appendChild(kartDiv);
              });
            }
          });
          
          kartVarMi = true;
        }
      }
      
      // 3. Eƒüer hi√ß kart yoksa mesaj g√∂ster
      if (!kartVarMi) {
        console.log('‚ùå Hi√ß kart bulunamadƒ±');
        currentDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 40px; font-size: 12px;">Bu hafta i√ßin hen√ºz e≈üle≈üme yok.</div>';
        if (eslesenBaslik) {
          eslesenBaslik.textContent = 'üìã E≈üle≈üen Kartlar';
        }
      } else {
        console.log('‚úÖ Kartlar sidebar\'a ba≈üarƒ±yla eklendi');
        
        // Benzersiz yemek √ße≈üidi sayƒ±sƒ±nƒ± hesapla
        const benzersizYemekler = new Set();
        
        // T√ºm kartlardaki yemek isimlerini topla
        const tumKartlar = currentDiv.querySelectorAll('[data-kart-name]');
        tumKartlar.forEach(kart => {
          const kartName = kart.getAttribute('data-kart-name');
          if (kartName) {
            // .jpg uzantƒ±sƒ±nƒ± kaldƒ±r ve normalize et
            const yemekAdi = kartName.replace('.jpg', '').replace(/_/g, ' ').toLowerCase();
            benzersizYemekler.add(yemekAdi);
          }
        });
        
        // Eƒüer data-kart-name yoksa, g√∂rsel isimlerden √ßƒ±kar
        if (benzersizYemekler.size === 0) {
          const gorselKartlari = currentDiv.querySelectorAll('img');
          gorselKartlari.forEach(img => {
            if (img.src && img.src.includes('/')) {
              const dosyaAdi = img.src.split('/').pop();
              const yemekAdi = dosyaAdi.replace('.jpg', '').replace(/_/g, ' ').toLowerCase();
              benzersizYemekler.add(yemekAdi);
            }
          });
        }
        
        const benzersizSayisi = benzersizYemekler.size;
        console.log('üçΩÔ∏è Benzersiz yemek √ße≈üidi sayƒ±sƒ±:', benzersizSayisi, 'Toplam kart:', currentDiv.children.length);
        
        // Ba≈ülƒ±k g√ºncelle - benzersiz yemek √ße≈üidi sayƒ±sƒ± ile
        if (eslesenBaslik) {
          eslesenBaslik.textContent = `üìã E≈üle≈üen Kartlar (${benzersizSayisi})`;
        }
        
        // Sadece g√ºvenlik i√ßin onclick'leri yeniden ata (otomatik kartlar i√ßin)
        const tumButonlar = currentDiv.querySelectorAll('button:not(.manuel-kart-silme-btn)');
        console.log('üîç Sidebar\'da bulunan buton sayƒ±sƒ±:', tumButonlar.length);
        
        tumButonlar.forEach((btn, index) => {
          if (btn.textContent.includes('ZIP ƒ∞ndir')) {
            console.log('üîç ZIP butonu bulundu, onclick kontrol ediliyor...');
            if (!btn.onclick) {
              console.log('üîß ZIP butonu onclick eksik, yeniden atanƒ±yor...');
              btn.onclick = function(e) { 
                e.preventDefault();
                console.log('üéØ ZIP butonuna tƒ±klandƒ± (sidebar), hafta index:', haftaIndex);
                zipEslesenGorseller(haftaIndex); 
              };
            }
          }
        });
      }
    }
    window.gosterEslesenKartlarSidebar = gosterEslesenKartlarSidebar;

    // ========================
    // SAYFA BA≈ûLATMA
    // ========================
    
    // Sayfa y√ºklendiƒüinde √ßalƒ±≈üacak ba≈ülatma fonksiyonu - SADECE YENƒ∞ Sƒ∞STEM
    async function sayfaBaslat() {
      console.log('üöÄ YENƒ∞ Sƒ∞STEM BA≈ûLATILIYOR - Eski sistem devre dƒ±≈üƒ±');
      
      // Sadece yeni sistemi y√ºkle
      console.log('üìã SADECE YENƒ∞ Sƒ∞STEM: hasta listesi y√ºkleniyor...');
      
      // Token kontrol√º
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        console.log('‚ÑπÔ∏è GitHub token yok - Offline modda ba≈ülatƒ±lƒ±yor');
        
        // Bo≈ü yeni sistem ba≈ülat
        hastaListesi = [];
        renderHastalarYeniSistem();
        
        // Kullanƒ±cƒ±ya bilgi ver
        const durum = document.getElementById('githubDurumu');
        if (durum) {
          durum.innerHTML = '‚ö†Ô∏è GitHub token gerekli - Token girin';
        }
        
        return;
      }
      
      // Token varsa direkt yeni sistemi y√ºkle
      try {
        console.log('üîÑ GitHub token mevcut, yeni sistem y√ºkleniyor...');
        await loadHastaDataFromGitHub(true); // sessiz y√ºkleme
        console.log('‚úÖ Yeni sistem ba≈üarƒ±yla y√ºklendi');
      } catch (error) {
        console.warn('‚ö†Ô∏è Yeni sistem y√ºklenemedi, bo≈ü sistem ba≈ülatƒ±lƒ±yor:', error.message);
        hastaListesi = [];
        renderHastalarYeniSistem();
      }
      
      // Toplu ZIP butonunu ekle
      ekleTopluZipButonu();
    }
    
    // Toplu ZIP butonunu sidebar'a ekle
    function ekleTopluZipButonu() {
      const sidebarButtons = document.getElementById('sidebarButtons');
      if (sidebarButtons) {
        // Eƒüer buton zaten varsa tekrar ekleme
        if (sidebarButtons.querySelector('.toplu-zip-button')) {
          return;
        }
        
        const topluZipButton = document.createElement('button');
        topluZipButton.className = 'toplu-zip-button';
        topluZipButton.innerHTML = 'üóúÔ∏è TOPLU ZIP ƒ∞NDƒ∞R';
        topluZipButton.title = 'T√ºm aktif hastalarƒ±n en son hafta tablarƒ±nƒ± tek ZIP dosyasƒ±nda indir';
        topluZipButton.style.cssText = `
          width: 100%; 
          padding: 12px; 
          font-size: 14px; 
          font-weight: bold; 
          background: linear-gradient(45deg, #ff6b6b, #ee5a24); 
          color: white; 
          border: none; 
          border-radius: 6px; 
          cursor: pointer; 
          margin-bottom: 10px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
          transition: all 0.3s ease;
        `;
        
        // Hover efekti i√ßin
        topluZipButton.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-2px)';
          this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
        });
        
        topluZipButton.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
        });
        
        topluZipButton.onclick = function() {
          topluZipIndir();
        };
        
        // Butonu sidebar'a ekle
        sidebarButtons.appendChild(topluZipButton);
        console.log('‚úÖ Toplu ZIP butonu eklendi');
      }
    }
    
    // === Mƒ∞GRATION COMPLETED - YENƒ∞ Sƒ∞STEM AKTƒ∞F ===
    // ARTIK SADECE YENƒ∞ JSON Sƒ∞STEMƒ∞ KULLANILIYOR
    // - data/hasta_kayitlari.json kullanƒ±lmƒ±yor
    // - T√ºm hastalar patients/ klas√∂r√ºnde ayrƒ± JSON dosyalarƒ±
    // - Hasta listesi patients/hastalar_listesi.json dosyasƒ±nda
    // - Eski sistem fonksiyonlarƒ± yeni sisteme y√∂nlendiriliyor
    
    // ========================
    // MANUEL KART EKLEME Sƒ∞STEMƒ∞
    // ========================
    
    let aktifHaftaIndex = null;
    let secilenManuelKartlar = [];
    
    // YEMEK ANALƒ∞Zƒ∞ DEƒûƒ∞≈ûKENLERƒ∞
    let yemekAnaliziAcikMi = false;
    let yemekAnaliziSiralama = 'cok'; // 'cok', 'az', 'alfabetik'
    
    function manuelKartEklemeModalAc() {
      // Hasta kontrol√º
      if (!seciliHasta) {
        alert('√ñnce bir hasta se√ßin!');
        return;
      }
      
      // √ñnce aktif hafta tab'ƒ±nƒ± bul
      const aktifTab = document.querySelector('.hafta-tab.active');
      if (!aktifTab) {
        alert('√ñnce bir hafta se√ßin!');
        return;
      }
      
      aktifHaftaIndex = parseInt(aktifTab.dataset.haftaIndex);
      if (isNaN(aktifHaftaIndex)) {
        alert('Hafta bilgisi alƒ±namadƒ±!');
        return;
      }
      
      // Hafta verisi kontrol√º
      if (!seciliHasta.haftalar || !seciliHasta.haftalar[aktifHaftaIndex]) {
        alert('Bu hafta i√ßin veri bulunamadƒ±!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[aktifHaftaIndex];
      
      console.log('üîç Manuel kart ekleme ba≈ülatƒ±ldƒ±:', {
        hastaId: seciliHasta.id,
        hastaAdi: seciliHasta.isim,
        haftaIndex: aktifHaftaIndex,
        haftaNo: hafta.haftaNo || 'belirsiz'
      });
      
      // Modal'ƒ± a√ß
      document.getElementById('manuelKartModal').style.display = 'block';
      document.getElementById('manuelKartArama').value = '';
      secilenManuelKartlar = [];
      
      // T√ºm kartlarƒ± y√ºkle (arama bo≈ü bƒ±rakƒ±lmƒ±≈ü gibi)
      manuelKartAramaYap('');
      
      // Modal ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
      const modalBaslik = document.querySelector('#manuelKartModal h3');
      if (modalBaslik) {
        modalBaslik.textContent = `Manuel Kart Ekleme - ${seciliHasta.isim} (${hafta.haftaNo || aktifHaftaIndex + 1}. Hafta)`;
      }
    }
    
    function manuelKartModalKapat(event) {
      if (event && event.target !== document.getElementById('manuelKartModal')) return;
      
      console.log('üîí Manuel kart modal kapatƒ±lƒ±yor');
      
      document.getElementById('manuelKartModal').style.display = 'none';
      secilenManuelKartlar = [];
      aktifHaftaIndex = null; // State'i temizle
      
      // Modal ba≈ülƒ±ƒüƒ±nƒ± sƒ±fƒ±rla
      const modalBaslik = document.querySelector('#manuelKartModal h3');
      if (modalBaslik) {
        modalBaslik.textContent = 'Manuel Kart Ekleme';
      }
    }
    
    function manuelKartAramaYap(aramaMetni) {
      const liste = document.getElementById('manuelKartListe');
      
      console.log('üîç Manuel kart arama debug:', {
        aramaMetni,
        windowTarifKartlari: window.tarifKartlari,
        tarifKartlariLength: window.tarifKartlari ? window.tarifKartlari.length : 'undefined'
      });
      
      // Tarif kartlarƒ± listesinden ara
      if (!window.tarifKartlari || window.tarifKartlari.length === 0) {
        console.log('‚ùå Tarif kartlarƒ± y√ºklenmemi≈ü veya bo≈ü!');
        liste.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Tarif kartlarƒ± y√ºklenmemi≈ü!</div>';
        return;
      }
      
      // Mevcut kartlarƒ± kategorize et
      const mevcutOtomatikKartlar = [];
      const mevcutManuelKartlar = [];
      
      if (seciliHasta && seciliHasta.haftalar && aktifHaftaIndex !== null && seciliHasta.haftalar[aktifHaftaIndex]) {
        const hafta = seciliHasta.haftalar[aktifHaftaIndex];
        
        // Otomatik e≈üle≈üen kartlar
        if (hafta.tarifKartlar) {
          hafta.tarifKartlar.forEach(kart => {
            if (kart.name) {
              mevcutOtomatikKartlar.push(kart.name);
            }
          });
        }
        
        // Manuel eklenen kartlar
        if (hafta.manuelKartlar) {
          hafta.manuelKartlar.forEach(kart => {
            if (kart.name) {
              mevcutManuelKartlar.push(kart.name);
            }
          });
        }
      }
      
      // T√ºm kartlarƒ± filtrele (arama kriterlerine g√∂re)
      let tumKartlar = window.tarifKartlari;
      
      // Arama metni varsa filtreleme yap
      if (aramaMetni && aramaMetni.trim().length > 0) {
        const aramaKelimeler = aramaMetni.toLowerCase().trim().split(/\s+/)
          .map(kelime => karakterDuzelt(kelime));
        
        console.log('üîç Arama kelimeleri (normalize edilmi≈ü):', aramaKelimeler);
        
        tumKartlar = tumKartlar.filter(kart => {
          const kartAdi = karakterDuzelt(kart.replace('.jpg', '').replace(/_/g, ' ').toLowerCase());
          
          console.log(`üîé Test edilen kart: "${kart}" ‚Üí normalize: "${kartAdi}"`);
          
          // T√ºm arama kelimelerinin kart adƒ±nda bulunmasƒ± gerekiyor
          const eslesiyor = aramaKelimeler.every(kelime => {
            const bulundu = kartAdi.includes(kelime);
            console.log(`  ‚úì "${kelime}" kelimesi "${kartAdi}" i√ßinde: ${bulundu}`);
            return bulundu;
          });
          
          console.log(`üìä "${kart}" filtreleme sonucu: ${eslesiyor}`);
          return eslesiyor;
        });
        
        console.log(`üìã Filtreleme sonrasƒ± kart sayƒ±sƒ±: ${tumKartlar.length}`);
      }
      
      // Sonu√ßlarƒ± e≈üle≈üme skoruna g√∂re sƒ±rala
      if (aramaMetni && aramaMetni.trim().length > 0) {
        const aramaKelimeler = aramaMetni.toLowerCase().trim().split(/\s+/)
          .map(kelime => karakterDuzelt(kelime));
        
        tumKartlar.sort((a, b) => {
          const aAdi = karakterDuzelt(a.replace('.jpg', '').replace(/_/g, ' ').toLowerCase());
          const bAdi = karakterDuzelt(b.replace('.jpg', '').replace(/_/g, ' ').toLowerCase());
          
          // Tam arama metni e≈üle≈ümesi
          const aramaTam = aramaKelimeler.join(' ');
          const aIceriyor = aAdi.includes(aramaTam);
          const bIceriyor = bAdi.includes(aramaTam);
          
          if (aIceriyor && !bIceriyor) return -1;
          if (!aIceriyor && bIceriyor) return 1;
          
          // Ba≈ülangƒ±√ß e≈üle≈ümesi
          const aBaslangic = aramaKelimeler.some(kelime => aAdi.startsWith(kelime));
          const bBaslangic = aramaKelimeler.some(kelime => bAdi.startsWith(kelime));
          
          if (aBaslangic && !bBaslangic) return -1;
          if (!aBaslangic && bBaslangic) return 1;
          
          // Alfabetik sƒ±ralama
          return a.localeCompare(b, 'tr-TR');
        });
      }
      
      if (tumKartlar.length === 0) {
        liste.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Sonu√ß bulunamadƒ±</div>';
        return;
      }
      
      // Sonu√ßlarƒ± liste olarak g√∂ster
      let html = '<div style="max-height: 300px; overflow-y: auto;">';
      
      tumKartlar.forEach(kart => {
        const kartAdi = kart.replace('.jpg', '').replace(/_/g, ' ');
        const otomatikMi = mevcutOtomatikKartlar.includes(kart);
        const manuelMi = mevcutManuelKartlar.includes(kart);
        const seciliMi = secilenManuelKartlar.includes(kart);
        const pasifMi = otomatikMi || manuelMi;
        
        let backgroundColor, hoverColor, textColor, prefix, icon;
        
        if (manuelMi) {
          // Manuel eklenen - Sarƒ± marker
          backgroundColor = 'rgba(255, 215, 0, 0.2)'; // Transparan sarƒ±
          hoverColor = 'rgba(255, 215, 0, 0.3)';
          textColor = '#666';
          prefix = 'üñêÔ∏è ';
          icon = '';
        } else if (otomatikMi) {
          // Otomatik e≈üle≈üen - Ye≈üil marker  
          backgroundColor = 'rgba(40, 167, 69, 0.2)'; // Transparan ye≈üil
          hoverColor = 'rgba(40, 167, 69, 0.3)';
          textColor = '#666';
          prefix = 'üîó ';
          icon = '';
        } else if (seciliMi) {
          // Yeni se√ßilen
          backgroundColor = '#e8f5e8';
          hoverColor = '#d4edda';
          textColor = '#333';
          prefix = '';
          icon = '';
        } else {
          // Hen√ºz eklenmemi≈ü
          backgroundColor = 'white';
          hoverColor = '#f8f9fa';
          textColor = '#333';
          prefix = '';
          icon = '';
        }
        
        html += `
          <div ${pasifMi ? '' : `onclick="manuelKartToggle('${kart}')"`} style="
            cursor: ${pasifMi ? 'not-allowed' : 'pointer'}; 
            padding: 8px 12px; 
            border-bottom: 1px solid #eee;
            background: ${backgroundColor};
            display: flex;
            align-items: center;
            transition: background 0.2s;
            opacity: ${pasifMi ? '0.7' : '1'};
          " ${pasifMi ? '' : `onmouseover="this.style.background='${hoverColor}'" onmouseout="this.style.background='${backgroundColor}'"`}>
            ${pasifMi ? 
              `<span style="margin-right: 10px; color: #999;">‚óè</span>` : 
              `<input type="checkbox" ${seciliMi ? 'checked' : ''} style="margin-right: 10px; pointer-events: none;" />`
            }
            <span style="font-size: 14px; color: ${textColor}; flex: 1;">${prefix}${kartAdi}</span>
            ${manuelMi ? '<span style="font-size: 11px; color: #856404; background: rgba(255, 215, 0, 0.3); padding: 2px 6px; border-radius: 10px; margin-left: 8px;">MANUEL</span>' : ''}
            ${otomatikMi ? '<span style="font-size: 11px; color: #155724; background: rgba(40, 167, 69, 0.3); padding: 2px 6px; border-radius: 10px; margin-left: 8px;">OTOMATƒ∞K</span>' : ''}
          </div>
        `;
      });
      
      html += '</div>';
      liste.innerHTML = html;
    }
    
    function manuelKartToggle(kartAdi) {
      const index = secilenManuelKartlar.indexOf(kartAdi);
      if (index > -1) {
        secilenManuelKartlar.splice(index, 1);
      } else {
        secilenManuelKartlar.push(kartAdi);
      }
      
      // Listeyi g√ºncelle (mevcut arama metnini koru)
      const aramaMetni = document.getElementById('manuelKartArama').value;
      manuelKartAramaYap(aramaMetni);
    }
    
    function getMevcutHaftaKartlari() {
      if (!seciliHasta || !seciliHasta.haftalar || aktifHaftaIndex === null || !seciliHasta.haftalar[aktifHaftaIndex]) {
        return [];
      }
      
      const hafta = seciliHasta.haftalar[aktifHaftaIndex];
      const kartlar = [];
      
      console.log('üîç Mevcut hafta kartlarƒ± kontrol ediliyor:', {
        hastaId: seciliHasta.id,
        hastaAdi: seciliHasta.isim,
        haftaIndex: aktifHaftaIndex,
        haftaNo: hafta.haftaNo
      });
      
      // Otomatik e≈üle≈üen kartlar
      if (hafta.tarifKartlar) {
        hafta.tarifKartlar.forEach(kart => {
          if (kart.name) {
            kartlar.push(kart.name);
            console.log('üìÑ Otomatik kart bulundu:', kart.name);
          }
        });
      }
      
      // Manuel eklenen kartlar (sadece bu hafta i√ßin)
      if (hafta.manuelKartlar) {
        hafta.manuelKartlar.forEach(kart => {
          if (kart.name) {
            kartlar.push(kart.name);
            console.log('üñêÔ∏è Manuel kart bulundu:', kart.name);
          }
        });
      }
      
      console.log('‚úÖ Toplam mevcut kartlar:', kartlar);
      return kartlar;
    }
    
    function secilenManuelKartlariEkle() {
      if (secilenManuelKartlar.length === 0) {
        alert('Hi√ß kart se√ßilmedi!');
        return;
      }
      
      if (!seciliHasta) {
        alert('Hasta se√ßilmemi≈ü!');
        return;
      }
      
      console.log('üìù Manuel kartlar ekleniyor:', secilenManuelKartlar);
      
      // Hasta verilerine manuel kartlarƒ± ekle
      if (!seciliHasta.haftalar[aktifHaftaIndex]) {
        alert('Hafta verisi bulunamadƒ±!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[aktifHaftaIndex];
      if (!hafta.manuelKartlar) {
        hafta.manuelKartlar = [];
      }
      
      // Yeni kartlarƒ± ekle
      secilenManuelKartlar.forEach(kartAdi => {
        hafta.manuelKartlar.push({
          name: kartAdi,
          data: `https://mustafasacar35.github.io/nutrition-planner/tarifler/${kartAdi}`,
          eklenmeTarihi: new Date().toISOString()
        });
      });
      
      console.log('‚úÖ Manuel kartlar hafta verisine eklendi');
      
      // Alert i√ßin kart sayƒ±sƒ±nƒ± sakla (modal kapatƒ±lmadan √∂nce)
      const eklenenKartSayisi = secilenManuelKartlar.length;
      
      // Verileri kaydet
      saveToStorage();
      hastayiAyriKaydet(seciliHasta);
      
      // Sidebar'ƒ± g√ºncelle
      haftaTabSecildiginde(aktifHaftaIndex);
      
      // Modal'ƒ± kapat
      manuelKartModalKapat();
      
      // Yemek analizini g√ºncelle
      updateYemekAnalizi();
      
      alert(`‚úÖ ${eklenenKartSayisi} kart ba≈üarƒ±yla eklendi!`);
    }
    
    // Manuel kart silme fonksiyonu
    function manuelKartSil(kartAdi, haftaIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        alert('Hasta veya hafta verisi bulunamadƒ±!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      if (!hafta.manuelKartlar) return;
      
      // Kartƒ± listeden √ßƒ±kar
      hafta.manuelKartlar = hafta.manuelKartlar.filter(kart => kart.name !== kartAdi);
      
      console.log('üóëÔ∏è Manuel kart silindi:', kartAdi);
      
      // Verileri kaydet
      saveToStorage();
      hastayiAyriKaydet(seciliHasta);
      
      // Sidebar'ƒ± g√ºncelle
      haftaTabSecildiginde(haftaIndex);
      
      // Yemek analizini g√ºncelle
      updateYemekAnalizi();
    }
    
    // √áoklu PDF kartƒ±nƒ± silme fonksiyonu
    function cokluPdfKartSil(kartAdi, haftaIndex, veriIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        alert('Hasta veya hafta verisi bulunamadƒ±!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      if (!hafta.cokluPdfVerileri || !hafta.cokluPdfVerileri[veriIndex]) return;
      
      const pdfVeri = hafta.cokluPdfVerileri[veriIndex];
      if (!pdfVeri.tarifKartlar) return;
      
      // Kartƒ± listeden √ßƒ±kar
      pdfVeri.tarifKartlar = pdfVeri.tarifKartlar.filter(kart => kart.name !== kartAdi);
      
      console.log('üóëÔ∏è √áoklu PDF kartƒ± silindi:', kartAdi);
      
      // Verileri kaydet
      saveToStorage();
      hastayiAyriKaydet(seciliHasta);
      
      // Sidebar'ƒ± g√ºncelle
      haftaTabSecildiginde(haftaIndex);
      
      // Yemek analizini g√ºncelle
      updateYemekAnalizi();
    }
    
    // Global olarak eri≈üilebilir yap
    window.manuelKartEklemeModalAc = manuelKartEklemeModalAc;
    window.manuelKartModalKapat = manuelKartModalKapat;
    window.manuelKartAramaYap = manuelKartAramaYap;
    window.manuelKartToggle = manuelKartToggle;
    window.secilenManuelKartlariEkle = secilenManuelKartlariEkle;
    window.manuelKartSil = manuelKartSil;
    window.cokluPdfKartSil = cokluPdfKartSil;

    // ========================
    // S√úR√úKLENEBƒ∞Lƒ∞R SIDEBAR
    // ========================
    
    function initResizableSidebars() {
      const container = document.querySelector('.main-container');
      const leftHandle = document.getElementById('leftHandle');
      const rightHandle = document.getElementById('rightHandle');
      
      let isResizing = false;
      let currentHandle = null;
      
      // Sol ayƒ±rƒ±cƒ± i√ßin
      leftHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        currentHandle = 'left';
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });
      
      // Saƒü ayƒ±rƒ±cƒ± i√ßin
      rightHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        currentHandle = 'right';
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });
      
      // Mouse move
      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const containerRect = container.getBoundingClientRect();
        const mouseX = e.clientX - containerRect.left;
        
        if (currentHandle === 'left') {
          // Sol sidebar geni≈üliƒüini ayarla (min: 200px, max: 400px)
          const newLeftWidth = Math.max(200, Math.min(400, mouseX));
          container.style.gridTemplateColumns = `${newLeftWidth}px 4px 1fr 4px 200px`;
        } else if (currentHandle === 'right') {
          // Saƒü sidebar geni≈üliƒüini ayarla (min: 200px, max: 500px)
          const newRightWidth = Math.max(200, Math.min(500, containerRect.width - mouseX));
          container.style.gridTemplateColumns = `280px 4px 1fr 4px ${newRightWidth}px`;
        }
      });
      
      // Mouse up
      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          currentHandle = null;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    }
    
    // Sayfa y√ºklendiƒüinde ba≈ülat
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
    // === YEMEK KULLANIM ANALƒ∞Zƒ∞ FONKSIYONLARI ===
    
    function siralaYemekAnalizi(tip) {
      yemekAnaliziSiralama = tip;
      updateYemekAnalizi();
    }
    
    // Sƒ±ralama fonksiyonunu global yap
    window.siralaYemekAnalizi = siralaYemekAnalizi;
    
    function updateYemekAnalizi() {
      console.log('üìä updateYemekAnalizi fonksiyonu √ßaƒürƒ±ldƒ±');
      
      if (!seciliHasta || !seciliHasta.haftalar) {
        document.getElementById('yemekAnaliziListe').innerHTML = 
          '<div style="text-align: center; color: #666; padding: 20px;">Hasta se√ßilmemi≈ü</div>';
        return;
      }
      
      // aktifHaftaIndex null ise en son haftayƒ± al
      if (aktifHaftaIndex === null || aktifHaftaIndex === undefined) {
        aktifHaftaIndex = seciliHasta.haftalar.length - 1;
        console.log('‚ö†Ô∏è aktifHaftaIndex null, en son hafta atandƒ±:', aktifHaftaIndex);
      }
      
      // Hafta index sƒ±nƒ±rlarƒ±nƒ± kontrol et
      if (aktifHaftaIndex < 0 || aktifHaftaIndex >= seciliHasta.haftalar.length) {
        aktifHaftaIndex = seciliHasta.haftalar.length - 1;
        console.log('‚ö†Ô∏è aktifHaftaIndex sƒ±nƒ±r dƒ±≈üƒ±, d√ºzeltildi:', aktifHaftaIndex);
      }
      
      // T√ºm tarif kartlarƒ± yoksa veya y√ºklenmediyse yeniden y√ºkleme dene
      if (!window.tarifKartlari || window.tarifKartlari.length === 0) {
        console.log('‚ö†Ô∏è Tarif kartlarƒ± y√ºklenmemi≈ü, yeniden y√ºkleme deneniyor...');
        
        // Tarif kartlarƒ±nƒ± yeniden y√ºkleme dene
        if (typeof loadTarifKartlariFromGitHub === 'function') {
          loadTarifKartlariFromGitHub().then(() => {
            console.log('‚úÖ Tarif kartlarƒ± yeniden y√ºklendi, analiz tekrar deneniyor');
            setTimeout(() => updateYemekAnalizi(), 1000); // 1 saniye sonra tekrar dene
          }).catch(err => {
            console.error('‚ùå Tarif kartlarƒ± yeniden y√ºklenemedi:', err);
          });
        }
        
        document.getElementById('yemekAnaliziListe').innerHTML = 
          '<div style="text-align: center; color: #dc3545; padding: 20px;">Tarif kartlarƒ± y√ºklenmeyi bekliyor... <br><small>GitHub\'dan tarif kartlarƒ± √ßekiliyor</small></div>';
        return;
      }
      
      const aktifHafta = seciliHasta.haftalar[aktifHaftaIndex];
      const aktifHaftaNo = aktifHafta ? (aktifHafta.haftaNo || (aktifHaftaIndex + 1)) : 1;
      
      console.log('üìä Yemek analizi ba≈ülatƒ±lƒ±yor:', {
        hastaId: seciliHasta.id,
        aktifHaftaIndex,
        aktifHaftaNo,
        toplamTarifKartSayisi: window.tarifKartlari.length
      });
      
      // T√úM tarif kartlarƒ± i√ßin kullanƒ±m sayacƒ± ba≈ülat
      const yemekKullanimlari = {};
      
      // √ñnce t√ºm tarif kartlarƒ±nƒ± 0 ile ba≈ülat
      window.tarifKartlari.forEach(kart => {
        const yemekAdi = kart.replace('.jpg', '').replace(/_/g, ' ');
        yemekKullanimlari[yemekAdi] = { sayac: 0, haftalar: [] };
      });
      
      console.log('üîÑ Yemek analizi ba≈ülatƒ±ldƒ±:', {
        hasta: seciliHasta.ad,
        haftaSayisi: seciliHasta.haftalar.length,
        aktifHafta: aktifHaftaNo,
        analizEdilenHaftalar: seciliHasta.haftalar.filter((_, index) => (index + 1) <= aktifHaftaNo).length
      });
      
      // Se√ßili haftaya kadar olan t√ºm haftalarƒ± kontrol et
      seciliHasta.haftalar.forEach((hafta, index) => {
        const haftaNo = hafta.haftaNo || (index + 1);
        
        // Sadece se√ßili haftaya kadar olan haftalarƒ± say
        if (haftaNo <= aktifHaftaNo) {
          const haftaninYemekleri = new Set(); // Aynƒ± hafta i√ßinde tekrar saymamasƒ± i√ßin Set kullan
          
          console.log(`üîç Hafta ${haftaNo} analiz ediliyor:`, {
            tarifKartlar: hafta.tarifKartlar?.length || 0,
            manuelKartlar: hafta.manuelKartlar?.length || 0,
            cokluPdfVerileri: hafta.cokluPdfVerileri?.length || 0,
            tarifKartlarVeriTipi: hafta.tarifKartlar ? typeof hafta.tarifKartlar[0] : 'undefined',
            tarifKartlarOrnek: hafta.tarifKartlar ? hafta.tarifKartlar.slice(0, 2) : [],
            manuelKartlarOrnek: hafta.manuelKartlar ? hafta.manuelKartlar.slice(0, 2) : []
          });
          
          // 1. Otomatik e≈üle≈üen kartlar (Manuel PDF y√ºkleme + √áoklu PDF otomatik e≈üle≈ütirme)
          if (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) {
            hafta.tarifKartlar.forEach(kart => {
              let kartAdi = null;
              
              // Farklƒ± veri yapƒ±larƒ±nƒ± kontrol et
              if (typeof kart === 'string') {
                kartAdi = kart; // Direkt string
              } else if (kart.name) {
                kartAdi = kart.name; // {name: "kart_adi.jpg"}
              } else if (kart.kartResmi) {
                kartAdi = kart.kartResmi; // {kartResmi: "kart_adi.jpg"}
              }
              
              if (kartAdi) {
                const yemekAdi = kartAdi.replace('.jpg', '').replace(/_/g, ' ');
                haftaninYemekleri.add(yemekAdi);
                console.log(`‚úÖ Otomatik e≈üle≈üen: ${yemekAdi}`);
              }
            });
          }
          
          // 2. Manuel eklenen kartlar (Sidebar'dan manuel ekleme)
          if (hafta.manuelKartlar && hafta.manuelKartlar.length > 0) {
            hafta.manuelKartlar.forEach(kart => {
              let kartAdi = null;
              
              // Farklƒ± veri yapƒ±larƒ±nƒ± kontrol et
              if (typeof kart === 'string') {
                kartAdi = kart; // Direkt string
              } else if (kart.name) {
                kartAdi = kart.name; // {name: "kart_adi.jpg"}
              }
              
              if (kartAdi) {
                const yemekAdi = kartAdi.replace('.jpg', '').replace(/_/g, ' ');
                haftaninYemekleri.add(yemekAdi);
                console.log(`‚úÖ Manuel eklenen: ${yemekAdi}`);
              }
            });
          }
          
          // 3. √áoklu PDF'den eklenen kartlar (Eski yapƒ± - geriye uyumluluk)
          if (hafta.cokluPdfVerileri && hafta.cokluPdfVerileri.length > 0) {
            hafta.cokluPdfVerileri.forEach(veri => {
              if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
                veri.tarifKartlar.forEach(kart => {
                  let kartAdi = null;
                  
                  // Farklƒ± veri yapƒ±larƒ±nƒ± kontrol et
                  if (typeof kart === 'string') {
                    kartAdi = kart; // Direkt string
                  } else if (kart.name) {
                    kartAdi = kart.name; // {name: "kart_adi.jpg"}
                  } else if (kart.kartResmi) {
                    kartAdi = kart.kartResmi; // {kartResmi: "kart_adi.jpg"}
                  }
                  
                  if (kartAdi) {
                    const yemekAdi = kartAdi.replace('.jpg', '').replace(/_/g, ' ');
                    haftaninYemekleri.add(yemekAdi);
                    console.log(`‚úÖ √áoklu PDF (eski): ${yemekAdi}`);
                  }
                });
              }
            });
          }
          
          // Her hafta i√ßin toplam e≈üsiz yemek sayƒ±sƒ±nƒ± raporla  
          console.log(`üìä Hafta ${haftaNo} toplam e≈üsiz yemek: ${haftaninYemekleri.size}`);
          
          // Bu haftada kullanƒ±lan her benzersiz yemeƒüi kaydet
          haftaninYemekleri.forEach(yemekAdi => {
            if (yemekKullanimlari[yemekAdi]) {
              yemekKullanimlari[yemekAdi].sayac++;
              yemekKullanimlari[yemekAdi].haftalar.push(haftaNo);
            }
          });
        }
      });
      
      console.log('üìä Toplam analiz edilen yemek sayƒ±sƒ±:', Object.keys(yemekKullanimlari).length);
      console.log('üìã Analiz edilen yemekler:', Object.keys(yemekKullanimlari));
      
      // Debug: Hasta verilerinin yapƒ±sƒ±nƒ± incele
      console.log('üîç Hasta veri yapƒ±sƒ± analizi:', {
        hastalar: Object.keys(window.hastalar || {}),
        seciliHasta: seciliHasta?.ad || 'Se√ßili deƒüil',
        haftaSayisi: seciliHasta?.haftalar?.length || 0,
        aktifHafta: aktifHaftaNo
      });
      
      // Sonu√ßlarƒ± diziye √ßevir ve sƒ±rala
      let yemekListesi = Object.keys(yemekKullanimlari).map(yemekAdi => ({
        ad: yemekAdi,
        sayac: yemekKullanimlari[yemekAdi].sayac,
        haftalar: yemekKullanimlari[yemekAdi].haftalar.sort((a,b) => a-b)
      }));
      
      // Sƒ±ralama yap
      if (yemekAnaliziSiralama === 'cok') {
        yemekListesi.sort((a, b) => b.sayac - a.sayac || a.ad.localeCompare(b.ad));
      } else if (yemekAnaliziSiralama === 'az') {
        yemekListesi.sort((a, b) => a.sayac - b.sayac || a.ad.localeCompare(b.ad));
      } else if (yemekAnaliziSiralama === 'hic') {
        // √ñnce hi√ß kullanƒ±lmayanlar (0), sonra kullanƒ±lanlar az->√ßok
        yemekListesi.sort((a, b) => {
          if (a.sayac === 0 && b.sayac === 0) return a.ad.localeCompare(b.ad);
          if (a.sayac === 0) return -1;
          if (b.sayac === 0) return 1;
          return a.sayac - b.sayac || a.ad.localeCompare(b.ad);
        });
      } else { // alfabetik
        yemekListesi.sort((a, b) => a.ad.localeCompare(b.ad));
      }
      
      // Aktif buton stilini g√ºncelle
      document.querySelectorAll('[id^="btn"]').forEach(btn => {
        btn.style.background = '#6c757d';
      });
      
      if (yemekAnaliziSiralama === 'cok') document.getElementById('btnCok').style.background = '#28a745';
      else if (yemekAnaliziSiralama === 'az') document.getElementById('btnAz').style.background = '#dc3545';
      else if (yemekAnaliziSiralama === 'hic') document.getElementById('btnHic').style.background = '#6c757d';
      else document.getElementById('btnAlfabetik').style.background = '#17a2b8';
      
      // HTML olu≈ütur
      const listeDiv = document.getElementById('yemekAnaliziListe');
      const kullanilmayanSayisi = yemekListesi.filter(y => y.sayac === 0).length;
      const kullanilanSayisi = yemekListesi.filter(y => y.sayac > 0).length;
      
      let html = `<div style="background: #f8f9fa; padding: 10px; margin-bottom: 10px; font-weight: bold; color: #333; border-bottom: 1px solid #ddd;">
        ${aktifHaftaNo}. haftaya kadar ‚Ä¢ Toplam: ${yemekListesi.length} tarif ‚Ä¢ Kullanƒ±lan: ${kullanilanSayisi} ‚Ä¢ Kullanƒ±lmayan: ${kullanilmayanSayisi}
      </div>`;
      
      yemekListesi.forEach(yemek => {
        let renkKodu, durum;
        if (yemek.sayac === 0) {
          renkKodu = '#6c757d';
          durum = 'KULLANILMADI';
        } else if (yemek.sayac >= 5) {
          renkKodu = '#28a745';
          durum = '√áOK KULLANILDI';
        } else if (yemek.sayac >= 3) {
          renkKodu = '#ffc107';
          durum = 'ORTA SEVƒ∞YE';
        } else {
          renkKodu = '#dc3545';
          durum = 'AZ KULLANILDI';
        }
        
        const haftalarStr = yemek.sayac > 0 ? yemek.haftalar.join('-') : '';
        
        html += `
          <div style="display: flex; align-items: center; padding: 8px 12px; border-bottom: 1px solid #f0f0f0; background: white; margin-bottom: 1px;">
            <span style="background: ${renkKodu}; color: white; border-radius: 50%; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 12px; min-width: 30px;">
              ${yemek.sayac}
            </span>
            <span style="flex: 1; font-weight: 500; color: #333; margin-right: 10px;">
              ${yemek.ad}
            </span>
            ${yemek.sayac > 0 ? 
              `<span style="font-size: 11px; color: #666; background: #e9ecef; padding: 3px 8px; border-radius: 12px; margin-right: 8px;">
                ${haftalarStr}
              </span>` : ''
            }
            <span style="font-size: 10px; color: ${renkKodu}; font-weight: bold; min-width: 80px; text-align: right;">
              ${durum}
            </span>
          </div>
        `;
      });
      
      listeDiv.innerHTML = html;
      
      // Accordion ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
      const analizBaslik = document.getElementById('analizBaslik');
      if (analizBaslik) {
        analizBaslik.textContent = `üìä Yemek Kullanƒ±m Analizi (${kullanilanSayisi}/${yemekListesi.length})`;
      }
      
      // Toplam bilgi elementi artƒ±k accordion sisteminde yok, kaldƒ±rƒ±ldƒ±
      // document.getElementById('analizToplamBilgi').textContent = 
      //   `${yemekListesi.length} tarif ‚Ä¢ ${kullanilanSayisi} kullanƒ±lan`;
    }
    
    // Analiz fonksiyonunu da global yap
    window.updateYemekAnalizi = updateYemekAnalizi;

    // üéØ ACCORDION Sƒ∞STEMƒ∞
    function toggleAccordion(section) {
      const sections = ['eslesen', 'eslesmeyenler', 'analiz'];
      
      sections.forEach(s => {
        const content = document.getElementById(s + 'Content');
        const icon = document.getElementById(s + 'Icon');
        
        if (s === section) {
          // Se√ßilen b√∂l√ºm√º a√ß/kapat
          const isOpen = content.style.display === 'block';
          content.style.display = isOpen ? 'none' : 'block';
          icon.textContent = isOpen ? '‚ñ∂' : '‚ñº';
        } else {
          // Diƒüer b√∂l√ºmleri kapat
          content.style.display = 'none';
          icon.textContent = '‚ñ∂';
        }
      });
    }
    
    // Global accordion fonksiyonu
    window.toggleAccordion = toggleAccordion;

    // üìÅ √áOKLU PDF UPLOAD Sƒ∞STEMƒ∞
    function parseProfessionalPdfName(fileName) {
      // T√ºrk√ße karakterleri normalize et
      fileName = fileName.replace(/[ƒ∞ƒ±ƒûƒü√ú√º≈û≈ü√ñ√∂√á√ß]/g, (match) => {
        const map = {'ƒ∞': 'I', 'ƒ±': 'i', 'ƒû': 'G', 'ƒü': 'g', '√ú': 'U', '√º': 'u', '≈û': 'S', '≈ü': 's', '√ñ': 'O', '√∂': 'o', '√á': 'C', '√ß': 'c'};
        return map[match] || match;
      });

      // T√ºrk√ße ay isimleri mapping
      const aylar = {
        'OCAK': 1, 'SUBAT': 2, 'MART': 3, 'NISAN': 4,
        'MAYIS': 5, 'HAZIRAN': 6, 'TEMMUZ': 7, 'AGUSTOS': 8,
        'EYLUL': 9, 'EKIM': 10, 'KASIM': 11, 'ARALIK': 12
      };

      // Regex pattern - Birden fazla format desteƒüi
      const patterns = [
        // ESƒ∞N KARAKU≈û 28 TEMMUZ -3 AƒûUSTOS 17. HAFTA
        /^(.+?)\s+(\d{1,2})\s+(\w+)\s*-\s*(\d{1,2})\s+(\w+)\s+(\d+)\.\s*HAFTA/i,
        // DERYA BAYINDIR 9-15 HAZƒ∞RAN 11. HAFTA
        /^(.+?)\s+(\d{1,2})\s*-\s*(\d{1,2})\s+(\w+)\s+(\d+)\.\s*HAFTA/i,
        // DERYA BAYINDIR 2-8 HAZƒ∞RAN 10.HAFTA (bo≈üluksuz)
        /^(.+?)\s+(\d{1,2})\s*-\s*(\d{1,2})\s+(\w+)\s+(\d+)\.HAFTA/i
      ];
      
      for (let pattern of patterns) {
        const match = fileName.replace('.pdf', '').match(pattern);
        
        if (match) {
          if (match.length === 7) {
            // Format: HASTA ADI GUN1 AY1 - GUN2 AY2 HAFTA
            const [_, hastaAdi, gun1, ay1, gun2, ay2, haftaNo] = match;
            return {
              hastaAdi: hastaAdi.trim(),
              baslangicTarihi: `${gun1} ${ay1}`,
              bitisTarihi: `${gun2} ${ay2}`,
              haftaNo: parseInt(haftaNo),
              tarihAraligi: `${gun1} ${ay1} - ${gun2} ${ay2}`
            };
          } else if (match.length === 6) {
            // Format: HASTA ADI GUN1-GUN2 AY HAFTA
            const [_, hastaAdi, gun1, gun2, ay, haftaNo] = match;
            return {
              hastaAdi: hastaAdi.trim(),
              baslangicTarihi: `${gun1} ${ay}`,
              bitisTarihi: `${gun2} ${ay}`,
              haftaNo: parseInt(haftaNo),
              tarihAraligi: `${gun1}-${gun2} ${ay}`
            };
          }
        }
      }
      
      return null;
    }

    function findOrCreateHasta(hastaAdi) {
      // Null/undefined check
      if (!hastaAdi || typeof hastaAdi !== 'string') {
        console.error('‚ùå Ge√ßersiz hasta adƒ±:', hastaAdi);
        return null;
      }

      // hastalar array kontrol
      if (!hastalar || !Array.isArray(hastalar)) {
        console.error('‚ùå hastalar array tanƒ±mlƒ± deƒüil, bo≈ü array olu≈üturuluyor');
        window.hastalar = [];
      }

      console.log('üîç findOrCreateHasta √ßaƒürƒ±ldƒ±:', hastaAdi, 'Mevcut hasta sayƒ±sƒ±:', hastalar.length);

      // Mevcut hastalar arasƒ±nda ara
      let mevcutHasta = hastalar.find(h => {
        console.log('üîç Hasta kontrol:', h);
        return h && h.ad && h.ad.toLowerCase() === hastaAdi.toLowerCase();
      });
      
      if (!mevcutHasta) {
        // Yeni hasta olu≈ütur
        const yeniHastaId = 'hasta_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        mevcutHasta = {
          id: yeniHastaId,
          ad: hastaAdi,
          haftalar: []
        };
        hastalar.push(mevcutHasta);
        console.log('‚úÖ Yeni hasta olu≈üturuldu:', hastaAdi);
      }
      
      return mevcutHasta;
    }

    function findOrCreateHafta(hasta, haftaNo, tarihAraligi) {
      // Mevcut hafta var mƒ± kontrol et
      let mevcutHafta = hasta.haftalar.find(h => h.haftaNo === haftaNo);
      
      if (!mevcutHafta) {
        // Yeni hafta olu≈ütur
        mevcutHafta = {
          haftaNo: haftaNo,
          tarihAraligi: tarihAraligi,
          tarifler: [],
          tarifKartlar: [],
          manuelKartlar: [],
          gptMesaj: '',
          aciklama: ''
        };
        hasta.haftalar.push(mevcutHafta);
        
        // Hafta sƒ±rasƒ±na g√∂re sƒ±rala
        hasta.haftalar.sort((a, b) => a.haftaNo - b.haftaNo);
        
        console.log(`‚úÖ ${hasta.ad} i√ßin ${haftaNo}. hafta olu≈üturuldu (${tarihAraligi})`);
      }
      
      return mevcutHafta;
    }

    // üîß YARDIMCI FONKSƒ∞YONLAR
    function extractTariflerFromText(pdfText) {
      if (!pdfText) return [];
      
      // Basit tarif √ßƒ±karma - satƒ±rlarƒ± al ve temizle
      const satirlar = pdfText.split('\n').filter(satir => 
        satir.trim().length > 2 && 
        !satir.includes('HAFTA') && 
        !satir.includes('TEMMUZ') &&
        !satir.includes('AƒûUSTOS')
      );
      
      console.log('üìù PDF\'den √ßƒ±karƒ±lan tarifler:', satirlar.length);
      return satirlar.slice(0, 20); // ƒ∞lk 20 satƒ±rƒ± al
    }

    async function extractPdfText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map(item => item.str).join(' ');
              fullText += pageText + '\n';
            }
            
            resolve(fullText);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = () => reject(new Error('PDF okuma hatasƒ±'));
        reader.readAsArrayBuffer(file);
      });
    }

    async function performTarifEslestirmesi(hafta, hasta) {
      if (!hafta.tarifler || hafta.tarifler.length === 0) {
        return;
      }

      console.log(`üîó ${hasta.ad} ${hafta.haftaNo}. hafta: tarif e≈üle≈ütirmesi ba≈ülatƒ±ldƒ±`);
      
      // Basit e≈üle≈ütirme - mevcut tarif kartlarƒ± ile kar≈üƒ±la≈ütƒ±r
      if (window.tarifKartlari && window.tarifKartlari.length > 0) {
        hafta.tarifKartlar = [];
        
        // Her tarifi kontrol et
        hafta.tarifler.forEach(tarif => {
          const eslesen = window.tarifKartlari.find(kart => {
            const kartAdi = kart.replace('.jpg', '').replace(/_/g, ' ').toLowerCase();
            return tarif.toLowerCase().includes(kartAdi) || kartAdi.includes(tarif.toLowerCase());
          });
          
          if (eslesen) {
            hafta.tarifKartlar.push({ name: eslesen });
          }
        });
        
        console.log(`üîó ${hasta.ad} ${hafta.haftaNo}. hafta: ${hafta.tarifKartlar.length} tarif e≈üle≈üti`);
      }
    }

    // √áoklu PDF sonu√ßlarƒ±nƒ± g√∂ster
    function showCokluPdfSonuclari(sonuclar, basarili, hatali) {
      const mesajlar = [];
      
      sonuclar.forEach(sonuc => {
        if (sonuc.durum === 'BA≈ûARILI') {
          mesajlar.push(`‚úÖ ${sonuc.dosya} ‚Üí ${sonuc.hasta} (${sonuc.hafta}. hafta) - ${sonuc.tarifSayisi || 0} tarif, ${sonuc.eslesmeSayisi || 0} e≈üle≈üme`);
        } else {
          mesajlar.push(`‚ùå ${sonuc.dosya} ‚Üí ${sonuc.mesaj}`);
        }
      });
      
      const rapor = `
üìÅ √áOKLU PDF ƒ∞≈ûLEME RAPORU

‚úÖ Ba≈üarƒ±lƒ±: ${basarili}
‚ùå Hatalƒ±: ${hatali}
üìä Toplam: ${sonuclar.length}

DETAYLAR:
${mesajlar.join('\n')}
      `;
      
      // Raporu modal olarak g√∂ster
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
          <h3>üìÅ PDF ƒ∞≈üleme Sonu√ßlarƒ±</h3>
          <pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; white-space: pre-wrap; font-size: 12px;">${rapor}</pre>
          <button onclick="this.closest('.modal').remove()" style="margin-top: 15px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Kapat</button>
        </div>
      `;
      
      modal.className = 'modal';
      document.body.appendChild(modal);
      
      // Modal dƒ±≈üƒ±na tƒ±klanƒ±rsa kapat
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      console.log('üìä PDF i≈üleme raporu g√∂sterildi');
    }

    // Global eri≈üim i√ßin
    window.showCokluPdfSonuclari = showCokluPdfSonuclari;

    // Hasta listesini g√ºncelle (sidebar'ƒ± yenile)
    function updateHastaListesi() {
      console.log('üîÑ Hasta listesi g√ºncelleniyor...');
      
      // Yeni sistem hasta listesini kullan
      if (typeof renderHastalarYeniSistem === 'function') {
        console.log('‚úÖ Yeni sisteme y√∂nlendiriliyor...');
        renderHastalarYeniSistem();
        return;
      }
      
      // Fallback: Eski sistem
      const hastaListesiDiv = document.getElementById('hastaListesi');
      if (!hastaListesiDiv) {
        console.warn('‚ö†Ô∏è hastaListesi elementi bulunamadƒ±');
        return;
      }
      
      // GitHub'dan gelen hasta listesini kullan
      const aktifHastalar = window.hastalar || [];
      console.log(`‚úÖ Hasta listesi g√ºncellendi: ${aktifHastalar.length} hasta`);
      
      // Bu fonksiyon artƒ±k renderHastalarYeniSistem'e y√∂nlendiriyor
      // Detaylar o fonksiyonda i≈üleniyor
    }

    // Global eri≈üim i√ßin
    window.updateHastaListesi = updateHastaListesi;

    // Hasta se√ßildiƒüinde √ßaƒürƒ±lan fonksiyon
    async function hastaSecildi(index) {
      seciliHasta = hastalar[index];
      console.log('üë§ Hasta se√ßildi:', seciliHasta.isim);
      
      // UI'ƒ± g√ºncelle
      updateHastaListesi(); // Se√ßimi g√ºncelle
      if (typeof renderHastalarYeniSistem === 'function') {
        await renderHastalarYeniSistem(); // Ana i√ßeriƒüi g√ºncelle
      }
    }

    // Global eri≈üim i√ßin
    window.hastaSecildi = hastaSecildi;

    //  Ô∏è TOPLU ZIP FONKSƒ∞YONU
    async function topluZipIndir() {
      try {
        console.log('üöÄ Toplu ZIP indirme ba≈ülatƒ±ldƒ±');
        
        // GitHub token kontrol√º
        const tokenElement = document.getElementById('githubToken');
        const repoElement = document.getElementById('githubRepo');
        
        const GITHUB_TOKEN = tokenElement ? tokenElement.value.trim() : '';
        const GITHUB_REPO = repoElement ? repoElement.value.trim() || 'mustafasacar35/nutrition-planner' : 'mustafasacar35/nutrition-planner';
        
        if (!GITHUB_TOKEN) {
          alert('GitHub token ayarlanmamƒ±≈ü. L√ºtfen √∂nce GitHub token\'ƒ±nƒ±zƒ± girin.');
          return;
        }
        
        // Hasta listesini al (GitHub'dan direkt y√ºkle)
        console.log('üìã Hasta listesi y√ºkleniyor...');
        const tumHastalar = await hastaListesiYukle();
        
        if (!tumHastalar || tumHastalar.length === 0) {
          alert('Hasta listesi y√ºklenmemi≈ü! L√ºtfen GitHub token\'ƒ±nƒ±zƒ± kontrol edin.');
          return;
        }
        
        const aktifHastalar = tumHastalar.filter(hasta => !hasta.arsiv);
        
        if (aktifHastalar.length === 0) {
          alert('Aktif hasta bulunamadƒ±!');
          return;
        }
        
        console.log(`üìä ${aktifHastalar.length} aktif hasta bulundu`);
        
        // Ana ZIP dosyasƒ±nƒ± olu≈ütur
        const anaZip = new JSZip();
        const bugununTarihi = new Date().toISOString().slice(0,10);
        const anaZipAdi = `TOPLU_HASTA_ZIP_${bugununTarihi}.zip`;
        
        // Progress g√∂sterimi
        const progressDiv = document.createElement('div');
        progressDiv.style.cssText = `
          position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
          background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
          z-index: 10000; min-width: 400px; text-align: center;
        `;
        progressDiv.innerHTML = `
          <h3>üóúÔ∏è Toplu ZIP Hazƒ±rlanƒ±yor...</h3>
          <div id="progressBar" style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
            <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s;"></div>
          </div>
          <div id="progressText">0 / ${aktifHastalar.length}</div>
          <div id="currentHasta" style="margin-top: 10px; font-weight: bold; color: #666;"></div>
        `;
        document.body.appendChild(progressDiv);
        
        let basariliHastalar = 0;
        let hataliHastalar = 0;
        
        // Her hasta i√ßin i≈ülem yap
        for (let i = 0; i < aktifHastalar.length; i++) {
          const hasta = aktifHastalar[i];
          
          // Progress g√ºncelle
          const progress = ((i + 1) / aktifHastalar.length) * 100;
          document.getElementById('progressFill').style.width = progress + '%';
          document.getElementById('progressText').textContent = `${i + 1} / ${aktifHastalar.length}`;
          document.getElementById('currentHasta').textContent = `ƒ∞≈üleniyor: ${hasta.isim}`;
          
          try {
            console.log(`üë§ ${hasta.isim} i≈üleniyor...`);
            
            // Hasta verilerini al
            const hastaData = await getHastaData(hasta.id, GITHUB_REPO, GITHUB_TOKEN, hasta.isim);
            if (!hastaData || !hastaData.haftalar) {
              console.warn(`‚ö†Ô∏è ${hasta.isim} i√ßin veri bulunamadƒ±`);
              hataliHastalar++;
              continue;
            }
            
            // En b√ºy√ºk hafta numarasƒ±nƒ± bul
            const haftalar = hastaData.haftalar || [];
            let enBuyukHafta = null;
            let enBuyukHaftaNo = 0;
            
            haftalar.forEach(hafta => {
              const haftaNo = hafta.haftaNo || 0;
              if (haftaNo > enBuyukHaftaNo) {
                enBuyukHaftaNo = haftaNo;
                enBuyukHafta = hafta;
              }
            });
            
            if (!enBuyukHafta) {
              console.warn(`‚ö†Ô∏è ${hasta.isim} i√ßin hafta verisi bulunamadƒ±`);
              hataliHastalar++;
              continue;
            }
            
            console.log(`üìÖ ${hasta.isim} - En b√ºy√ºk hafta: ${enBuyukHaftaNo}`);
            
            // Hasta klas√∂r√º olu≈ütur - men√º PDF adƒ±nƒ± kullan
            let hastaKlasorAdi = hasta.isim.toUpperCase().replace(/\s/g, '_').replace(/[ƒ∞ƒ±√á√ßƒûƒü√ú√º≈û≈ü√ñ√∂]/g, match => {
              const trMap = {'ƒ∞': 'I', 'ƒ±': 'i', '√á': 'C', '√ß': 'c', 'ƒû': 'G', 'ƒü': 'g', '√ú': 'U', '√º': 'u', '≈û': 'S', '≈ü': 's', '√ñ': 'O', '√∂': 'o'};
              return trMap[match] || match;
            });
            
            // Sadece en b√ºy√ºk hafta i√ßin men√º PDF'sini ekle
            if (enBuyukHafta.githubUrl || enBuyukHafta.indirmeUrl || (enBuyukHafta.pdf && (enBuyukHafta.pdfName || enBuyukHafta.pdfOrijinalIsim))) {
              try {
                let pdfFileName = enBuyukHafta.pdfName || enBuyukHafta.pdfOrijinalIsim;
                
                // Klas√∂r adƒ±nƒ± men√º PDF adƒ±yla deƒüi≈ütir (MENU_ prefix'i olmadan)
                if (pdfFileName) {
                  hastaKlasorAdi = pdfFileName.replace('.pdf', '');
                }
                
                console.log(`üìÑ ${hasta.isim} - En b√ºy√ºk hafta (${enBuyukHaftaNo}) men√º PDF'i indiriliyor`);
                
                // Raw GitHub URL'sini kullan
                let pdfUrl;
                if (enBuyukHafta.githubUrl) {
                  // githubUrl varsa raw formatƒ±na √ßevir
                  pdfUrl = enBuyukHafta.githubUrl
                    .replace('github.com', 'raw.githubusercontent.com')
                    .replace('/blob/', '/');
                  // PDF dosya adƒ±nƒ± URL'den √ßƒ±kar
                  if (!pdfFileName) {
                    pdfFileName = decodeURIComponent(pdfUrl.split('/').pop());
                  }
                } else if (enBuyukHafta.indirmeUrl) {
                  // indirmeUrl varsa raw formatƒ±na √ßevir
                  pdfUrl = enBuyukHafta.indirmeUrl
                    .replace('github.com', 'raw.githubusercontent.com')
                    .replace('/blob/', '/');
                  // PDF dosya adƒ±nƒ± URL'den √ßƒ±kar
                  if (!pdfFileName) {
                    pdfFileName = decodeURIComponent(pdfUrl.split('/').pop());
                  }
                } else {
                  // Standart raw format ile dene
                  const encodedFileName = encodeURIComponent(pdfFileName);
                  pdfUrl = `https://raw.githubusercontent.com/mustafasacar35/nutrition-planner/main/pdfs/${encodedFileName}`;
                }
                
                console.log(`  PDF URL: ${pdfUrl}`);
                
                const pdfResponse = await fetch(pdfUrl);
                
                if (pdfResponse.ok) {
                  const pdfBlob = await pdfResponse.blob();
                  anaZip.file(`${hastaKlasorAdi}/MENU_PDF_${pdfFileName}`, pdfBlob);
                  console.log(`‚úÖ ${hasta.isim} - Men√º PDF eklendi: ${pdfFileName}`);
                } else {
                  console.warn(`‚ùå ${hasta.isim} - Men√º PDF indirilemedi (${pdfResponse.status}): ${pdfUrl}`);
                }
              } catch (error) {
                console.warn(`‚ùå ${hasta.isim} - Men√º PDF eklenemedi:`, error);
              }
            } else {
              console.log(`‚ÑπÔ∏è ${hasta.isim} - En b√ºy√ºk hafta i√ßin PDF verisi yok (githubUrl: ${!!enBuyukHafta.githubUrl}, indirmeUrl: ${!!enBuyukHafta.indirmeUrl}, pdf: ${!!enBuyukHafta.pdf}, pdfName: ${!!enBuyukHafta.pdfName})`);
            }
            
            // Tarif kartlarƒ±nƒ± ekle
            if (enBuyukHafta.tarifKartlar && enBuyukHafta.tarifKartlar.length > 0) {
              console.log(`üîç ${hasta.isim} - Tarif kartlarƒ±:`, enBuyukHafta.tarifKartlar);
              for (const kart of enBuyukHafta.tarifKartlar) {
                try {
                  console.log(`üîç ${hasta.isim} - Kart objesi:`, kart);
                  // Doƒüru √∂zellik adƒ±nƒ± kullan: kartData
                  const kartUrl = kart.kartData || kart.data;
                  if (!kartUrl) {
                    console.warn(`‚ö†Ô∏è ${hasta.isim} - Kart URL'si bulunamadƒ±:`, kart);
                    continue;
                  }
                  const response = await fetch(kartUrl);
                  if (response.ok) {
                    const blob = await response.blob();
                    const fileName = kartUrl.split('/').pop() || `tarif_${kart.tarifAdi || 'kart'}.jpg`;
                    anaZip.file(`${hastaKlasorAdi}/${fileName}`, blob);
                    console.log(`‚úÖ ${hasta.isim} - Tarif kartƒ± eklendi:`, fileName);
                  }
                } catch (error) {
                  console.warn(`‚ùå ${hasta.isim} - Tarif kartƒ± eklenemedi:`, kart.tarifAdi || 'bilinmeyen', error);
                }
              }
            }
            
            // Manuel kartlarƒ± ekle
            if (enBuyukHafta.manuelKartlar && enBuyukHafta.manuelKartlar.length > 0) {
              console.log(`üîç ${hasta.isim} - Manuel kartlar:`, enBuyukHafta.manuelKartlar);
              for (const kart of enBuyukHafta.manuelKartlar) {
                try {
                  // Doƒüru √∂zellik adƒ±nƒ± kullan: kartData
                  const kartUrl = kart.kartData || kart.data;
                  if (!kartUrl) {
                    console.warn(`‚ö†Ô∏è ${hasta.isim} - Manuel kart URL'si bulunamadƒ±:`, kart);
                    continue;
                  }
                  const response = await fetch(kartUrl);
                  if (response.ok) {
                    const blob = await response.blob();
                    const fileName = kartUrl.split('/').pop() || `manuel_${kart.tarifAdi || 'kart'}.jpg`;
                    anaZip.file(`${hastaKlasorAdi}/${fileName}`, blob);
                    console.log(`‚úÖ ${hasta.isim} - Manuel kart eklendi:`, fileName);
                  }
                } catch (error) {
                  console.warn(`‚ùå ${hasta.isim} - Manuel kart eklenemedi:`, kart.tarifAdi || 'bilinmeyen', error);
                }
              }
            }
            
            // √áoklu PDF kartlarƒ±nƒ± ekle
            if (enBuyukHafta.cokluPdfVerileri && enBuyukHafta.cokluPdfVerileri.length > 0) {
              console.log(`üîç ${hasta.isim} - √áoklu PDF verileri:`, enBuyukHafta.cokluPdfVerileri);
              for (const veri of enBuyukHafta.cokluPdfVerileri) {
                if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
                  for (const kart of veri.tarifKartlar) {
                    try {
                      // Doƒüru √∂zellik adƒ±nƒ± kullan: kartData
                      const kartUrl = kart.kartData || kart.data;
                      if (!kartUrl) {
                        console.warn(`‚ö†Ô∏è ${hasta.isim} - √áoklu PDF kart URL'si bulunamadƒ±:`, kart);
                        continue;
                      }
                      const response = await fetch(kartUrl);
                      if (response.ok) {
                        const blob = await response.blob();
                        const fileName = kartUrl.split('/').pop() || `coklu_${kart.tarifAdi || 'kart'}.jpg`;
                        anaZip.file(`${hastaKlasorAdi}/${fileName}`, blob);
                        console.log(`‚úÖ ${hasta.isim} - √áoklu PDF kartƒ± eklendi:`, fileName);
                      }
                    } catch (error) {
                      console.warn(`‚ùå ${hasta.isim} - √áoklu PDF kartƒ± eklenemedi:`, kart.tarifAdi || 'bilinmeyen', error);
                    }
                  }
                }
              }
            }
            
            // GPT mesajƒ±nƒ± ekle
            if (enBuyukHafta.gptMesaj && enBuyukHafta.gptMesaj.trim()) {
              anaZip.file(`${hastaKlasorAdi}/GPT_MESAJI.txt`, enBuyukHafta.gptMesaj.trim());
            }
            
            // Lenf masajƒ± planƒ±nƒ± ekle (5. hafta i√ßin)
            if (enBuyukHaftaNo === 5) {
              try {
                await createAndAddLenfMasajPDF(anaZip, hastaData, haftalar, `${hastaKlasorAdi}/`);
              } catch (error) {
                console.warn(`‚ùå ${hasta.isim} - Lenf masajƒ± planƒ± eklenemedi:`, error);
              }
            }
            
            // Egzersiz planƒ±nƒ± ekle (9. hafta i√ßin)
            if (enBuyukHaftaNo === 9) {
              try {
                await createAndAddEgzersizPDF(anaZip, hastaData, haftalar, `${hastaKlasorAdi}/`);
              } catch (error) {
                console.warn(`‚ùå ${hasta.isim} - Egzersiz planƒ± eklenemedi:`, error);
              }
            }
            
            basariliHastalar++;
            console.log(`‚úÖ ${hasta.isim} ba≈üarƒ±yla i≈ülendi`);
            
          } catch (error) {
            console.error(`‚ùå ${hasta.isim} i≈ülenirken hata:`, error);
            hataliHastalar++;
          }
          
          // K√º√ß√ºk delay (performans i√ßin)
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Progress'i kapat
        document.body.removeChild(progressDiv);
        
        if (basariliHastalar === 0) {
          alert('Hi√ßbir hasta ba≈üarƒ±yla i≈ülenemedi!');
          return;
        }
        
        // ZIP dosyasƒ±nƒ± olu≈ütur ve indir
        console.log('üóúÔ∏è ZIP dosyasƒ± olu≈üturuluyor...');
        const zipBlob = await anaZip.generateAsync({type: 'blob'});
        
        // ƒ∞ndirme i≈ülemi
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = anaZipAdi;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Ba≈üarƒ± mesajƒ±
        alert(`üéâ Toplu ZIP ba≈üarƒ±yla olu≈üturuldu!\n\n` +
              `‚úÖ Ba≈üarƒ±lƒ±: ${basariliHastalar} hasta\n` +
              `‚ùå Hatalƒ±: ${hataliHastalar} hasta\n\n` +
              `Dosya adƒ±: ${anaZipAdi}`);
        
        console.log('üéâ Toplu ZIP i≈ülemi tamamlandƒ±!');
        
      } catch (error) {
        console.error('‚ùå Toplu ZIP hatasƒ±:', error);
        alert('Toplu ZIP olu≈üturulurken hata olu≈ütu: ' + error.message);
      }
    }
    
    // Global eri≈üim i√ßin
    window.topluZipIndir = topluZipIndir;

    //  üìÅ ANA √áOKLU PDF FONKSƒ∞YONU
    async function processCokluPdf(files) {
      if (!files || files.length === 0) {
        alert('L√ºtfen en az bir PDF dosyasƒ± se√ßin.');
        return;
      }

      console.log('üìÅ √áoklu PDF i≈ülemi ba≈ülatƒ±ldƒ±:', files.length, 'dosya');
      
      const sonuclar = [];
      let basarili = 0;
      let hatali = 0;

      // Progress g√∂sterimi
      const progressDiv = document.createElement('div');
      progressDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000; min-width: 300px; text-align: center;
      `;
      progressDiv.innerHTML = `
        <h3>üìÅ PDF'ler ƒ∞≈üleniyor...</h3>
        <div id="progressBar" style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
          <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s;"></div>
        </div>
        <div id="progressText">0 / ${files.length}</div>
      `;
      document.body.appendChild(progressDiv);

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = ((i + 1) / files.length) * 100;
        
        // Progress g√ºncelle
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressText').textContent = `${i + 1} / ${files.length}`;
        
        try {
          console.log(`üîç ${i + 1}/${files.length} - "${file.name}" analiz ediliyor...`);
          
          // Dosya adƒ±nƒ± parse et
          const parsed = parseProfessionalPdfName(file.name);
          
          if (!parsed) {
            console.warn('‚ö†Ô∏è Dosya adƒ± format hatasƒ±:', file.name);
            sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: 'Dosya adƒ± formatƒ± tanƒ±nmadƒ±' });
            hatali++;
            continue;
          }

          // Hasta olu≈ütur/bul
          const hasta = findOrCreateHasta(parsed.hastaAdi);
          
          // Hafta olu≈ütur/bul
          const hafta = findOrCreateHafta(hasta, parsed.haftaNo, parsed.tarihAraligi);
          
          // PDF'i Base64'e √ßevir ve sakla
          const pdfBase64 = await fileToBase64(file);
          hafta.pdf = pdfBase64;
          hafta.pdfName = file.name;
          hafta.pdfOrijinalIsim = file.name;
          hafta.pdfYolu = `pdfs/${file.name}`;
          hafta.kayitTarihi = new Date().toISOString();
          hafta.pdfFile = {
            name: file.name,
            size: file.size,
            type: file.type
          };
          
          // PDF'i analiz et ve tarifleri √ßƒ±kar
          let pdfText = '';
          let tarifler = [];
          let eslesenKartlar = [];
          let recipeCount = 0;
          let matchCount = 0;
          
          try {
            // PDF i√ßeriƒüini √ßƒ±kar
            const loadingTask = pdfjsLib.getDocument({data: atob(pdfBase64)});
            const pdf = await loadingTask.promise;
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
              const page = await pdf.getPage(pageNum);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map(item => item.str).join(' ');
              pdfText += pageText + ' ';
            }
            
            // Tarifleri analiz et
            if (typeof window.tarifKartlari !== 'undefined' && Array.isArray(window.tarifKartlari)) {
              window.tarifKartlari.forEach(kart => {
                const tarifAdi = kart.querySelector('.card-title')?.textContent?.trim();
                if (tarifAdi && pdfText.toLowerCase().includes(tarifAdi.toLowerCase())) {
                  tarifler.push(tarifAdi);
                  eslesenKartlar.push({
                    id: kart.id,
                    name: tarifAdi,
                    kategori: kart.dataset.kategori || 'Genel',
                    type: 'auto',
                    eklenmeTarihi: new Date().toISOString()
                  });
                  matchCount++;
                }
              });
            }
            
            // Toplam tarif sayƒ±sƒ±nƒ± tahmin et
            const tarifMatches = pdfText.match(/tarif|yemek|√∂ƒü√ºn/gi);
            recipeCount = tarifMatches ? tarifMatches.length : 0;
            
          } catch (pdfError) {
            console.warn('PDF i√ßerik √ßƒ±karma hatasƒ±:', pdfError);
          }
          
          // Hafta verilerini g√ºncelle
          hafta.tarifler = tarifler;
          hafta.tarifKartlar = eslesenKartlar;
          hafta.pdfText = pdfText.substring(0, 2000); // ƒ∞lk 2000 karakter
          hafta.gptMesaj = `PDF analizi: ${recipeCount} tarif tespit edildi, ${matchCount} e≈üle≈üme bulundu.`;
          
          sonuclar.push({ 
            dosya: file.name, 
            durum: 'BA≈ûARILI', 
            hasta: parsed.hastaAdi,
            hafta: parsed.haftaNo,
            tarifSayisi: recipeCount,
            eslesmeSayisi: matchCount
          });
          basarili++;
          
          console.log(`‚úÖ ${file.name} ba≈üarƒ±yla i≈ülendi - ${recipeCount} tarif, ${matchCount} e≈üle≈üme`);
          
        } catch (error) {
          console.error('‚ùå PDF i≈üleme hatasƒ±:', file.name, error);
          sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: error.message });
          hatali++;
        }
        
        // K√º√ß√ºk bir delay (UI donmamasƒ± i√ßin)
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // Progress dialog'u kapat
      document.body.removeChild(progressDiv);
      
      // Sonu√ßlarƒ± kaydet
      localStorage.setItem('lipedem_hasta_kayitlari', JSON.stringify(hastalar));
      
      // Otomatik kaydetme - hasta verileri deƒüi≈üti
      if (seciliHasta) {
        autoSaveHastaData(seciliHasta);
      }
      
      // UI'ƒ± g√ºncelle ve sidebar'ƒ± yenile
      if (typeof renderHastalarYeniSistem === 'function') {
        await renderHastalarYeniSistem();
      }
      updateHastaListesi(); // Sidebar'daki hasta listesini g√ºncelle
      
      // Sonu√ß raporu g√∂ster
      showCokluPdfSonuclari(sonuclar, basarili, hatali);
      
      console.log('üéâ √áoklu PDF i≈ülemi tamamlandƒ±! Ba≈üarƒ±lƒ±:', basarili, 'Hatalƒ±:', hatali);
    }
    
    // === EMNƒ∞YET Kƒ∞Lƒ∞Dƒ∞ FONKSƒ∞YONLARI ===
    
    // Hafta kaydet ve kilitle
    async function haftaKaydet(haftaIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        alert('‚ùå Ge√ßersiz hafta!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      const haftaNo = hafta.haftaNo || (haftaIndex + 1);
      
      if (!confirm(`Bu haftayƒ± kaydetmek ve kilitlemek istediƒüinize emin misiniz?\n\nHafta: ${haftaNo}\nTarih: ${hafta.baslangic} - ${hafta.bitis}\n\n‚ö†Ô∏è Kaydedildikten sonra PDF ve GPT alanlarƒ± kilitlenicek!`)) {
        return;
      }
      
      try {
        // Hafta verilerini kilitle
        hafta.kilitli = true;
        hafta.kayitTarihi = new Date().toISOString();
        
        // localStorage'a kaydet
        saveToStorage();
        
        // GitHub'a kaydet
        const kaydedildi = await hastayiAyriKaydet(seciliHasta);
        
        if (kaydedildi) {
          console.log(`‚úÖ ${haftaNo}. hafta ba≈üarƒ±yla kaydedildi ve kilitlendi`);
          
          // UI'ƒ± g√ºncelle
          gosterHaftalar();
          
          // Ba≈üarƒ± mesajƒ±
          alert(`‚úÖ ${haftaNo}. hafta ba≈üarƒ±yla kaydedildi!\n\nHafta artƒ±k kilitli. PDF ve GPT alanlarƒ± korunuyor.\nKilidi a√ßmak i√ßin üîì butonunu kullanƒ±n.`);
          
        } else {
          // GitHub kaydetme ba≈üarƒ±sƒ±z
          hafta.kilitli = false; // Kilidi geri a√ß
          hafta.kayitTarihi = null;
          saveToStorage();
          
          alert('‚ùå GitHub\'a kaydetme ba≈üarƒ±sƒ±z! Hafta kilitlenemedi.');
        }
        
      } catch (error) {
        console.error('‚ùå Hafta kaydetme hatasƒ±:', error);
        
        // Hata durumunda kilidi geri a√ß
        hafta.kilitli = false;
        hafta.kayitTarihi = null;
        saveToStorage();
        
        alert(`‚ùå Hafta kaydetme hatasƒ±: ${error.message}`);
      }
    }
    
    // Hafta kilidini a√ß
    async function haftaKilidiAc(haftaIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        alert('‚ùå Ge√ßersiz hafta!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      const haftaNo = hafta.haftaNo || (haftaIndex + 1);
      
      if (!confirm(`${haftaNo}. hafta kilidini a√ßmak istediƒüinize emin misiniz?\n\n‚ö†Ô∏è Kilidi a√ßtƒ±ktan sonra PDF ve GPT alanlarƒ±nƒ± deƒüi≈ütirebilirsiniz.\nVerilerinizi yanlƒ±≈ülƒ±kla kaybetmemek i√ßin dikkatli olun!`)) {
        return;
      }
      
      try {
        // Hafta kilidini a√ß
        hafta.kilitli = false;
        
        // localStorage'a kaydet
        saveToStorage();
        
        // GitHub'a kaydet
        const kaydedildi = await hastayiAyriKaydet(seciliHasta);
        
        if (kaydedildi) {
          console.log(`üîì ${haftaNo}. hafta kilidi a√ßƒ±ldƒ±`);
          
          // UI'ƒ± g√ºncelle
          gosterHaftalar();
          
          // Ba≈üarƒ± mesajƒ±
          alert(`üîì ${haftaNo}. hafta kilidi a√ßƒ±ldƒ±!\n\nArtƒ±k PDF ve GPT alanlarƒ±nƒ± d√ºzenleyebilirsiniz.\nƒ∞≈ülemlerinizi bitirdikten sonra tekrar kaydetmeyi unutmayƒ±n.`);
          
        } else {
          // GitHub kaydetme ba≈üarƒ±sƒ±z
          hafta.kilitli = true; // Kilidi geri koy
          saveToStorage();
          
          alert('‚ùå GitHub\'a kaydetme ba≈üarƒ±sƒ±z! Kilit a√ßƒ±lamadƒ±.');
        }
        
      } catch (error) {
        console.error('‚ùå Kilit a√ßma hatasƒ±:', error);
        
        // Hata durumunda kilidi geri koy
        hafta.kilitli = true;
        saveToStorage();
        
        alert(`‚ùå Kilit a√ßma hatasƒ±: ${error.message}`);
      }
    }
    
    // Global fonksiyonlar
    window.haftaKaydet = haftaKaydet;
    window.haftaKilidiAc = haftaKilidiAc;

        sayfaBaslat();
        initResizableSidebars();
      });
    } else {
      sayfaBaslat();
      initResizableSidebars();
    }
    
    // Global fonksiyon yap
    window.processCokluPdf = processCokluPdf;

    // ===== EMNƒ∞YET Kƒ∞Lƒ∞Dƒ∞ Sƒ∞STEMƒ∞ FONKSIYONLARI =====
    
    // Hafta kaydet ve kilitle
    async function haftaKaydet(i) {
      if (!seciliHasta) {
        alert('‚ùå L√ºtfen √∂nce bir hasta se√ßin!');
        return;
      }
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[i];
      
      if (hafta.kilitli) {
        alert('‚ö†Ô∏è Bu hafta zaten kilitli!');
        return;
      }
      
      // Kullanƒ±cƒ±dan onay al
      const onay = confirm(`üîí ${hafta.haftaNo}. haftayƒ± kaydetmek ve kilitlemek istediƒüinize emin misiniz?\n\nKilitlendikten sonra:\n‚Ä¢ PDF deƒüi≈ütirilemez\n‚Ä¢ GPT mesajƒ± deƒüi≈ütirilemez\n‚Ä¢ A√ßƒ±klama deƒüi≈ütirilemez\n\n‚ö†Ô∏è Deƒüi≈üiklik yapmak i√ßin kilidi a√ßmanƒ±z gerekecek.`);
      
      if (!onay) return;
      
      try {
        // 1. Hafta verilerini g√ºncelle
        hafta.kilitli = true;
        hafta.kilitlenmeTarihi = new Date().toISOString();
        
        // 2. LocalStorage'a kaydet
        saveToStorage();
        
        // 3. GitHub'a kaydet
        const githubBasarili = await hastayiAyriKaydet(seciliHasta);
        
        if (githubBasarili) {
          console.log(`‚úÖ ${hafta.haftaNo}. hafta kaydedildi ve kilitlendi`);
          alert(`‚úÖ ${hafta.haftaNo}. hafta ba≈üarƒ±yla kaydedildi ve kilitlendi!\n\nüîí Hafta artƒ±k yanlƒ±≈ülƒ±kla deƒüi≈ütirilemez.\nüíæ Veriler GitHub'a kaydedildi.`);
        } else {
          console.warn(`‚ö†Ô∏è ${hafta.haftaNo}. hafta kilitlendi ama GitHub kaydƒ± ba≈üarƒ±sƒ±z`);
          alert(`‚ö†Ô∏è ${hafta.haftaNo}. hafta kilitlendi ancak GitHub'a kaydetme ba≈üarƒ±sƒ±z!\n\nüîí Yerel kilit aktif.\nüíæ GitHub baƒülantƒ±nƒ±zƒ± kontrol edin.`);
        }
        
        // 4. UI'ƒ± g√ºncelle
        gosterHaftalar();
        
        // 5. Aktif tab'ƒ± koru
        setTimeout(() => switchTab(i), 100);
        
      } catch (error) {
        console.error('‚ùå Hafta kaydetme ve kilitleme hatasƒ±:', error);
        alert(`‚ùå Hafta kaydetme ba≈üarƒ±sƒ±z!\n\nHata: ${error.message}`);
      }
    }
    
    // Hafta kilidini a√ß
    async function haftaKilidiAc(i) {
      if (!seciliHasta) {
        alert('‚ùå L√ºtfen √∂nce bir hasta se√ßin!');
        return;
      }
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[i];
      
      if (!hafta.kilitli) {
        alert('‚ö†Ô∏è Bu hafta zaten kilitli deƒüil!');
        return;
      }
      
      // Kullanƒ±cƒ±dan onay al
      const onay = confirm(`üîì ${hafta.haftaNo}. haftanƒ±n kilidini a√ßmak istediƒüinize emin misiniz?\n\nKilit a√ßƒ±ldƒ±ktan sonra:\n‚Ä¢ PDF deƒüi≈ütirilebilir\n‚Ä¢ GPT mesajƒ± deƒüi≈ütirilebilir\n‚Ä¢ A√ßƒ±klama deƒüi≈ütirilebilir\n\n‚ö†Ô∏è Yanlƒ±≈ülƒ±kla veri kaybƒ± riski olu≈üur!`);
      
      if (!onay) return;
      
      try {
        // 1. Hafta verilerini g√ºncelle
        hafta.kilitli = false;
        hafta.kilitAcmaTarihi = new Date().toISOString();
        
        // 2. LocalStorage'a kaydet
        saveToStorage();
        
        // 3. GitHub'a kaydet
        const githubBasarili = await hastayiAyriKaydet(seciliHasta);
        
        if (githubBasarili) {
          console.log(`üîì ${hafta.haftaNo}. hafta kilidi a√ßƒ±ldƒ±`);
          alert(`üîì ${hafta.haftaNo}. hafta kilidi ba≈üarƒ±yla a√ßƒ±ldƒ±!\n\n‚úèÔ∏è Artƒ±k d√ºzenleyebilirsiniz.\nüíæ Deƒüi≈üiklik GitHub'a kaydedildi.`);
        } else {
          console.warn(`‚ö†Ô∏è ${hafta.haftaNo}. hafta kilidi a√ßƒ±ldƒ± ama GitHub kaydƒ± ba≈üarƒ±sƒ±z`);
          alert(`‚ö†Ô∏è ${hafta.haftaNo}. hafta kilidi a√ßƒ±ldƒ± ancak GitHub'a kaydetme ba≈üarƒ±sƒ±z!\n\nüîì Yerel kilit a√ßƒ±k.\nüíæ GitHub baƒülantƒ±nƒ±zƒ± kontrol edin.`);
        }
        
        // 4. UI'ƒ± g√ºncelle
        gosterHaftalar();
        
        // 5. Aktif tab'ƒ± koru
        setTimeout(() => switchTab(i), 100);
        
      } catch (error) {
        console.error('‚ùå Hafta kilit a√ßma hatasƒ±:', error);
        alert(`‚ùå Kilit a√ßma ba≈üarƒ±sƒ±z!\n\nHata: ${error.message}`);
      }
    }
    
    // Global fonksiyonlar
    window.haftaKaydet = haftaKaydet;
    window.haftaKilidiAc = haftaKilidiAc;

    // ============================================
    // üî∞ GOOGLE DRIVE API ENTEGRASYONU
    // ============================================
    
    // Google API'yi y√ºkle ve ba≈ülat
    async function initGoogleApi() {
      try {
        if (window.googleApiLoaded) return true;
        
        // File protokol√º kontrol√º
        if (window.isFileProtocol) {
          console.log('‚ö†Ô∏è File protokol√ºnde Google API kƒ±sƒ±tlƒ± - HTTP/HTTPS sunucu gerekli');
          window.googleApiAvailable = false;
          return false;
        }
        
        // API Key kontrol√º
        if (window.GOOGLE_DRIVE_CONFIG.API_KEY === 'YOUR_API_KEY_HERE') {
          console.log('‚ö†Ô∏è Google API Key ayarlanmamƒ±≈ü');
          window.googleApiAvailable = false;
          return false;
        }
        
        console.log('üîÑ Google Drive API y√ºkleniyor (Yeni GIS)...');
        
        // GAPI Client'ƒ± ba≈ülat
        await new Promise((resolve, reject) => {
          gapi.load('client', {
            callback: resolve,
            onerror: reject
          });
        });
        
        // Client'ƒ± ba≈ülat
        await gapi.client.init({
          apiKey: window.GOOGLE_DRIVE_CONFIG.API_KEY,
          discoveryDocs: [
            'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
            'https://sheets.googleapis.com/$discovery/rest?version=v4'
          ]
        });
        
        // Google Identity Services Token Client'ƒ± ba≈ülat
        window.tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: window.GOOGLE_DRIVE_CONFIG.CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/spreadsheets.readonly',
          callback: (response) => {
            if (response.error !== undefined) {
              console.error('‚ùå GIS Token Hatasƒ±:', response);
              throw response;
            }
            console.log('‚úÖ GIS Token alƒ±ndƒ±:', response);
            window.accessToken = response.access_token;
            gapi.client.setToken({access_token: response.access_token});
          },
        });
        
        window.googleApiLoaded = true;
        window.googleApiAvailable = true;
        console.log('‚úÖ Google Drive API y√ºklendi (GIS)');
        return true;
        
      } catch (error) {
        console.error('‚ùå Google API y√ºkleme hatasƒ±:', error);
        
        // OAuth origin hatasƒ± i√ßin √∂zel mesaj
        if (error.error === 'idpiframe_initialization_failed' && error.details && error.details.includes('Not a valid origin')) {
          console.log('üîß OAuth Origin Hatasƒ± Tespit Edildi!');
          console.log('üìç Mevcut Origin:', window.location.origin);
          console.log('üìç Tam URL:', window.location.href);
          console.log('‚ö†Ô∏è Google Cloud Console\'da Authorized JavaScript origins kƒ±smƒ±na ≈üunu ekleyin:', window.location.origin);
          console.log('üí° Eƒüer zaten ekliyse, 5-10 dakika bekleyin (propagasyon s√ºresi)');
          
          // Kullanƒ±cƒ±ya daha a√ßƒ±k mesaj g√∂ster
          const statusDiv = document.getElementById('googleDriveStatus');
          if (statusDiv) {
            statusDiv.innerHTML = `‚ùå OAuth Origin Hatasƒ±<br>
            üìç Google Cloud Console'da bu origin'i ekleyin: <strong>${window.location.origin}</strong><br>
            üí° Ekleme yaptƒ±ysanƒ±z 5-10 dakika bekleyin`;
          }
        } else {
          const statusDiv = document.getElementById('googleDriveStatus');
          if (statusDiv) {
            statusDiv.innerHTML = '‚ùå Google API y√ºklenemedi: ' + (error.details || error.error || 'Bilinmeyen hata');
          }
        }
        
        window.googleApiAvailable = false;
        return false;
      }
    }
    
    // Google Drive'a giri≈ü yap
    async function signInToGoogle() {
      try {
        // File protokol√º kontrol√º
        if (window.isFileProtocol) {
          alert('‚ö†Ô∏è Google Drive entegrasyonu i√ßin HTTP/HTTPS sunucu gereklidir.\n\nDosyayƒ± bir web sunucusunda √ßalƒ±≈ütƒ±rƒ±n (√∂rn: Live Server, Apache, IIS)');
          updateGoogleDriveStatus('error');
          return false;
        }
        
        // API Key kontrol√º
        if (window.GOOGLE_DRIVE_CONFIG.API_KEY === 'YOUR_API_KEY_HERE') {
          alert('‚ö†Ô∏è Google Drive API ayarlarƒ± eksik!\n\nL√ºtfen konfig√ºrasyon b√∂l√ºm√ºnde API_KEY ve CLIENT_ID deƒüerlerini ayarlayƒ±n.');
          updateGoogleDriveStatus('error');
          return false;
        }
        
        if (!window.googleApiLoaded) {
          const loaded = await initGoogleApi();
          if (!loaded) return false;
        }
        
        if (window.googleSignedIn) {
          console.log('‚úÖ Zaten Google Drive\'a baƒülƒ±');
          updateGoogleDriveStatus();
          return true;
        }
        
        console.log('üîÑ Google Drive\'a giri≈ü yapƒ±lƒ±yor (GIS)...');
        updateGoogleDriveStatus('connecting');
        
        // Yeni Google Identity Services ile token al
        return new Promise((resolve) => {
          if (!window.tokenClient) {
            console.error('‚ùå Token client ba≈ülatƒ±lmamƒ±≈ü');
            resolve(false);
            return;
          }
          
          // Token client callback'ini g√ºncelle
          window.tokenClient.callback = (response) => {
            if (response.error !== undefined) {
              console.error('‚ùå GIS Token Hatasƒ±:', response);
              updateGoogleDriveStatus('error');
              resolve(false);
              return;
            }
            
            console.log('‚úÖ GIS Token alƒ±ndƒ±:', response);
            window.accessToken = response.access_token;
            gapi.client.setToken({access_token: response.access_token});
            window.googleSignedIn = true;
            console.log('‚úÖ Google Drive\'a ba≈üarƒ±yla giri≈ü yapƒ±ldƒ± (GIS)');
            updateGoogleDriveStatus('connected');
            resolve(true);
          };
          
          // Token isteƒüi ba≈ülat
          window.tokenClient.requestAccessToken({prompt: 'consent'});
        });
        
      } catch (error) {
        console.error('‚ùå Google Drive giri≈ü hatasƒ±:', error);
        updateGoogleDriveStatus('error');
        
        let errorMessage = 'Google Drive\'a giri≈ü yapƒ±lamadƒ±: ' + error.message;
        
        if (error.toString().includes('cookiePolicy')) {
          errorMessage = '‚ùå Google Drive giri≈ü hatasƒ±!\n\nFile protokol√ºnde √ßalƒ±≈üƒ±yorsunuz. L√ºtfen dosyayƒ± bir web sunucusunda (HTTP/HTTPS) √ßalƒ±≈ütƒ±rƒ±n.';
        } else if (error.details && error.details.includes('Not a valid origin')) {
          const currentOrigin = window.location.origin;
          errorMessage = `‚ùå OAuth Client ID Hatasƒ±!\n\nüîß √á√∂z√ºm:\n1. Google Cloud Console > Credentials > OAuth 2.0 Client ID'nizi d√ºzenleyin\n2. "Authorized JavaScript origins" kƒ±smƒ±na ekleyin:\n   ${currentOrigin}\n3. "Authorized redirect URIs" kƒ±smƒ±na da ekleyin:\n   ${currentOrigin}\n4. Kaydedin ve 5-10 dakika bekleyin\n\nüí° Mevcut origin: ${currentOrigin}`;
        } else if (error.error === 'idpiframe_initialization_failed') {
          errorMessage = '‚ùå OAuth Konfig√ºrasyon Hatasƒ±!\n\nüîß Muhtemel sebep: Authorized domains eksik\n\n1. Google Cloud Console > Credentials\n2. OAuth 2.0 Client ID d√ºzenleyin\n3. Authorized JavaScript origins ekleyin\n4. Ayarlarƒ± kaydedin ve bekleyin';
        }
        
        alert(errorMessage);
        return false;
      }
    }
    
    // Google Drive durumunu g√ºncelle
    function updateGoogleDriveStatus(status = null) {
      const statusDiv = document.getElementById('googleDriveStatus');
      const btn = document.getElementById('googleDriveBtn');
      
      if (!statusDiv || !btn) return;
      
      // File protokol√º kontrol√º
      if (window.isFileProtocol) {
        statusDiv.textContent = 'Drive: HTTP/HTTPS Gerekli';
        statusDiv.style.color = '#fd7e14';
        btn.innerHTML = '<span style="font-size: 14px;">‚ö†Ô∏è</span> Sunucu Gerekli';
        btn.style.background = '#fd7e14';
        btn.disabled = false;
        btn.onclick = () => {
          alert('‚ö†Ô∏è Google Drive entegrasyonu i√ßin HTTP/HTTPS sunucu gereklidir.\n\n√á√∂z√ºmler:\n1. Live Server extension kullanƒ±n\n2. XAMPP/WAMP ile Apache ba≈ülatƒ±n\n3. Python: python -m http.server\n4. Node.js: npx http-server');
        };
        return;
      }
      
      if (status === 'connecting') {
        statusDiv.textContent = 'Drive: Baƒülanƒ±yor...';
        statusDiv.style.color = '#ffc107';
        btn.innerHTML = '<span style="font-size: 14px;">‚è≥</span> Baƒülanƒ±yor...';
        btn.disabled = true;
        
      } else if (status === 'connected' || window.googleSignedIn) {
        statusDiv.textContent = 'Drive: Baƒülƒ± ‚úÖ';
        statusDiv.style.color = '#28a745';
        btn.innerHTML = '<span style="font-size: 14px;">‚úÖ</span> Baƒülƒ±';
        btn.style.background = '#28a745';
        btn.disabled = false;
        btn.onclick = () => alert('Google Drive\'a zaten baƒülƒ±sƒ±nƒ±z!');
        
      } else if (status === 'error') {
        statusDiv.textContent = 'Drive: Hata ‚ùå';
        statusDiv.style.color = '#dc3545';
        btn.innerHTML = '<span style="font-size: 14px;">üíæ</span> Tekrar Dene';
        btn.style.background = '#dc3545';
        btn.disabled = false;
        
      } else {
        statusDiv.textContent = 'Drive: Baƒülantƒ± Yok';
        statusDiv.style.color = '#666';
        btn.innerHTML = '<span style="font-size: 14px;">üíæ</span> Google Drive\'a Baƒülan';
        btn.style.background = '#4285f4';
        btn.disabled = false;
        btn.onclick = signInToGoogle;
      }
    }
    
    // Google Sheets'te hasta adƒ±na g√∂re dosya ara
    async function findPatientSheet(hastaAdi) {
      try {
        // OAuth token kontrol√º
        if (!window.accessToken) {
          console.error('‚ùå OAuth token bulunamadƒ±');
          throw new Error('√ñnce Google Drive\'a giri≈ü yapmalƒ±sƒ±nƒ±z');
        }
        
        const query = `name contains '${hastaAdi}' and mimeType='application/vnd.google-apps.spreadsheet'`;
        
        console.log('üîç Google Drive arama yapƒ±lƒ±yor, token:', window.accessToken.substring(0, 20) + '...');
        
        const response = await gapi.client.drive.files.list({
          q: query,
          fields: 'files(id,name,webViewLink)'
        });
        
        const files = response.result.files;
        console.log(`üîç "${hastaAdi}" i√ßin ${files.length} adet sheet dosyasƒ± bulundu`, files);
        
        // Tam e≈üle≈üme ara
        let exactMatch = files.find(file => 
          file.name.toLowerCase().includes(hastaAdi.toLowerCase()) ||
          hastaAdi.toLowerCase().includes(file.name.toLowerCase())
        );
        
        if (!exactMatch && files.length > 0) {
          exactMatch = files[0]; // ƒ∞lkini al
        }
        
        return exactMatch;
        
      } catch (error) {
        console.error('‚ùå Google Sheets arama hatasƒ±:', error);
        throw error;
      }
    }
    
    // Google Sheets'ten belirli tab'ƒ± PDF olarak export et
    async function exportSheetTabAsPdf(sheetId, tabName) {
      try {
        console.log(`üìÑ Sheet PDF export ediliyor: ${sheetId}, Tab: ${tabName}`);
        
        // √ñnce sheet'in tab'larƒ±nƒ± listele
        const sheetsResponse = await gapi.client.request({
          path: `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}`,
          params: {
            fields: 'sheets.properties'
          }
        });
        
        const sheets = sheetsResponse.result.sheets;
        console.log('üìã Mevcut tab\'lar:', sheets.map(s => s.properties.title));
        
        // Tab adƒ±nƒ± esnek arama
        let targetSheet = sheets.find(sheet => 
          sheet.properties.title.toLowerCase() === tabName.toLowerCase()
        );
        
        // Eƒüer tam e≈üle≈üme bulunamazsa, benzer arama yap
        if (!targetSheet) {
          // Bo≈üluklarƒ± ve noktalama i≈üaretlerini normalize et
          const normalizeTabName = (name) => name.toLowerCase().replace(/[\s\.]/g, '');
          const normalizedTargetName = normalizeTabName(tabName);
          
          targetSheet = sheets.find(sheet => {
            const normalizedSheetName = normalizeTabName(sheet.properties.title);
            return normalizedSheetName.includes(normalizedTargetName) || 
                   normalizedTargetName.includes(normalizedSheetName);
          });
          
          if (targetSheet) {
            console.log(`‚úÖ Benzer tab bulundu: "${targetSheet.properties.title}" ~ "${tabName}"`);
          }
        }
        
        if (!targetSheet) {
          console.error('‚ùå Tab bulunamadƒ±:', tabName);
          console.error('üìã Mevcut tab\'lar:', sheets.map(s => s.properties.title));
          throw new Error(`Tab bulunamadƒ±: ${tabName}. Mevcut tab'lar: ${sheets.map(s => s.properties.title).join(', ')}`);
        }
        
        const sheetGid = targetSheet.properties.sheetId;
        console.log(`‚úÖ Tab bulundu: ${tabName} (ID: ${sheetGid})`);
        
        // PDF export URL'ini olu≈ütur
        const exportUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=pdf&gid=${sheetGid}&portrait=true&fitw=true&source=web`;
        
        // GIS access token'ƒ±nƒ± kontrol et
        if (!window.accessToken) {
          throw new Error('OAuth token bulunamadƒ±. L√ºtfen tekrar Google Drive\'a giri≈ü yapƒ±n.');
        }
        
        console.log('üìã PDF export URL:', exportUrl);
        console.log('üîë Access token (ilk 20 karakter):', window.accessToken.substring(0, 20) + '...');
        
        // PDF'i indir
        const response = await fetch(exportUrl, {
          headers: {
            'Authorization': `Bearer ${window.accessToken}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`PDF export hatasƒ±: ${response.status}`);
        }
        
        const pdfBlob = await response.blob();
        console.log('‚úÖ PDF ba≈üarƒ±yla export edildi');
        
        return pdfBlob;
        
      } catch (error) {
        console.error('‚ùå Google Sheets PDF export hatasƒ±:', error);
        throw error;
      }
    }
    
    // Drive'dan PDF y√ºkle (ana fonksiyon)
    async function drivedenPdfYukle(haftaIndeks) {
      try {
        console.log(`üîÑ Drive'dan PDF y√ºkleniyor: Hafta ${haftaIndeks + 1}`);
        
        // File protokol√º kontrol√º
        if (window.isFileProtocol) {
          alert('‚ö†Ô∏è Google Drive entegrasyonu i√ßin HTTP/HTTPS sunucu gereklidir.\n\nDosyayƒ± bir web sunucusunda √ßalƒ±≈ütƒ±rƒ±n.');
          return;
        }
        
        // Se√ßili hasta kontrol√º
        if (!seciliHasta) {
          alert('√ñnce bir hasta se√ßmelisiniz!');
          console.log('‚ùå seciliHasta deƒüi≈ükeni:', seciliHasta);
          return;
        }
        
        const hasta = seciliHasta;
        console.log('‚úÖ Se√ßili hasta bulundu:', hasta.isim || hasta.hastaIsim);
        
        // Hafta kilit kontrol√º
        const hafta = hasta.haftalar[haftaIndeks];
        if (hafta?.kilitli) {
          alert('üîí Bu hafta kilitli! PDF y√ºklemek i√ßin √∂nce kilidi a√ßƒ±n.');
          return;
        }
        
        // Google API'yi ba≈ülat ve giri≈ü yap
        const signedIn = await signInToGoogle();
        if (!signedIn) {
          return;
        }
        
        // Hasta sheet'ini ara
        const hastaAdi = hasta.hastaIsim || hasta.isim;
        console.log(`üîç "${hastaAdi}" i√ßin Google Sheets ara≈ütƒ±rƒ±lƒ±yor...`);
        
        const patientSheet = await findPatientSheet(hastaAdi);
        if (!patientSheet) {
          alert(`"${hastaAdi}" i√ßin Google Sheets dosyasƒ± bulunamadƒ±!\n\nL√ºtfen Google Drive'da "${hastaAdi}" isimli bir spreadsheet dosyasƒ± olu≈üturun.`);
          return;
        }
        
        console.log('‚úÖ Hasta sheet\'i bulundu:', patientSheet.name);
        
        // PDF tab ismini olu≈ütur - farklƒ± varyasyonlarƒ± dene
        const haftaNo = haftaIndeks + 1;
        const possibleTabNames = [
          `${haftaNo}. hafta pdf`,      // "1. hafta pdf"
          `${haftaNo}.hafta pdf`,       // "1.hafta pdf"
          `${haftaNo} hafta pdf`,       // "1 hafta pdf"
          `${haftaNo}hafta pdf`,        // "1hafta pdf"
          `${haftaNo}. hafta`,          // "1. hafta"
          `${haftaNo}.hafta`,           // "1.hafta"
          `hafta ${haftaNo}`,           // "hafta 1"
          `hafta${haftaNo}`,            // "hafta1"
        ];
        
        console.log(`üìÑ Tab aranƒ±yor, olasƒ± isimler:`, possibleTabNames);
        
        // ƒ∞lk bulunan tab adƒ±nƒ± kullan
        let pdfBlob = null;
        let foundTabName = null;
        
        for (const tabName of possibleTabNames) {
          try {
            console.log(`üîç Deneniyor: "${tabName}"`);
            pdfBlob = await exportSheetTabAsPdf(patientSheet.id, tabName);
            foundTabName = tabName;
            console.log(`‚úÖ Tab bulundu: "${tabName}"`);
            break;
          } catch (error) {
            console.log(`‚ùå "${tabName}" bulunamadƒ±`);
            continue;
          }
        }
        
        if (!pdfBlob) {
          alert(`‚ùå Hi√ßbir hafta tab'ƒ± bulunamadƒ±!\n\nüîç Aranan varyasyonlar:\n${possibleTabNames.join('\n')}\n\nüí° Google Sheets'te yukardaki isimlerden birini kullanƒ±n.`);
          return;
        }
        
        // PDF dosyasƒ±nƒ± File objesine √ßevir
        const pdfFile = new File([pdfBlob], `${hastaAdi}_${haftaNo}_hafta.pdf`, {
          type: 'application/pdf'
        });
        
        console.log('‚úÖ PDF dosyasƒ± hazƒ±rlandƒ±:', pdfFile.name);
        
        // Mevcut PDF y√ºkleme fonksiyonunu kullan
        await pdfYukleHaftaManuel(haftaIndeks, pdfFile);
        
        // Ba≈üarƒ± mesajƒ± g√∂ster ve otomatik kaybet
        showToast(`‚úÖ PDF ba≈üarƒ±yla Drive'dan y√ºklendi: ${foundTabName}`, 'success', 3000);
        
      } catch (error) {
        console.error('‚ùå Drive PDF y√ºkleme hatasƒ±:', error);
        
        // Farklƒ± hata tiplerini yakala
        if (error.message && error.message.includes('Google Drive\'a giri≈ü yapmalƒ±sƒ±nƒ±z')) {
          alert('‚ö†Ô∏è √ñnce Google Drive\'a giri≈ü yapmalƒ±sƒ±nƒ±z!\n\n"Google Drive\'a Baƒülan" butonunu kullanƒ±n.');
        } else if (error.status === 403) {
          alert(`‚ùå Google Drive Eri≈üim Hatasƒ±!\n\nüîç Sebep: ƒ∞zin sorunu\nüí° √á√∂z√ºm:\n1. Google Drive\'da "${hasta.isim || hasta.hastaIsim}" adƒ±nda bir Google Sheets dosyasƒ± olu≈üturun\n2. Bu dosyayƒ± herkese a√ßƒ±k yapƒ±n veya email adresinizle payla≈üƒ±n\n3. Tekrar deneyin\n\nüìù Not: API Key yerine OAuth kullanƒ±lƒ±yor.`);
        } else if (error.result && error.result.files && error.result.files.length === 0) {
          alert(`‚ùå Google Sheets Bulunamadƒ±!\n\nüîç Aranan: "${hasta.isim || hasta.hastaIsim}"\nüí° √á√∂z√ºm:\n1. Google Drive\'da bu isimde bir Google Sheets dosyasƒ± olu≈üturun\n2. ƒ∞√ßinde "${haftaIndeks + 1}. hafta" adƒ±nda bir tab olduƒüundan emin olun\n3. Tekrar deneyin`);
        } else {
          alert(`‚ùå Drive PDF y√ºkleme hatasƒ±!\n\n${error.message || 'Bilinmeyen hata'}\n\nKonsola detaylar yazdƒ±rƒ±ldƒ±.`);
        }
      }
    }
    
    // Manuel PDF y√ºkleme fonksiyonu (input olmadan)
    async function pdfYukleHaftaManuel(haftaIndeks, pdfFile) {
      try {
        console.log('üîç Manuel PDF y√ºkleniyor:', pdfFile.name);
        
        const hasta = seciliHasta;
        if (!hasta) {
          throw new Error('Hasta se√ßilmemi≈ü');
        }
        
        // PDF'den tarih ve hafta bilgisi √ßƒ±kar
        let pdfTarihi = null;
        let pdfHaftasi = haftaIndeks + 1;
        
        try {
          const parsedInfo = parseProfessionalPdfName(pdfFile.name);
          if (parsedInfo?.tarih) {
            pdfTarihi = parsedInfo.tarih;
          }
          if (parsedInfo?.hafta) {
            pdfHaftasi = parsedInfo.hafta;
          }
        } catch (error) {
          console.log('‚ö†Ô∏è PDF isim parse hatasƒ± (devam ediliyor):', error.message);
        }
        
        // GitHub'a PDF y√ºkle
        console.log('  PDF GitHub\'a y√ºkleniyor...');
        const githubSonuc = await pdfYukleGithub(pdfFile, hasta.id, haftaIndeks + 1);
        
        if (githubSonuc.success) {
          // Hafta verisini g√ºncelle
          if (!hasta.haftalar[haftaIndeks]) {
            hasta.haftalar[haftaIndeks] = {
              haftaNo: haftaIndeks + 1,
              aciklama: '',
              tarifler: [],
              tarihler: [],
              kayitTarihi: null,
              kilitli: false
            };
          }
          
          // PDF bilgilerini kaydet
          hasta.haftalar[haftaIndeks].pdf = githubSonuc.content;
          hasta.haftalar[haftaIndeks].pdfYolu = githubSonuc.path;
          hasta.haftalar[haftaIndeks].pdfName = githubSonuc.fileName;
          hasta.haftalar[haftaIndeks].pdfOrijinalIsim = pdfFile.name;
          hasta.haftalar[haftaIndeks].githubUrl = githubSonuc.githubUrl;
          hasta.haftalar[haftaIndeks].githubLink = githubSonuc.githubUrl;
          hasta.haftalar[haftaIndeks].githubRawLink = githubSonuc.rawUrl;
          hasta.haftalar[haftaIndeks].indirmeUrl = githubSonuc.rawUrl;
          
          // Tarih bilgisini ekle
          if (pdfTarihi) {
            hasta.haftalar[haftaIndeks].pdfTarihi = pdfTarihi;
            hasta.haftalar[haftaIndeks].tarihler.push(pdfTarihi);
          }
          
          // Kayƒ±t tarihini g√ºncelle
          hasta.haftalar[haftaIndeks].kayitTarihi = new Date().toISOString();
          
          // Hasta verisini GitHub'a kaydet
          await hastayiAyriKaydet(hasta);
          
          // UI'ƒ± g√ºncelle
          if (typeof renderSecilenHasta === 'function') {
            renderSecilenHasta();
          } else if (typeof gosterHaftalar === 'function') {
            gosterHaftalar();
          }
          
          console.log('‚úÖ Manuel PDF y√ºkleme ba≈üarƒ±lƒ±:', pdfFile.name);
          
        } else {
          throw new Error(githubSonuc.error || 'GitHub y√ºkleme ba≈üarƒ±sƒ±z');
        }
        
      } catch (error) {
        console.error('‚ùå Manuel PDF y√ºkleme hatasƒ±:', error);
        throw error;
      }
    }
    
    // Global fonksiyonlarƒ± ekle
    window.drivedenPdfYukle = drivedenPdfYukle;
    window.initGoogleApi = initGoogleApi;
    window.signInToGoogle = signInToGoogle;
    window.updateGoogleDriveStatus = updateGoogleDriveStatus;
    
    // Google API Konfig√ºrasyon fonksiyonlarƒ±
    function showGoogleApiConfig() {
      const modal = document.getElementById('googleApiConfigModal');
      const apiKeyInput = document.getElementById('googleApiKeyInput');
      const clientIdInput = document.getElementById('googleClientIdInput');
      
      // localStorage'dan mevcut deƒüerleri y√ºkle
      const savedApiKey = localStorage.getItem('googleDriveApiKey');
      const savedClientId = localStorage.getItem('googleDriveClientId');
      
      apiKeyInput.value = savedApiKey && savedApiKey !== 'YOUR_API_KEY_HERE' ? savedApiKey : '';
      clientIdInput.value = savedClientId && savedClientId !== 'YOUR_CLIENT_ID_HERE' ? savedClientId : '';
      
      // Mevcut origin'i √∂rneklerde g√∂ster
      const currentOrigin = window.location.origin;
      const example1 = document.getElementById('currentOriginExample');
      const example2 = document.getElementById('currentOriginExample2');
      if (example1) example1.textContent = currentOrigin;
      if (example2) example2.textContent = currentOrigin;
      
      modal.style.display = 'flex';
      
      // Eƒüer ayarlar zaten mevcutsa bilgilendirme g√∂ster
      if (savedApiKey && savedClientId) {
        console.log('üíæ Mevcut ayarlar localStorage\'dan y√ºklendi');
      }
    }
    
    function hideGoogleApiConfig() {
      const modal = document.getElementById('googleApiConfigModal');
      modal.style.display = 'none';
      
      // Google Drive durumunu g√ºncelle
      updateGoogleDriveStatus();
    }
    
    function saveGoogleApiConfig() {
      const apiKeyInput = document.getElementById('googleApiKeyInput');
      const clientIdInput = document.getElementById('googleClientIdInput');
      
      const apiKey = apiKeyInput.value.trim();
      const clientId = clientIdInput.value.trim();
      
      if (!apiKey || !clientId) {
        alert('‚ö†Ô∏è L√ºtfen hem API Key hem de Client ID alanlarƒ±nƒ± doldurun!');
        return;
      }
      
      if (!apiKey.startsWith('AIza')) {
        alert('‚ö†Ô∏è API Key formatƒ± hatalƒ±! "AIza" ile ba≈ülamalƒ±dƒ±r.');
        return;
      }
      
      if (!clientId.includes('-') || clientId.length < 20) {
        alert('‚ö†Ô∏è Client ID formatƒ± hatalƒ±! Daha uzun olmalƒ± ve "-" i√ßermelidir.');
        return;
      }
      
      // localStorage'a kaydet
      localStorage.setItem('googleDriveApiKey', apiKey);
      localStorage.setItem('googleDriveClientId', clientId);
      console.log('üíæ Google API ayarlarƒ± localStorage\'a kaydedildi');
      
      // Konfig√ºrasyonu g√ºncelle
      window.GOOGLE_DRIVE_CONFIG.API_KEY = apiKey;
      window.GOOGLE_DRIVE_CONFIG.CLIENT_ID = clientId;
      
      // Google API durumunu sƒ±fƒ±rla
      window.googleApiLoaded = false;
      window.googleSignedIn = false;
      window.googleApiAvailable = false;
      
      hideGoogleApiConfig();
      updateGoogleDriveStatus();
      
      // Debug bilgilerini g√∂ster
      const currentUrl = window.location.href;
      console.log('üîß Google API Konfig√ºrasyonu:');
      console.log('üìç Current URL:', currentUrl);
      console.log('üîë API Key (ilk 10 karakter):', apiKey.substring(0, 10) + '...');
      console.log('üÜî Client ID (ilk 20 karakter):', clientId.substring(0, 20) + '...');
      console.log('üíæ localStorage\'a kaydedildi - sayfa yenilendiƒüinde kalacak');
      
      alert(`‚úÖ Google Drive API ayarlarƒ± kaydedildi ve localStorage'a saklandƒ±!\n\nüíæ Artƒ±k sayfa yenilendiƒüinde ayarlarƒ±nƒ±z kaybolmayacak!\n\nüåê Mevcut URL: ${currentUrl}\n\n‚ö†Ô∏è OAuth Ayarlarƒ± Kontrol Listesi:\n‚úì Google Cloud Console > Credentials > OAuth 2.0 Client ID\n‚úì Authorized JavaScript origins: ${currentUrl.replace(/\/[^\/]*$/, '').replace(/\/[^\/]*$/, '')}\n‚úì Authorized redirect URIs: aynƒ± URL\n\nüí° Ayarlarƒ±n etkili olmasƒ± 5-10 dakika s√ºrebilir!`);
      
      console.log('‚úÖ Google Drive API konfig√ºrasyonu g√ºncellendi');
    }
    
    // Toast bildirimi g√∂ster
    function showToast(message, type = 'success', duration = 3000) {
      // Varsa eski toast'ƒ± kaldƒ±r
      const oldToast = document.getElementById('customToast');
      if (oldToast) {
        oldToast.remove();
      }
      
      // Toast container olu≈ütur
      const toast = document.createElement('div');
      toast.id = 'customToast';
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        font-size: 14px;
        z-index: 10000;
        min-width: 300px;
        max-width: 500px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        transform: translateX(100%);
        ${type === 'success' ? 'background: linear-gradient(135deg, #28a745, #20c997);' : 
          type === 'error' ? 'background: linear-gradient(135deg, #dc3545, #fd7e14);' : 
          'background: linear-gradient(135deg, #007bff, #6f42c1);'}
      `;
      
      toast.innerHTML = message;
      document.body.appendChild(toast);
      
      // Animate in
      setTimeout(() => {
        toast.style.transform = 'translateX(0)';
      }, 100);
      
      // Auto remove
      setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (toast && toast.parentNode) {
            toast.remove();
          }
        }, 300);
      }, duration);
    }
    
    // === GPT Y√ñNETƒ∞M Sƒ∞STEMƒ∞ ===
    
    // GPT ayarlarƒ± i√ßin localStorage anahtarlarƒ±
    const GPT_SETTINGS_KEY = 'gptSettings';
    const GENEL_PROMPTLAR_KEY = 'genelPromptlar';
    const HAFTALIK_PROMPTLAR_KEY = 'haftalikPromptlar';
    
    // GPT panelini g√∂ster
    function showGptPanel() {
      document.getElementById('gptPanel').style.display = 'block';
      loadGptSettings();
      renderGenelPromptlar();
      renderHaftalikPromptlar();
    }
    
    // GPT panelini gizle
    function hideGptPanel(event) {
      if (event && event.target === event.currentTarget) {
        document.getElementById('gptPanel').style.display = 'none';
      } else if (!event) {
        document.getElementById('gptPanel').style.display = 'none';
      }
    }
    
    // GPT ayarlarƒ±nƒ± y√ºkle
    function loadGptSettings() {
      try {
        const settings = JSON.parse(localStorage.getItem(GPT_SETTINGS_KEY) || '{}');
        document.getElementById('gptApiKey').value = settings.apiKey || '';
        document.getElementById('gptModel').value = settings.model || 'gpt-4';
      } catch (error) {
        console.error('GPT ayarlarƒ± y√ºkleme hatasƒ±:', error);
      }
    }
    
    // GPT ayarlarƒ±nƒ± kaydet
    function saveGptSettings() {
      try {
        const settings = {
          apiKey: document.getElementById('gptApiKey').value,
          model: document.getElementById('gptModel').value
        };
        localStorage.setItem(GPT_SETTINGS_KEY, JSON.stringify(settings));
        showToast('‚úÖ GPT ayarlarƒ± kaydedildi', 'success', 2000);
      } catch (error) {
        console.error('GPT ayarlarƒ± kaydetme hatasƒ±:', error);
        showToast('‚ùå GPT ayarlarƒ± kaydedilemedi', 'error', 3000);
      }
    }
    
    // Yeni genel prompt ekle
    function yeniGenelPrompt() {
      const promptlar = JSON.parse(localStorage.getItem(GENEL_PROMPTLAR_KEY) || '[]');
      const yeniPrompt = {
        id: Date.now(),
        baslik: 'Yeni Prompt ≈ûablonu',
        icerik: 'Sen bir beslenme uzmanƒ±sƒ±n...'
      };
      promptlar.push(yeniPrompt);
      localStorage.setItem(GENEL_PROMPTLAR_KEY, JSON.stringify(promptlar));
      renderGenelPromptlar();
    }
    
    // Genel promptlarƒ± render et
    function renderGenelPromptlar() {
      const container = document.getElementById('genelPromptlar');
      const promptlar = JSON.parse(localStorage.getItem(GENEL_PROMPTLAR_KEY) || '[]');
      
      container.innerHTML = promptlar.map(prompt => `
        <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
            <input type="text" value="${prompt.baslik}" onchange="updateGenelPromptBaslik(${prompt.id}, this.value)" 
                   style="flex: 1; padding: 5px; border: 1px solid #ced4da; border-radius: 4px; font-weight: bold;">
            <button onclick="deleteGenelPrompt(${prompt.id})" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
          </div>
          <textarea onchange="updateGenelPromptIcerik(${prompt.id}, this.value)" rows="4" 
                    style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; resize: vertical;"
                    placeholder="Prompt i√ßeriƒüi...">${prompt.icerik}</textarea>
        </div>
      `).join('');
    }
    
    // PDF'den metin √ßƒ±karma fonksiyonu
    async function extractTextFromPdf(pdfData) {
      try {
        if (!pdfData || pdfData.length < 100) {
          throw new Error('PDF verisi √ßok k√º√ß√ºk veya bo≈ü');
        }
        
        // PDF.js ile metin √ßƒ±karma
        const loadingTask = pdfjsLib.getDocument({ data: pdfData });
        const pdf = await loadingTask.promise;
        
        let textContent = '';
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const textData = await page.getTextContent();
          const pageText = textData.items.map(item => item.str).join(' ');
          textContent += pageText + '\n';
        }
        
        return textContent.trim();
      } catch (error) {
        console.error('PDF metin √ßƒ±karma hatasƒ±:', error);
        throw error;
      }
    }
    
    // Base64 UTF-8 g√ºvenli encoding
    function safeBase64Encode(str) {
      try {
        // T√ºrk√ße karakterleri encode et
        return btoa(unescape(encodeURIComponent(str)));
      } catch (error) {
        console.warn('Base64 encoding hatasƒ±, alternatif y√∂ntem kullanƒ±lƒ±yor:', error);
        // Alternatif: T√ºrk√ße karakterleri temizle
        const cleanStr = str.replace(/[^\x00-\x7F]/g, "?");
        return btoa(cleanStr);
      }
    }
    
    // Base64 UTF-8 g√ºvenli decoding
    function safeBase64Decode(str) {
      try {
        return decodeURIComponent(escape(atob(str)));
      } catch (error) {
        console.warn('Base64 decoding hatasƒ±:', error);
        return atob(str);
      }
    }

    // GPT ile analiz et
    async function gptAnalizeEt(haftaIndex) {
      try {
        // GPT ayarlarƒ±nƒ± kontrol et
        const settings = JSON.parse(localStorage.getItem(GPT_SETTINGS_KEY) || '{}');
        if (!settings.apiKey) {
          alert('‚ùå GPT API Key girilmemi≈ü!\n\nL√ºtfen GPT Y√∂netimi panelinden API Key\'inizi girin.');
          showGptPanel();
          return;
        }
        
        // Haftalƒ±k a√ßƒ±klama alanƒ±ndaki metni otomatik olarak "Ek Bilgiler" alanƒ±na √ßek
        const aciklamaInput = document.getElementById(`aciklama_${haftaIndex}`);
        const ekNotlarInput = document.getElementById(`ekNotlar_${haftaIndex}`);
        
        if (aciklamaInput && ekNotlarInput && aciklamaInput.value.trim()) {
          // Eƒüer ek notlar alanƒ± bo≈üsa a√ßƒ±klamayƒ± otomatik √ßek
          if (!ekNotlarInput.value.trim()) {
            ekNotlarInput.value = aciklamaInput.value.trim();
            console.log('‚úÖ A√ßƒ±klama alanƒ±ndaki metin "Ek Bilgiler" alanƒ±na otomatik √ßekildi:', aciklamaInput.value);
          } else {
            // Eƒüer ek notlar alanƒ±nda zaten metin varsa, a√ßƒ±klamayƒ± da ekle
            ekNotlarInput.value = `${ekNotlarInput.value.trim()}\n\nA√ßƒ±klama: ${aciklamaInput.value.trim()}`;
            console.log('‚úÖ A√ßƒ±klama mevcut ek notlara eklendi');
          }
        }
        
        // Loading g√∂ster
        const gptMesajTextarea = document.getElementById(`gptMesaj_${haftaIndex}`);
        gptMesajTextarea.value = 'ü§ñ GPT analiz ediyor, l√ºtfen bekleyin...';
        gptMesajTextarea.disabled = true;
        
        // Prompt par√ßalarƒ±nƒ± topla
        const prompts = [];
        
        // 1. Genel Prompt
        if (document.getElementById(`genelPrompt_${haftaIndex}`)?.checked) {
          const genelPromptlar = JSON.parse(localStorage.getItem(GENEL_PROMPTLAR_KEY) || '[]');
          if (genelPromptlar.length > 0) {
            prompts.push('=== GENEL TALƒ∞MAT ===');
            prompts.push(genelPromptlar[0].icerik);
          }
        }
        
        // 2. Haftalƒ±k Prompt
        if (document.getElementById(`haftalikPrompt_${haftaIndex}`)?.checked) {
          const haftalikPromptlar = JSON.parse(localStorage.getItem(HAFTALIK_PROMPTLAR_KEY) || '[]');
          const haftaPrompt = haftalikPromptlar.find(p => p.haftaNo === (haftaIndex + 1));
          if (haftaPrompt) {
            prompts.push('=== HAFTALIK TEMA ===');
            prompts.push(haftaPrompt.icerik);
          }
        }
        
        // 3. Hasta Bilgileri
        if (document.getElementById(`hastaPrompt_${haftaIndex}`)?.checked && seciliHasta) {
          prompts.push('=== HASTA Bƒ∞LGƒ∞LERƒ∞ ===');
          prompts.push(`Hasta Adƒ±: ${seciliHasta.hastaIsim || seciliHasta.isim || 'Bilinmiyor'}`);
          // Ana hasta notu
          if (seciliHasta.not) {
            prompts.push(`Hasta Notu: ${seciliHasta.not}`);
          }
          // Ek notlar
          if (seciliHasta.notlar) {
            prompts.push(`Hasta Notlarƒ±: ${seciliHasta.notlar}`);
          }
          // Ya≈üam bilgileri
          if (seciliHasta.yasam) {
            prompts.push(`Ya≈üam Bilgileri: ${seciliHasta.yasam}`);
          }
        }
        
        // 3.5. √ñnceki Haftalarƒ±n GPT Analizleri (Tutarlƒ±lƒ±k i√ßin)
        if (document.getElementById(`oncekiAnalizler_${haftaIndex}`)?.checked && seciliHasta) {
          const oncekiAnalizler = getOncekiGptAnalizleri(haftaIndex);
          if (oncekiAnalizler.length > 0) {
            prompts.push('=== √ñNCEKƒ∞ HAFTALARIN GPT ANALƒ∞ZLERƒ∞ (TUTARLILIK ƒ∞√áƒ∞N) ===');
            prompts.push('√ñNEMLƒ∞: Bu i√ßerikleri aynen tekrar etmeyin! Sadece tutarlƒ±lƒ±k saƒülamak ve tekrardan ka√ßƒ±nmak i√ßin kullanƒ±n.');
            prompts.push('Hasta ile daha √∂nce konu≈ütuklarƒ± konularƒ± tekrar etmek yerine, s√ºreci ileriye ta≈üƒ±yan yeni bakƒ±≈ü a√ßƒ±larƒ± sunun.');
            prompts.push('');
            oncekiAnalizler.forEach((analiz, index) => {
              prompts.push(`--- ${analiz.haftaNo}. Hafta (√ñzet) ---`);
              prompts.push(analiz.icerik.substring(0, 800) + '...');
              prompts.push('');
            });
            prompts.push('--- √ñnceki analizlerin sonu ---');
            prompts.push('Bu hafta i√ßin tamamen yeni, √∂nceki haftalarƒ± tamamlayan i√ßerik olu≈üturun.');
          }
        }
        
        // 4. Ek Notlar
        if (document.getElementById(`ekPrompt_${haftaIndex}`)?.checked) {
          const ekNotlar = document.getElementById(`ekNotlar_${haftaIndex}`)?.value?.trim();
          if (ekNotlar) {
            prompts.push('=== BU HAFTA ƒ∞√áƒ∞N EK Bƒ∞LGƒ∞LER ===');
            prompts.push(ekNotlar);
          }
        }
        
        // 5. PDF/Beslenme Listesi ƒ∞√ßeriƒüi
        if (seciliHasta?.haftalar?.[haftaIndex]) {
          const hafta = seciliHasta.haftalar[haftaIndex];
          prompts.push('=== BESLENME Lƒ∞STESƒ∞ ===');
          
          // PDF i√ßeriƒüi varsa
          if (hafta.pdf && hafta.pdf.length > 1000) {
            try {
              const pdfText = await extractTextFromPdf(hafta.pdf);
              if (pdfText && pdfText.trim().length > 50) {
                prompts.push('PDF ƒ∞√ßeriƒüi:');
                prompts.push(pdfText.substring(0, 3000)); // ƒ∞lk 3000 karakter
              } else {
                throw new Error('PDF metni √ßƒ±karƒ±lamadƒ±');
              }
            } catch (pdfError) {
              console.warn('PDF okuma hatasƒ±, tarif listesi kullanƒ±lƒ±yor:', pdfError);
              prompts.push('Tarif Listesi:');
              if (hafta.tarifler && hafta.tarifler.length > 0) {
                prompts.push(hafta.tarifler.map(t => `‚Ä¢ ${t}`).join('\n'));
              } else {
                prompts.push('Hen√ºz tarif listesi yok.');
              }
            }
          } else if (hafta.tarifler && hafta.tarifler.length > 0) {
            prompts.push('Tarif Listesi:');
            prompts.push(hafta.tarifler.map(t => `‚Ä¢ ${t}`).join('\n'));
          } else {
            prompts.push('Bu hafta i√ßin hen√ºz beslenme listesi y√ºklenmemi≈ü.');
          }
        }
        
        // Final prompt olu≈ütur
        const finalPrompt = prompts.length > 0 ? prompts.join('\n\n') : 'Bu hafta i√ßin analiz yapƒ±labilecek veri bulunamadƒ±.';
        
        // Prompt'u daha okunabilir hale getir (ba≈ülƒ±klarƒ± bold ve altƒ± √ßizili yap)
        const formattedPrompt = finalPrompt
          .replace(/=== (.*?) ===/g, '<b><u>$1</u></b>')
          .replace(/\n/g, '\n');
        
        // Debug i√ßin prompt'u konsola yazdƒ±r
        console.log('üîç GPT\'ye g√∂nderilen prompt:', finalPrompt);
        
        // Nihai prompt'u g√∂ster ve d√ºzenleme imkanƒ± ver
        window.tempSettings = settings; // Ge√ßici olarak global'e kaydet
        showFinalPromptModal(finalPrompt, haftaIndex, settings, gptMesajTextarea);
        
      } catch (error) {
        console.error('GPT analiz hatasƒ±:', error);
        document.getElementById(`gptMesaj_${haftaIndex}`).value = `‚ùå GPT analiz hatasƒ±: ${error.message}`;
        document.getElementById(`gptMesaj_${haftaIndex}`).disabled = false;
        showToast('‚ùå GPT analizi ba≈üarƒ±sƒ±z', 'error', 4000);
      }
    }
    
    // √ñnceki haftalardaki GPT analizlerini al (tutarlƒ±lƒ±k i√ßin)
    function getOncekiGptAnalizleri(haftaIndex) {
      const analizler = [];
      
      if (!seciliHasta || !seciliHasta.haftalar) {
        return analizler;
      }
      
      // √ñnceki haftalardaki GPT mesajlarƒ±nƒ± topla (max 5 hafta)
      const maxOncekiHafta = Math.min(haftaIndex, 5);
      
      for (let i = Math.max(0, haftaIndex - maxOncekiHafta); i < haftaIndex; i++) {
        const hafta = seciliHasta.haftalar[i];
        if (hafta && hafta.gptMesaj && hafta.gptMesaj.trim().length > 50) {
          analizler.push({
            haftaNo: hafta.haftaNo || (i + 1),
            icerik: hafta.gptMesaj.trim()
          });
        }
      }
      
      console.log(`üìä ${analizler.length} √∂nceki hafta analizi bulundu (${haftaIndex + 1}. hafta i√ßin)`);
      return analizler;
    }
    
    // Token hesaplayƒ±cƒ±sƒ± (yakla≈üƒ±k)
    function hesaplaToken(text) {
      if (!text || typeof text !== 'string') return 0;
      // Yakla≈üƒ±k hesaplama: 1 token ‚âà 4 karakter (ƒ∞ngilizce i√ßin)
      // T√ºrk√ße i√ßin biraz daha fazla olabilir
      return Math.ceil(text.length / 3.5);
    }
    
    // Maliyet tahmini hesapla
    function hesaplaMaliyet(tokenSayisi, model = 'gpt-4') {
      const fiyatlar = {
        'gpt-4': { input: 0.03, output: 0.06 }, // $0.03 input, $0.06 output per 1K tokens
        'gpt-4-turbo': { input: 0.01, output: 0.03 },
        'gpt-3.5-turbo': { input: 0.001, output: 0.002 }
      };
      
      const fiyat = fiyatlar[model] || fiyatlar['gpt-4'];
      const inputMaliyet = (tokenSayisi / 1000) * fiyat.input;
      const outputMaliyet = (1000 / 1000) * fiyat.output; // Ortalama 1000 token output varsayƒ±mƒ±
      
      return {
        inputToken: tokenSayisi,
        outputToken: 1000,
        toplamToken: tokenSayisi + 1000,
        inputMaliyet: inputMaliyet,
        outputMaliyet: outputMaliyet,
        toplamMaliyet: inputMaliyet + outputMaliyet,
        model: model
      };
    }
    
    // Nihai prompt g√∂sterme ve d√ºzenleme modal'ƒ±
    function showFinalPromptModal(finalPrompt, haftaIndex, settings, gptMesajTextarea) {
      // Token ve maliyet hesapla
      const tokenSayisi = hesaplaToken(finalPrompt);
      const maliyet = hesaplaMaliyet(tokenSayisi, settings.model || 'gpt-4');
      
      // Prompt'u daha okunabilir hale getir (ba≈ülƒ±klarƒ± bold ve altƒ± √ßizili yap)
      const formattedPromptForDisplay = finalPrompt
        .replace(/=== (.*?) ===/g, '<div style="font-weight: bold; text-decoration: underline; color: #007bff; margin: 15px 0 10px 0; font-size: 14px;">üìã $1</div>')
        .replace(/\n/g, '<br>');
      
      // Modal HTML'i olu≈ütur
      const modalHtml = `
        <div id="finalPromptModal" style="
          position: fixed; 
          top: 0; 
          left: 0; 
          width: 100%; 
          height: 100%; 
          background: rgba(0,0,0,0.7); 
          display: flex; 
          justify-content: center; 
          align-items: center; 
          z-index: 10000;
        ">
          <div style="
            background: white; 
            border-radius: 12px; 
            padding: 25px; 
            max-width: 90%; 
            max-height: 90%; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          ">
            <h3 style="margin: 0 0 15px 0; color: #004085; font-size: 18px; display: flex; align-items: center; gap: 10px;">
              <span>üéØ</span> GPT'ye G√∂nderilecek Nihai Prompt
            </h3>
            
            <!-- Token ve Maliyet Bilgisi -->
            <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #28a745;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 12px;">
                <div><strong>üìä Token:</strong> ~${tokenSayisi.toLocaleString()}</div>
                <div><strong>ü§ñ Model:</strong> ${maliyet.model}</div>
                <div><strong>üí∞ Tahmini Maliyet:</strong> ~$${maliyet.toplamMaliyet.toFixed(4)}</div>
                <div><strong>üî¢ Toplam Token:</strong> ~${maliyet.toplamToken.toLocaleString()}</div>
              </div>
            </div>
            
            <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
              <strong>üìã ƒ∞√ßerik √ñzeti:</strong> Se√ßili prompt b√∂l√ºmleri, hasta bilgileri ve beslenme listesi birle≈ütirilerek hazƒ±rlandƒ±.
            </div>
            
            <!-- G√∂rsel √∂nizleme -->
            <div id="promptPreview" style="
              width: 100%; 
              height: 300px; 
              padding: 15px; 
              border: 2px solid #e3f2fd; 
              border-radius: 8px; 
              font-family: Arial, sans-serif; 
              font-size: 12px; 
              overflow-y: auto;
              background: #f8f9fa;
              margin-bottom: 15px;
            ">${formattedPromptForDisplay}</div>
            
            <!-- D√ºzenlenebilir textarea (gizli) -->
            <textarea id="finalPromptText" style="display: none;">${finalPrompt}</textarea>
            
            <!-- D√ºzenleme butonu -->
            <div style="margin-bottom: 15px;">
              <button id="editPromptBtn" onclick="toggleEditMode()" style="
                padding: 8px 15px; 
                background: #ffc107; 
                color: #212529; 
                border: none; 
                border-radius: 4px; 
                cursor: pointer;
                font-size: 12px;
              ">‚úèÔ∏è D√ºzenle</button>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
              <div style="color: #666; font-size: 12px;">
                üí° <strong>ƒ∞pucu:</strong> Prompt'u d√ºzenleyebilir ve sonra GPT'ye g√∂nderebilirsiniz.
              </div>
              
              <div style="display: flex; gap: 10px;">
                <button onclick="closeFinalPromptModal()" style="
                  padding: 10px 20px; 
                  background: #6c757d; 
                  color: white; 
                  border: none; 
                  border-radius: 6px; 
                  cursor: pointer;
                  font-size: 14px;
                ">‚ùå ƒ∞ptal</button>
                
                <button onclick="sendFinalPromptToGpt(${haftaIndex}, null, '${gptMesajTextarea.id}')" style="
                  padding: 10px 20px; 
                  background: linear-gradient(135deg, #007bff, #0056b3); 
                  color: white; 
                  border: none; 
                  border-radius: 6px; 
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: bold;
                ">üöÄ GPT'ye G√∂nder</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Modal'ƒ± sayfaya ekle
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    // Modal'ƒ± kapat
    function closeFinalPromptModal() {
      const modal = document.getElementById('finalPromptModal');
      if (modal) {
        modal.remove();
      }
      
      // Ge√ßici deƒüi≈ükeni temizle
      if (window.tempSettings) {
        delete window.tempSettings;
      }
      
      // Loading durumunu sƒ±fƒ±rla
      const allTextareas = document.querySelectorAll('[id^="gptMesaj_"]');
      allTextareas.forEach(textarea => {
        if (textarea.value === 'ü§ñ GPT analiz ediyor, l√ºtfen bekleyin...') {
          textarea.value = '';
          textarea.disabled = false;
        }
      });
    }
    
    // D√ºzenleme modunu toggle et
    function toggleEditMode() {
      const previewDiv = document.getElementById('promptPreview');
      const textareaEl = document.getElementById('finalPromptText');
      const editBtn = document.getElementById('editPromptBtn');
      
      if (textareaEl.style.display === 'none') {
        // D√ºzenleme moduna ge√ß
        previewDiv.style.display = 'none';
        textareaEl.style.display = 'block';
        textareaEl.style.width = '100%';
        textareaEl.style.height = '300px';
        textareaEl.style.padding = '15px';
        textareaEl.style.border = '2px solid #e3f2fd';
        textareaEl.style.borderRadius = '8px';
        textareaEl.style.fontFamily = 'monospace';
        textareaEl.style.fontSize = '12px';
        textareaEl.style.resize = 'vertical';
        editBtn.textContent = 'üëÅÔ∏è √ñnizleme';
        editBtn.style.background = '#17a2b8';
        editBtn.style.color = 'white';
      } else {
        // √ñnizleme moduna ge√ß
        const updatedText = textareaEl.value;
        const formattedText = updatedText
          .replace(/=== (.*?) ===/g, '<div style="font-weight: bold; text-decoration: underline; color: #007bff; margin: 15px 0 10px 0; font-size: 14px;">üìã $1</div>')
          .replace(/\n/g, '<br>');
        
        previewDiv.innerHTML = formattedText;
        previewDiv.style.display = 'block';
        textareaEl.style.display = 'none';
        editBtn.textContent = '‚úèÔ∏è D√ºzenle';
        editBtn.style.background = '#ffc107';
        editBtn.style.color = '#212529';
      }
    }
    
    // D√ºzenlenmi≈ü prompt'u GPT'ye g√∂nder
    async function sendFinalPromptToGpt(haftaIndex, settings, textareaId) {
      try {
        const finalPromptText = document.getElementById('finalPromptText').value.trim();
        const gptMesajTextarea = document.getElementById(textareaId);
        
        if (!finalPromptText) {
          alert('‚ùå Prompt bo≈ü olamaz!');
          return;
        }
        
        // Settings'i doƒüru ≈üekilde al
        const currentSettings = window.tempSettings || JSON.parse(localStorage.getItem('gptSettings') || '{}');
        
        if (!currentSettings.apiKey) {
          alert('‚ùå GPT API Key girilmemi≈ü!\n\nL√ºtfen GPT Y√∂netimi panelinden API Key\'inizi girin.');
          closeFinalPromptModal();
          return;
        }
        
        // Modal'ƒ± kapat
        closeFinalPromptModal();
        
        // Loading g√∂ster
        gptMesajTextarea.value = 'ü§ñ GPT analiz ediyor, l√ºtfen bekleyin...';
        gptMesajTextarea.disabled = true;
        
        // GPT'ye g√∂nder
        await sendToGpt(finalPromptText, haftaIndex, currentSettings, gptMesajTextarea);
        
      } catch (error) {
        console.error('Prompt g√∂nderme hatasƒ±:', error);
        alert(`‚ùå Hata: ${error.message}`);
        closeFinalPromptModal();
      }
    }
    
    // GPT'ye prompt g√∂nder
    async function sendToGpt(finalPrompt, haftaIndex, settings, gptMesajTextarea) {
      try {
        // GPT API'ye g√∂nder
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${settings.apiKey}`
          },
          body: JSON.stringify({
            model: settings.model || 'gpt-4',
            messages: [{ 
              role: 'user', 
              content: finalPrompt 
            }],
            max_tokens: 2000,
            temperature: 0.7
          })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`GPT API hatasƒ±: ${response.status} - ${errorText}`);
        }
        
        const result = await response.json();
        const gptYanit = result.choices[0].message.content;
        
        // Sonucu g√∂ster
        gptMesajTextarea.value = gptYanit;
        gptMesajTextarea.disabled = false;
        
        // Hafta verisine kaydet
        if (seciliHasta?.haftalar?.[haftaIndex]) {
          seciliHasta.haftalar[haftaIndex].gptMesaj = gptYanit;
          seciliHasta.haftalar[haftaIndex].ekNotlar = document.getElementById(`ekNotlar_${haftaIndex}`)?.value || '';
          saveToStorage();
          
          // GitHub'a da kaydet (hata kontrol√º ile)
          if (seciliHasta) {
            try {
              await hastayiAyriKaydet(seciliHasta);
              console.log('‚úÖ GPT sonucu GitHub\'a kaydedildi');
            } catch (githubError) {
              console.warn('‚ö†Ô∏è GitHub kaydetme hatasƒ± (normal):', githubError.message);
              // GitHub hatasƒ± sistem √ßalƒ±≈ümasƒ±nƒ± engellemez
            }
          }
        }
        
        showToast('‚úÖ GPT analizi tamamlandƒ±', 'success', 3000);
        
      } catch (error) {
        console.error('GPT g√∂nderim hatasƒ±:', error);
        gptMesajTextarea.value = `‚ùå GPT g√∂nderim hatasƒ±: ${error.message}`;
        gptMesajTextarea.disabled = false;
        showToast('‚ùå GPT g√∂nderimi ba≈üarƒ±sƒ±z', 'error', 4000);
      }
    }
    
    // GPT mesajƒ±nƒ± kaydet
    function gptMesajKaydet(haftaIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) return;
      
      const gptMesaj = document.getElementById(`gptMesaj_${haftaIndex}`).value;
      seciliHasta.haftalar[haftaIndex].gptMesaj = gptMesaj;
      saveToStorage();
    }
    
    // Genel prompt ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
    function updateGenelPromptBaslik(id, yeniBaslik) {
      const promptlar = JSON.parse(localStorage.getItem(GENEL_PROMPTLAR_KEY) || '[]');
      const prompt = promptlar.find(p => p.id === id);
      if (prompt) {
        prompt.baslik = yeniBaslik;
        localStorage.setItem(GENEL_PROMPTLAR_KEY, JSON.stringify(promptlar));
      }
    }
    
    // Genel prompt i√ßeriƒüini g√ºncelle
    function updateGenelPromptIcerik(id, yeniIcerik) {
      const promptlar = JSON.parse(localStorage.getItem(GENEL_PROMPTLAR_KEY) || '[]');
      const prompt = promptlar.find(p => p.id === id);
      if (prompt) {
        prompt.icerik = yeniIcerik;
        localStorage.setItem(GENEL_PROMPTLAR_KEY, JSON.stringify(promptlar));
      }
    }
    
    // Genel prompt sil
    function deleteGenelPrompt(id) {
      if (confirm('Bu prompt ≈üablonunu silmek istediƒüinizden emin misiniz?')) {
        const promptlar = JSON.parse(localStorage.getItem(GENEL_PROMPTLAR_KEY) || '[]');
        const yeniPromptlar = promptlar.filter(p => p.id !== id);
        localStorage.setItem(GENEL_PROMPTLAR_KEY, JSON.stringify(yeniPromptlar));
        renderGenelPromptlar();
      }
    }
    
    // Yeni haftalƒ±k prompt ekle
    function yeniHaftalikPrompt() {
      const haftaNo = parseInt(document.getElementById('yeniHaftaNo').value);
      const baslik = document.getElementById('yeniHaftaBaslik').value.trim();
      
      if (!haftaNo || haftaNo < 1 || haftaNo > 52) {
        alert('L√ºtfen 1-52 arasƒ± ge√ßerli bir hafta numarasƒ± girin');
        return;
      }
      
      if (!baslik) {
        alert('L√ºtfen tema ba≈ülƒ±ƒüƒ± girin');
        return;
      }
      
      const promptlar = JSON.parse(localStorage.getItem(HAFTALIK_PROMPTLAR_KEY) || '[]');
      
      // Aynƒ± hafta varsa g√ºncelle
      const mevcutIndex = promptlar.findIndex(p => p.haftaNo === haftaNo);
      const yeniPrompt = {
        id: Date.now(),
        haftaNo: haftaNo,
        baslik: baslik,
        icerik: `${haftaNo}. hafta temasƒ±: ${baslik}\n\nBu haftaki beslenme listesinde...`
      };
      
      if (mevcutIndex >= 0) {
        promptlar[mevcutIndex] = yeniPrompt;
      } else {
        promptlar.push(yeniPrompt);
      }
      
      localStorage.setItem(HAFTALIK_PROMPTLAR_KEY, JSON.stringify(promptlar));
      document.getElementById('yeniHaftaNo').value = '';
      document.getElementById('yeniHaftaBaslik').value = '';
      renderHaftalikPromptlar();
    }
    
    // Haftalƒ±k promptlarƒ± render et
    function renderHaftalikPromptlar() {
      const container = document.getElementById('haftalikPromptlar');
      const promptlar = JSON.parse(localStorage.getItem(HAFTALIK_PROMPTLAR_KEY) || '[]');
      
      // Hafta numarasƒ±na g√∂re sƒ±rala
      promptlar.sort((a, b) => a.haftaNo - b.haftaNo);
      
      container.innerHTML = promptlar.map(prompt => `
        <div style="margin-bottom: 15px; padding: 15px; background: #fff8e1; border-radius: 8px; border: 1px solid #ffecb3;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-weight: bold; color: #f57c00; margin-right: 10px;">${prompt.haftaNo}. Hafta:</span>
            <input type="text" value="${prompt.baslik}" onchange="updateHaftalikPromptBaslik(${prompt.id}, this.value)" 
                   style="flex: 1; padding: 5px; border: 1px solid #ffcc02; border-radius: 4px; background: #fffde7;">
            <button onclick="deleteHaftalikPrompt(${prompt.id})" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
          </div>
          <textarea onchange="updateHaftalikPromptIcerik(${prompt.id}, this.value)" rows="3" 
                    style="width: 100%; padding: 8px; border: 1px solid #ffcc02; border-radius: 4px; resize: vertical; background: #fffde7;"
                    placeholder="Hafta temasƒ± prompt i√ßeriƒüi...">${prompt.icerik}</textarea>
        </div>
      `).join('');
    }
    
    // Haftalƒ±k prompt ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
    function updateHaftalikPromptBaslik(id, yeniBaslik) {
      const promptlar = JSON.parse(localStorage.getItem(HAFTALIK_PROMPTLAR_KEY) || '[]');
      const prompt = promptlar.find(p => p.id === id);
      if (prompt) {
        prompt.baslik = yeniBaslik;
        localStorage.setItem(HAFTALIK_PROMPTLAR_KEY, JSON.stringify(promptlar));
      }
    }
    
    // Haftalƒ±k prompt i√ßeriƒüini g√ºncelle
    function updateHaftalikPromptIcerik(id, yeniIcerik) {
      const promptlar = JSON.parse(localStorage.getItem(HAFTALIK_PROMPTLAR_KEY) || '[]');
      const prompt = promptlar.find(p => p.id === id);
      if (prompt) {
        prompt.icerik = yeniIcerik;
        localStorage.setItem(HAFTALIK_PROMPTLAR_KEY, JSON.stringify(promptlar));
      }
    }
    
    // Haftalƒ±k prompt sil
    function deleteHaftalikPrompt(id) {
      if (confirm('Bu haftalƒ±k prompt temasƒ±nƒ± silmek istediƒüinizden emin misiniz?')) {
        const promptlar = JSON.parse(localStorage.getItem(HAFTALIK_PROMPTLAR_KEY) || '[]');
        const yeniPromptlar = promptlar.filter(p => p.id !== id);
        localStorage.setItem(HAFTALIK_PROMPTLAR_KEY, JSON.stringify(yeniPromptlar));
        renderHaftalikPromptlar();
      }
    }
    
    // Global fonksiyonlarƒ± ekle
    window.showGptPanel = showGptPanel;
    window.hideGptPanel = hideGptPanel;
    window.saveGptSettings = saveGptSettings;
    window.yeniGenelPrompt = yeniGenelPrompt;
    window.updateGenelPromptBaslik = updateGenelPromptBaslik;
    window.updateGenelPromptIcerik = updateGenelPromptIcerik;
    window.deleteGenelPrompt = deleteGenelPrompt;
    window.yeniHaftalikPrompt = yeniHaftalikPrompt;
    window.updateHaftalikPromptBaslik = updateHaftalikPromptBaslik;
    window.updateHaftalikPromptIcerik = updateHaftalikPromptIcerik;
    window.deleteHaftalikPrompt = deleteHaftalikPrompt;
    window.gptAnalizeEt = gptAnalizeEt;
    window.gptMesajKaydet = gptMesajKaydet;
    window.showFinalPromptModal = showFinalPromptModal;
    window.closeFinalPromptModal = closeFinalPromptModal;
    window.sendFinalPromptToGpt = sendFinalPromptToGpt;
    window.toggleEditMode = toggleEditMode;
    
    // Global fonksiyonlarƒ± ekle
    window.showToast = showToast;
    window.showGoogleApiConfig = showGoogleApiConfig;
    window.hideGoogleApiConfig = hideGoogleApiConfig;
    window.saveGoogleApiConfig = saveGoogleApiConfig;
    
    // Sayfa y√ºklendiƒüinde Google API'yi hazƒ±rla
    window.addEventListener('load', function() {
      // Google API'yi arka planda hazƒ±rla (kullanƒ±cƒ± i≈ülemi gerektirmez)
      setTimeout(() => {
        initGoogleApi().catch(error => {
          console.log('‚ÑπÔ∏è Google API otomatik y√ºkleme atlandƒ± (normal):', error.message);
        });
      }, 2000);
      
      // Drive durumunu ba≈ülat
      updateGoogleDriveStatus();
    });

  </script>

  <!-- üîß Google API Konfig√ºrasyon Modalƒ± -->
  <div id="googleApiConfigModal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 10000;
    justify-content: center;
    align-items: center;
  ">
    <div style="
      background: white;
      padding: 30px;
      border-radius: 12px;
      width: 600px;
      max-width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    ">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #4285f4;">üîß Google Drive API Ayarlarƒ±</h2>
        <button onclick="hideGoogleApiConfig()" style="
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #666;
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
        ">√ó</button>
      </div>
      
      <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
        <h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è √ñnemli Bilgilendirme</h4>
        <p style="margin: 0; color: #856404; font-size: 14px;">
          Google Drive entegrasyonu i√ßin Google Cloud Console'dan API Key ve Client ID almalƒ±sƒ±nƒ±z. 
          Ayrƒ±ca dosyayƒ± HTTP/HTTPS sunucuda √ßalƒ±≈ütƒ±rmanƒ±z gerekir (file:// protokol√º √ßalƒ±≈ümaz).
        </p>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
          üîë API Key:
        </label>
        <input type="text" id="googleApiKeyInput" placeholder="AIzaSyD..." style="
          width: 100%;
          padding: 12px;
          border: 2px solid #ddd;
          border-radius: 6px;
          font-size: 14px;
          font-family: monospace;
        ">
        <small style="color: #666; font-size: 12px;">Google Cloud Console > Credentials > API Keys</small>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
          üÜî Client ID:
        </label>
        <input type="text" id="googleClientIdInput" placeholder="123456789012-..." style="
          width: 100%;
          padding: 12px;
          border: 2px solid #ddd;
          border-radius: 6px;
          font-size: 14px;
          font-family: monospace;
        ">
        <small style="color: #666; font-size: 12px;">Google Cloud Console > Credentials > OAuth 2.0 Client IDs</small>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h4 style="margin: 0 0 10px 0; color: #28a745;">üìã Hƒ±zlƒ± Kurulum Rehberi:</h4>
        <ol style="padding-left: 20px; color: #666; font-size: 14px; line-height: 1.6;">
          <li><strong>Google Cloud Console'a gidin:</strong> <a href="https://console.cloud.google.com/" target="_blank" style="color: #4285f4;">console.cloud.google.com</a></li>
          <li><strong>Proje olu≈üturun</strong> veya mevcut projeyi se√ßin</li>
          <li><strong>API & Services > Library</strong> b√∂l√ºm√ºnden ≈üu API'leri aktifle≈ütirin:
            <ul style="margin: 5px 0;">
              <li>Google Drive API</li>
              <li>Google Sheets API</li>
            </ul>
          </li>
          <li><strong>API & Services > Credentials</strong> b√∂l√ºm√ºnden:
            <ul style="margin: 5px 0;">
              <li>API Key olu≈üturun</li>
              <li>OAuth 2.0 Client ID olu≈üturun (Web application)</li>
            </ul>
          </li>
          <li><strong>OAuth Client ID</strong> ayarlarƒ±nda:
            <ul style="margin: 5px 0;">
              <li>Authorized JavaScript origins: <code id="currentOriginExample">http://localhost:5500</code></li>
              <li>Authorized redirect URIs: <code id="currentOriginExample2">http://localhost:5500</code></li>
            </ul>
          </li>
        </ol>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="hideGoogleApiConfig()" style="
          padding: 10px 20px;
          background: #6c757d;
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
        ">ƒ∞ptal</button>
        <button onclick="saveGoogleApiConfig()" style="
          padding: 10px 20px;
          background: #28a745;
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          font-weight: bold;
        ">üíæ Kaydet ve Uygula</button>
      </div>
    </div>
  </div>

</body>
</html>



